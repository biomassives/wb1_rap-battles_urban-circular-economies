---
/**
 * track/[id].astro
 * TRACK DETAIL PAGE
 * 
 * PLANNING NOTES & DECISIONS NEEDED
 * ================================
 * 
 * PURPOSE:
 * - Display full track details
 * - Play audio with waveform visualization
 * - Show lyrics and metadata
 * - Enable social interactions (like, comment, share)
 * 
 * KEY DECISIONS TO MAKE:
 * 
 * 1. AUDIO PLAYER IMPLEMENTATION
 *    Q: What level of audio player features?
 *    Options:
 *    A) Basic: Play/pause, seek bar, volume
 *    B) Advanced: Waveform visualization, speed control, loop
 *    C) Full: Playlist, shuffle, equalizer, download
 *    DECISION: _______________
 *    
 *    Q: Audio hosting?
 *    Options:
 *    A) IPFS (decentralized, permanent)
 *    B) S3/Blob (centralized, fast)
 *    C) Hybrid (IPFS backup + CDN cache)
 *    DECISION: _______________
 * 
 * 2. LYRICS DISPLAY
 *    Q: How should lyrics be displayed?
 *    Options:
 *    A) Static text block
 *    B) Scrolling with audio sync (karaoke-style)
 *    C) Line-by-line highlight as audio plays
 *    DECISION: _______________
 * 
 * 3. SOCIAL INTERACTIONS
 *    Q: Which interactions to enable?
 *    - Like/unlike track
 *    - Add to playlist
 *    - Share to social media
 *    - Comment on track
 *    - Tip artist (SOL/USDC)
 *    - Download (if allowed)
 *    - Report inappropriate content
 *    DECISION: Enable _______________ (list which ones)
 * 
 * 4. COMMENTS SYSTEM
 *    Q: Comment features?
 *    Options:
 *    A) Simple: Text comments only, chronological
 *    B) Threaded: Replies to comments
 *    C) Timestamped: Comments linked to specific audio timestamps
 *    D) All of the above
 *    DECISION: _______________
 *    
 *    Q: Moderation?
 *    - Auto-hide flagged comments
 *    - Require wallet connection to comment
 *    - Rate limiting (X comments per hour)
 *    DECISION: _______________
 * 
 * 5. NFT MINTING STATUS
 *    Q: How to display if track is minted as NFT?
 *    - Show NFT badge
 *    - Link to NFT marketplace
 *    - Display owner/minter
 *    - Show edition number (if multiple editions)
 *    - Purchase button (if available)
 *    DECISION: _______________
 * 
 * 6. COLLABORATION DISPLAY
 *    Q: How to show collaborators?
 *    Options:
 *    A) Simple list with profile links
 *    B) Individual contribution notes (who did what)
 *    C) Revenue split display (if transparent)
 *    DECISION: _______________
 * 
 * 7. ANALYTICS
 *    Q: What stats to show?
 *    Public stats (all users see):
 *    - Total plays
 *    - Likes
 *    - Comments count
 *    - Shares
 *    - Date published
 *    
 *    Creator-only stats:
 *    - Play duration average
 *    - Skip rate
 *    - Geographic distribution
 *    - Listener demographics
 *    DECISION: _______________
 * 
 * EVENT FLOWS:
 * 
 * Flow 1: Play Track
 * User clicks play ‚Üí Load audio from storage ‚Üí Initialize waveform ‚Üí 
 * Start playback ‚Üí Track play count +1 ‚Üí Award listener XP (small amount)
 * 
 * Flow 2: Like Track
 * Click like ‚Üí API call /api/music/like ‚Üí Update like count ‚Üí 
 * Add to user's liked tracks ‚Üí Award creator XP
 * 
 * Flow 3: Comment
 * Write comment ‚Üí Submit ‚Üí Validate (not spam) ‚Üí Save to DB ‚Üí 
 * Display in thread ‚Üí Notify creator ‚Üí Award commenter XP
 * 
 * Flow 4: Tip Artist
 * Click tip ‚Üí Enter amount ‚Üí Connect wallet ‚Üí Sign transaction ‚Üí 
 * Transfer SOL/USDC ‚Üí Notify artist ‚Üí Show success ‚Üí Award tipper XP
 * 
 * Flow 5: Add to Battle
 * Creator clicks "Use in battle" ‚Üí Select which battle ‚Üí 
 * Submit as battle entry ‚Üí Validate rules ‚Üí Confirm submission
 */

import BaseLayout from '../../layouts/BaseLayout.astro';

// Generate static paths - returns placeholder, real data fetched client-side
export function getStaticPaths() {
  return [
    { params: { id: 'placeholder' } }
  ];
}

// Get track ID from URL
const { id } = Astro.params;

// TODO: Fetch track data from API
// const trackData = await fetch(`/api/music/track?id=${id}`);
const trackData = {
  id: id,
  title: "Sample Track Title",
  artist: {
    username: "artist_username",
    displayName: "Artist Name",
    walletAddress: "ABC...XYZ"
  },
  collaborators: [],
  genre: "rap",
  audioFileUrl: null, // TODO: Get from IPFS/S3
  coverArtUrl: null,
  lyrics: null,
  description: null,
  tags: [],
  duration: 180, // seconds
  publishedAt: new Date().toISOString(),
  isNftMinted: false,
  nftDetails: null,
  stats: {
    plays: 0,
    likes: 0,
    comments: 0,
    shares: 0
  },
  userActions: {
    hasLiked: false,
    hasPlayed: false
  }
};

const trackExists = trackData !== null;
---

<BaseLayout 
  title={trackData.title}
  description={`Listen to ${trackData.title} by ${trackData.artist.username}`}
  activeSection="music"
>

  <!-- ============================================ -->
  <!-- TRACK NOT FOUND -->
  <!-- ============================================ -->
  {!trackExists && (
    <section class="track-not-found">
      <div class="container mx-auto">
        <div class="not-found-content">
          <div class="not-found-icon">üéµ‚ùå</div>
          <h1>Track Not Found</h1>
          <p>This track doesn't exist or has been removed.</p>
          <a href="/music" class="btn-primary">Browse Music</a>
        </div>
      </div>
    </section>
  )}

  <!-- ============================================ -->
  <!-- TRACK PLAYER SECTION -->
  <!-- ============================================ -->
  {trackExists && (
    <section class="track-player-section">
      <div class="container mx-auto">
        
        <div class="track-player-layout">
          
          <!-- Left: Cover Art & Player -->
          <div class="track-player-side">
            
            <!-- Cover Art -->
            <div class="track-cover-art">
              {trackData.coverArtUrl ? (
                <img src={trackData.coverArtUrl} alt={trackData.title} />
              ) : (
                <div class="cover-placeholder">
                  <span class="cover-icon">üéµ</span>
                  <span class="cover-genre">{trackData.genre}</span>
                </div>
              )}
              
              {/* NFT Badge if minted */}
              {trackData.isNftMinted && (
                <div class="nft-badge-overlay">
                  <span class="nft-icon">üíé</span>
                  <span class="nft-text">NFT</span>
                </div>
              )}
            </div>

            <!-- Audio Player -->
            <div class="audio-player-container">
              {/* 
              DECISION POINT: Audio Player Implementation
              
              TODO: Implement audio player with:
              - Play/pause button
              - Seek bar with current time / total time
              - Volume control
              - Waveform visualization (using wavesurfer.js or similar)
              - Speed control (0.5x, 1x, 1.5x, 2x)
              - Loop button
              - Download button (if allowed)
              
              Libraries to consider:
              - Wavesurfer.js (waveform)
              - Howler.js (audio playback)
              - Plyr (player UI)
              - Tone.js (advanced audio)
              */}
              
              <audio id="track-audio" controls style="width: 100%;">
                <source src={trackData.audioFileUrl || '/placeholder-audio.mp3'} type="audio/mpeg" />
                Your browser does not support the audio element.
              </audio>

              {/* TODO: Replace with custom player */}
              <div class="player-placeholder">
                <p>üéß Custom audio player will be implemented here</p>
                <p>Features: Waveform, speed control, timestamps</p>
              </div>
            </div>

            <!-- Track Actions -->
            <div class="track-actions">
              
              <button 
                class="action-btn like-btn" 
                id="like-btn"
                data-liked={trackData.userActions.hasLiked}
              >
                <span class="action-icon">{trackData.userActions.hasLiked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                <span class="action-text">
                  <strong id="like-count">{trackData.stats.likes}</strong> Likes
                </span>
              </button>

              <button class="action-btn" id="add-to-playlist-btn">
                <span class="action-icon">‚ûï</span>
                <span class="action-text">Add to Playlist</span>
              </button>

              <button class="action-btn" id="share-btn">
                <span class="action-icon">üîó</span>
                <span class="action-text">Share</span>
              </button>

              {/* TODO: Add tip button for SOL/USDC tips */}
              <button class="action-btn tip-btn" id="tip-btn">
                <span class="action-icon">üí∞</span>
                <span class="action-text">Tip Artist</span>
              </button>

              {/* More actions dropdown */}
              <div class="dropdown">
                <button class="action-btn" id="more-actions">
                  <span class="action-icon">‚ãÆ</span>
                </button>
                <div class="dropdown-menu" id="more-menu" style="display: none;">
                  <button class="dropdown-item" onclick="downloadTrack()">
                    ‚¨áÔ∏è Download
                  </button>
                  <button class="dropdown-item" onclick="addToQueue()">
                    üìù Add to Queue
                  </button>
                  <button class="dropdown-item" onclick="reportTrack()">
                    ‚ö†Ô∏è Report
                  </button>
                </div>
              </div>

            </div>

            <!-- Stats Bar -->
            <div class="track-stats-bar">
              <div class="stat-item">
                <span class="stat-icon">‚ñ∂Ô∏è</span>
                <span class="stat-value">{trackData.stats.plays.toLocaleString()}</span>
                <span class="stat-label">Plays</span>
              </div>
              <div class="stat-item">
                <span class="stat-icon">üí¨</span>
                <span class="stat-value">{trackData.stats.comments}</span>
                <span class="stat-label">Comments</span>
              </div>
              <div class="stat-item">
                <span class="stat-icon">üîÑ</span>
                <span class="stat-value">{trackData.stats.shares}</span>
                <span class="stat-label">Shares</span>
              </div>
            </div>

          </div>

          <!-- Right: Track Info & Metadata -->
          <div class="track-info-side">
            
            <!-- Track Header -->
            <div class="track-header">
              <h1 class="track-title">{trackData.title}</h1>
              
              <!-- Artist Info -->
              <div class="artist-info">
                <a href={`/user/${trackData.artist.username}`} class="artist-link">
                  <div class="artist-avatar">
                    {trackData.artist.displayName?.slice(0, 2).toUpperCase() || trackData.artist.username.slice(0, 2).toUpperCase()}
                  </div>
                  <div class="artist-details">
                    <div class="artist-name">
                      {trackData.artist.displayName || trackData.artist.username}
                    </div>
                    <div class="artist-username">@{trackData.artist.username}</div>
                  </div>
                </a>
                
                {/* Follow button */}
                <button class="btn-secondary small" id="follow-artist-btn">
                  + Follow
                </button>
              </div>

              {/* Collaborators (if any) */}
              {trackData.collaborators.length > 0 && (
                <div class="collaborators-section">
                  <h3 class="section-label">Featuring:</h3>
                  <div class="collaborators-list">
                    {trackData.collaborators.map(collab => (
                      <a href={`/user/${collab.username}`} class="collaborator-chip">
                        <span class="collab-avatar">{collab.username.slice(0, 1).toUpperCase()}</span>
                        <span class="collab-name">{collab.username}</span>
                        {/* 
                        DECISION POINT: Show contribution details?
                        e.g., "Beats", "Hook", "Verse 2"
                        */}
                      </a>
                    ))}
                  </div>
                </div>
              )}

              {/* Tags */}
              {trackData.tags.length > 0 && (
                <div class="track-tags">
                  {trackData.tags.map(tag => (
                    <a href={`/music?tag=${tag}`} class="tag-chip">#{tag}</a>
                  ))}
                </div>
              )}
            </div>

            <!-- Description -->
            {trackData.description && (
              <div class="track-description">
                <h3 class="section-label">About</h3>
                <p>{trackData.description}</p>
              </div>
            )}

            <!-- Metadata -->
            <div class="track-metadata">
              <div class="metadata-item">
                <span class="meta-label">Genre:</span>
                <span class="meta-value">{trackData.genre}</span>
              </div>
              <div class="metadata-item">
                <span class="meta-label">Duration:</span>
                <span class="meta-value">{Math.floor(trackData.duration / 60)}:{(trackData.duration % 60).toString().padStart(2, '0')}</span>
              </div>
              <div class="metadata-item">
                <span class="meta-label">Published:</span>
                <span class="meta-value">
                  {new Date(trackData.publishedAt).toLocaleDateString('en-US', { 
                    month: 'long', 
                    day: 'numeric', 
                    year: 'numeric' 
                  })}
                </span>
              </div>
            </div>

            <!-- NFT Details (if minted) -->
            {trackData.isNftMinted && trackData.nftDetails && (
              <div class="nft-details-card">
                <h3 class="section-label">üíé NFT Details</h3>
                <div class="nft-info-grid">
                  <div class="nft-info-item">
                    <span class="nft-info-label">Edition:</span>
                    <span class="nft-info-value">{trackData.nftDetails.edition} / {trackData.nftDetails.totalEditions}</span>
                  </div>
                  <div class="nft-info-item">
                    <span class="nft-info-label">Mint Address:</span>
                    <span class="nft-info-value mono">{trackData.nftDetails.mintAddress.slice(0, 8)}...{trackData.nftDetails.mintAddress.slice(-8)}</span>
                  </div>
                  {/* TODO: Add purchase/bid functionality */}
                  <a href={`/nft/${trackData.nftDetails.tokenId}`} class="btn-primary">
                    View NFT Details
                  </a>
                </div>
              </div>
            )}

          </div>

        </div>

      </div>
    </section>

    <!-- ============================================ -->
    <!-- LYRICS SECTION -->
    <!-- ============================================ -->
    {trackData.lyrics && (
      <section class="lyrics-section">
        <div class="container mx-auto">
          
          <div class="lyrics-header">
            <h2 class="section-title">üìù Lyrics</h2>
            {/* 
            DECISION POINT: Lyrics features
            - Copy to clipboard button
            - Print lyrics button
            - Highlight/annotation (for learning)
            - Translation (if multi-language support)
            */}
            <button class="btn-secondary small" onclick="copyLyrics()">
              üìã Copy
            </button>
          </div>

          <div class="lyrics-content" id="lyrics-content">
            {/* 
            TODO: Implement time-synced lyrics
            - Parse lyrics with timestamps [00:15.5]
            - Highlight current line during playback
            - Click line to seek to that time
            */}
            <pre class="lyrics-text">{trackData.lyrics}</pre>
          </div>

        </div>
      </section>
    )}

    <!-- ============================================ -->
    <!-- COMMENTS SECTION -->
    <!-- ============================================ -->
    <section class="comments-section">
      <div class="container mx-auto">
        
        <h2 class="section-title">
          üí¨ Comments ({trackData.stats.comments})
        </h2>

        {/* Comment Form */}
        <div class="comment-form-container">
          <form id="comment-form" class="comment-form">
            <div class="comment-input-group">
              <textarea 
                id="comment-text"
                name="commentText"
                class="comment-textarea"
                placeholder="Add a comment... (Requires wallet connection)"
                rows="3"
                maxlength="500"
              ></textarea>
              <div class="comment-form-actions">
                <span class="char-counter">
                  <span id="comment-char-count">0</span> / 500
                </span>
                <button type="submit" class="btn-primary">
                  Post Comment
                </button>
              </div>
            </div>
          </form>
        </div>

        {/* Comments List */}
        <div class="comments-list" id="comments-list">
          {/* 
          TODO: Load comments from API
          
          DECISION POINT: Comment features
          - Threaded replies (nested comments)
          - Timestamped comments (link to audio position)
          - Like/upvote comments
          - Sort by: newest, oldest, most liked, timestamp
          - Report/flag comments
          - Edit/delete own comments
          
          Comment structure:
          {
            id: 1,
            user: { username, avatar },
            text: "Great track!",
            timestamp: null, // or audio timestamp in seconds
            createdAt: "2025-01-01",
            likes: 5,
            replies: []
          }
          */}
          <p class="empty-state">No comments yet. Be the first to comment!</p>
        </div>

        <button class="btn-secondary" id="load-more-comments" style="display: none;">
          Load More Comments
        </button>

      </div>
    </section>

    <!-- ============================================ -->
    <!-- RELATED TRACKS -->
    <!-- ============================================ -->
    <section class="related-tracks-section">
      <div class="container mx-auto">
        
        <h2 class="section-title">üéµ More from {trackData.artist.username}</h2>
        
        <div class="tracks-grid" id="artist-tracks-grid">
          {/* TODO: Load more tracks from same artist */}
          <p class="empty-state">Loading more tracks...</p>
        </div>

        <h2 class="section-title">Similar Tracks</h2>
        
        <div class="tracks-grid" id="similar-tracks-grid">
          {/* TODO: Load similar tracks (same genre/tags) */}
          <p class="empty-state">Loading similar tracks...</p>
        </div>

      </div>
    </section>
  )}

  <!-- ============================================ -->
  <!-- TIP ARTIST MODAL -->
  <!-- ============================================ -->
  <div id="tip-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üí∞ Tip {trackData.artist.username}</h3>
        <button class="btn-close" onclick="closeTipModal()">√ó</button>
      </div>

      <div class="tip-modal-body">
        <p>Show your appreciation by sending a tip!</p>
        
        <form id="tip-form">
          {/* Quick amounts */}
          <div class="tip-quick-amounts">
            <button type="button" class="tip-amount-btn" data-amount="0.1">
              0.1 SOL
            </button>
            <button type="button" class="tip-amount-btn" data-amount="0.5">
              0.5 SOL
            </button>
            <button type="button" class="tip-amount-btn" data-amount="1">
              1 SOL
            </button>
            <button type="button" class="tip-amount-btn" data-amount="5">
              5 SOL
            </button>
          </div>

          {/* Custom amount */}
          <div class="form-group">
            <label for="custom-tip-amount">Custom Amount</label>
            <div class="input-with-suffix">
              <input 
                type="number" 
                id="custom-tip-amount"
                name="tipAmount"
                class="form-input"
                placeholder="0.0"
                step="0.01"
                min="0.01"
              />
              <span class="input-suffix">SOL</span>
            </div>
          </div>

          {/* Optional message */}
          <div class="form-group">
            <label for="tip-message">Message (Optional)</label>
            <textarea 
              id="tip-message"
              name="tipMessage"
              class="form-textarea"
              rows="2"
              placeholder="Leave an encouraging message..."
              maxlength="200"
            ></textarea>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-secondary" onclick="closeTipModal()">
              Cancel
            </button>
            <button type="submit" class="btn-primary">
              Send Tip
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

</BaseLayout>

<script>
  /**
   * Track Detail Page Manager
   * 
   * IMPLEMENTATION NOTES:
   * ====================
   * 
   * TODO: API Endpoints Needed
   * - GET /api/music/track?id={id}
   * - POST /api/music/like
   * - POST /api/music/play-count (increment plays)
   * - POST /api/music/comment
   * - GET /api/music/comments?trackId={id}
   * - POST /api/payments/tip
   * - GET /api/music/related?trackId={id}
   * 
   * TODO: Audio Player Features
   * - Waveform visualization (wavesurfer.js)
   * - Play count tracking
   * - Resume from last position
   * - Keyboard shortcuts (space = play/pause, arrow keys = seek)
   * - Mobile-friendly controls
   * 
   * TODO: Social Features
   * - Real-time like counter updates
   * - Comment notifications to artist
   * - Share to Twitter/Discord with audio snippet
   * - Collaborative playlist creation
   * 
   * TODO: Monetization
   * - Tip in SOL or USDC
   * - Revenue split for collaborators
   * - NFT purchase if available
   * - Subscription for early access
   * 
   * ANALYTICS TRACKING:
   * - Track play duration (how long did user listen)
   * - Skip rate (if they stop before end)
   * - Replay count
   * - Share source tracking
   * - Comment sentiment analysis (future)
   */

  class TrackDetailManager {
    constructor() {
      this.trackId = null;
      this.isPlaying = false;
      this.hasLiked = false;
      this.audioPlayer = null;
    }

    async initialize() {
      // Get track ID from URL
      const pathParts = window.location.pathname.split('/');
      this.trackId = pathParts[pathParts.length - 1];

      await this.loadTrackData();
      this.setupAudioPlayer();
      this.setupActions();
      this.setupComments();
      this.loadRelatedTracks();
    }

    async loadTrackData() {
      // TODO: Fetch from API
      console.log('Loading track:', this.trackId);
    }

    setupAudioPlayer() {
      this.audioPlayer = document.getElementById('track-audio');
      
      if (this.audioPlayer) {
        // Track play event
        this.audioPlayer.addEventListener('play', () => {
          this.trackPlay();
        });

        // Track completion
        this.audioPlayer.addEventListener('ended', () => {
          this.trackCompleted();
        });

        // TODO: Implement waveform visualization
        // TODO: Add custom controls
      }
    }

    async trackPlay() {
      // Increment play count
      try {
        await fetch('/api/music/play-count', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            trackId: this.trackId,
            walletAddress: window.walletManager?.connectedWallet
          })
        });
      } catch (error) {
        console.error('Failed to track play:', error);
      }
    }

    async trackCompleted() {
      // Award XP for listening to full track
      await window.progressManager?.awardXP(
        5,
        'track_listened',
        'Listened to full track'
      );
    }

    setupActions() {
      // Like button
      document.getElementById('like-btn')?.addEventListener('click', () => {
        this.toggleLike();
      });

      // Tip button
      document.getElementById('tip-btn')?.addEventListener('click', () => {
        this.openTipModal();
      });

      // Share button
      document.getElementById('share-btn')?.addEventListener('click', () => {
        this.shareTrack();
      });

      // Tip form
      document.getElementById('tip-form')?.addEventListener('submit', (e) => {
        e.preventDefault();
        this.sendTip();
      });

      // Quick tip amounts
      document.querySelectorAll('.tip-amount-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const amount = e.target.dataset.amount;
          document.getElementById('custom-tip-amount').value = amount;
        });
      });
    }

    async toggleLike() {
      const btn = document.getElementById('like-btn');
      const icon = btn.querySelector('.action-icon');
      const count = document.getElementById('like-count');

      try {
        const endpoint = this.hasLiked ? '/api/music/unlike' : '/api/music/like';
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            trackId: this.trackId,
            walletAddress: window.walletManager?.connectedWallet
          })
        });

        const data = await response.json();
        
        if (data.success) {
          this.hasLiked = !this.hasLiked;
          icon.textContent = this.hasLiked ? '‚ù§Ô∏è' : 'ü§ç';
          count.textContent = this.hasLiked 
            ? parseInt(count.textContent) + 1 
            : parseInt(count.textContent) - 1;

          // Award XP for liking
          if (this.hasLiked) {
            await window.progressManager?.awardXP(
              2,
              'track_liked',
              'Liked a track'
            );
          }
        }
      } catch (error) {
        console.error('Failed to toggle like:', error);
      }
    }

    setupComments() {
      // Comment form
      const form = document.getElementById('comment-form');
      const textarea = document.getElementById('comment-text');
      const charCount = document.getElementById('comment-char-count');

      // Character counter
      textarea?.addEventListener('input', (e) => {
        charCount.textContent = e.target.value.length;
      });

      // Submit comment
      form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        await this.postComment();
      });

      // Load existing comments
      this.loadComments();
    }

    async postComment() {
      const textarea = document.getElementById('comment-text');
      const commentText = textarea.value.trim();

      if (!commentText) return;

      try {
        const response = await fetch('/api/music/comment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            trackId: this.trackId,
            walletAddress: window.walletManager?.connectedWallet,
            text: commentText
          })
        });

        const data = await response.json();
        
        if (data.success) {
          // Clear form
          textarea.value = '';
          document.getElementById('comment-char-count').textContent = '0';

          // Reload comments
          await this.loadComments();

          // Award XP
          await window.progressManager?.awardXP(
            10,
            'track_commented',
            'Commented on a track'
          );

          // Show success
          alert('Comment posted!');
        }
      } catch (error) {
        console.error('Failed to post comment:', error);
        alert('Failed to post comment. Please try again.');
      }
    }

    async loadComments() {
      // TODO: Fetch comments from API
      console.log('Loading comments for track:', this.trackId);
    }

    openTipModal() {
      document.getElementById('tip-modal').style.display = 'flex';
    }

    async sendTip() {
      const amount = parseFloat(document.getElementById('custom-tip-amount').value);
      const message = document.getElementById('tip-message').value;

      if (!amount || amount < 0.01) {
        alert('Please enter a valid tip amount (minimum 0.01 SOL)');
        return;
      }

      // TODO: Implement Solana payment
      console.log('Sending tip:', { amount, message, trackId: this.trackId });
      alert('Tip functionality coming soon!');
    }

    shareTrack() {
      const url = window.location.href;
      const text = `Check out this track on Hobby Farm!`;

      if (navigator.share) {
        navigator.share({ title: document.title, text, url });
      } else {
        navigator.clipboard.writeText(url);
        alert('Link copied to clipboard!');
      }
    }

    async loadRelatedTracks() {
      // TODO: Load related tracks from API
      console.log('Loading related tracks');
    }
  }

  // Global functions
  function closeTipModal() {
    document.getElementById('tip-modal').style.display = 'none';
  }

  function copyLyrics() {
    const lyrics = document.querySelector('.lyrics-text').textContent;
    navigator.clipboard.writeText(lyrics);
    alert('Lyrics copied to clipboard!');
  }

  function downloadTrack() {
    // TODO: Implement download (if allowed by artist)
    alert('Download feature coming soon!');
  }

  function addToQueue() {
    // TODO: Implement queue system
    alert('Queue feature coming soon!');
  }

  function reportTrack() {
    // TODO: Implement reporting
    if (confirm('Report this track as inappropriate?')) {
      console.log('Report track');
    }
  }

  // Initialize
  window.trackDetailManager = new TrackDetailManager();

  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
      window.trackDetailManager.initialize();
    }, 500);
  });
</script>

<style>
  .track-player-section {
    background: var(--color-gray-50);
    padding: 3rem 0;
  }

  .track-player-layout {
    display: grid;
    grid-template-columns: 400px 1fr;
    gap: 3rem;
  }

  .track-cover-art {
    width: 100%;
    aspect-ratio: 1;
    border-radius: var(--radius-lg);
    overflow: hidden;
    position: relative;
    box-shadow: var(--shadow-xl);
  }

  .track-cover-art img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .cover-placeholder {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
  }

  .cover-icon {
    font-size: 6rem;
    margin-bottom: 1rem;
  }

  .cover-genre {
    font-size: 1.5rem;
    font-weight: 700;
    text-transform: uppercase;
  }

  .nft-badge-overlay {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
    color: #333;
    padding: 0.5rem 1rem;
    border-radius: var(--radius-full);
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: var(--shadow-lg);
  }

  .audio-player-container {
    margin-top: 2rem;
  }

  .player-placeholder {
    background: white;
    padding: 2rem;
    border-radius: var(--radius-lg);
    text-align: center;
    margin-top: 1rem;
    border: 2px dashed var(--color-gray-300);
  }

  .track-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 2rem;
    flex-wrap: wrap;
  }

  .action-btn {
    flex: 1;
    min-width: 120px;
    padding: 0.75rem 1rem;
    background: white;
    border: 2px solid var(--color-gray-200);
    border-radius: var(--radius-md);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    cursor: pointer;
    transition: all var(--transition-base);
  }

  .action-btn:hover {
    border-color: var(--color-primary);
    transform: translateY(-2px);
  }

  .action-btn.like-btn[data-liked="true"] {
    border-color: var(--color-error);
    background: #fef2f2;
  }

  .action-icon {
    font-size: 1.5rem;
  }

  .action-text {
    font-size: 0.875rem;
  }

  .track-stats-bar {
    display: flex;
    justify-content: space-around;
    margin-top: 2rem;
    padding: 1.5rem;
    background: white;
    border-radius: var(--radius-lg);
  }

  .stat-item {
    text-align: center;
  }

  .stat-icon {
    font-size: 1.5rem;
    display: block;
    margin-bottom: 0.5rem;
  }

  .stat-value {
    display: block;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-primary);
  }

  .stat-label {
    display: block;
    font-size: 0.875rem;
    color: var(--color-gray-600);
    margin-top: 0.25rem;
  }

  .track-title {
    font-size: 2.5rem;
    font-weight: 800;
    margin-bottom: 1.5rem;
  }

  .artist-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 2px solid var(--color-gray-200);
  }

  .artist-link {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex: 1;
    text-decoration: none;
    color: inherit;
  }

  .artist-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
  }

  .artist-name {
    font-size: 1.25rem;
    font-weight: 700;
  }

  .artist-username {
    font-size: 0.875rem;
    color: var(--color-gray-600);
  }

  .lyrics-section {
    background: white;
    padding: 3rem 0;
  }

  .lyrics-content {
    background: var(--color-gray-50);
    padding: 2rem;
    border-radius: var(--radius-lg);
    border-left: 4px solid var(--color-primary);
  }

  .lyrics-text {
    font-family: var(--font-mono);
    font-size: 1rem;
    line-height: 1.8;
    white-space: pre-wrap;
    margin: 0;
  }

  .comment-form-container {
    margin-bottom: 2rem;
  }

  .comment-textarea {
    width: 100%;
    padding: 1rem;
    border: 2px solid var(--color-gray-300);
    border-radius: var(--radius-md);
    font-family: inherit;
    resize: vertical;
  }

  .comment-form-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 0.5rem;
  }

  .char-counter {
    font-size: 0.875rem;
    color: var(--color-gray-600);
  }

  .tip-quick-amounts {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }

  .tip-amount-btn {
    padding: 0.75rem;
    background: white;
    border: 2px solid var(--color-gray-300);
    border-radius: var(--radius-md);
    font-weight: 700;
    cursor: pointer;
    transition: all var(--transition-base);
  }

  .tip-amount-btn:hover,
  .tip-amount-btn:focus {
    border-color: var(--color-primary);
    background: var(--color-primary-light);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .track-player-layout {
      grid-template-columns: 1fr;
    }

    .track-actions {
      grid-template-columns: 1fr 1fr;
    }

    .tip-quick-amounts {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>
