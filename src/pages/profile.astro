---
/**
 * profile.astro
 * Streamlined Profile - Command Center for WorldBridger One
 *
 * 5 Focused Tabs:
 * 1. Dashboard - Overview, notifications, quick actions
 * 2. My Work - Projects, contributions, data submissions
 * 3. Rewards - NFTs, claimable rewards, staking
 * 4. Wallet - Balances, payouts, gift cards
 * 5. Settings - Profile, notifications, privacy
 */

import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout
  title="Profile - WorldBridger One"
  description="Your command center for projects, rewards, and community impact"
  activeSection="profile"
>

<div class="profile-page">
  <div class="container">

    <!-- ========== HEADER ========== -->
    <header class="profile-header">
      <div class="user-info">
        <div class="avatar" id="user-avatar">
          <span class="avatar-placeholder">?</span>
        </div>
        <div class="user-details">
          <h1 class="username" id="username">Loading...</h1>
          <div class="wallet-id" id="wallet-id">----</div>
          <div class="level-badge">
            <span class="level-icon">‚ñ≤</span>
            <span class="level-text">Level <span id="user-level">1</span></span>
          </div>
        </div>
      </div>

      <div class="xp-progress">
        <div class="xp-info">
          <span class="xp-current"><span id="current-xp">0</span> XP</span>
          <span class="xp-next">Next: <span id="xp-to-next">100</span></span>
        </div>
        <div class="xp-bar">
          <div class="xp-fill" id="xp-bar" style="width: 0%"></div>
        </div>
      </div>

      <!-- Notification Bell -->
      <button class="notification-bell" id="notification-bell" onclick="toggleNotificationPanel()">
        <span class="bell-icon">üîî</span>
        <span class="notification-count" id="notification-count" style="display: none;">0</span>
      </button>
    </header>

    <!-- ========== NOTIFICATION PANEL (Slide-out) ========== -->
    <div class="notification-panel" id="notification-panel">
      <div class="panel-header">
        <h3>Notifications</h3>
        <div class="panel-actions">
          <button class="text-btn" onclick="markAllRead()">Mark all read</button>
          <button class="close-btn" onclick="toggleNotificationPanel()">√ó</button>
        </div>
      </div>

      <div class="notification-filters">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="xp">XP</button>
        <button class="filter-btn" data-filter="nft">NFT</button>
        <button class="filter-btn" data-filter="project">Projects</button>
        <button class="filter-btn" data-filter="payout">Wallet</button>
      </div>

      <div class="notification-list" id="notification-list">
        <div class="loading-notifications">Loading...</div>
      </div>
    </div>

    <!-- ========== TAB NAVIGATION ========== -->
    <nav class="tab-nav">
      <button class="tab-btn active" data-tab="dashboard">
        <span class="tab-icon">üìä</span>
        <span class="tab-label">Dashboard</span>
      </button>
      <button class="tab-btn" data-tab="work">
        <span class="tab-icon">üìÅ</span>
        <span class="tab-label">My Work</span>
      </button>
      <button class="tab-btn" data-tab="rewards">
        <span class="tab-icon">üéÅ</span>
        <span class="tab-label">Rewards</span>
        <span class="tab-badge" id="rewards-badge" style="display: none;">!</span>
      </button>
      <button class="tab-btn" data-tab="wallet">
        <span class="tab-icon">üí∞</span>
        <span class="tab-label">Wallet</span>
      </button>
      <button class="tab-btn" data-tab="settings">
        <span class="tab-icon">‚öôÔ∏è</span>
        <span class="tab-label">Settings</span>
      </button>
    </nav>

    <!-- ========== TAB: DASHBOARD ========== -->
    <section class="tab-content active" id="tab-dashboard">
      <!-- Quick Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">‚ö°</div>
          <div class="stat-value" id="stat-xp">0</div>
          <div class="stat-label">Total XP</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üìÅ</div>
          <div class="stat-value" id="stat-projects">0</div>
          <div class="stat-label">Projects</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üíé</div>
          <div class="stat-value" id="stat-nfts">0</div>
          <div class="stat-label">NFTs</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üó≥Ô∏è</div>
          <div class="stat-value" id="stat-votes">0</div>
          <div class="stat-label">Votes Cast</div>
        </div>
      </div>

      <!-- Recent Notifications (Inline) -->
      <div class="section-card">
        <div class="card-header">
          <h3>Recent Activity</h3>
          <button class="text-btn" onclick="switchTab('settings')">Manage ‚Üí</button>
        </div>
        <div class="activity-feed" id="recent-activity">
          <div class="empty-state">No recent activity</div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="section-card">
        <div class="card-header">
          <h3>Quick Actions</h3>
        </div>
        <div class="quick-actions">
          <button class="action-btn" onclick="openModal('submit-data')">
            <span>üìä</span> Log Data
          </button>
          <button class="action-btn" onclick="openModal('new-project')">
            <span>‚ûï</span> New Project
          </button>
          <button class="action-btn" onclick="switchTab('rewards')">
            <span>üéÅ</span> Claim Rewards
          </button>
          <button class="action-btn" onclick="switchTab('wallet')">
            <span>üí∏</span> Cash Out
          </button>
        </div>
      </div>

      <!-- Health/Data Streak -->
      <div class="section-card streak-card">
        <div class="card-header">
          <h3>üî• Data Streak</h3>
        </div>
        <div class="streak-display">
          <div class="streak-count" id="streak-count">0</div>
          <div class="streak-label">days</div>
        </div>
        <p class="streak-message" id="streak-message">Start logging to build your streak!</p>
        <button class="primary-btn" onclick="openModal('submit-data')">Log Today's Data</button>
      </div>
    </section>

    <!-- ========== TAB: MY WORK ========== -->
    <section class="tab-content" id="tab-work">
      <!-- Sub-tabs -->
      <div class="sub-tabs">
        <button class="sub-tab active" data-subtab="projects">Projects</button>
        <button class="sub-tab" data-subtab="contributions">Contributions</button>
        <button class="sub-tab" data-subtab="data">Data Submissions</button>
      </div>

      <!-- Projects Sub-tab -->
      <div class="sub-content active" id="subtab-projects">
        <div class="section-header">
          <h3>My Projects</h3>
          <button class="primary-btn" onclick="openModal('new-project')">+ New Project</button>
        </div>
        <div class="projects-list" id="my-projects-list">
          <div class="loading">Loading projects...</div>
        </div>
      </div>

      <!-- Contributions Sub-tab -->
      <div class="sub-content" id="subtab-contributions">
        <div class="section-header">
          <h3>My Contributions</h3>
        </div>
        <div class="contributions-summary" id="contributions-summary">
          <div class="summary-stat">
            <span class="value" id="total-contributed">$0</span>
            <span class="label">Total Value</span>
          </div>
          <div class="summary-stat">
            <span class="value" id="projects-supported">0</span>
            <span class="label">Projects Supported</span>
          </div>
          <div class="summary-stat">
            <span class="value" id="equity-earned">0%</span>
            <span class="label">Equity Earned</span>
          </div>
        </div>
        <div class="contributions-list" id="contributions-list">
          <div class="loading">Loading contributions...</div>
        </div>
      </div>

      <!-- Data Submissions Sub-tab -->
      <div class="sub-content" id="subtab-data">
        <div class="section-header">
          <h3>Data Submissions</h3>
          <button class="primary-btn" onclick="openModal('submit-data')">+ Submit Data</button>
        </div>
        <div class="data-types">
          <button class="type-btn" onclick="openModal('submit-data', 'environmental')">üåç Environmental</button>
          <button class="type-btn" onclick="openModal('submit-data', 'health')">‚ù§Ô∏è Health</button>
          <button class="type-btn" onclick="openModal('submit-data', 'community')">üë• Community</button>
        </div>
        <div class="submissions-list" id="data-submissions-list">
          <div class="loading">Loading submissions...</div>
        </div>
      </div>
    </section>

    <!-- ========== TAB: REWARDS ========== -->
    <section class="tab-content" id="tab-rewards">
      <!-- Claimable Rewards -->
      <div class="section-card highlight-card">
        <div class="card-header">
          <h3>üéÅ Claimable Rewards</h3>
        </div>
        <div class="claimable-rewards" id="claimable-rewards">
          <div class="loading">Checking eligibility...</div>
        </div>
      </div>

      <!-- NFT Collection -->
      <div class="section-card">
        <div class="card-header">
          <h3>üíé My NFTs</h3>
          <a href="/nft-gallery" class="text-btn">View Gallery ‚Üí</a>
        </div>
        <div class="nft-grid" id="nft-grid">
          <div class="loading">Loading NFTs...</div>
        </div>
      </div>

      <!-- Active Stakes -->
      <div class="section-card">
        <div class="card-header">
          <h3>üîí Active Stakes</h3>
        </div>
        <div class="stakes-list" id="stakes-list">
          <div class="empty-state">No active stakes</div>
        </div>
        <button class="secondary-btn" onclick="openModal('stake-nft')">Stake an NFT</button>
      </div>

      <!-- Marketplace Activity -->
      <div class="section-card">
        <div class="card-header">
          <h3>üõí My Listings</h3>
          <a href="/marketplace" class="text-btn">Marketplace ‚Üí</a>
        </div>
        <div class="listings-list" id="my-listings">
          <div class="empty-state">No active listings</div>
        </div>
      </div>
    </section>

    <!-- ========== TAB: WALLET ========== -->
    <section class="tab-content" id="tab-wallet">
      <!-- Balances -->
      <div class="balances-grid">
        <div class="balance-card primary">
          <div class="balance-label">Available XP</div>
          <div class="balance-value" id="xp-balance">0</div>
          <div class="balance-usd">‚âà $<span id="xp-usd-value">0.00</span></div>
        </div>
        <div class="balance-card">
          <div class="balance-label">USD Balance</div>
          <div class="balance-value">$<span id="usd-balance">0.00</span></div>
        </div>
        <div class="balance-card">
          <div class="balance-label">SOL Balance</div>
          <div class="balance-value"><span id="sol-balance">0.00</span> SOL</div>
        </div>
        <div class="balance-card">
          <div class="balance-label">Pending Royalties</div>
          <div class="balance-value">$<span id="royalties-balance">0.00</span></div>
        </div>
      </div>

      <!-- Cash Out Options -->
      <div class="section-card">
        <div class="card-header">
          <h3>üí∏ Cash Out</h3>
        </div>
        <div class="cashout-options">
          <button class="cashout-btn" onclick="openModal('payout', 'mobile_money')">
            <span class="icon">üì±</span>
            <span class="label">Mobile Money</span>
            <span class="desc">M-Pesa, Airtel Money</span>
          </button>
          <button class="cashout-btn" onclick="openModal('payout', 'crypto')">
            <span class="icon">üîó</span>
            <span class="label">Crypto</span>
            <span class="desc">SOL, USDC</span>
          </button>
          <button class="cashout-btn" onclick="openModal('payout', 'gift_card')">
            <span class="icon">üéÅ</span>
            <span class="label">Gift Cards</span>
            <span class="desc">Airtime, Data, Shopping</span>
          </button>
        </div>
      </div>

      <!-- KYC Status -->
      <div class="section-card">
        <div class="card-header">
          <h3>üîê Verification Status</h3>
        </div>
        <div class="kyc-status" id="kyc-status">
          <div class="kyc-level">
            <span class="level-badge" id="kyc-level-badge">Level 0</span>
            <span class="level-name" id="kyc-level-name">None</span>
          </div>
          <div class="kyc-limits">
            <p>Daily Limit: <strong>$<span id="daily-limit">50</span></strong></p>
            <p>Used Today: <strong>$<span id="daily-used">0</span></strong></p>
          </div>
          <button class="secondary-btn" onclick="openModal('kyc-upgrade')">Upgrade Limits</button>
        </div>
      </div>

      <!-- Recent Payouts -->
      <div class="section-card">
        <div class="card-header">
          <h3>üìã Recent Payouts</h3>
        </div>
        <div class="payouts-list" id="payouts-list">
          <div class="empty-state">No payouts yet</div>
        </div>
      </div>

      <!-- Gift Card Redemptions -->
      <div class="section-card">
        <div class="card-header">
          <h3>üéüÔ∏è My Gift Cards</h3>
        </div>
        <div class="gift-cards-list" id="gift-cards-list">
          <div class="empty-state">No gift cards redeemed</div>
        </div>
      </div>
    </section>

    <!-- ========== TAB: SETTINGS ========== -->
    <section class="tab-content" id="tab-settings">
      <!-- Profile Settings -->
      <div class="section-card">
        <div class="card-header">
          <h3>üë§ Profile</h3>
        </div>
        <form id="profile-form" class="settings-form">
          <div class="form-group">
            <label>Username</label>
            <input type="text" name="username" id="settings-username" placeholder="Enter username">
          </div>
          <div class="form-group">
            <label>Bio</label>
            <textarea name="bio" id="settings-bio" rows="3" placeholder="Tell your story..."></textarea>
          </div>
          <div class="form-group">
            <label>Location</label>
            <input type="text" name="location" id="settings-location" placeholder="City, Country">
          </div>
          <button type="submit" class="primary-btn">Save Profile</button>
        </form>
      </div>

      <!-- Notification Settings -->
      <div class="section-card">
        <div class="card-header">
          <h3>üîî Notifications</h3>
        </div>
        <form id="notification-settings-form" class="settings-form">
          <p class="form-description">Choose which notifications you want to receive.</p>

          <div class="toggle-group">
            <label class="toggle-row">
              <span>‚ö° XP & Level Updates</span>
              <input type="checkbox" name="notify_xp" checked>
              <span class="toggle-switch"></span>
            </label>
            <label class="toggle-row">
              <span>üéÅ NFT Rewards</span>
              <input type="checkbox" name="notify_nft" checked>
              <span class="toggle-switch"></span>
            </label>
            <label class="toggle-row">
              <span>üìÅ Project Updates</span>
              <input type="checkbox" name="notify_project" checked>
              <span class="toggle-switch"></span>
            </label>
            <label class="toggle-row">
              <span>üó≥Ô∏è Governance</span>
              <input type="checkbox" name="notify_governance" checked>
              <span class="toggle-switch"></span>
            </label>
            <label class="toggle-row">
              <span>üí∞ Wallet & Payouts</span>
              <input type="checkbox" name="notify_payout" checked>
              <span class="toggle-switch"></span>
            </label>
            <label class="toggle-row">
              <span>üë• Social</span>
              <input type="checkbox" name="notify_social" checked>
              <span class="toggle-switch"></span>
            </label>
            <label class="toggle-row">
              <span>‚≠ê Achievements</span>
              <input type="checkbox" name="notify_achievement" checked>
              <span class="toggle-switch"></span>
            </label>
          </div>

          <div class="form-divider"></div>

          <div class="form-group">
            <label>Email Notifications</label>
            <select name="email_frequency" id="email-frequency">
              <option value="never">Disabled</option>
              <option value="instant">Instant</option>
              <option value="daily">Daily Digest</option>
              <option value="weekly">Weekly Summary</option>
            </select>
          </div>

          <div class="form-group" id="email-address-group" style="display: none;">
            <label>Email Address</label>
            <input type="email" name="email_address" id="settings-email" placeholder="your@email.com">
          </div>

          <button type="submit" class="primary-btn">Save Notifications</button>
        </form>
      </div>

      <!-- Privacy Settings -->
      <div class="section-card">
        <div class="card-header">
          <h3>üîí Privacy</h3>
        </div>
        <form id="privacy-form" class="settings-form">
          <div class="toggle-group">
            <label class="toggle-row">
              <span>Profile Visible</span>
              <input type="checkbox" name="profile_visible" checked>
              <span class="toggle-switch"></span>
            </label>
            <label class="toggle-row">
              <span>Show Activity Feed</span>
              <input type="checkbox" name="activity_visible" checked>
              <span class="toggle-switch"></span>
            </label>
            <label class="toggle-row">
              <span>Show NFT Collection</span>
              <input type="checkbox" name="nfts_visible" checked>
              <span class="toggle-switch"></span>
            </label>
          </div>
          <button type="submit" class="primary-btn">Save Privacy</button>
        </form>
      </div>

      <!-- Payout Settings -->
      <div class="section-card">
        <div class="card-header">
          <h3>üí≥ Payout Settings</h3>
        </div>
        <form id="payout-settings-form" class="settings-form">
          <div class="form-group">
            <label>Preferred Method</label>
            <select name="preferred_method" id="payout-method">
              <option value="gift_card">Gift Cards</option>
              <option value="mobile_money">Mobile Money</option>
              <option value="crypto">Crypto (SOL)</option>
            </select>
          </div>

          <div id="mobile-money-settings" style="display: none;">
            <div class="form-group">
              <label>Provider</label>
              <select name="mobile_provider">
                <option value="mpesa">M-Pesa</option>
                <option value="airtel_money">Airtel Money</option>
                <option value="mtn_momo">MTN MoMo</option>
              </select>
            </div>
            <div class="form-group">
              <label>Phone Number</label>
              <input type="tel" name="mobile_phone" placeholder="+254...">
            </div>
          </div>

          <div id="crypto-settings" style="display: none;">
            <div class="form-group">
              <label>Wallet Address</label>
              <input type="text" name="crypto_wallet" id="crypto-wallet" placeholder="Solana wallet address">
              <button type="button" class="text-btn" onclick="useConnectedWallet()">Use Connected Wallet</button>
            </div>
          </div>

          <button type="submit" class="primary-btn">Save Payout Settings</button>
        </form>
      </div>

      <!-- Data Export -->
      <div class="section-card">
        <div class="card-header">
          <h3>üì• Data Export</h3>
        </div>
        <p class="form-description">Download a copy of your data.</p>
        <div class="export-buttons">
          <button class="secondary-btn" onclick="exportData('profile')">Export Profile</button>
          <button class="secondary-btn" onclick="exportData('activity')">Export Activity</button>
          <button class="secondary-btn" onclick="exportData('all')">Export All</button>
        </div>
      </div>
    </section>

  </div>
</div>

<!-- ========== MODALS ========== -->
<div class="modal-overlay" id="modal-overlay" style="display: none;">
  <div class="modal" id="modal-container">
    <div class="modal-header">
      <h3 id="modal-title">Modal</h3>
      <button class="close-btn" onclick="closeModal()">√ó</button>
    </div>
    <div class="modal-body" id="modal-body">
      <!-- Dynamic content -->
    </div>
  </div>
</div>

</BaseLayout>

<style>
/* ========== CSS Variables ========== */
:root {
  --primary: #10b981;
  --primary-dark: #059669;
  --secondary: #6366f1;
  --warning: #f59e0b;
  --danger: #ef4444;
  --bg: #0a0a0f;
  --bg-card: #111118;
  --bg-elevated: #1a1a24;
  --border: #2a2a3a;
  --text: #e5e5e5;
  --text-muted: #888;
  --radius: 12px;
  --radius-sm: 8px;
}

/* ========== Base ========== */
.profile-page {
  min-height: 100vh;
  background: var(--bg);
  color: var(--text);
  padding: 1rem;
}

.container {
  max-width: 900px;
  margin: 0 auto;
}

/* ========== Header ========== */
.profile-header {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1.5rem;
  background: var(--bg-card);
  border-radius: var(--radius);
  margin-bottom: 1rem;
  position: relative;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex: 1;
}

.avatar {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
}

.username {
  font-size: 1.25rem;
  font-weight: 600;
  margin: 0;
}

.wallet-id {
  font-size: 0.75rem;
  color: var(--text-muted);
  font-family: monospace;
}

.level-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
  background: var(--primary);
  color: #000;
  padding: 0.25rem 0.5rem;
  border-radius: 999px;
  font-size: 0.75rem;
  font-weight: 600;
  margin-top: 0.25rem;
}

.xp-progress {
  width: 200px;
}

.xp-info {
  display: flex;
  justify-content: space-between;
  font-size: 0.75rem;
  margin-bottom: 0.25rem;
}

.xp-current {
  color: var(--primary);
  font-weight: 600;
}

.xp-next {
  color: var(--text-muted);
}

.xp-bar {
  height: 6px;
  background: var(--border);
  border-radius: 3px;
  overflow: hidden;
}

.xp-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
  transition: width 0.3s;
}

.notification-bell {
  position: relative;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 50%;
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 1.25rem;
}

.notification-count {
  position: absolute;
  top: -4px;
  right: -4px;
  background: var(--danger);
  color: #fff;
  font-size: 0.65rem;
  font-weight: 600;
  min-width: 18px;
  height: 18px;
  border-radius: 999px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ========== Notification Panel ========== */
.notification-panel {
  position: fixed;
  top: 0;
  right: -400px;
  width: 400px;
  max-width: 100vw;
  height: 100vh;
  background: var(--bg-card);
  border-left: 1px solid var(--border);
  z-index: 1000;
  transition: right 0.3s;
  display: flex;
  flex-direction: column;
}

.notification-panel.open {
  right: 0;
}

.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem;
  border-bottom: 1px solid var(--border);
}

.panel-header h3 {
  margin: 0;
}

.panel-actions {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.notification-filters {
  display: flex;
  gap: 0.5rem;
  padding: 0.75rem 1rem;
  border-bottom: 1px solid var(--border);
  overflow-x: auto;
}

.filter-btn {
  padding: 0.25rem 0.75rem;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 999px;
  color: var(--text-muted);
  font-size: 0.75rem;
  cursor: pointer;
  white-space: nowrap;
}

.filter-btn.active {
  background: var(--primary);
  border-color: var(--primary);
  color: #000;
}

.notification-list {
  flex: 1;
  overflow-y: auto;
  padding: 0.5rem;
}

.notification-item {
  display: flex;
  gap: 0.75rem;
  padding: 0.75rem;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: background 0.2s;
}

.notification-item:hover {
  background: var(--bg-elevated);
}

.notification-item.unread {
  background: rgba(16, 185, 129, 0.1);
}

.notification-item .icon {
  font-size: 1.25rem;
}

.notification-item .content {
  flex: 1;
  min-width: 0;
}

.notification-item .title {
  font-weight: 500;
  margin-bottom: 0.25rem;
}

.notification-item .message {
  font-size: 0.85rem;
  color: var(--text-muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.notification-item .time {
  font-size: 0.7rem;
  color: var(--text-muted);
  margin-top: 0.25rem;
}

/* ========== Tab Navigation ========== */
.tab-nav {
  display: flex;
  gap: 0.5rem;
  padding: 0.5rem;
  background: var(--bg-card);
  border-radius: var(--radius);
  margin-bottom: 1rem;
  overflow-x: auto;
}

.tab-btn {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.25rem;
  padding: 0.75rem 0.5rem;
  background: transparent;
  border: none;
  border-radius: var(--radius-sm);
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  min-width: 70px;
}

.tab-btn:hover {
  background: var(--bg-elevated);
  color: var(--text);
}

.tab-btn.active {
  background: var(--primary);
  color: #000;
}

.tab-icon {
  font-size: 1.25rem;
}

.tab-label {
  font-size: 0.7rem;
  font-weight: 500;
}

.tab-badge {
  position: absolute;
  top: 4px;
  right: 4px;
  background: var(--danger);
  color: #fff;
  font-size: 0.6rem;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ========== Tab Content ========== */
.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

/* ========== Cards & Sections ========== */
.section-card {
  background: var(--bg-card);
  border-radius: var(--radius);
  padding: 1rem;
  margin-bottom: 1rem;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.card-header h3 {
  margin: 0;
  font-size: 1rem;
}

.highlight-card {
  border: 1px solid var(--primary);
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), transparent);
}

/* ========== Stats Grid ========== */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 0.75rem;
  margin-bottom: 1rem;
}

.stat-card {
  background: var(--bg-card);
  border-radius: var(--radius);
  padding: 1rem;
  text-align: center;
}

.stat-icon {
  font-size: 1.5rem;
  margin-bottom: 0.5rem;
}

.stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--primary);
}

.stat-label {
  font-size: 0.7rem;
  color: var(--text-muted);
  text-transform: uppercase;
}

/* ========== Quick Actions ========== */
.quick-actions {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 0.5rem;
}

.action-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.25rem;
  padding: 0.75rem;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  cursor: pointer;
  font-size: 0.75rem;
  transition: all 0.2s;
}

.action-btn:hover {
  border-color: var(--primary);
  background: rgba(16, 185, 129, 0.1);
}

.action-btn span:first-child {
  font-size: 1.25rem;
}

/* ========== Streak Card ========== */
.streak-card {
  text-align: center;
}

.streak-display {
  display: flex;
  align-items: baseline;
  justify-content: center;
  gap: 0.25rem;
  margin-bottom: 0.5rem;
}

.streak-count {
  font-size: 3rem;
  font-weight: 700;
  color: var(--warning);
}

.streak-label {
  font-size: 1rem;
  color: var(--text-muted);
}

.streak-message {
  color: var(--text-muted);
  margin-bottom: 1rem;
}

/* ========== Sub-tabs ========== */
.sub-tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
  border-bottom: 1px solid var(--border);
  padding-bottom: 0.5rem;
}

.sub-tab {
  padding: 0.5rem 1rem;
  background: transparent;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  border-radius: var(--radius-sm);
  font-size: 0.85rem;
}

.sub-tab.active {
  background: var(--bg-elevated);
  color: var(--text);
}

.sub-content {
  display: none;
}

.sub-content.active {
  display: block;
}

/* ========== Balances Grid ========== */
.balances-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0.75rem;
  margin-bottom: 1rem;
}

.balance-card {
  background: var(--bg-card);
  border-radius: var(--radius);
  padding: 1rem;
}

.balance-card.primary {
  grid-column: span 2;
  background: linear-gradient(135deg, var(--primary-dark), var(--primary));
  color: #000;
}

.balance-label {
  font-size: 0.75rem;
  opacity: 0.8;
  margin-bottom: 0.25rem;
}

.balance-value {
  font-size: 1.5rem;
  font-weight: 700;
}

.balance-card.primary .balance-value {
  font-size: 2rem;
}

.balance-usd {
  font-size: 0.85rem;
  opacity: 0.8;
}

/* ========== Cash Out Options ========== */
.cashout-options {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.75rem;
}

.cashout-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
  padding: 1rem;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text);
  cursor: pointer;
  transition: all 0.2s;
}

.cashout-btn:hover {
  border-color: var(--primary);
  transform: translateY(-2px);
}

.cashout-btn .icon {
  font-size: 1.5rem;
}

.cashout-btn .label {
  font-weight: 600;
}

.cashout-btn .desc {
  font-size: 0.7rem;
  color: var(--text-muted);
}

/* ========== Forms ========== */
.settings-form {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.form-group label {
  font-size: 0.8rem;
  font-weight: 500;
}

.form-group input,
.form-group select,
.form-group textarea {
  padding: 0.75rem;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-size: 0.9rem;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--primary);
}

.form-description {
  font-size: 0.85rem;
  color: var(--text-muted);
  margin-bottom: 0.5rem;
}

.form-divider {
  height: 1px;
  background: var(--border);
  margin: 0.5rem 0;
}

/* ========== Toggle Rows ========== */
.toggle-group {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.toggle-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem 0;
  cursor: pointer;
}

.toggle-row input {
  display: none;
}

.toggle-switch {
  width: 44px;
  height: 24px;
  background: var(--border);
  border-radius: 12px;
  position: relative;
  transition: background 0.2s;
}

.toggle-switch::after {
  content: '';
  position: absolute;
  top: 2px;
  left: 2px;
  width: 20px;
  height: 20px;
  background: #fff;
  border-radius: 50%;
  transition: transform 0.2s;
}

.toggle-row input:checked + .toggle-switch {
  background: var(--primary);
}

.toggle-row input:checked + .toggle-switch::after {
  transform: translateX(20px);
}

/* ========== Buttons ========== */
.primary-btn {
  padding: 0.75rem 1.5rem;
  background: var(--primary);
  border: none;
  border-radius: var(--radius-sm);
  color: #000;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.primary-btn:hover {
  background: var(--primary-dark);
}

.secondary-btn {
  padding: 0.75rem 1.5rem;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  cursor: pointer;
  transition: all 0.2s;
}

.secondary-btn:hover {
  border-color: var(--primary);
  color: var(--primary);
}

.text-btn {
  background: none;
  border: none;
  color: var(--primary);
  cursor: pointer;
  font-size: 0.85rem;
}

.text-btn:hover {
  text-decoration: underline;
}

.close-btn {
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 1.5rem;
  cursor: pointer;
  line-height: 1;
}

/* ========== Modal ========== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1001;
  padding: 1rem;
}

.modal {
  background: var(--bg-card);
  border-radius: var(--radius);
  width: 100%;
  max-width: 500px;
  max-height: 90vh;
  overflow: auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem;
  border-bottom: 1px solid var(--border);
}

.modal-header h3 {
  margin: 0;
}

.modal-body {
  padding: 1rem;
}

/* ========== Utilities ========== */
.loading {
  text-align: center;
  color: var(--text-muted);
  padding: 2rem;
}

.empty-state {
  text-align: center;
  color: var(--text-muted);
  padding: 2rem;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.section-header h3 {
  margin: 0;
}

/* ========== Responsive ========== */
@media (max-width: 768px) {
  .profile-header {
    flex-wrap: wrap;
  }

  .xp-progress {
    width: 100%;
    order: 3;
    margin-top: 1rem;
  }

  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }

  .quick-actions {
    grid-template-columns: repeat(2, 1fr);
  }

  .balances-grid {
    grid-template-columns: 1fr;
  }

  .balance-card.primary {
    grid-column: span 1;
  }

  .cashout-options {
    grid-template-columns: 1fr;
  }

  .notification-panel {
    width: 100%;
    right: -100%;
  }
}
</style>

<script>
// ========== Profile Manager ==========
class ProfileManager {
  constructor() {
    this.wallet = null;
    this.userData = null;
    this.notifications = [];
    this.currentTab = 'dashboard';
  }

  async init() {
    this.wallet = window.walletManager?.connectedWallet;
    if (!this.wallet) {
      // Wait for wallet connection
      document.addEventListener('walletConnected', () => {
        this.wallet = window.walletManager?.connectedWallet;
        this.loadData();
      });
      return;
    }
    await this.loadData();
    this.setupEventListeners();
  }

  async loadData() {
    if (!this.wallet) return;

    // Load in parallel
    await Promise.all([
      this.loadProfile(),
      this.loadNotifications(),
      this.loadDashboardData()
    ]);
  }

  async loadProfile() {
    try {
      const res = await fetch(`/api/profile/get?walletAddress=${this.wallet}`);
      const data = await res.json();
      if (data.success) {
        this.userData = data.profile;
        this.updateProfileUI();
      }
    } catch (e) {
      console.error('Failed to load profile:', e);
    }
  }

  async loadNotifications() {
    try {
      const res = await fetch(`/api/notifications?walletAddress=${this.wallet}`);
      const data = await res.json();
      if (data.success) {
        this.notifications = data.notifications;
        this.updateNotificationsUI(data);
      }
    } catch (e) {
      console.error('Failed to load notifications:', e);
    }
  }

  async loadDashboardData() {
    // Load rewards eligibility
    try {
      const res = await fetch(`/api/nft/rewards/check-eligibility?walletAddress=${this.wallet}`);
      const data = await res.json();
      if (data.success && data.rewards.eligible.length > 0) {
        document.getElementById('rewards-badge').style.display = 'flex';
      }
    } catch (e) {}

    // Load wallet data
    try {
      const res = await fetch(`/api/payout/settings?walletAddress=${this.wallet}`);
      const data = await res.json();
      if (data.success) {
        this.updateWalletUI(data);
      }
    } catch (e) {}

    // Load streak
    try {
      const res = await fetch(`/api/data/health/log?walletAddress=${this.wallet}`);
      const data = await res.json();
      if (data.success) {
        document.getElementById('streak-count').textContent = data.streak || 0;
        document.getElementById('streak-message').textContent = data.message;
      }
    } catch (e) {}
  }

  updateProfileUI() {
    if (!this.userData) return;
    const { username, wallet_address, xp, level } = this.userData;

    document.getElementById('username').textContent = username || 'Anonymous';
    document.getElementById('wallet-id').textContent =
      wallet_address ? `${wallet_address.slice(0, 4)}...${wallet_address.slice(-4)}` : '----';
    document.getElementById('user-level').textContent = level || 1;
    document.getElementById('current-xp').textContent = xp || 0;
    document.getElementById('stat-xp').textContent = xp || 0;

    // Calculate XP bar
    const currentLevel = level || 1;
    const xpForLevel = (currentLevel - 1) ** 2 * 100;
    const xpForNext = currentLevel ** 2 * 100;
    const progress = ((xp - xpForLevel) / (xpForNext - xpForLevel)) * 100;
    document.getElementById('xp-bar').style.width = `${Math.min(100, progress)}%`;
    document.getElementById('xp-to-next').textContent = xpForNext;

    // Settings form
    document.getElementById('settings-username').value = username || '';
    document.getElementById('settings-bio').value = this.userData.bio || '';
    document.getElementById('settings-location').value = this.userData.location || '';
  }

  updateNotificationsUI(data) {
    const { notifications, totalUnread, unreadCounts } = data;

    // Update bell badge
    const countEl = document.getElementById('notification-count');
    if (totalUnread > 0) {
      countEl.textContent = totalUnread > 99 ? '99+' : totalUnread;
      countEl.style.display = 'flex';
    } else {
      countEl.style.display = 'none';
    }

    // Update notification list
    const listEl = document.getElementById('notification-list');
    if (notifications.length === 0) {
      listEl.innerHTML = '<div class="empty-state">No notifications</div>';
      return;
    }

    listEl.innerHTML = notifications.map(n => `
      <div class="notification-item ${n.is_read ? '' : 'unread'}" data-id="${n.id}">
        <span class="icon">${n.icon}</span>
        <div class="content">
          <div class="title">${n.title}</div>
          ${n.message ? `<div class="message">${n.message}</div>` : ''}
          <div class="time">${this.timeAgo(n.created_at)}</div>
        </div>
      </div>
    `).join('');

    // Also update recent activity on dashboard
    const activityEl = document.getElementById('recent-activity');
    const recent = notifications.slice(0, 5);
    if (recent.length > 0) {
      activityEl.innerHTML = recent.map(n => `
        <div class="notification-item ${n.is_read ? '' : 'unread'}">
          <span class="icon">${n.icon}</span>
          <div class="content">
            <div class="title">${n.title}</div>
            <div class="time">${this.timeAgo(n.created_at)}</div>
          </div>
        </div>
      `).join('');
    }
  }

  updateWalletUI(data) {
    const { balance, limits, usage } = data;

    document.getElementById('xp-balance').textContent = balance?.xp_balance || 0;
    document.getElementById('xp-usd-value').textContent = ((balance?.xp_balance || 0) * 0.001).toFixed(2);
    document.getElementById('usd-balance').textContent = (balance?.usd_balance || 0).toFixed(2);
    document.getElementById('sol-balance').textContent = (balance?.sol_balance || 0).toFixed(4);
    document.getElementById('royalties-balance').textContent = (balance?.pending_royalties || 0).toFixed(2);

    document.getElementById('kyc-level-badge').textContent = `Level ${data.kycStatus?.level || 0}`;
    document.getElementById('kyc-level-name').textContent = data.kycStatus?.levelName || 'None';
    document.getElementById('daily-limit').textContent = limits?.daily_limit_usd || 50;
    document.getElementById('daily-used').textContent = (usage?.todayTotal || 0).toFixed(2);
  }

  timeAgo(date) {
    const seconds = Math.floor((new Date() - new Date(date)) / 1000);
    if (seconds < 60) return 'just now';
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
    return `${Math.floor(seconds / 86400)}d ago`;
  }

  setupEventListeners() {
    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        this.switchTab(tab);
      });
    });

    // Sub-tab switching
    document.querySelectorAll('.sub-tab').forEach(btn => {
      btn.addEventListener('click', () => {
        const subtab = btn.dataset.subtab;
        document.querySelectorAll('.sub-tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.sub-content').forEach(c => c.classList.remove('active'));
        document.getElementById(`subtab-${subtab}`).classList.add('active');
      });
    });

    // Notification filters
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        this.filterNotifications(btn.dataset.filter);
      });
    });

    // Forms
    document.getElementById('profile-form')?.addEventListener('submit', (e) => {
      e.preventDefault();
      this.saveProfile();
    });

    document.getElementById('notification-settings-form')?.addEventListener('submit', (e) => {
      e.preventDefault();
      this.saveNotificationSettings();
    });

    document.getElementById('payout-settings-form')?.addEventListener('submit', (e) => {
      e.preventDefault();
      this.savePayoutSettings();
    });

    // Payout method change
    document.getElementById('payout-method')?.addEventListener('change', (e) => {
      document.getElementById('mobile-money-settings').style.display =
        e.target.value === 'mobile_money' ? 'block' : 'none';
      document.getElementById('crypto-settings').style.display =
        e.target.value === 'crypto' ? 'block' : 'none';
    });

    // Email frequency change
    document.getElementById('email-frequency')?.addEventListener('change', (e) => {
      document.getElementById('email-address-group').style.display =
        e.target.value !== 'never' ? 'block' : 'none';
    });
  }

  switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');
    this.currentTab = tab;

    // Load tab-specific data
    if (tab === 'rewards') this.loadRewardsData();
    if (tab === 'wallet') this.loadWalletData();
    if (tab === 'work') this.loadWorkData();
  }

  async loadRewardsData() {
    const container = document.getElementById('claimable-rewards');
    try {
      const res = await fetch(`/api/nft/rewards/check-eligibility?walletAddress=${this.wallet}`);
      const data = await res.json();
      if (data.success) {
        if (data.rewards.eligible.length > 0) {
          container.innerHTML = data.rewards.eligible.map(r => `
            <div class="reward-item">
              <span class="reward-name">${r.name}</span>
              <span class="reward-rarity">${r.rarityTier}</span>
              <button class="primary-btn" onclick="profileManager.claimReward('${r.ruleId}')">Claim</button>
            </div>
          `).join('');
        } else {
          container.innerHTML = '<div class="empty-state">No rewards to claim right now. Keep contributing!</div>';
        }
      }
    } catch (e) {
      container.innerHTML = '<div class="empty-state">Failed to load rewards</div>';
    }
  }

  async loadWalletData() {
    // Already loaded in loadDashboardData, but can refresh here
  }

  async loadWorkData() {
    // Load projects
    try {
      const res = await fetch(`/api/user-projects/list?walletAddress=${this.wallet}`);
      const data = await res.json();
      const container = document.getElementById('my-projects-list');
      if (data.success && data.projects.length > 0) {
        container.innerHTML = data.projects.map(p => `
          <div class="project-item">
            <h4>${p.title}</h4>
            <span class="status">${p.visibility}</span>
            <a href="/projects/${p.slug}">View ‚Üí</a>
          </div>
        `).join('');
        document.getElementById('stat-projects').textContent = data.projects.length;
      } else {
        container.innerHTML = '<div class="empty-state">No projects yet</div>';
      }
    } catch (e) {}
  }

  async saveProfile() {
    const form = document.getElementById('profile-form');
    const formData = new FormData(form);

    try {
      const res = await fetch('/api/profile/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          walletAddress: this.wallet,
          username: formData.get('username'),
          bio: formData.get('bio'),
          location: formData.get('location')
        })
      });
      const data = await res.json();
      if (data.success) {
        alert('Profile saved!');
      }
    } catch (e) {
      alert('Failed to save profile');
    }
  }

  async saveNotificationSettings() {
    const form = document.getElementById('notification-settings-form');
    const formData = new FormData(form);

    try {
      await fetch('/api/notifications/preferences', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          walletAddress: this.wallet,
          notifyXp: form.querySelector('[name="notify_xp"]').checked,
          notifyNft: form.querySelector('[name="notify_nft"]').checked,
          notifyProject: form.querySelector('[name="notify_project"]').checked,
          notifyGovernance: form.querySelector('[name="notify_governance"]').checked,
          notifyPayout: form.querySelector('[name="notify_payout"]').checked,
          notifySocial: form.querySelector('[name="notify_social"]').checked,
          notifyAchievement: form.querySelector('[name="notify_achievement"]').checked,
          emailFrequency: formData.get('email_frequency'),
          emailAddress: formData.get('email_address')
        })
      });
      alert('Notification settings saved!');
    } catch (e) {
      alert('Failed to save settings');
    }
  }

  async savePayoutSettings() {
    const form = document.getElementById('payout-settings-form');
    const formData = new FormData(form);

    try {
      await fetch('/api/payout/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          walletAddress: this.wallet,
          preferredMethod: formData.get('preferred_method'),
          mobileMoneyProvider: formData.get('mobile_provider'),
          mobileMoneyPhone: formData.get('mobile_phone'),
          cryptoWalletAddress: formData.get('crypto_wallet')
        })
      });
      alert('Payout settings saved!');
    } catch (e) {
      alert('Failed to save settings');
    }
  }

  filterNotifications(filter) {
    // Filter notification list
    const items = document.querySelectorAll('.notification-item');
    items.forEach(item => {
      if (filter === 'all') {
        item.style.display = 'flex';
      } else {
        const notif = this.notifications.find(n => n.id == item.dataset.id);
        item.style.display = notif?.category === filter ? 'flex' : 'none';
      }
    });
  }

  async claimReward(ruleId) {
    try {
      const res = await fetch('/api/nft/rewards/claim', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ walletAddress: this.wallet, ruleId })
      });
      const data = await res.json();
      if (data.success) {
        alert(data.message);
        this.loadRewardsData();
      } else {
        alert(data.error);
      }
    } catch (e) {
      alert('Failed to claim reward');
    }
  }
}

// Global functions
function toggleNotificationPanel() {
  document.getElementById('notification-panel').classList.toggle('open');
}

async function markAllRead() {
  if (!profileManager.wallet) return;
  await fetch('/api/notifications', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: 'markRead', walletAddress: profileManager.wallet })
  });
  profileManager.loadNotifications();
}

function switchTab(tab) {
  profileManager.switchTab(tab);
}

function openModal(type, subtype) {
  const modal = document.getElementById('modal-overlay');
  const title = document.getElementById('modal-title');
  const body = document.getElementById('modal-body');

  modal.style.display = 'flex';

  // Set content based on type
  switch (type) {
    case 'new-project':
      title.textContent = 'Create New Project';
      body.innerHTML = `<p>Project creation form coming soon...</p>`;
      break;
    case 'submit-data':
      title.textContent = 'Submit Data';
      body.innerHTML = `<p>Data submission form coming soon...</p>`;
      break;
    case 'payout':
      title.textContent = 'Cash Out';
      body.innerHTML = `<p>Payout form for ${subtype} coming soon...</p>`;
      break;
    default:
      title.textContent = 'Modal';
      body.innerHTML = '';
  }
}

function closeModal() {
  document.getElementById('modal-overlay').style.display = 'none';
}

function useConnectedWallet() {
  const wallet = window.walletManager?.connectedWallet;
  if (wallet) {
    document.getElementById('crypto-wallet').value = wallet;
  }
}

function exportData(type) {
  alert(`Exporting ${type} data...`);
}

// Initialize
const profileManager = new ProfileManager();
document.addEventListener('DOMContentLoaded', () => profileManager.init());
</script>
