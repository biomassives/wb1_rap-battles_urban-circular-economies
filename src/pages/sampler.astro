---
import BioSampler from "../components/BioSampler.astro";
import taxonomy from "/public/data/seed.json";
---

<!-- MIDI Parser Library -->
<script is:inline src="https://unpkg.com/@tonejs/midi@2.0.28/build/Midi.js"></script>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bio Sampler Pad Bank | Worldbridger One</title>

  <style>
    :root {
      --bg: #0e1117;
      --panel: #161b22;
      --text: #e6edf3;
      --muted: #8b949e;
      --accent: #58a6ff;
      --success: #10b981;
      --warning: #f59e0b;
      --purple: #7c3aed;
      --danger: #ef4444;
      --drum-color: #ff6b6b;
      --bass-color: #4ecdc4;
      --synth-color: #a78bfa;
      --horn-color: #f4a261;
      --vibes-color: #2a9d8f;
      --sax-color: #e76f51;
      --ocean-color: #264653;
      --forest-color: #52b788;
      --river-color: #48cae4;
      --mountain-color: #8d99ae;
      --radius: 10px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 2rem;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      overflow-x: hidden;
      user-select: none;
    }

    main {
      max-width: 1600px;
      margin: auto;
    }

    .header {
      text-align: center;
      margin-bottom: 2rem;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, #58a6ff, #7c3aed);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      color: var(--muted);
      font-size: 1.125rem;
    }

    .controls-bar {
      background: var(--panel);
      border-radius: var(--radius);
      padding: 1rem 1.5rem;
      margin-bottom: 2rem;
      display: flex;
      gap: 1rem;
      align-items: center;
      justify-content: space-between;
      border: 1px solid #30363d;
      flex-wrap: wrap;
    }

    .controls-group {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .mode-toggle {
      background: linear-gradient(135deg, #2a2e35, #1a1d23);
      border: 2px solid #30363d;
      border-radius: 8px;
      display: flex;
      padding: 0.25rem;
    }

    .mode-btn {
      padding: 0.5rem 1.25rem;
      border: none;
      background: transparent;
      color: var(--muted);
      font-weight: 600;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
      font-size: 0.95rem;
    }

    .mode-btn.active {
      background: linear-gradient(135deg, #58a6ff, #4a9eff);
      color: #000;
      box-shadow: 0 2px 8px rgba(88, 166, 255, 0.4);
    }

    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.95rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, #58a6ff, #4a9eff);
      color: #000;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(88, 166, 255, 0.4);
    }

    .btn-secondary {
      background: #30363d;
      color: var(--text);
      border: 1px solid #444c56;
    }

    .btn-secondary:hover {
      background: #3d444d;
      border-color: var(--accent);
    }

    .btn-danger {
      background: #da3633;
      color: white;
    }

    .btn-danger:hover {
      background: #c93330;
    }

    /* Master Controls */
    .master-controls {
      background: linear-gradient(135deg, #1a1f26 0%, #0d1117 100%);
      border: 2px solid #30363d;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      display: flex;
      gap: 2rem;
      align-items: center;
    }

    .master-fader {
      flex: 1;
      max-width: 300px;
    }

    .fader-label {
      font-size: 0.875rem;
      color: var(--muted);
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .fader-value {
      color: var(--accent);
      font-weight: 600;
      font-size: 1.125rem;
    }

    .fader-track {
      height: 8px;
      background: #0d1117;
      border-radius: 4px;
      position: relative;
      border: 1px solid #30363d;
      overflow: hidden;
    }

    .fader-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--purple));
      border-radius: 4px;
      transition: width 0.1s;
    }

    .fader-input {
      width: 100%;
      margin-top: 0.5rem;
      -webkit-appearance: none;
      appearance: none;
      background: transparent;
      cursor: pointer;
    }

    .fader-input::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      border: 2px solid #fff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
    }

    .fader-input::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      border: 2px solid #fff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
    }

    /* Sections */
    .section {
      margin-bottom: 2rem;
      background: var(--panel);
      border-radius: 12px;
      padding: 1.5rem;
      border: 2px solid #30363d;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #30363d;
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
      user-select: none;
    }

    .section-icon {
      font-size: 2rem;
    }

    .collapse-icon {
      font-size: 1.25rem;
      margin-left: 0.5rem;
      transition: transform 0.3s ease;
    }

    .section.collapsed .collapse-icon {
      transform: rotate(-90deg);
    }

    .section.collapsed .pad-bank {
      display: none;
    }

    .section.collapsed .section-fader {
      display: none;
    }

    .section.drums .section-title {
      color: var(--drum-color);
    }

    .section.bass .section-title {
      color: var(--bass-color);
    }

    .section.synth .section-title {
      color: var(--synth-color);
    }

    .section.horn .section-title {
      color: var(--horn-color);
    }

    .section.vibes .section-title {
      color: var(--vibes-color);
    }

    .section.sax .section-title {
      color: var(--sax-color);
    }

    .section.ocean .section-title {
      color: var(--ocean-color);
    }

    .section.forest .section-title {
      color: var(--forest-color);
    }

    .section.river .section-title {
      color: var(--river-color);
    }

    .section.mountain .section-title {
      color: var(--mountain-color);
    }

    .section-fader {
      display: flex;
      align-items: center;
      gap: 1rem;
      min-width: 200px;
    }

    .pad-bank {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      perspective: 1000px;
    }

    .pad-bank.compact {
      grid-template-columns: repeat(2, 1fr);
    }

    .pad {
      aspect-ratio: 1;
      background: linear-gradient(135deg, #1a1f26 0%, #0d1117 100%);
      border-radius: 12px;
      border: 2px solid #30363d;
      cursor: pointer;
      position: relative;
      transform-style: preserve-3d;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 0.5rem;
      touch-action: manipulation;
    }

    .pad::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(88, 166, 255, 0.1), rgba(124, 58, 237, 0.1));
      opacity: 0;
      transition: opacity 0.3s;
    }

    .section.drums .pad::before {
      background: linear-gradient(135deg, rgba(255, 107, 107, 0.2), rgba(255, 107, 107, 0.05));
    }

    .section.bass .pad::before {
      background: linear-gradient(135deg, rgba(78, 205, 196, 0.2), rgba(78, 205, 196, 0.05));
    }

    .section.synth .pad::before {
      background: linear-gradient(135deg, rgba(167, 139, 250, 0.2), rgba(167, 139, 250, 0.05));
    }

    .section.horn .pad::before {
      background: linear-gradient(135deg, rgba(244, 162, 97, 0.2), rgba(244, 162, 97, 0.05));
    }

    .section.vibes .pad::before {
      background: linear-gradient(135deg, rgba(42, 157, 143, 0.2), rgba(42, 157, 143, 0.05));
    }

    .section.sax .pad::before {
      background: linear-gradient(135deg, rgba(231, 111, 81, 0.2), rgba(231, 111, 81, 0.05));
    }

    .section.ocean .pad::before {
      background: linear-gradient(135deg, rgba(38, 70, 83, 0.3), rgba(38, 70, 83, 0.05));
    }

    .section.forest .pad::before {
      background: linear-gradient(135deg, rgba(82, 183, 136, 0.2), rgba(82, 183, 136, 0.05));
    }

    .section.river .pad::before {
      background: linear-gradient(135deg, rgba(72, 202, 228, 0.2), rgba(72, 202, 228, 0.05));
    }

    .section.mountain .pad::before {
      background: linear-gradient(135deg, rgba(141, 153, 174, 0.2), rgba(141, 153, 174, 0.05));
    }

    .pad:hover {
      transform: translateY(-8px) rotateX(5deg);
      box-shadow:
        0 12px 24px rgba(0, 0, 0, 0.4),
        0 0 0 1px rgba(88, 166, 255, 0.2),
        0 0 20px rgba(88, 166, 255, 0.2);
    }

    .pad:hover::before {
      opacity: 1;
    }

    body.edit-mode .pad:hover {
      border-color: var(--accent);
    }

    body.play-mode .pad:hover {
      border-color: var(--success);
    }

    .pad:active {
      transform: translateY(-4px) scale(0.98);
    }

    .pad.configured {
      background: linear-gradient(135deg, #1e3a5f 0%, #162840 100%);
      border-color: var(--accent);
    }

    .section.drums .pad.configured {
      background: linear-gradient(135deg, #3d2020 0%, #2d1515 100%);
      border-color: var(--drum-color);
    }

    .section.bass .pad.configured {
      background: linear-gradient(135deg, #1e3d3a 0%, #152d2a 100%);
      border-color: var(--bass-color);
    }

    .section.synth .pad.configured {
      background: linear-gradient(135deg, #2d2540 0%, #1d1530 100%);
      border-color: var(--synth-color);
    }

    .section.horn .pad.configured {
      background: linear-gradient(135deg, #3d2d1e 0%, #2d1f10 100%);
      border-color: var(--horn-color);
    }

    .section.vibes .pad.configured {
      background: linear-gradient(135deg, #1a3d38 0%, #0d2d28 100%);
      border-color: var(--vibes-color);
    }

    .section.sax .pad.configured {
      background: linear-gradient(135deg, #3d2420 0%, #2d1510 100%);
      border-color: var(--sax-color);
    }

    .section.ocean .pad.configured {
      background: linear-gradient(135deg, #1e2d33 0%, #0f1d23 100%);
      border-color: var(--ocean-color);
    }

    .section.forest .pad.configured {
      background: linear-gradient(135deg, #1e3d2d 0%, #0f2d1d 100%);
      border-color: var(--forest-color);
    }

    .section.river .pad.configured {
      background: linear-gradient(135deg, #1e3540 0%, #0f2530 100%);
      border-color: var(--river-color);
    }

    .section.mountain .pad.configured {
      background: linear-gradient(135deg, #2d3238 0%, #1d2228 100%);
      border-color: var(--mountain-color);
    }

    .pad.configured::after {
      content: '';
      position: absolute;
      top: 4px;
      right: 4px;
      width: 8px;
      height: 8px;
      background: var(--success);
      border-radius: 50%;
      box-shadow: 0 0 8px var(--success);
    }

    .pad.playing {
      animation: pulse 0.6s ease-in-out;
    }

    .section.drums .pad.playing {
      border-color: var(--drum-color);
      box-shadow: 0 12px 24px rgba(255, 107, 107, 0.6), 0 0 20px rgba(255, 107, 107, 0.8);
    }

    .section.bass .pad.playing {
      border-color: var(--bass-color);
      box-shadow: 0 12px 24px rgba(78, 205, 196, 0.6), 0 0 20px rgba(78, 205, 196, 0.8);
    }

    .section.synth .pad.playing {
      border-color: var(--synth-color);
      box-shadow: 0 12px 24px rgba(167, 139, 250, 0.6), 0 0 20px rgba(167, 139, 250, 0.8);
    }

    .pad.holding {
      animation: pulse-loop 0.8s ease-in-out infinite;
      border-width: 3px;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes pulse-loop {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.08); opacity: 0.9; }
    }

    /* Pad number styling moved above for better text glow effects */

    .pad-label {
      font-size: 0.7rem;
      color: rgba(139, 148, 158, 0.3); /* Muted by default */
      text-align: center;
      margin-top: 0.25rem;
      z-index: 1;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      transition: all 0.3s ease;
    }

    .pad:hover .pad-label,
    .pad.playing .pad-label {
      color: var(--text);
      text-shadow: 0 0 8px rgba(230, 237, 243, 0.5);
    }

    .pad.configured .pad-label {
      color: rgba(230, 237, 243, 0.7); /* Slightly visible when configured */
    }

    .pad.configured:hover .pad-label,
    .pad.configured.playing .pad-label {
      color: var(--text);
      text-shadow: 0 0 12px rgba(230, 237, 243, 0.8);
    }

    .pad-freq {
      font-size: 0.65rem;
      color: rgba(88, 166, 255, 0.3); /* Muted by default */
      margin-top: 0.125rem;
      z-index: 1;
      transition: all 0.3s ease;
    }

    .pad:hover .pad-freq,
    .pad.playing .pad-freq {
      color: var(--accent);
      text-shadow: 0 0 8px rgba(88, 166, 255, 0.6);
    }

    .pad-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: rgba(139, 148, 158, 0.4); /* Muted by default */
      z-index: 1;
      transition: all 0.3s ease;
    }

    .pad:hover .pad-number,
    .pad.playing .pad-number {
      color: var(--text);
      text-shadow: 0 0 12px currentColor;
    }

    .two-finger-effect {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }

    .pad.two-finger .two-finger-effect {
      opacity: 1;
      animation: spin 0.5s linear infinite;
    }

    @keyframes spin {
      from { transform: translate(-50%, -50%) rotate(0deg); }
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 2rem;
      overflow-y: auto;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg);
      border-radius: 16px;
      max-width: 950px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      border: 2px solid #30363d;
      box-shadow: 0 24px 48px rgba(0, 0, 0, 0.6);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      padding: 1.5rem 2rem;
      border-bottom: 1px solid #30363d;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #161b22 0%, #0d1117 100%);
      border-radius: 16px 16px 0 0;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text);
    }

    .modal-close {
      background: #30363d;
      border: none;
      color: var(--text);
      width: 36px;
      height: 36px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: #3d444d;
      color: #ff6b6b;
    }

    .modal-body {
      padding: 0;
    }

    .modal-actions {
      padding: 1.5rem 2rem;
      border-top: 1px solid #30363d;
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      background: var(--panel);
      border-radius: 0 0 16px 16px;
    }

    footer {
      text-align: center;
      color: var(--muted);
      font-size: 0.875rem;
      margin-top: 2rem;
      padding: 1rem;
    }

    .mode-indicator {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      border: 2px solid var(--accent);
      font-weight: 600;
      font-size: 0.875rem;
      z-index: 999;
      display: none;
    }

    body.play-mode .mode-indicator {
      display: block;
      border-color: var(--success);
      color: var(--success);
    }

    @media (max-width: 1200px) {
      .section-header {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
      }
    }

    /* Sequencer Styles */
    .sequencer-section {
      background: var(--panel);
      border: 2px solid #30363d;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .sequencer-section.collapsed {
      max-height: 0;
      padding: 0;
      margin: 0;
      border: none;
      opacity: 0;
    }

    .sequencer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .sequencer-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text);
    }

    .sequencer-controls {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .seq-btn {
      padding: 0.5rem 1rem;
      border: 2px solid #30363d;
      background: linear-gradient(135deg, #2a2e35, #1a1d23);
      color: var(--text);
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .seq-btn:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
    }

    .seq-btn.active {
      border-color: var(--success);
      box-shadow: 0 0 12px rgba(16, 185, 129, 0.3);
    }

    .record-btn.recording {
      background: linear-gradient(135deg, #da3633, #a82724);
      border-color: #da3633;
      animation: record-pulse 1s ease-in-out infinite;
    }

    @keyframes record-pulse {
      0%, 100% { box-shadow: 0 0 0 rgba(218, 54, 51, 0.4); }
      50% { box-shadow: 0 0 16px rgba(218, 54, 51, 0.8); }
    }

    .play-btn.playing {
      background: linear-gradient(135deg, #10b981, #059669);
      border-color: var(--success);
    }

    .loop-btn.active {
      color: var(--success);
    }

    .pattern-controls {
      display: flex;
      gap: 0.5rem;
    }

    .btn-sm {
      padding: 0.4rem 0.75rem;
      font-size: 0.85rem;
    }

    .timeline-container {
      background: #0d1117;
      border-radius: 8px;
      padding: 1rem;
      border: 1px solid #30363d;
    }

    .timeline-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .current-pattern-name {
      font-weight: 600;
      color: var(--accent);
      font-size: 1rem;
    }

    .timeline-position {
      font-family: 'Courier New', monospace;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .timeline {
      position: relative;
      height: 270px;
      background: #000;
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 0.5rem;
      cursor: crosshair;
    }

    .timeline:hover {
      box-shadow: inset 0 0 0 2px rgba(88, 166, 255, 0.3);
    }

    .timeline-note-preview {
      position: absolute;
      width: 8px;
      height: 14px;
      background: rgba(88, 166, 255, 0.5);
      border-radius: 2px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.1s;
    }

    .timeline:hover .timeline-note-preview {
      opacity: 1;
    }

    .timeline-grid {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
    }

    #notes-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .playhead {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--success);
      box-shadow: 0 0 8px var(--success);
      z-index: 10;
      pointer-events: none;
      left: 0;
    }

    .timeline-legend {
      display: flex;
      gap: 2rem;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .timeline-legend span {
      display: flex;
      gap: 0.5rem;
    }

    .timeline-legend span span {
      color: var(--accent);
      font-weight: 600;
    }

    @media (max-width: 1200px) {
      .sequencer-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    @media (max-width: 768px) {
      .pad-number {
        font-size: 1.2rem;
      }

      .pad-label {
        font-size: 0.6rem;
      }

      .sequencer-controls {
        flex-wrap: wrap;
      }

      .pattern-controls {
        width: 100%;
        justify-content: space-between;
      }
    }
  </style>
</head>

<body class="play-mode">
<main>
  <div class="header">
    <h1>üéõÔ∏è Bio Sampler Pad Bank</h1>
    <p class="subtitle">16 pressure-sensitive pads ‚Ä¢ Bio-inspired synthesis ‚Ä¢ Play-first design</p>
  </div>

  <div class="controls-bar">
    <div class="controls-group">
      <div class="mode-toggle">
        <button class="mode-btn" id="edit-mode-btn">‚úèÔ∏è Edit</button>
        <button class="mode-btn active" id="play-mode-btn">‚ñ∂Ô∏è Play</button>
      </div>
      <button class="btn btn-secondary" id="toggle-sequencer">üìä Sequencer</button>
      <button class="btn btn-secondary" id="load-pack">üì¶ Load Pack</button>
      <button class="btn btn-secondary" id="save-pack">üíæ Save Pack</button>
    </div>
    <div class="controls-group">
      <select id="pack-selector" style="padding: 0.5rem; background: var(--panel); border: 1px solid #30363d; color: var(--text); border-radius: 6px; font-size: 0.9rem;">
        <option value="default">Default Pack</option>
        <option value="custom">Custom Pack</option>
      </select>
    </div>
  </div>

  <div class="master-controls">
    <div class="master-fader">
      <div class="fader-label">
        <span>üéöÔ∏è Master Volume</span>
        <span class="fader-value" id="master-value">80%</span>
      </div>
      <div class="fader-track">
        <div class="fader-fill" id="master-fill" style="width: 80%"></div>
      </div>
      <input type="range" class="fader-input" id="master-fader" min="0" max="100" value="80" />
    </div>
  </div>

  <!-- Sequencer Section -->
  <div class="sequencer-section collapsed">
    <div class="sequencer-header">
      <div class="sequencer-title">
        <span style="font-size: 1.5rem;">üéº</span>
        <span style="font-size: 1.25rem; font-weight: 600;">Sequencer</span>
      </div>

      <div class="sequencer-controls">
        <button class="seq-btn record-btn" id="record-btn" title="Record (R)">
          <span class="record-icon">‚è∫</span> REC
        </button>
        <button class="seq-btn play-btn" id="play-seq-btn" title="Play/Pause (Space)">
          <span id="play-icon">‚ñ∂Ô∏è</span>
        </button>
        <button class="seq-btn" id="stop-btn" title="Stop">‚èπÔ∏è</button>
        <button class="seq-btn loop-btn active" id="loop-btn" title="Loop">üîÅ</button>
        <div class="tempo-control">
          <label style="font-size: 0.75rem; color: var(--muted);">BPM</label>
          <input type="number" id="tempo-input" min="60" max="200" value="120" style="width: 60px; padding: 0.25rem; background: #0d1117; border: 1px solid #30363d; color: var(--text); border-radius: 4px;" />
        </div>
      </div>

      <div class="pattern-controls">
        <select id="demo-track-selector" style="padding: 0.4rem 0.75rem; background: var(--panel); border: 1px solid #30363d; color: var(--text); border-radius: 6px; font-size: 0.85rem; margin-right: 0.5rem;">
          <option value="">Load Demo Track...</option>
          <option value="rap">üé§ Rap Beat</option>
          <option value="jazz">üé∑ Jazz Backing</option>
          <option value="blues">üé∏ Robert Johnson Blues</option>
          <option value="rock">ü§ò Rock Ballad</option>
        </select>
        <button class="btn btn-secondary btn-sm" id="save-pattern-btn">üíæ Save</button>
        <button class="btn btn-secondary btn-sm" id="save-as-btn">üìù Save As</button>
        <button class="btn btn-secondary btn-sm" id="load-pattern-btn">üìÇ Load</button>
        <button class="btn btn-secondary btn-sm" id="new-pattern-btn">‚ûï New</button>
        <button class="btn btn-secondary btn-sm" id="import-midi-btn" title="Import MIDI file">üì• MIDI</button>
      </div>
    </div>

    <div class="timeline-container">
      <div class="timeline-header">
        <span class="current-pattern-name" id="pattern-name">Untitled Pattern</span>
        <span class="timeline-position" id="timeline-pos">1.1.1</span>
      </div>
      <div class="timeline" id="timeline">
        <div class="playhead" id="playhead"></div>
        <div class="timeline-grid" id="timeline-grid"></div>
        <canvas id="notes-canvas" width="1600" height="270"></canvas>
      </div>
      <div class="timeline-legend">
        <span>Bar: <span id="current-bar">1</span>/16</span>
        <span>Beat: <span id="current-beat">1</span>/4</span>
      </div>
    </div>
  </div>

  <!-- 4x4 Pad Grid - Play First Design -->
  <div class="section main-grid">
    <div class="pad-bank" id="main-pad-bank" style="max-width: 900px; margin: 0 auto;">
      <!-- 16 pads in 4x4 grid will be created here -->
      <!-- Row 1: Drums (red) -->
      <!-- Row 2: Bass (cyan) -->
      <!-- Row 3: Melody (purple) -->
      <!-- Row 4: FX (orange) -->
    </div>
  </div>

  <!-- Category Legend -->
  <div style="display: flex; gap: 2rem; justify-content: center; margin-top: 1.5rem; flex-wrap: wrap;">
    <div style="display: flex; align-items: center; gap: 0.5rem;">
      <div style="width: 12px; height: 12px; background: var(--drum-color); border-radius: 50%;"></div>
      <span style="color: var(--muted); font-size: 0.9rem;">ü•Å Drums (1-4)</span>
    </div>
    <div style="display: flex; align-items: center; gap: 0.5rem;">
      <div style="width: 12px; height: 12px; background: var(--bass-color); border-radius: 50%;"></div>
      <span style="color: var(--muted); font-size: 0.9rem;">üé∏ Bass (5-8)</span>
    </div>
    <div style="display: flex; align-items: center; gap: 0.5rem;">
      <div style="width: 12px; height: 12px; background: var(--synth-color); border-radius: 50%;"></div>
      <span style="color: var(--muted); font-size: 0.9rem;">üéπ Melody (9-12)</span>
    </div>
    <div style="display: flex; align-items: center; gap: 0.5rem;">
      <div style="width: 12px; height: 12px; background: var(--horn-color); border-radius: 50%;"></div>
      <span style="color: var(--muted); font-size: 0.9rem;">‚ú® FX (13-16)</span>
    </div>
  </div>

  <footer>
    üß¨ Bio-inspired synthesis ‚Ä¢ All sounds generated locally ‚Ä¢ Hold pads for repeat ‚Ä¢ Two fingers for effect
  </footer>
</main>

<div class="mode-indicator">‚ñ∂Ô∏è PLAY MODE</div>

<!-- Save Pattern Modal -->
<div class="modal-overlay" id="save-modal">
  <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header">
      <h3 class="modal-title">Save Pattern</h3>
      <button class="modal-close" id="save-modal-close">√ó</button>
    </div>
    <div class="modal-body" style="padding: 2rem;">
      <label style="display: block; margin-bottom: 0.5rem; color: var(--muted);">Pattern Name</label>
      <input type="text" id="pattern-name-input" placeholder="My Awesome Beat" style="width: 100%; padding: 0.75rem; background: #0d1117; border: 1px solid #30363d; color: var(--text); border-radius: 6px; font-size: 1rem;" />
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" id="cancel-save">Cancel</button>
      <button class="btn btn-primary" id="confirm-save">Save Pattern</button>
    </div>
  </div>
</div>

<!-- Load Pattern Modal -->
<div class="modal-overlay" id="load-modal">
  <div class="modal-content" style="max-width: 600px;">
    <div class="modal-header">
      <h3 class="modal-title">Load Pattern</h3>
      <button class="modal-close" id="load-modal-close">√ó</button>
    </div>
    <div class="modal-body" style="padding: 1.5rem;">
      <div id="patterns-list" style="max-height: 400px; overflow-y: auto;"></div>
      <div id="no-patterns" style="text-align: center; padding: 2rem; color: var(--muted); display: none;">
        No saved patterns yet. Record something and save it!
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title" id="modal-title">Configure Pad 1</h3>
      <button class="modal-close" id="modal-close">√ó</button>
    </div>
    <div class="modal-body">
      <BioSampler taxonomy={taxonomy} />
    </div>
    <div class="modal-actions">
      <button class="btn btn-danger" id="clear-pad">Clear Pad</button>
      <button class="btn btn-secondary" id="cancel-modal">Cancel</button>
      <button class="btn btn-primary" id="save-pad">Save to Pad</button>
    </div>
  </div>
</div>

<script is:inline src="/scripts/bio-synth-generator.js"></script>

<script>
  const gen = new window.BioSynthGenerator();
  let currentPad = null;
  let isPlayMode = true; // Start in play mode
  const padBank = Array(16).fill(null); // 16 pads in 4x4 grid
  const padElements = {};
  let holdIntervals = {};
  let activeTouches = new Map();

  // Volume controls
  let masterVolume = 0.8;
  let sectionVolumes = { drums: 1.0, bass: 1.0, melody: 1.0, fx: 1.0 };

  // Initialize default pack - 16 pads organized into 4 categories
  const defaultPack = {
    name: "Default Pack",
    version: "1.0",
    pads: [
      // Drums (Pads 1-4) - Red theme
      { preset: 'rap', frequency: 60, duration: 0.5, intensity: 0.9, modulation: 40, label: 'Kick', category: 'drums' },
      { preset: 'rap', frequency: 200, duration: 0.3, intensity: 0.8, modulation: 50, label: 'Snare', category: 'drums' },
      { preset: 'rap', frequency: 8000, duration: 0.1, intensity: 0.7, modulation: 100, label: 'Hi-Hat', category: 'drums' },
      { preset: 'rap', frequency: 150, duration: 0.2, intensity: 0.75, modulation: 60, label: 'Clap', category: 'drums' },

      // Bass (Pads 5-8) - Cyan theme
      { preset: 'reggae', frequency: 41.2, duration: 2.0, intensity: 0.8, modulation: 7.83, label: 'Bass E', category: 'bass' },
      { preset: 'reggae', frequency: 49.0, duration: 2.0, intensity: 0.8, modulation: 7.83, label: 'Bass G', category: 'bass' },
      { preset: 'reggae', frequency: 55.0, duration: 2.0, intensity: 0.8, modulation: 7.83, label: 'Bass A', category: 'bass' },
      { preset: 'reggae', frequency: 61.74, duration: 2.0, intensity: 0.8, modulation: 7.83, label: 'Bass B', category: 'bass' },

      // Melody (Pads 9-12) - Purple theme
      { preset: 'singing', frequency: 256, duration: 1.5, intensity: 0.7, modulation: 128, label: 'C Note', category: 'melody' },
      { preset: 'singing', frequency: 288, duration: 1.5, intensity: 0.7, modulation: 128, label: 'D Note', category: 'melody' },
      { preset: 'singing', frequency: 323, duration: 1.5, intensity: 0.7, modulation: 128, label: 'E Note', category: 'melody' },
      { preset: 'singing', frequency: 384, duration: 1.5, intensity: 0.7, modulation: 128, label: 'G Note', category: 'melody' },

      // FX (Pads 13-16) - Orange theme
      { preset: 'water', frequency: 1200, duration: 0.8, intensity: 0.6, modulation: 800, label: 'Water', category: 'fx' },
      { preset: 'electric', frequency: 2000, duration: 0.4, intensity: 0.8, modulation: 1500, label: 'Zap', category: 'fx' },
      { preset: 'schumann', frequency: 7.83, duration: 3.0, intensity: 0.5, modulation: 14.3, label: 'Earth', category: 'fx' },
      { preset: 'solfeggio', frequency: 528, duration: 2.5, intensity: 0.6, modulation: 264, label: 'Love', category: 'fx' }
    ]
  };

  // Load saved bank
  function loadBank() {
    const saved = localStorage.getItem('biosampler-bank');
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        parsed.forEach((config, index) => {
          padBank[index] = config;
        });
      } catch (e) {
        console.error('Failed to load bank:', e);
      }
    }
  }

  // Save bank
  function saveBank() {
    localStorage.setItem('biosampler-bank', JSON.stringify(padBank));
    updateConfiguredCount();
  }

  // Update configured count (removed from UI but kept for compatibility)
  function updateConfiguredCount() {
    // Silently track configuration status
    const count = padBank.filter(p => p !== null).length;
    console.log(`Configured pads: ${count}/16`);
  }

  // Create 4x4 pad grid
  function createPads() {
    const container = document.getElementById('main-pad-bank');
    container.innerHTML = '';

    // Create 16 pads in 4x4 grid
    for (let i = 0; i < 16; i++) {
      const pad = document.createElement('div');
      pad.className = 'pad';

      // Determine category based on row (4 rows, 4 pads each)
      let category = 'drums';
      let sectionClass = 'drums';
      if (i >= 4 && i < 8) { category = 'bass'; sectionClass = 'bass'; }
      else if (i >= 8 && i < 12) { category = 'melody'; sectionClass = 'synth'; }
      else if (i >= 12) { category = 'fx'; sectionClass = 'horn'; }

      // Add section class for themed colors
      const sectionDiv = document.createElement('div');
      sectionDiv.className = `section ${sectionClass}`;
      sectionDiv.style.display = 'contents';

      pad.dataset.padIndex = i;
      pad.dataset.category = category;
      padElements[i] = pad;

      if (padBank[i]) {
        pad.classList.add('configured');
      }

      const config = padBank[i];
      const label = config ? (config.label || config.preset) : 'Empty';
      const freq = config ? `${Math.round(config.frequency)}Hz` : '';

      pad.innerHTML = `
        <div class="pad-number">${i + 1}</div>
        <div class="pad-label">${label}</div>
        ${freq ? `<div class="pad-freq">${freq}</div>` : ''}
        <div class="two-finger-effect">üåÄ</div>
      `;

      setupPadInteractions(pad, i);
      sectionDiv.appendChild(pad);
      container.appendChild(sectionDiv);
    }
  }

  // Setup pad interactions
  function setupPadInteractions(pad, padIndex) {
    // Click handler
    pad.addEventListener('click', (e) => {
      if (!isPlayMode) {
        openModal(padIndex);
      }
    });

    // Mouse hold
    let mouseHoldTimeout;
    pad.addEventListener('mousedown', (e) => {
      if (isPlayMode && padBank[padIndex]) {
        e.preventDefault();
        playPad(padIndex);
        pad.classList.add('holding');

        mouseHoldTimeout = setTimeout(() => {
          startHoldRepeat(padIndex);
        }, 300);
      }
    });

    pad.addEventListener('mouseup', () => {
      clearTimeout(mouseHoldTimeout);
      stopHoldRepeat(padIndex);
      pad.classList.remove('holding');
    });

    pad.addEventListener('mouseleave', () => {
      clearTimeout(mouseHoldTimeout);
      stopHoldRepeat(padIndex);
      pad.classList.remove('holding');
    });

    // Touch interactions
    pad.addEventListener('touchstart', (e) => {
      if (isPlayMode && padBank[padIndex]) {
        e.preventDefault();

        // Track touches
        Array.from(e.touches).forEach(touch => {
          activeTouches.set(touch.identifier, { padIndex, startTime: Date.now() });
        });

        // Check for two-finger touch
        if (e.touches.length >= 2) {
          pad.classList.add('two-finger');
          playPadWithEffect(padIndex, 'pitch');
        } else {
          playPad(padIndex);
          pad.classList.add('holding');

          setTimeout(() => {
            if (activeTouches.has(e.touches[0].identifier)) {
              startHoldRepeat(padIndex);
            }
          }, 300);
        }
      }
    });

    pad.addEventListener('touchend', (e) => {
      Array.from(e.changedTouches).forEach(touch => {
        activeTouches.delete(touch.identifier);
      });

      if (activeTouches.size === 0) {
        stopHoldRepeat(padIndex);
        pad.classList.remove('holding');
        pad.classList.remove('two-finger');
      }
    });
  }

  // Hold repeat
  function startHoldRepeat(padIndex) {
    if (holdIntervals[padIndex]) return;

    const config = padBank[padIndex];
    if (!config) return;

    const repeatInterval = Math.max(config.duration * 1000 * 0.8, 150);

    holdIntervals[padIndex] = setInterval(() => {
      playPad(padIndex);
    }, repeatInterval);
  }

  function stopHoldRepeat(padIndex) {
    if (holdIntervals[padIndex]) {
      clearInterval(holdIntervals[padIndex]);
      delete holdIntervals[padIndex];
    }
  }

  // Play pad
  async function playPad(padIndex, volumeMod = 1.0) {
    const config = padBank[padIndex];
    if (!config) return;

    const pad = padElements[padIndex];
    pad.classList.add('playing');

    // Calculate category volume based on position in 4x4 grid
    let categoryVolume = 1.0;
    if (padIndex < 4) categoryVolume = sectionVolumes.drums;      // Row 1: Drums
    else if (padIndex < 8) categoryVolume = sectionVolumes.bass;  // Row 2: Bass
    else if (padIndex < 12) categoryVolume = sectionVolumes.melody; // Row 3: Melody
    else categoryVolume = sectionVolumes.fx;                       // Row 4: FX

    const sectionVolume = categoryVolume;

    // Generate audio
    const samples = Math.floor(gen.sampleRate * config.duration);
    const audioData = new Float32Array(samples);

    for (let i = 0; i < samples; i++) {
      const t = i / gen.sampleRate;
      audioData[i] = Math.sin(2 * Math.PI * config.frequency * t
        + Math.sin(2 * Math.PI * config.modulation * t) * 0.3)
        * Math.exp(-t * 2) * config.intensity * masterVolume * sectionVolume * volumeMod;
    }

    await gen.previewAudio(audioData);

    setTimeout(() => {
      pad.classList.remove('playing');
    }, config.duration * 1000);
  }

  // Play with effect
  async function playPadWithEffect(padIndex, effect) {
    const config = padBank[padIndex];
    if (!config) return;

    const pad = padElements[padIndex];
    pad.classList.add('playing');

    let categoryVolume = 1.0;
    if (padIndex < 4) categoryVolume = sectionVolumes.drums;
    else if (padIndex < 8) categoryVolume = sectionVolumes.bass;
    else if (padIndex < 12) categoryVolume = sectionVolumes.melody;
    else categoryVolume = sectionVolumes.fx;

    const sectionVolume = categoryVolume;

    const samples = Math.floor(gen.sampleRate * config.duration);
    const audioData = new Float32Array(samples);

    for (let i = 0; i < samples; i++) {
      const t = i / gen.sampleRate;
      const progress = i / samples;

      let freq = config.frequency;
      if (effect === 'pitch') {
        // Pitch bend effect
        freq = config.frequency * (1 + progress * 0.5);
      }

      audioData[i] = Math.sin(2 * Math.PI * freq * t
        + Math.sin(2 * Math.PI * config.modulation * t) * 0.3)
        * Math.exp(-t * 2) * config.intensity * masterVolume * sectionVolume;
    }

    await gen.previewAudio(audioData);

    setTimeout(() => {
      pad.classList.remove('playing');
    }, config.duration * 1000);
  }

  // Mode toggle
  function setMode(mode) {
    isPlayMode = mode === 'play';
    document.body.className = isPlayMode ? 'play-mode' : 'edit-mode';

    document.getElementById('edit-mode-btn').classList.toggle('active', !isPlayMode);
    document.getElementById('play-mode-btn').classList.toggle('active', isPlayMode);

    // Clear any active holds
    Object.keys(holdIntervals).forEach(stopHoldRepeat);
  }

  // Modal functions
  function openModal(padIndex) {
    currentPad = padIndex;

    // Determine category based on 4x4 grid position
    let categoryName = 'Drums';
    let padNumber = (padIndex % 4) + 1;
    if (padIndex >= 4 && padIndex < 8) categoryName = 'Bass';
    else if (padIndex >= 8 && padIndex < 12) categoryName = 'Melody';
    else if (padIndex >= 12) categoryName = 'FX';

    document.getElementById('modal-title').textContent = `Configure ${categoryName} Pad ${padNumber}`;
    document.getElementById('modal').classList.add('active');

    if (padBank[padIndex]) {
      const config = padBank[padIndex];
      document.getElementById('preset').value = config.preset;
      document.getElementById('f').value = config.frequency;
      document.getElementById('d').value = config.duration;
      document.getElementById('a').value = config.intensity;
      document.getElementById('m').value = config.modulation;
      document.getElementById('preset').dispatchEvent(new Event('change'));
    }
  }

  function closeModal() {
    document.getElementById('modal').classList.remove('active');
    currentPad = null;
  }

  function savePad() {
    if (currentPad === null) return;

    const config = {
      preset: document.getElementById('preset').value,
      frequency: parseFloat(document.getElementById('f').value),
      duration: parseFloat(document.getElementById('d').value),
      intensity: parseFloat(document.getElementById('a').value),
      modulation: parseFloat(document.getElementById('m').value),
      created: new Date().toISOString()
    };

    padBank[currentPad] = config;
    saveBank();
    createPads();
    closeModal();
  }

  function clearPad() {
    if (currentPad === null) return;
    padBank[currentPad] = null;
    saveBank();
    createPads();
    closeModal();
  }

  // Fader controls
  function setupFaders() {
    const masterFader = document.getElementById('master-fader');
    masterFader.addEventListener('input', (e) => {
      masterVolume = e.target.value / 100;
      document.getElementById('master-value').textContent = `${e.target.value}%`;
      document.getElementById('master-fill').style.width = `${e.target.value}%`;
    });

    // No individual section faders in 4x4 grid design - master volume only
    // Future: Could add category faders if needed
  }

  // Export/Import (legacy - use save/load pack instead)
  function exportBank() {
    const pack = savePack(`Export-${Date.now()}`);
    const blob = new Blob([JSON.stringify(pack, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${pack.name}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function importBank() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'application/json';
    input.onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const imported = JSON.parse(event.target.result);

          // Support both old format (array) and new format (pack object)
          if (Array.isArray(imported)) {
            // Old format - direct array
            if (imported.length === 16) {
              imported.forEach((config, index) => {
                padBank[index] = config;
              });
              saveBank();
              createPads();
              alert('Bank imported successfully!');
            } else {
              alert(`Invalid bank file: expected 16 pads, got ${imported.length}`);
            }
          } else if (imported.pads && Array.isArray(imported.pads)) {
            // New pack format
            loadPack(imported);
            alert(`Pack imported: ${imported.name}`);
          } else {
            alert('Invalid file format');
          }
        } catch (err) {
          alert('Failed to import: ' + err.message);
        }
      };
      reader.readAsText(file);
    };
    input.click();
  }

  // Load default pack - all 16 pads pre-configured
  function loadDefaults() {
    // Always load default pack if bank is empty
    if (padBank.every(p => p === null)) {
      defaultPack.pads.forEach((preset, i) => {
        padBank[i] = { ...preset, created: new Date().toISOString() };
      });
      saveBank();
      console.log('‚úÖ Default pack loaded: 16 pads ready to play!');
    }
  }

  // Load pack from object
  function loadPack(pack) {
    if (!pack || !pack.pads || pack.pads.length !== 16) {
      console.error('Invalid pack format');
      return false;
    }

    pack.pads.forEach((preset, i) => {
      if (i < 16) {
        padBank[i] = { ...preset, loaded: new Date().toISOString() };
      }
    });

    saveBank();
    createPads();
    console.log(`‚úÖ Pack loaded: ${pack.name}`);
    return true;
  }

  // Save current bank as pack
  function savePack(packName) {
    const pack = {
      name: packName || 'Custom Pack',
      version: '1.0',
      created: new Date().toISOString(),
      pads: padBank.map((config, i) => ({
        ...config,
        category: i < 4 ? 'drums' : i < 8 ? 'bass' : i < 12 ? 'melody' : 'fx'
      }))
    };

    // Save to localStorage
    const packs = JSON.parse(localStorage.getItem('biosampler-packs') || '[]');
    const existingIndex = packs.findIndex(p => p.name === pack.name);

    if (existingIndex >= 0) {
      packs[existingIndex] = pack;
    } else {
      packs.push(pack);
    }

    localStorage.setItem('biosampler-packs', JSON.stringify(packs));
    console.log(`üíæ Pack saved: ${pack.name}`);

    // TODO: Add web3/postgres integration here
    // await uploadPackToChain(pack);
    // await savePackToPostgres(pack);

    return pack;
  }

  // Toggle sequencer visibility
  function toggleSequencer() {
    const sequencer = document.querySelector('.sequencer-section');
    sequencer.classList.toggle('collapsed');
    const btn = document.getElementById('toggle-sequencer');
    btn.textContent = sequencer.classList.contains('collapsed') ? 'üìä Show Sequencer' : 'üìä Hide Sequencer';
  }

  // Show load pack dialog
  function showLoadPackDialog() {
    const packs = JSON.parse(localStorage.getItem('biosampler-packs') || '[]');
    const packList = packs.map(p => `${p.name} (${new Date(p.created).toLocaleDateString()})`).join('\n');

    if (packs.length === 0) {
      alert('No saved packs found. Save your current setup first!');
      return;
    }

    const packName = prompt(`Available packs:\n${packList}\n\nEnter pack name to load:`);
    if (!packName) return;

    const pack = packs.find(p => p.name === packName);
    if (pack) {
      loadPack(pack);
      alert(`‚úÖ Loaded: ${pack.name}`);
    } else {
      alert(`‚ùå Pack "${packName}" not found`);
    }

    // TODO: Add UI modal for pack selection with web3/postgres packs
  }

  // Show save pack dialog
  function showSavePackDialog() {
    const packName = prompt('Enter pack name:', 'My Custom Pack');
    if (!packName) return;

    savePack(packName);
    alert(`üíæ Pack saved: ${packName}`);
  }

  // Load demo track
  function loadDemoTrack(trackId) {
    const track = demoTracks[trackId];
    if (!track) return;

    recordedNotes = [...track.notes];
    bpm = track.bpm;
    currentPatternName = track.name;

    document.getElementById('tempo-input').value = bpm;
    document.getElementById('pattern-name').textContent = currentPatternName;

    drawRecordedNotes();
    console.log(`‚úÖ Loaded demo: ${track.name} (${bpm} BPM, ${track.notes.length} notes)`);

    // Show sequencer if hidden
    const sequencer = document.querySelector('.sequencer-section');
    if (sequencer.classList.contains('collapsed')) {
      toggleSequencer();
    }
  }

  // Import MIDI file
  async function importMIDI() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.mid,.midi';
    input.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        const arrayBuffer = await file.arrayBuffer();

        // Parse MIDI using Tone.js MIDI library
        const midi = await Midi.fromUrl(URL.createObjectURL(file));

        console.log('MIDI parsed:', {
          name: midi.name,
          duration: midi.duration,
          tracks: midi.tracks.length,
          header: midi.header
        });

        // Extract tempo
        if (midi.header.tempos.length > 0) {
          bpm = Math.round(midi.header.tempos[0].bpm);
          document.getElementById('tempo-input').value = bpm;
        }

        // Convert MIDI notes to sequencer format
        recordedNotes = convertMIDIToNotes(midi);

        currentPatternName = file.name.replace(/\.(mid|midi)$/i, '');
        document.getElementById('pattern-name').textContent = currentPatternName;

        drawRecordedNotes();
        alert(`‚úÖ MIDI imported: ${midi.name}\n${recordedNotes.length} notes ‚Ä¢ ${bpm} BPM`);

        // Show sequencer
        const sequencer = document.querySelector('.sequencer-section');
        if (sequencer.classList.contains('collapsed')) {
          toggleSequencer();
        }
      } catch (err) {
        alert(`Failed to import MIDI: ${err.message}`);
        console.error('MIDI import error:', err);
      }
    };
    input.click();
  }

  // Convert MIDI data to sequencer notes
  function convertMIDIToNotes(midi) {
    const notes = [];
    const loopDuration = getBeatDuration() * TOTAL_BEATS;

    // MIDI note to pad mapping
    const noteMap = {
      // Drums (General MIDI drum map)
      36: 0, // Kick (C1) -> Pad 1
      38: 1, // Snare (D1) -> Pad 2
      42: 2, // Closed Hi-Hat (F#1) -> Pad 3
      46: 2, // Open Hi-Hat (A#1) -> Pad 3
      39: 3, // Clap (D#1) -> Pad 4

      // Bass notes (E1-B1) -> Pads 5-8
      40: 4, // E1 -> Pad 5
      41: 4, // F1 -> Pad 5
      43: 5, // G1 -> Pad 6
      45: 6, // A1 -> Pad 7
      47: 7, // B1 -> Pad 8

      // Melody (C2-B2) -> Pads 9-12
      48: 8,  // C2 -> Pad 9
      50: 9,  // D2 -> Pad 10
      52: 10, // E2 -> Pad 11
      55: 11, // G2 -> Pad 12

      // FX (higher notes) -> Pads 13-16
      60: 12, // C3 -> Pad 13
      62: 13, // D3 -> Pad 14
      64: 14, // E3 -> Pad 15
      67: 15  // G3 -> Pad 16
    };

    // Process all tracks
    midi.tracks.forEach((track, trackIndex) => {
      console.log(`Track ${trackIndex}: ${track.name} (${track.notes.length} notes)`);

      track.notes.forEach(midiNote => {
        // Convert time to milliseconds
        const time = midiNote.time * 1000;

        // Skip notes beyond loop duration
        if (time >= loopDuration) return;

        // Map MIDI note to pad index
        let padIndex = noteMap[midiNote.midi];

        // If no exact mapping, try to map by range
        if (padIndex === undefined) {
          if (midiNote.midi >= 36 && midiNote.midi <= 39) padIndex = 0; // Drums
          else if (midiNote.midi >= 40 && midiNote.midi <= 47) padIndex = Math.min(4 + (midiNote.midi - 40) % 4, 7); // Bass
          else if (midiNote.midi >= 48 && midiNote.midi <= 59) padIndex = Math.min(8 + (midiNote.midi - 48) % 4, 11); // Melody
          else padIndex = Math.min(12 + (midiNote.midi % 4), 15); // FX
        }

        notes.push({
          padIndex,
          time,
          velocity: midiNote.velocity,
          duration: midiNote.duration * 1000,
          originalMidi: midiNote.midi,
          originalNote: midiNote.name
        });
      });
    });

    notes.sort((a, b) => a.time - b.time);
    console.log(`Converted ${notes.length} MIDI notes to sequencer format`);

    return notes;
  }

  // Event listeners
  document.getElementById('edit-mode-btn').addEventListener('click', () => setMode('edit'));
  document.getElementById('play-mode-btn').addEventListener('click', () => setMode('play'));
  document.getElementById('toggle-sequencer').addEventListener('click', toggleSequencer);
  document.getElementById('load-pack').addEventListener('click', showLoadPackDialog);
  document.getElementById('save-pack').addEventListener('click', showSavePackDialog);

  // Demo track selector
  document.getElementById('demo-track-selector').addEventListener('change', (e) => {
    const trackId = e.target.value;
    if (trackId) {
      loadDemoTrack(trackId);
      e.target.value = ''; // Reset selector
    }
  });

  // MIDI import
  document.getElementById('import-midi-btn').addEventListener('click', importMIDI);

  document.getElementById('modal-close').addEventListener('click', closeModal);
  document.getElementById('cancel-modal').addEventListener('click', closeModal);
  document.getElementById('save-pad').addEventListener('click', savePad);
  document.getElementById('clear-pad').addEventListener('click', clearPad);

  document.getElementById('modal').addEventListener('click', (e) => {
    if (e.target.id === 'modal') closeModal();
  });

  // Keyboard
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && document.getElementById('modal').classList.contains('active')) {
      closeModal();
    }

    if (!document.getElementById('modal').classList.contains('active') && isPlayMode) {
      // Number keys 1-9 for first row of each section
      if (e.key >= '1' && e.key <= '9') {
        const index = parseInt(e.key) - 1;
        if (padBank[index]) playPad(index);
      }

      // Tab to toggle mode
      if (e.key === 'Tab') {
        e.preventDefault();
        setMode(isPlayMode ? 'edit' : 'play');
      }
    }
  });

  // ==================== SEQUENCER ====================
  let isRecording = false;
  let isPlayingSequence = false;
  let isLooping = true;
  let bpm = 120;
  let recordedNotes = [];
  let recordStartTime = 0;
  let playbackStartTime = 0;
  let currentPatternName = 'Untitled Pattern';
  let playbackInterval = null;
  let timelineCanvas = null;
  let timelineCtx = null;

  const BARS = 16;
  const BEATS_PER_BAR = 4;
  const TOTAL_BEATS = BARS * BEATS_PER_BAR;

  // Demo track patterns (placeholder - will be replaced with MIDI imports)
  const demoTracks = {
    rap: {
      name: "Rap Beat",
      bpm: 95,
      notes: generateRapBeat()
    },
    jazz: {
      name: "Jazz Backing",
      bpm: 140,
      notes: generateJazzBacking()
    },
    blues: {
      name: "Robert Johnson Blues",
      bpm: 85,
      notes: generateBluesBacking()
    },
    rock: {
      name: "Rock Ballad",
      bpm: 72,
      notes: generateRockBallad()
    }
  };

  // Generate rap beat pattern
  function generateRapBeat() {
    const notes = [];
    const beatDur = (60 / 95) * 1000; // 95 BPM

    // Kick pattern (pad 0) - on 1 and 3
    for (let bar = 0; bar < 16; bar++) {
      notes.push({ padIndex: 0, time: bar * beatDur * 4 }); // Beat 1
      notes.push({ padIndex: 0, time: bar * beatDur * 4 + beatDur * 2 }); // Beat 3
    }

    // Snare pattern (pad 1) - on 2 and 4
    for (let bar = 0; bar < 16; bar++) {
      notes.push({ padIndex: 1, time: bar * beatDur * 4 + beatDur }); // Beat 2
      notes.push({ padIndex: 1, time: bar * beatDur * 4 + beatDur * 3 }); // Beat 4
    }

    // Hi-hat pattern (pad 2) - 8th notes
    for (let bar = 0; bar < 16; bar++) {
      for (let eighth = 0; eighth < 8; eighth++) {
        notes.push({ padIndex: 2, time: bar * beatDur * 4 + eighth * beatDur * 0.5 });
      }
    }

    return notes;
  }

  // Generate jazz backing pattern
  function generateJazzBacking() {
    const notes = [];
    const beatDur = (60 / 140) * 1000; // 140 BPM (swing)

    // Ride cymbal pattern (pad 2)
    for (let bar = 0; bar < 16; bar++) {
      for (let beat = 0; beat < 4; beat++) {
        notes.push({ padIndex: 2, time: bar * beatDur * 4 + beat * beatDur });
      }
    }

    // Walking bass (pads 4-7 cycling)
    for (let bar = 0; bar < 16; bar++) {
      notes.push({ padIndex: 4, time: bar * beatDur * 4 });
      notes.push({ padIndex: 5, time: bar * beatDur * 4 + beatDur });
      notes.push({ padIndex: 6, time: bar * beatDur * 4 + beatDur * 2 });
      notes.push({ padIndex: 7, time: bar * beatDur * 4 + beatDur * 3 });
    }

    return notes;
  }

  // Generate blues pattern
  function generateBluesBacking() {
    const notes = [];
    const beatDur = (60 / 85) * 1000; // 85 BPM (slow blues)

    // Shuffle drum pattern
    for (let bar = 0; bar < 12; bar++) { // 12-bar blues
      notes.push({ padIndex: 0, time: bar * beatDur * 4 }); // Kick
      notes.push({ padIndex: 1, time: bar * beatDur * 4 + beatDur * 2 }); // Snare backbeat
    }

    // Blues bass line (E-A-E progression)
    for (let bar = 0; bar < 12; bar++) {
      const bassPad = bar < 4 ? 4 : bar < 8 ? 5 : 4; // E-A-E
      notes.push({ padIndex: bassPad, time: bar * beatDur * 4 });
      notes.push({ padIndex: bassPad, time: bar * beatDur * 4 + beatDur * 2 });
    }

    return notes;
  }

  // Generate rock ballad pattern
  function generateRockBallad() {
    const notes = [];
    const beatDur = (60 / 72) * 1000; // 72 BPM (ballad)

    // Power ballad drums
    for (let bar = 0; bar < 16; bar++) {
      notes.push({ padIndex: 0, time: bar * beatDur * 4 }); // Kick on 1
      notes.push({ padIndex: 0, time: bar * beatDur * 4 + beatDur * 2 }); // Kick on 3
      notes.push({ padIndex: 1, time: bar * beatDur * 4 + beatDur * 1.5 }); // Snare on 2
      notes.push({ padIndex: 1, time: bar * beatDur * 4 + beatDur * 3.5 }); // Snare on 4
    }

    // Melodic line (pads 8-11)
    const melody = [8, 9, 10, 11, 10, 9];
    for (let bar = 0; bar < 16; bar++) {
      const note = melody[bar % melody.length];
      notes.push({ padIndex: note, time: bar * beatDur * 4 });
    }

    return notes;
  }

  // Initialize timeline
  function initTimeline() {
    timelineCanvas = document.getElementById('notes-canvas');
    timelineCtx = timelineCanvas.getContext('2d');
    drawTimelineGrid();
    drawRecordedNotes();
    setupTimelineClickToAdd();
  }

  // Setup click-to-add functionality on timeline
  function setupTimelineClickToAdd() {
    const timeline = document.getElementById('timeline');

    timeline.addEventListener('click', (e) => {
      const rect = timeline.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      // Calculate which pad (lane) was clicked
      const laneHeight = rect.height / 16;
      const padIndex = Math.floor(y / laneHeight);

      // Calculate time position (in ms)
      const loopDuration = getBeatDuration() * TOTAL_BEATS;
      const time = (x / rect.width) * loopDuration;

      // Add note
      if (padIndex >= 0 && padIndex < 16) {
        recordedNotes.push({ padIndex, time });
        recordedNotes.sort((a, b) => a.time - b.time); // Keep sorted
        drawRecordedNotes();
        console.log(`Added note: Pad ${padIndex + 1} at ${(time / 1000).toFixed(2)}s`);
      }
    });

    // Right-click to remove notes
    timeline.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      const rect = timeline.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      const laneHeight = rect.height / 16;
      const padIndex = Math.floor(y / laneHeight);
      const loopDuration = getBeatDuration() * TOTAL_BEATS;
      const time = (x / rect.width) * loopDuration;

      // Remove notes within 50ms of click
      const beforeLength = recordedNotes.length;
      recordedNotes = recordedNotes.filter(note => {
        if (note.padIndex !== padIndex) return true;
        return Math.abs(note.time - time) > 50;
      });

      if (recordedNotes.length < beforeLength) {
        drawRecordedNotes();
        console.log(`Removed note(s) at pad ${padIndex + 1}`);
      }
    });
  }

  // Draw timeline grid
  function drawTimelineGrid() {
    const canvas = timelineCanvas;
    const ctx = timelineCtx;
    const width = canvas.width;
    const height = canvas.height;

    ctx.clearRect(0, 0, width, height);

    // Draw bar lines
    ctx.strokeStyle = '#30363d';
    ctx.lineWidth = 1;
    for (let bar = 0; bar <= BARS; bar++) {
      const x = (bar / BARS) * width;
      ctx.beginPath();
      ctx.moveTo(x, 0);
      ctx.lineTo(x, height);
      ctx.stroke();

      // Bar numbers
      if (bar < BARS) {
        ctx.fillStyle = '#8b949e';
        ctx.font = '10px system-ui';
        ctx.fillText((bar + 1).toString(), x + 5, 15);
      }
    }

    // Draw beat lines
    ctx.strokeStyle = '#21262d';
    for (let beat = 0; beat < TOTAL_BEATS; beat++) {
      const x = (beat / TOTAL_BEATS) * width;
      ctx.beginPath();
      ctx.moveTo(x, 0);
      ctx.lineTo(x, height);
      ctx.stroke();
    }

    // Draw pad lanes (16 lanes for 4x4 grid)
    const laneHeight = height / 16;
    ctx.strokeStyle = '#161b22';
    for (let i = 0; i <= 16; i++) {
      const y = i * laneHeight;
      ctx.beginPath();
      ctx.moveTo(0, y);
      ctx.lineTo(width, y);
      ctx.stroke();
    }
  }

  // Draw recorded notes
  function drawRecordedNotes() {
    drawTimelineGrid();

    const width = timelineCanvas.width;
    const height = timelineCanvas.height;
    const laneHeight = height / 16; // 16 pads in 4x4 grid
    const beatWidth = width / TOTAL_BEATS;

    recordedNotes.forEach(note => {
      const x = (note.time / (getBeatDuration() * TOTAL_BEATS)) * width;
      const noteWidth = Math.max(beatWidth * 0.2, 5);
      const y = note.padIndex * laneHeight + 2;
      const h = laneHeight - 4;

      // Color based on category (4 rows of 4)
      let color = '#58a6ff';
      if (note.padIndex < 4) color = '#ff6b6b';      // Drums (row 1)
      else if (note.padIndex < 8) color = '#4ecdc4'; // Bass (row 2)
      else if (note.padIndex < 12) color = '#a78bfa'; // Melody (row 3)
      else color = '#f4a261';                         // FX (row 4)

      timelineCtx.fillStyle = color;
      timelineCtx.fillRect(x, y, noteWidth, h);

      // Highlight effect
      timelineCtx.fillStyle = 'rgba(255, 255, 255, 0.3)';
      timelineCtx.fillRect(x, y, noteWidth, h * 0.3);
    });
  }

  // Get beat duration in ms
  function getBeatDuration() {
    return (60 / bpm) * 1000;
  }

  // Start recording
  function startRecording() {
    isRecording = true;
    recordedNotes = [];
    recordStartTime = Date.now();
    document.getElementById('record-btn').classList.add('recording');
    setMode('play'); // Auto switch to play mode
  }

  // Stop recording
  function stopRecording() {
    isRecording = false;
    document.getElementById('record-btn').classList.remove('recording');
    drawRecordedNotes();
  }

  // Record note
  function recordNote(padIndex) {
    if (!isRecording) return;
    const time = Date.now() - recordStartTime;
    recordedNotes.push({ padIndex, time });
  }

  // Start playback
  function startPlayback() {
    if (recordedNotes.length === 0) return;

    isPlayingSequence = true;
    playbackStartTime = Date.now();
    document.getElementById('play-seq-btn').classList.add('playing');
    document.getElementById('play-icon').textContent = '‚è∏Ô∏è';

    playSequence();
  }

  // Stop playback
  function stopPlayback() {
    isPlayingSequence = false;
    document.getElementById('play-seq-btn').classList.remove('playing');
    document.getElementById('play-icon').textContent = '‚ñ∂Ô∏è';
    document.getElementById('playhead').style.left = '0%';
    if (playbackInterval) clearInterval(playbackInterval);
  }

  // Play sequence
  function playSequence() {
    const loopDuration = getBeatDuration() * TOTAL_BEATS;
    let noteIndex = 0;

    playbackInterval = setInterval(() => {
      const elapsed = Date.now() - playbackStartTime;
      const position = elapsed % loopDuration;

      // Update playhead
      const progress = (position / loopDuration) * 100;
      document.getElementById('playhead').style.left = `${progress}%`;

      // Update position display
      const currentBeat = Math.floor(position / getBeatDuration());
      const bar = Math.floor(currentBeat / BEATS_PER_BAR) + 1;
      const beat = (currentBeat % BEATS_PER_BAR) + 1;
      document.getElementById('current-bar').textContent = bar;
      document.getElementById('current-beat').textContent = beat;
      document.getElementById('timeline-pos').textContent = `${bar}.${beat}.1`;

      // Play notes
      recordedNotes.forEach(note => {
        const noteTime = note.time % loopDuration;
        if (Math.abs(noteTime - position) < 50) {
          playPad(note.padIndex);
        }
      });

      // Loop check
      if (!isLooping && elapsed >= loopDuration) {
        stopPlayback();
      }
    }, 10);
  }

  // Save pattern
  function savePattern(name) {
    const patterns = JSON.parse(localStorage.getItem('biosampler-patterns') || '[]');
    const pattern = {
      id: Date.now(),
      name: name || currentPatternName,
      notes: recordedNotes,
      bpm: bpm,
      created: new Date().toISOString()
    };

    const existingIndex = patterns.findIndex(p => p.name === pattern.name);
    if (existingIndex >= 0) {
      patterns[existingIndex] = pattern;
    } else {
      patterns.push(pattern);
    }

    localStorage.setItem('biosampler-patterns', JSON.stringify(patterns));
    currentPatternName = pattern.name;
    document.getElementById('pattern-name').textContent = currentPatternName;
  }

  // Load pattern
  function loadPattern(pattern) {
    recordedNotes = pattern.notes;
    bpm = pattern.bpm;
    currentPatternName = pattern.name;
    document.getElementById('tempo-input').value = bpm;
    document.getElementById('pattern-name').textContent = currentPatternName;
    drawRecordedNotes();
  }

  // Show save modal
  function showSaveModal(saveAs = false) {
    if (recordedNotes.length === 0) {
      alert('Record something first!');
      return;
    }
    document.getElementById('pattern-name-input').value = saveAs ? '' : currentPatternName;
    document.getElementById('save-modal').classList.add('active');
    document.getElementById('pattern-name-input').focus();
  }

  // Show load modal
  function showLoadModal() {
    const patterns = JSON.parse(localStorage.getItem('biosampler-patterns') || '[]');
    const list = document.getElementById('patterns-list');
    const noPatterns = document.getElementById('no-patterns');

    if (patterns.length === 0) {
      list.style.display = 'none';
      noPatterns.style.display = 'block';
    } else {
      list.style.display = 'block';
      noPatterns.style.display = 'none';
      list.innerHTML = patterns.map(p => `
        <div style="padding: 1rem; margin-bottom: 0.5rem; background: var(--bg); border: 1px solid #30363d; border-radius: 8px; cursor: pointer; transition: all 0.2s;"
             onmouseover="this.style.borderColor='#58a6ff'"
             onmouseout="this.style.borderColor='#30363d'"
             onclick="window.loadPatternById(${p.id})">
          <div style="font-weight: 600; color: var(--text); margin-bottom: 0.25rem;">${p.name}</div>
          <div style="font-size: 0.85rem; color: var(--muted);">
            ${p.notes.length} notes ‚Ä¢ ${p.bpm} BPM ‚Ä¢ ${new Date(p.created).toLocaleDateString()}
          </div>
        </div>
      `).join('');
    }

    document.getElementById('load-modal').classList.add('active');
  }

  window.loadPatternById = (id) => {
    const patterns = JSON.parse(localStorage.getItem('biosampler-patterns') || '[]');
    const pattern = patterns.find(p => p.id === id);
    if (pattern) {
      loadPattern(pattern);
      document.getElementById('load-modal').classList.remove('active');
    }
  };

  // New pattern
  function newPattern() {
    if (recordedNotes.length > 0 && !confirm('Clear current pattern?')) return;
    recordedNotes = [];
    currentPatternName = 'Untitled Pattern';
    document.getElementById('pattern-name').textContent = currentPatternName;
    drawRecordedNotes();
  }

  // ==================== PRESSURE-SENSITIVE PAD PHYSICS ====================

  // Add pressure-sensitive deformation to pads
  function setupPadPhysics() {
    Object.keys(padElements).forEach(padIndex => {
      const pad = padElements[padIndex];

      // Add deformation container
      const deformLayer = document.createElement('div');
      deformLayer.className = 'deform-layer';
      deformLayer.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        border-radius: 12px;
        overflow: hidden;
      `;
      pad.appendChild(deformLayer);

      // Track active touches
      let activePressure = 0;
      let pressureAnimationFrame = null;

      function applyPressure(x, y, force) {
        activePressure = Math.min(force, 1);

        // Color shift based on pressure
        const hue = force < 0.5 ? 210 : 210 + (force - 0.5) * 60; // Blue to cyan
        const saturation = 50 + force * 50;
        const lightness = 30 + force * 20;

        // Deformation effect
        const deformScale = 1 - (force * 0.15); // Press in
        const glowIntensity = force * 20;

        pad.style.transform = `scale(${deformScale}) translateY(-${4 + force * 4}px)`;
        pad.style.boxShadow = `
          0 ${12 - force * 4}px ${24 + glowIntensity}px rgba(0, 0, 0, 0.4),
          0 0 ${glowIntensity}px hsl(${hue}, ${saturation}%, ${lightness}%)
        `;

        // Create ripple effect
        const ripple = document.createElement('div');
        ripple.style.cssText = `
          position: absolute;
          left: ${x}px;
          top: ${y}px;
          width: ${force * 100}px;
          height: ${force * 100}px;
          margin-left: ${-force * 50}px;
          margin-top: ${-force * 50}px;
          background: radial-gradient(circle,
            hsla(${hue}, ${saturation}%, ${lightness + 20}%, ${force * 0.6}) 0%,
            hsla(${hue}, ${saturation}%, ${lightness}%, 0) 70%);
          border-radius: 50%;
          animation: ripple-expand 0.6s ease-out;
          pointer-events: none;
        `;
        deformLayer.appendChild(ripple);

        setTimeout(() => ripple.remove(), 600);
      }

      function releasePressure() {
        activePressure = 0;
        pad.style.transform = '';
        pad.style.boxShadow = '';
      }

      // Mouse events
      pad.addEventListener('mousedown', (e) => {
        const rect = pad.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const force = 0.8; // Simulate pressure for mouse
        applyPressure(x, y, force);
        setTimeout(releasePressure, 200);
      });

      // Touch events with pressure
      pad.addEventListener('touchstart', (e) => {
        if (!isPlayMode || !padBank[padIndex]) return;

        Array.from(e.touches).forEach(touch => {
          const rect = pad.getBoundingClientRect();
          const x = touch.clientX - rect.left;
          const y = touch.clientY - rect.top;

          // Get touch force if available (iOS Safari, some Android)
          const force = touch.force || (touch.radiusX ? Math.min(touch.radiusX / 30, 1) : 0.7);
          applyPressure(x, y, force);

          // Record if recording
          if (isRecording) recordNote(padIndex);
        });
      });

      pad.addEventListener('touchend', () => {
        setTimeout(releasePressure, 150);
      });

      pad.addEventListener('touchmove', (e) => {
        if (e.touches.length > 0) {
          const touch = e.touches[0];
          const rect = pad.getBoundingClientRect();
          const x = touch.clientX - rect.left;
          const y = touch.clientY - rect.top;
          const force = touch.force || 0.7;

          if (force !== activePressure) {
            applyPressure(x, y, force);
          }
        }
      });

      // Click events for recording
      pad.addEventListener('click', (e) => {
        if (isPlayMode && isRecording && padBank[padIndex]) {
          recordNote(padIndex);
        }
      });
    });
  }

  // ==================== SEQUENCER EVENT LISTENERS ====================

  document.getElementById('record-btn').addEventListener('click', () => {
    if (isRecording) stopRecording();
    else startRecording();
  });

  document.getElementById('play-seq-btn').addEventListener('click', () => {
    if (isPlayingSequence) stopPlayback();
    else startPlayback();
  });

  document.getElementById('stop-btn').addEventListener('click', () => {
    stopPlayback();
    stopRecording();
  });

  document.getElementById('loop-btn').addEventListener('click', (e) => {
    isLooping = !isLooping;
    e.target.classList.toggle('active', isLooping);
  });

  document.getElementById('tempo-input').addEventListener('input', (e) => {
    bpm = parseInt(e.target.value);
  });

  document.getElementById('save-pattern-btn').addEventListener('click', () => showSaveModal(false));
  document.getElementById('save-as-btn').addEventListener('click', () => showSaveModal(true));
  document.getElementById('load-pattern-btn').addEventListener('click', showLoadModal);
  document.getElementById('new-pattern-btn').addEventListener('click', newPattern);

  // Save modal
  document.getElementById('save-modal-close').addEventListener('click', () => {
    document.getElementById('save-modal').classList.remove('active');
  });
  document.getElementById('cancel-save').addEventListener('click', () => {
    document.getElementById('save-modal').classList.remove('active');
  });
  document.getElementById('confirm-save').addEventListener('click', () => {
    const name = document.getElementById('pattern-name-input').value.trim() || currentPatternName;
    savePattern(name);
    document.getElementById('save-modal').classList.remove('active');
  });

  // Load modal
  document.getElementById('load-modal-close').addEventListener('click', () => {
    document.getElementById('load-modal').classList.remove('active');
  });

  // Keyboard shortcuts for sequencer
  document.addEventListener('keydown', (e) => {
    if (document.querySelector('.modal-overlay.active')) return;

    if (e.key === ' ' && isPlayMode) {
      e.preventDefault();
      if (isPlayingSequence) stopPlayback();
      else startPlayback();
    }

    if (e.key.toLowerCase() === 'r' && isPlayMode) {
      e.preventDefault();
      if (isRecording) stopRecording();
      else startRecording();
    }
  });

  // Add ripple animation CSS
  const style = document.createElement('style');
  style.textContent = `
    @keyframes ripple-expand {
      from {
        transform: scale(0);
        opacity: 1;
      }
      to {
        transform: scale(2);
        opacity: 0;
      }
    }
  `;
  document.head.appendChild(style);

  // Initialize
  loadBank();
  loadDefaults();
  createPads();
  setupFaders();
  initTimeline();
  setupPadPhysics();
</script>
</body>
</html>
