---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Offline Storage Test - WorldBridger One">
  <div class="container" style="max-width: 1200px; margin: 2rem auto; padding: 0 1rem;">

    <h1 class="pixel-title" style="text-align: center; margin-bottom: 2rem;">
      ğŸ—„ï¸ OFFLINE STORAGE TEST
    </h1>

    <div class="pixel-border" style="padding: 2rem; margin-bottom: 2rem;">
      <h2>ğŸ“Š Storage Status</h2>
      <div id="storage-status" style="font-family: monospace; margin-top: 1rem;">
        <p>â³ Loading storage managers...</p>
      </div>
    </div>

    <div class="pixel-border" style="padding: 2rem; margin-bottom: 2rem;">
      <h2>ğŸ‘¤ Profile Test</h2>
      <form id="profile-form" style="display: grid; gap: 1rem;">
        <input type="text" name="username" placeholder="Username" required style="padding: 0.5rem;">
        <input type="email" name="email" placeholder="Email (will be encrypted)" style="padding: 0.5rem;">
        <textarea name="bio" placeholder="Bio" rows="3" style="padding: 0.5rem;"></textarea>
        <button type="submit" class="pixel-btn">ğŸ’¾ Save Profile (Local)</button>
      </form>
      <div id="profile-result" style="margin-top: 1rem; font-family: monospace;"></div>
    </div>

    <div class="pixel-border" style="padding: 2rem; margin-bottom: 2rem;">
      <h2>ğŸµ Track Upload Test</h2>
      <form id="track-form" style="display: grid; gap: 1rem;">
        <input type="text" name="title" placeholder="Track Title" required style="padding: 0.5rem;">
        <select name="genre" required style="padding: 0.5rem;">
          <option value="">Select Genre</option>
          <option value="rap">Rap</option>
          <option value="reggae">Reggae</option>
          <option value="dancehall">Dancehall</option>
          <option value="afrobeat">Afrobeat</option>
          <option value="hip-hop">Hip-Hop</option>
        </select>
        <input type="url" name="audioFileUrl" placeholder="Audio URL" required style="padding: 0.5rem;">
        <input type="url" name="coverArtUrl" placeholder="Cover Art URL" style="padding: 0.5rem;">
        <textarea name="lyrics" placeholder="Lyrics (optional)" rows="4" style="padding: 0.5rem;"></textarea>
        <input type="number" name="bpm" placeholder="BPM" style="padding: 0.5rem;">
        <input type="text" name="key" placeholder="Musical Key (e.g., C Major)" style="padding: 0.5rem;">
        <button type="submit" class="pixel-btn">ğŸ¸ Upload Track (Local)</button>
      </form>
      <div id="track-result" style="margin-top: 1rem; font-family: monospace;"></div>
    </div>

    <div class="pixel-border" style="padding: 2rem; margin-bottom: 2rem;">
      <h2>ğŸ“‹ Your Data</h2>
      <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
        <button id="load-profile-btn" class="pixel-btn">ğŸ‘¤ Load Profile</button>
        <button id="load-tracks-btn" class="pixel-btn">ğŸµ Load Tracks</button>
        <button id="load-activities-btn" class="pixel-btn">ğŸ“Š Load Activities</button>
      </div>
      <pre id="data-display" style="background: #000; color: #0f0; padding: 1rem; border-radius: 4px; overflow: auto; max-height: 400px;">
// Your data will appear here
      </pre>
    </div>

    <div class="pixel-border" style="padding: 2rem; margin-bottom: 2rem;">
      <h2>ğŸ’¾ Export / Import</h2>
      <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <button id="export-btn" class="pixel-btn">ğŸ“¤ Export All Data</button>
        <button id="import-btn" class="pixel-btn">ğŸ“¥ Import Data</button>
        <button id="clear-btn" class="pixel-btn" style="background: #c00;">ğŸ—‘ï¸ Clear All Data</button>
      </div>
      <input type="file" id="import-file" accept=".json" style="display: none;">
      <div id="export-result" style="margin-top: 1rem; font-family: monospace;"></div>
    </div>

    <div class="pixel-border" style="padding: 2rem;">
      <h2>ğŸ§ª Test Encryption</h2>
      <div style="display: grid; gap: 1rem;">
        <input type="text" id="encrypt-input" placeholder="Text to encrypt" style="padding: 0.5rem;">
        <button id="encrypt-btn" class="pixel-btn">ğŸ” Encrypt</button>
        <div id="encrypt-result" style="font-family: monospace; word-break: break-all;"></div>
      </div>
    </div>

  </div>

  <script>
    // Wait for storage managers to load
    async function waitForManagers() {
      let attempts = 0;
      while (!window.localDB?.db || !window.cryptoManager?.salt) {
        if (attempts++ > 50) {
          throw new Error('Storage managers failed to load');
        }
        await new Promise(r => setTimeout(r, 100));
      }
    }

    // Initialize
    async function init() {
      try {
        await waitForManagers();

        // Update storage status
        const statusDiv = document.getElementById('storage-status');
        const lsInfo = window.localStore.getStorageInfo();

        let quotaInfo = '';
        if (navigator.storage && navigator.storage.estimate) {
          const { usage, quota } = await navigator.storage.estimate();
          quotaInfo = `IndexedDB: ${(usage/1024/1024).toFixed(2)} MB / ${(quota/1024/1024/1024).toFixed(2)} GB`;
        }

        statusDiv.innerHTML = `
          <p>âœ… <strong>Crypto Manager:</strong> ${window.cryptoManager ? 'Ready' : 'Not loaded'}</p>
          <p>âœ… <strong>LocalStorage:</strong> ${lsInfo.itemCount} items, ${lsInfo.sizeMB} MB</p>
          <p>âœ… <strong>IndexedDB:</strong> Ready (worldbridger_local)</p>
          <p>âœ… <strong>Form Adapter:</strong> ${window.formAdapter ? 'Ready' : 'Not loaded'}</p>
          ${quotaInfo ? `<p>ğŸ’¾ <strong>${quotaInfo}</strong></p>` : ''}
          <p>ğŸŒ <strong>Status:</strong> ${navigator.onLine ? 'Online' : 'Offline'}</p>
        `;

      } catch (error) {
        console.error('Initialization error:', error);
        document.getElementById('storage-status').innerHTML = `
          <p style="color: red;">âŒ Error: ${error.message}</p>
        `;
      }
    }

    // Profile form
    document.getElementById('profile-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);

      try {
        const result = await window.formAdapter.submitProfile(data);
        document.getElementById('profile-result').innerHTML = `
          <p style="color: #0f0;">âœ… Profile saved successfully!</p>
          <pre>${JSON.stringify(result, null, 2)}</pre>
        `;
      } catch (error) {
        document.getElementById('profile-result').innerHTML = `
          <p style="color: #f00;">âŒ Error: ${error.message}</p>
        `;
      }
    });

    // Track form
    document.getElementById('track-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);

      // Convert BPM to number
      if (data.bpm) data.bpm = parseInt(data.bpm);

      try {
        const result = await window.formAdapter.submitTrack(data);
        document.getElementById('track-result').innerHTML = `
          <p style="color: #0f0;">âœ… Track uploaded successfully!</p>
          <p>âœ¨ XP Awarded: ${result.xpAwarded}</p>
          <pre>${JSON.stringify(result.track, null, 2)}</pre>
        `;
      } catch (error) {
        document.getElementById('track-result').innerHTML = `
          <p style="color: #f00;">âŒ Error: ${error.message}</p>
        `;
      }
    });

    // Load profile
    document.getElementById('load-profile-btn').addEventListener('click', async () => {
      try {
        const wallet = window.walletManager?.connectedWallet;
        if (!wallet) {
          alert('Please connect your wallet first');
          return;
        }
        const profile = await window.localDB.getProfile(wallet);
        document.getElementById('data-display').textContent = JSON.stringify(profile, null, 2);
      } catch (error) {
        document.getElementById('data-display').textContent = 'Error: ' + error.message;
      }
    });

    // Load tracks
    document.getElementById('load-tracks-btn').addEventListener('click', async () => {
      try {
        const wallet = window.walletManager?.connectedWallet;
        if (!wallet) {
          alert('Please connect your wallet first');
          return;
        }
        const tracks = await window.localDB.getTracks({ userWallet: wallet });
        document.getElementById('data-display').textContent = JSON.stringify(tracks, null, 2);
      } catch (error) {
        document.getElementById('data-display').textContent = 'Error: ' + error.message;
      }
    });

    // Load activities
    document.getElementById('load-activities-btn').addEventListener('click', async () => {
      try {
        const wallet = window.walletManager?.connectedWallet;
        if (!wallet) {
          alert('Please connect your wallet first');
          return;
        }
        const activities = await window.localDB.getActivities(wallet, 20);
        document.getElementById('data-display').textContent = JSON.stringify(activities, null, 2);
      } catch (error) {
        document.getElementById('data-display').textContent = 'Error: ' + error.message;
      }
    });

    // Export
    document.getElementById('export-btn').addEventListener('click', async () => {
      try {
        await window.formAdapter.exportUserData();
        document.getElementById('export-result').innerHTML = '<p style="color: #0f0;">âœ… Data exported successfully!</p>';
      } catch (error) {
        document.getElementById('export-result').innerHTML = `<p style="color: #f00;">âŒ ${error.message}</p>`;
      }
    });

    // Import
    document.getElementById('import-btn').addEventListener('click', () => {
      document.getElementById('import-file').click();
    });

    document.getElementById('import-file').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        const result = await window.formAdapter.importUserData(file);
        document.getElementById('export-result').innerHTML = `<p style="color: #0f0;">âœ… ${result.message}</p>`;
      } catch (error) {
        document.getElementById('export-result').innerHTML = `<p style="color: #f00;">âŒ ${error.message}</p>`;
      }
    });

    // Clear all
    document.getElementById('clear-btn').addEventListener('click', async () => {
      if (!confirm('âš ï¸ This will delete ALL your local data! Continue?')) return;

      try {
        await window.localDB.clearAllData();
        window.localStore.clearAll();
        document.getElementById('export-result').innerHTML = '<p style="color: #0f0;">âœ… All data cleared!</p>';
        setTimeout(() => location.reload(), 1000);
      } catch (error) {
        document.getElementById('export-result').innerHTML = `<p style="color: #f00;">âŒ ${error.message}</p>`;
      }
    });

    // Encrypt test
    document.getElementById('encrypt-btn').addEventListener('click', async () => {
      const input = document.getElementById('encrypt-input').value;
      if (!input) return;

      try {
        const wallet = window.walletManager?.connectedWallet || 'test_wallet';
        const encrypted = await window.cryptoManager.encrypt(wallet, input);
        const decrypted = await window.cryptoManager.decrypt(wallet, encrypted);

        document.getElementById('encrypt-result').innerHTML = `
          <p><strong>Original:</strong> ${input}</p>
          <p><strong>Encrypted:</strong> ${encrypted}</p>
          <p><strong>Decrypted:</strong> ${decrypted}</p>
          <p style="color: #0f0;">âœ… Encryption working!</p>
        `;
      } catch (error) {
        document.getElementById('encrypt-result').innerHTML = `<p style="color: #f00;">âŒ ${error.message}</p>`;
      }
    });

    // Initialize on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>

  <style>
    .pixel-btn {
      padding: 0.75rem 1.5rem;
      background: #0f0;
      color: #000;
      border: 2px solid #000;
      font-family: monospace;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    .pixel-btn:hover {
      background: #0c0;
      transform: translateY(-2px);
      box-shadow: 0 4px 0 #000;
    }

    .pixel-title {
      font-family: monospace;
      color: #0f0;
      text-shadow: 2px 2px 0 #000;
    }

    .pixel-border {
      border: 4px solid #0f0;
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
    }
  </style>
</BaseLayout>
