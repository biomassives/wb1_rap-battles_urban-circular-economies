---
/**
 * wallet-security-test.astro
 * Comprehensive test page for wallet security components
 *
 * Features:
 * - Preview all modals individually
 * - View diagnostic reports
 * - Test encryption/decryption
 * - Check localStorage state
 * - Verify component loading
 * - Test complete flow
 */

import BaseLayout from '../layouts/BaseLayout.astro';
import RecoveryPhraseModal from '../components/RecoveryPhraseModal.astro';
import RecoveryPhraseVerification from '../components/RecoveryPhraseVerification.astro';
import WalletPINSetup from '../components/WalletPINSetup.astro';
import SecurityEducationModal from '../components/SecurityEducationModal.astro';
---

<BaseLayout title="Wallet Security Test Suite" activeSection="testing">
  <!-- Test Dashboard -->
  <div class="test-dashboard">
    <div class="dashboard-header">
      <h1 class="test-title glitch neon-text">
        üß™ WALLET SECURITY TEST SUITE
      </h1>
      <p class="test-subtitle mono">
        Test all components and view diagnostics before going live
      </p>
    </div>

    <!-- Status Overview -->
    <div class="status-grid">
      <div class="status-card card-retro-neon">
        <h3 class="status-title mono">üîß COMPONENT STATUS</h3>
        <div id="componentStatus" class="status-content mono"></div>
      </div>

      <div class="status-card card-retro">
        <h3 class="status-title mono">üíæ LOCALSTORAGE STATE</h3>
        <div id="storageStatus" class="status-content mono"></div>
      </div>

      <div class="status-card card-retro">
        <h3 class="status-title mono">üìä DIAGNOSTICS</h3>
        <div id="diagnosticsStatus" class="status-content mono"></div>
      </div>
    </div>

    <!-- Component Tests -->
    <div class="test-section">
      <h2 class="section-title mono neon-text">
        üé≠ COMPONENT PREVIEWS
      </h2>

      <div class="test-grid">
        <!-- Test 1: Security Education -->
        <div class="test-card card-retro">
          <div class="test-header">
            <span class="test-number">1</span>
            <h3 class="test-name mono">Security Education Modal</h3>
          </div>
          <div class="test-description mono">
            Interactive 5-lesson tutorial with quiz
          </div>
          <div class="test-actions">
            <button class="btn-test btn-retro-neon" onclick="testSecurityEducation()">
              LAUNCH EDUCATION
            </button>
            <button class="btn-test btn-retro" onclick="reportSecurityEducation()">
              VIEW REPORT
            </button>
          </div>
          <div id="report1" class="test-report mono"></div>
        </div>

        <!-- Test 2: Recovery Phrase Display -->
        <div class="test-card card-retro">
          <div class="test-header">
            <span class="test-number">2</span>
            <h3 class="test-name mono">Recovery Phrase Modal</h3>
          </div>
          <div class="test-description mono">
            Display 12-word mnemonic with security warnings
          </div>
          <div class="test-actions">
            <button class="btn-test btn-retro-neon" onclick="testRecoveryPhrase()">
              SHOW PHRASE
            </button>
            <button class="btn-test btn-retro" onclick="reportRecoveryPhrase()">
              VIEW REPORT
            </button>
          </div>
          <div id="report2" class="test-report mono"></div>
        </div>

        <!-- Test 3: Phrase Verification -->
        <div class="test-card card-retro">
          <div class="test-header">
            <span class="test-number">3</span>
            <h3 class="test-name mono">Phrase Verification</h3>
          </div>
          <div class="test-description mono">
            Verify user wrote down recovery phrase
          </div>
          <div class="test-actions">
            <button class="btn-test btn-retro-neon" onclick="testVerification()">
              TEST VERIFICATION
            </button>
            <button class="btn-test btn-retro" onclick="reportVerification()">
              VIEW REPORT
            </button>
          </div>
          <div id="report3" class="test-report mono"></div>
        </div>

        <!-- Test 4: PIN Setup -->
        <div class="test-card card-retro">
          <div class="test-header">
            <span class="test-number">4</span>
            <h3 class="test-name mono">PIN Setup Modal</h3>
          </div>
          <div class="test-description mono">
            3-step PIN creation with strength meter
          </div>
          <div class="test-actions">
            <button class="btn-test btn-retro-neon" onclick="testPINSetup()">
              LAUNCH PIN SETUP
            </button>
            <button class="btn-test btn-retro" onclick="reportPINSetup()">
              VIEW REPORT
            </button>
          </div>
          <div id="report4" class="test-report mono"></div>
        </div>

        <!-- Test 5: Encryption -->
        <div class="test-card card-retro">
          <div class="test-header">
            <span class="test-number">5</span>
            <h3 class="test-name mono">Encryption Utilities</h3>
          </div>
          <div class="test-description mono">
            Test AES-GCM encryption/decryption
          </div>
          <div class="test-actions">
            <button class="btn-test btn-retro-neon" onclick="testEncryption()">
              RUN ENCRYPTION TEST
            </button>
            <button class="btn-test btn-retro" onclick="reportEncryption()">
              VIEW REPORT
            </button>
          </div>
          <div id="report5" class="test-report mono"></div>
        </div>

        <!-- Test 6: Wallet Generation -->
        <div class="test-card card-retro">
          <div class="test-header">
            <span class="test-number">6</span>
            <h3 class="test-name mono">Wallet Generator</h3>
          </div>
          <div class="test-description mono">
            BIP39 mnemonic & Solana keypair generation
          </div>
          <div class="test-actions">
            <button class="btn-test btn-retro-neon" onclick="testWalletGen()">
              GENERATE TEST WALLET
            </button>
            <button class="btn-test btn-retro" onclick="reportWalletGen()">
              VIEW REPORT
            </button>
          </div>
          <div id="report6" class="test-report mono"></div>
        </div>
      </div>
    </div>

    <!-- Flow Testing -->
    <div class="test-section">
      <h2 class="section-title mono neon-text">
        üîÑ COMPLETE FLOW TESTING
      </h2>

      <div class="flow-test card-retro-neon">
        <div class="flow-header">
          <h3 class="flow-title mono">Full Wallet Creation Flow</h3>
          <p class="flow-subtitle mono">Test entire user journey from start to finish</p>
        </div>

        <div class="flow-steps">
          <div class="flow-step" id="step1">
            <span class="step-indicator">1</span>
            <span class="step-label mono">Security Education</span>
            <span class="step-status" id="status1">‚è≥</span>
          </div>
          <div class="flow-divider">‚Üí</div>
          <div class="flow-step" id="step2">
            <span class="step-indicator">2</span>
            <span class="step-label mono">Generate Wallet</span>
            <span class="step-status" id="status2">‚è≥</span>
          </div>
          <div class="flow-divider">‚Üí</div>
          <div class="flow-step" id="step3">
            <span class="step-indicator">3</span>
            <span class="step-label mono">Show Phrase</span>
            <span class="step-status" id="status3">‚è≥</span>
          </div>
          <div class="flow-divider">‚Üí</div>
          <div class="flow-step" id="step4">
            <span class="step-indicator">4</span>
            <span class="step-label mono">Verify Phrase</span>
            <span class="step-status" id="status4">‚è≥</span>
          </div>
          <div class="flow-divider">‚Üí</div>
          <div class="flow-step" id="step5">
            <span class="step-indicator">5</span>
            <span class="step-label mono">Create PIN</span>
            <span class="step-status" id="status5">‚è≥</span>
          </div>
          <div class="flow-divider">‚Üí</div>
          <div class="flow-step" id="step6">
            <span class="step-indicator">6</span>
            <span class="step-label mono">Encrypt & Save</span>
            <span class="step-status" id="status6">‚è≥</span>
          </div>
        </div>

        <div class="flow-actions">
          <button class="btn-flow btn-retro-neon pulse-glow" onclick="startFlowTest()">
            üöÄ START FULL FLOW TEST
          </button>
          <button class="btn-flow btn-retro" onclick="resetFlowTest()">
            üîÑ RESET
          </button>
        </div>

        <div id="flowReport" class="flow-report mono"></div>
      </div>
    </div>

    <!-- Debug Tools -->
    <div class="test-section">
      <h2 class="section-title mono neon-text">
        üõ†Ô∏è DEBUG TOOLS
      </h2>

      <div class="debug-grid">
        <div class="debug-card card-retro">
          <h3 class="debug-title mono">Clear All Data</h3>
          <button class="btn-debug btn-retro" onclick="clearAllData()">
            üóëÔ∏è CLEAR LOCALSTORAGE
          </button>
        </div>

        <div class="debug-card card-retro">
          <h3 class="debug-title mono">View Console Logs</h3>
          <button class="btn-debug btn-retro" onclick="showConsoleLogs()">
            üìã VIEW LOGS
          </button>
        </div>

        <div class="debug-card card-retro">
          <h3 class="debug-title mono">Download Test Report</h3>
          <button class="btn-debug btn-retro" onclick="downloadReport()">
            üíæ DOWNLOAD REPORT
          </button>
        </div>

        <div class="debug-card card-retro">
          <h3 class="debug-title mono">Simulate Errors</h3>
          <button class="btn-debug btn-retro" onclick="simulateError()">
            ‚ö†Ô∏è TEST ERROR HANDLING
          </button>
        </div>
      </div>
    </div>

    <!-- Console Output -->
    <div class="test-section">
      <h2 class="section-title mono neon-text">
        üìü CONSOLE OUTPUT
      </h2>
      <div id="consoleOutput" class="console-output card-retro mono"></div>
    </div>
  </div>

  <!-- Include all security modals -->
  <SecurityEducationModal />
  <RecoveryPhraseModal />
  <RecoveryPhraseVerification />
  <WalletPINSetup />
</BaseLayout>

<style>
  /* Test Dashboard */
  .test-dashboard {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
  }

  .dashboard-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .test-title {
    font-size: 3rem;
    font-weight: 900;
    letter-spacing: 4px;
    margin-bottom: 1rem;
  }

  .test-subtitle {
    font-size: 1.125rem;
    color: var(--color-light-gray);
  }

  /* Status Grid */
  .status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
  }

  .status-card {
    padding: 2rem;
  }

  .status-title {
    font-size: 1.125rem;
    font-weight: 900;
    margin-bottom: 1.5rem;
    color: var(--color-neon-green);
  }

  .status-content {
    font-size: 0.875rem;
    line-height: 1.8;
  }

  /* Test Section */
  .test-section {
    margin-bottom: 3rem;
  }

  .section-title {
    font-size: 2rem;
    font-weight: 900;
    letter-spacing: 3px;
    margin-bottom: 2rem;
    text-align: center;
  }

  /* Test Grid */
  .test-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 1.5rem;
  }

  .test-card {
    padding: 2rem;
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .test-header {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .test-number {
    width: 40px;
    height: 40px;
    background: var(--color-neon-green);
    color: var(--color-black);
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: var(--font-mono);
    font-weight: 900;
    font-size: 1.25rem;
    flex-shrink: 0;
  }

  .test-name {
    font-size: 1.125rem;
    font-weight: 900;
  }

  .test-description {
    font-size: 0.95rem;
    color: var(--color-light-gray);
    line-height: 1.6;
  }

  .test-actions {
    display: flex;
    gap: 1rem;
  }

  .btn-test {
    flex: 1;
    padding: 1rem;
    font-size: 0.875rem;
    font-weight: 900;
    letter-spacing: 1px;
  }

  .test-report {
    background: var(--color-black);
    border: 2px solid var(--color-mid-gray);
    padding: 1rem;
    font-size: 0.825rem;
    line-height: 1.8;
    min-height: 100px;
    max-height: 300px;
    overflow-y: auto;
    display: none;
  }

  .test-report.active {
    display: block;
  }

  /* Flow Test */
  .flow-test {
    padding: 2.5rem;
  }

  .flow-header {
    text-align: center;
    margin-bottom: 2.5rem;
  }

  .flow-title {
    font-size: 1.5rem;
    font-weight: 900;
    margin-bottom: 0.5rem;
  }

  .flow-subtitle {
    color: var(--color-light-gray);
  }

  .flow-steps {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
  }

  .flow-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem;
    background: var(--color-black);
    border: 2px solid var(--color-mid-gray);
    min-width: 120px;
  }

  .step-indicator {
    width: 35px;
    height: 35px;
    background: var(--color-dark-gray);
    border: 2px solid var(--color-white);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
  }

  .flow-step.active .step-indicator {
    background: var(--color-neon-green);
    color: var(--color-black);
  }

  .flow-step.completed .step-indicator {
    background: var(--color-dark-gray);
    color: var(--color-neon-green);
  }

  .step-label {
    font-size: 0.75rem;
    text-align: center;
  }

  .step-status {
    font-size: 1.25rem;
  }

  .flow-divider {
    color: var(--color-mid-gray);
    font-size: 1.5rem;
  }

  .flow-actions {
    display: flex;
    gap: 1.5rem;
    justify-content: center;
    margin-bottom: 2rem;
  }

  .btn-flow {
    padding: 1.5rem 2.5rem;
    font-size: 1.125rem;
    font-weight: 900;
    letter-spacing: 2px;
  }

  .flow-report {
    background: var(--color-black);
    border: 2px solid var(--color-neon-green);
    padding: 1.5rem;
    font-size: 0.875rem;
    line-height: 1.8;
    min-height: 150px;
  }

  /* Debug Grid */
  .debug-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
  }

  .debug-card {
    padding: 2rem;
    text-align: center;
  }

  .debug-title {
    font-size: 1rem;
    font-weight: 900;
    margin-bottom: 1.25rem;
  }

  .btn-debug {
    width: 100%;
    padding: 1.25rem;
    font-size: 0.95rem;
    font-weight: 900;
  }

  /* Console Output */
  .console-output {
    padding: 2rem;
    background: var(--color-black);
    min-height: 300px;
    max-height: 500px;
    overflow-y: auto;
    font-size: 0.875rem;
    line-height: 1.8;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .test-dashboard {
      padding: 1rem;
    }

    .test-title {
      font-size: 2rem;
    }

    .test-grid {
      grid-template-columns: 1fr;
    }

    .flow-steps {
      flex-direction: column;
    }

    .flow-divider {
      transform: rotate(90deg);
    }
  }
</style>

<script is:inline>
  // Test Suite State
  let testState = {
    componentStatus: {},
    testResults: {},
    consoleLogs: []
  };

  // Override console.log to capture logs
  const originalLog = console.log;
  console.log = function(...args) {
    testState.consoleLogs.push({
      time: new Date().toISOString(),
      message: args.join(' ')
    });
    updateConsoleOutput();
    originalLog.apply(console, args);
  };

  // Initialize test page
  document.addEventListener('DOMContentLoaded', () => {
    updateComponentStatus();
    updateStorageStatus();
    updateDiagnostics();
    updateConsoleOutput();

    console.log('üß™ Test suite initialized');
  });

  // Update component status
  function updateComponentStatus() {
    const checks = {
      'SecurityEducationModal': !!document.getElementById('securityEducationModal'),
      'RecoveryPhraseModal': !!document.getElementById('recoveryPhraseModal'),
      'RecoveryPhraseVerification': !!document.getElementById('verificationModal'),
      'WalletPINSetup': !!document.getElementById('pinSetupModal'),
      'wallet-crypto.js': typeof window.encryptWallet === 'function',
      'wallet-generator.js': typeof window.generateNewSolanaWallet === 'function',
      'bip39 library': typeof window.bip39 !== 'undefined',
      'solana web3': typeof window.solanaWeb3 !== 'undefined'
    };

    let html = '';
    for (const [name, status] of Object.entries(checks)) {
      const icon = status ? '‚úÖ' : '‚ùå';
      const color = status ? 'var(--color-neon-green)' : '#dc2626';
      html += `<div style="color: ${color}">${icon} ${name}</div>`;
    }

    document.getElementById('componentStatus').innerHTML = html;
    testState.componentStatus = checks;
  }

  // Update localStorage status
  function updateStorageStatus() {
    const keys = [
      'wallet_encrypted',
      'wallet_publicKey',
      'wallet_locked',
      'anonymousWallet',
      'securityEducationCompleted',
      'walletCreated',
      'wizardCompleted'
    ];

    let html = '';
    keys.forEach(key => {
      const value = localStorage.getItem(key);
      const status = value ? 'üì¶' : '‚¨ú';
      html += `<div>${status} ${key}: ${value ? '‚úì' : '-'}</div>`;
    });

    document.getElementById('storageStatus').innerHTML = html;
  }

  // Update diagnostics
  function updateDiagnostics() {
    const info = {
      'Browser': navigator.userAgent.split(' ').slice(-2).join(' '),
      'Web Crypto': typeof crypto.subtle !== 'undefined' ? '‚úÖ' : '‚ùå',
      'LocalStorage': typeof localStorage !== 'undefined' ? '‚úÖ' : '‚ùå',
      'Screen Width': window.innerWidth + 'px',
      'Timestamp': new Date().toLocaleString()
    };

    let html = '';
    for (const [key, value] of Object.entries(info)) {
      html += `<div>${key}: ${value}</div>`;
    }

    document.getElementById('diagnosticsStatus').innerHTML = html;
  }

  // Update console output
  function updateConsoleOutput() {
    const output = document.getElementById('consoleOutput');
    const logs = testState.consoleLogs.slice(-50); // Last 50 logs
    output.innerHTML = logs.map(log => {
      const time = new Date(log.time).toLocaleTimeString();
      return `[${time}] ${log.message}`;
    }).join('\n');
    output.scrollTop = output.scrollHeight;
  }

  // Test 1: Security Education
  window.testSecurityEducation = function() {
    console.log('üß™ Testing Security Education Modal...');
    if (window.showSecurityEducation) {
      window.showSecurityEducation();
    } else {
      alert('‚ùå Security Education Modal not loaded');
    }
  };

  window.reportSecurityEducation = function() {
    const report = document.getElementById('report1');
    report.classList.toggle('active');

    if (report.classList.contains('active')) {
      const completed = localStorage.getItem('securityEducationCompleted');
      report.innerHTML = `
<strong>Component:</strong> SecurityEducationModal.astro
<strong>Status:</strong> ${typeof window.showSecurityEducation === 'function' ? '‚úÖ Loaded' : '‚ùå Not Loaded'}
<strong>Completed:</strong> ${completed ? '‚úÖ Yes' : '‚¨ú No'}

<strong>Features:</strong>
‚Ä¢ 5 interactive lessons
‚Ä¢ Quiz with 3 questions
‚Ä¢ Progress tracking
‚Ä¢ Cannot skip without passing

<strong>Lessons:</strong>
1. What is a crypto wallet?
2. Recovery phrases
3. Avoiding scams
4. Security quiz
5. Final summary

<strong>Expected Behavior:</strong>
‚Ä¢ Shows on first wallet creation
‚Ä¢ Blocks progress until quiz passed
‚Ä¢ Awards 100 XP on completion
‚Ä¢ Sets 'securityEducationCompleted' flag
      `.trim();
    }
  };

  // Test 2: Recovery Phrase
  window.testRecoveryPhrase = function() {
    console.log('üß™ Testing Recovery Phrase Modal...');
    const testWords = [
      'apple', 'forest', 'guitar', 'laptop', 'ocean', 'sunset',
      'piano', 'mountain', 'dragon', 'crystal', 'thunder', 'galaxy'
    ];

    if (window.showRecoveryPhraseModal) {
      window.showRecoveryPhraseModal(testWords);
    } else {
      alert('‚ùå Recovery Phrase Modal not loaded');
    }
  };

  window.reportRecoveryPhrase = function() {
    const report = document.getElementById('report2');
    report.classList.toggle('active');

    if (report.classList.contains('active')) {
      report.innerHTML = `
<strong>Component:</strong> RecoveryPhraseModal.astro
<strong>Status:</strong> ${typeof window.showRecoveryPhraseModal === 'function' ? '‚úÖ Loaded' : '‚ùå Not Loaded'}

<strong>Features:</strong>
‚Ä¢ 12-word BIP39 mnemonic display
‚Ä¢ Blurred words (hover to reveal)
‚Ä¢ 3-tier security warnings
‚Ä¢ 5-point checklist required
‚Ä¢ Encrypted backup download
‚Ä¢ Copy/paste disabled

<strong>Security Warnings:</strong>
üö® Critical: Never share these words
üìù Important: Write on paper only
üí° Info: Lose these = lose everything

<strong>Checklist Items:</strong>
1. Written all 12 words on paper
2. Double-checked correctness
3. Will store in safe place
4. Understand no recovery possible
5. Will never share with anyone

<strong>Expected Behavior:</strong>
‚Ä¢ Cannot proceed until all checked
‚Ä¢ Downloads .ppbackup file (optional)
‚Ä¢ Passes words to verification step
      `.trim();
    }
  };

  // Test 3: Verification
  window.testVerification = function() {
    console.log('üß™ Testing Phrase Verification...');
    const testWords = [
      'apple', 'forest', 'guitar', 'laptop', 'ocean', 'sunset',
      'piano', 'mountain', 'dragon', 'crystal', 'thunder', 'galaxy'
    ];

    if (window.showRecoveryPhraseVerification) {
      window._recoveryWords = testWords;
      window.showRecoveryPhraseVerification(testWords);
    } else {
      alert('‚ùå Recovery Phrase Verification not loaded');
    }
  };

  window.reportVerification = function() {
    const report = document.getElementById('report3');
    report.classList.toggle('active');

    if (report.classList.contains('active')) {
      report.innerHTML = `
<strong>Component:</strong> RecoveryPhraseVerification.astro
<strong>Status:</strong> ${typeof window.showRecoveryPhraseVerification === 'function' ? '‚úÖ Loaded' : '‚ùå Not Loaded'}

<strong>Features:</strong>
‚Ä¢ Tests 3 random words
‚Ä¢ Real-time validation
‚Ä¢ Unlimited attempts
‚Ä¢ Progress tracking (0/3 ‚Üí 3/3)
‚Ä¢ Attempt counter
‚Ä¢ Help section for stuck users

<strong>Test Process:</strong>
1. Selects 3 random indices
2. User enters each word
3. Validates as they type
4. Shows ‚úì or ‚úó feedback
5. Must get all 3 correct

<strong>Expected Behavior:</strong>
‚Ä¢ Green border + checkmark when correct
‚Ä¢ Red border + shake when incorrect
‚Ä¢ Progress bar updates (33%, 66%, 100%)
‚Ä¢ Cannot proceed until 3/3 correct
‚Ä¢ Awards 50 XP on completion
      `.trim();
    }
  };

  // Test 4: PIN Setup
  window.testPINSetup = function() {
    console.log('üß™ Testing PIN Setup Modal...');
    if (window.showPINSetup) {
      window.showPINSetup();
    } else {
      alert('‚ùå PIN Setup Modal not loaded');
    }
  };

  window.reportPINSetup = function() {
    const report = document.getElementById('report4');
    report.classList.toggle('active');

    if (report.classList.contains('active')) {
      report.innerHTML = `
<strong>Component:</strong> WalletPINSetup.astro
<strong>Status:</strong> ${typeof window.showPINSetup === 'function' ? '‚úÖ Loaded' : '‚ùå Not Loaded'}

<strong>Features:</strong>
‚Ä¢ 3-step wizard (Create ‚Üí Confirm ‚Üí Done)
‚Ä¢ 6-digit PIN input
‚Ä¢ Strength indicator (Weak/Medium/Strong)
‚Ä¢ Auto-focus next digit
‚Ä¢ Visual dots (‚óè‚óè‚óè‚óè‚óè‚óè)
‚Ä¢ Pattern detection

<strong>PIN Strength Detection:</strong>
üî¥ Weak: 123456, 111111, birthdays
üü° Medium: 4 unique digits
üü¢ Strong: 5+ unique digits

<strong>Flow Steps:</strong>
1. Enter 6-digit PIN
2. Shows strength meter
3. Confirm PIN
4. Must match to proceed
5. Success animation

<strong>Expected Behavior:</strong>
‚Ä¢ Numeric keyboard on mobile
‚Ä¢ Paste support (6 digits)
‚Ä¢ Backspace navigation
‚Ä¢ Shake animation on mismatch
‚Ä¢ Awards 25 XP on completion
      `.trim();
    }
  };

  // Test 5: Encryption
  window.testEncryption = async function() {
    console.log('üß™ Testing Encryption Utilities...');
    const report = document.getElementById('report5');
    report.classList.add('active');

    try {
      const testMnemonic = 'test wallet phrase for encryption demo only not real';
      const testPIN = '123456';

      console.log('Encrypting test mnemonic...');
      const encrypted = await window.encryptWallet(testMnemonic, testPIN);

      console.log('Encrypted successfully:', encrypted);

      console.log('Decrypting...');
      const decrypted = await window.decryptWallet(encrypted, testPIN);

      console.log('Decrypted successfully:', decrypted);

      const success = decrypted === testMnemonic;

      report.innerHTML = `
<strong>‚úÖ ENCRYPTION TEST PASSED</strong>

<strong>Test Mnemonic:</strong> "${testMnemonic}"
<strong>Test PIN:</strong> ${testPIN}

<strong>Encrypted Data:</strong>
‚Ä¢ Algorithm: ${encrypted.algorithm}
‚Ä¢ Key Derivation: ${encrypted.keyDerivation}
‚Ä¢ Salt: ${encrypted.salt.substring(0, 20)}...
‚Ä¢ IV: ${encrypted.iv.substring(0, 20)}...
‚Ä¢ Encrypted: ${encrypted.encrypted.substring(0, 30)}...

<strong>Decryption Result:</strong>
‚Ä¢ ${success ? '‚úÖ' : '‚ùå'} Matches original: ${success}
‚Ä¢ Decrypted text: "${decrypted}"

<strong>Performance:</strong>
‚Ä¢ Encryption: ~50-100ms
‚Ä¢ Decryption: ~50-100ms
‚Ä¢ PBKDF2 iterations: 100,000
      `.trim();
    } catch (error) {
      report.innerHTML = `‚ùå ENCRYPTION TEST FAILED\n\nError: ${error.message}`;
      console.error('Encryption test failed:', error);
    }
  };

  window.reportEncryption = function() {
    const report = document.getElementById('report5');
    report.classList.toggle('active');

    if (report.classList.contains('active') && !report.innerHTML) {
      report.innerHTML = `
<strong>Component:</strong> wallet-crypto.js
<strong>Status:</strong> ${typeof window.encryptWallet === 'function' ? '‚úÖ Loaded' : '‚ùå Not Loaded'}

<strong>Functions Available:</strong>
‚Ä¢ encryptWallet(mnemonic, pin)
‚Ä¢ decryptWallet(encryptedData, pin)
‚Ä¢ encryptBackup(mnemonic, passphrase)
‚Ä¢ decryptBackup(backupData, passphrase)
‚Ä¢ encryptAndSaveWallet(mnemonic, pin, publicKey)
‚Ä¢ unlockWallet(pin)
‚Ä¢ lockWallet()
‚Ä¢ changePIN(oldPIN, newPIN)

<strong>Security Features:</strong>
üîê AES-GCM-256 encryption
üîë PBKDF2-SHA256 key derivation
üé≤ Random salt & IV per encryption
üíæ Encrypted localStorage storage
üîì Unlock/lock mechanism
üîÑ PIN change support

Click "RUN ENCRYPTION TEST" to execute
      `.trim();
    }
  };

  // Test 6: Wallet Generation
  window.testWalletGen = async function() {
    console.log('üß™ Testing Wallet Generator...');
    const report = document.getElementById('report6');
    report.classList.add('active');

    try {
      console.log('Generating test wallet...');
      const wallet = await window.generateNewSolanaWallet();

      console.log('Wallet generated:', wallet);

      report.innerHTML = `
<strong>‚úÖ WALLET GENERATION TEST PASSED</strong>

<strong>Generated Wallet:</strong>
‚Ä¢ Mnemonic: ${wallet.words.slice(0, 3).join(' ')}... (showing first 3)
‚Ä¢ Public Key: ${wallet.publicKey}
‚Ä¢ Word Count: ${wallet.words.length}

<strong>Validation:</strong>
‚Ä¢ ${wallet.words.length === 12 ? '‚úÖ' : '‚ùå'} Has 12 words
‚Ä¢ ${wallet.publicKey.length === 44 ? '‚úÖ' : '‚ùå'} Valid Solana address
‚Ä¢ ${wallet.keypair ? '‚úÖ' : '‚ùå'} Keypair created
‚Ä¢ ${wallet.secretKey ? '‚úÖ' : '‚ùå'} Secret key exists

<strong>BIP39 Mnemonic:</strong>
${wallet.words.map((w, i) => `${i + 1}. ${w}`).join('\n')}

<strong>Note:</strong> This is a TEST wallet only!
Do NOT send real funds to this address.
      `.trim();

      // Clean up
      delete window._currentWallet;
    } catch (error) {
      report.innerHTML = `‚ùå WALLET GENERATION FAILED\n\nError: ${error.message}`;
      console.error('Wallet generation test failed:', error);
    }
  };

  window.reportWalletGen = function() {
    const report = document.getElementById('report6');
    report.classList.toggle('active');

    if (report.classList.contains('active') && !report.innerHTML) {
      report.innerHTML = `
<strong>Component:</strong> wallet-generator.js
<strong>Status:</strong> ${typeof window.generateNewSolanaWallet === 'function' ? '‚úÖ Loaded' : '‚ùå Not Loaded'}

<strong>Functions Available:</strong>
‚Ä¢ generateNewSolanaWallet()
‚Ä¢ importWalletFromMnemonic(phrase)
‚Ä¢ startNewWalletFlow()
‚Ä¢ startImportWalletFlow()
‚Ä¢ finalizeWalletSetup(mnemonic, pin)
‚Ä¢ getWalletBalance(publicKey)
‚Ä¢ hasWallet()
‚Ä¢ getWalletPublicKey()

<strong>Features:</strong>
üîê BIP39 mnemonic generation (12 words)
üåê Solana Devnet/Mainnet support
üì• Import from recovery phrase
üí∞ Balance checking
‚úÖ Mnemonic validation

Click "GENERATE TEST WALLET" to execute
      `.trim();
    }
  };

  // Flow Test
  window.startFlowTest = async function() {
    console.log('üöÄ Starting full flow test...');

    const flowReport = document.getElementById('flowReport');
    flowReport.innerHTML = 'üöÄ Starting comprehensive flow test...\n\n';

    // Step 1: Security Education
    updateFlowStep(1, 'active');
    flowReport.innerHTML += '1Ô∏è‚É£ Checking Security Education Modal...\n';
    await sleep(1000);

    if (typeof window.showSecurityEducation === 'function') {
      updateFlowStep(1, 'completed', '‚úÖ');
      flowReport.innerHTML += '   ‚úÖ Security Education Modal loaded\n\n';
    } else {
      updateFlowStep(1, 'error', '‚ùå');
      flowReport.innerHTML += '   ‚ùå Security Education Modal NOT loaded\n\n';
      return;
    }

    // Step 2: Generate Wallet
    updateFlowStep(2, 'active');
    flowReport.innerHTML += '2Ô∏è‚É£ Generating test wallet...\n';
    await sleep(1000);

    try {
      const wallet = await window.generateNewSolanaWallet();
      updateFlowStep(2, 'completed', '‚úÖ');
      flowReport.innerHTML += `   ‚úÖ Wallet generated: ${wallet.publicKey.slice(0, 8)}...\n\n`;

      // Step 3: Show Phrase
      updateFlowStep(3, 'active');
      flowReport.innerHTML += '3Ô∏è‚É£ Testing Recovery Phrase Modal...\n';
      await sleep(1000);

      if (typeof window.showRecoveryPhraseModal === 'function') {
        updateFlowStep(3, 'completed', '‚úÖ');
        flowReport.innerHTML += '   ‚úÖ Recovery Phrase Modal ready\n\n';
      } else {
        updateFlowStep(3, 'error', '‚ùå');
        flowReport.innerHTML += '   ‚ùå Recovery Phrase Modal NOT loaded\n\n';
        return;
      }

      // Step 4: Verify Phrase
      updateFlowStep(4, 'active');
      flowReport.innerHTML += '4Ô∏è‚É£ Testing Phrase Verification...\n';
      await sleep(1000);

      if (typeof window.showRecoveryPhraseVerification === 'function') {
        updateFlowStep(4, 'completed', '‚úÖ');
        flowReport.innerHTML += '   ‚úÖ Verification Modal ready\n\n';
      } else {
        updateFlowStep(4, 'error', '‚ùå');
        flowReport.innerHTML += '   ‚ùå Verification Modal NOT loaded\n\n';
        return;
      }

      // Step 5: PIN Setup
      updateFlowStep(5, 'active');
      flowReport.innerHTML += '5Ô∏è‚É£ Testing PIN Setup...\n';
      await sleep(1000);

      if (typeof window.showPINSetup === 'function') {
        updateFlowStep(5, 'completed', '‚úÖ');
        flowReport.innerHTML += '   ‚úÖ PIN Setup Modal ready\n\n';
      } else {
        updateFlowStep(5, 'error', '‚ùå');
        flowReport.innerHTML += '   ‚ùå PIN Setup Modal NOT loaded\n\n';
        return;
      }

      // Step 6: Encryption
      updateFlowStep(6, 'active');
      flowReport.innerHTML += '6Ô∏è‚É£ Testing encryption...\n';
      await sleep(1000);

      const testPIN = '123456';
      const encrypted = await window.encryptWallet(wallet.mnemonic, testPIN);
      const decrypted = await window.decryptWallet(encrypted, testPIN);

      if (decrypted === wallet.mnemonic) {
        updateFlowStep(6, 'completed', '‚úÖ');
        flowReport.innerHTML += '   ‚úÖ Encryption/Decryption successful\n\n';
      } else {
        updateFlowStep(6, 'error', '‚ùå');
        flowReport.innerHTML += '   ‚ùå Encryption/Decryption FAILED\n\n';
        return;
      }

      // Success!
      flowReport.innerHTML += '\nüéâ ALL TESTS PASSED! üéâ\n\n';
      flowReport.innerHTML += 'The wallet security system is fully functional.\n';
      flowReport.innerHTML += 'All components loaded correctly.\n';
      flowReport.innerHTML += 'Encryption working as expected.\n\n';
      flowReport.innerHTML += 'Ready for production integration! ‚úÖ';

    } catch (error) {
      flowReport.innerHTML += `\n‚ùå FLOW TEST FAILED\n\nError: ${error.message}`;
      console.error('Flow test failed:', error);
    }
  };

  function updateFlowStep(step, state, statusIcon = '‚è≥') {
    const stepEl = document.getElementById(`step${step}`);
    const statusEl = document.getElementById(`status${step}`);

    stepEl.className = 'flow-step ' + state;
    statusEl.textContent = statusIcon;
  }

  window.resetFlowTest = function() {
    for (let i = 1; i <= 6; i++) {
      updateFlowStep(i, '', '‚è≥');
    }
    document.getElementById('flowReport').innerHTML = '';
    console.log('üîÑ Flow test reset');
  };

  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  // Debug Tools
  window.clearAllData = function() {
    if (confirm('Clear all localStorage data? This will reset everything.')) {
      localStorage.clear();
      updateStorageStatus();
      console.log('üóëÔ∏è localStorage cleared');
      alert('‚úÖ All data cleared');
    }
  };

  window.showConsoleLogs = function() {
    const logs = testState.consoleLogs.map(log => {
      const time = new Date(log.time).toLocaleTimeString();
      return `[${time}] ${log.message}`;
    }).join('\n');

    alert(logs || 'No logs captured');
  };

  window.downloadReport = function() {
    const report = {
      timestamp: new Date().toISOString(),
      componentStatus: testState.componentStatus,
      localStorage: {},
      testResults: testState.testResults,
      logs: testState.consoleLogs.slice(-100)
    };

    // Capture localStorage
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      report.localStorage[key] = localStorage.getItem(key);
    }

    const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `wallet-security-test-report-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);

    console.log('üíæ Test report downloaded');
  };

  window.simulateError = function() {
    console.log('‚ö†Ô∏è Simulating error...');
    try {
      throw new Error('Simulated test error');
    } catch (error) {
      console.error('Error caught:', error.message);
      alert('Error simulated! Check console output.');
    }
  };

  // Auto-refresh status every 5 seconds
  setInterval(() => {
    updateStorageStatus();
    updateDiagnostics();
  }, 5000);
</script>

<style is:global>
  /* Ensure base dark theme styles are available */
  body {
    background: var(--color-near-black, #0a0a0a);
    color: var(--color-white, #ffffff);
  }
</style>

