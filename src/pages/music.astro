---
/**
 * music.astro
 * Music Studio - Track Creation, Rap Battles & Collaborations
 * 
 * Features:
 * - Track upload form (audio, metadata, lyrics)
 * - Rap battle arena (create/join battles)
 * - Collaboration board (find partners, start projects)
 * - User's music library
 */

import BaseLayout from '../layouts/BaseLayout.astro';
const steps = Array.from({ length: 16 });

// You can also define your tracks here for better scaling
const tracks = ["kick", "snare", "hihat", "reggaeton"];
---

<style>
/* Base Container Styling */
.beatmaker-container {
  font-family: system-ui, -apple-system, sans-serif;
  background: #1a1a1a;
  color: #efefef;
  padding: 2rem;
  border-radius: 12px;
  border: 1px solid #333;
  max-width: 800px;
  margin: 0 auto;
}

/* Mode Toggle Styling */
.beatmaker-mode-toggle {
  display: flex;
  gap: 1rem;
  background: #2a2a2a;
  padding: 0.5rem;
  border-radius: 8px;
  width: fit-content;
}

.mode-btn {
  background: transparent;
  border: none;
  color: #888;
  padding: 0.5rem 1rem;
  cursor: pointer;
  transition: all 0.2s ease;
  border-radius: 6px;
}

.mode-btn.active {
  background: #007bff;
  color: white;
  box-shadow: 0 2px 8px rgba(0, 123, 255, 0.4);
}

/* The Sequencer/Sampler Grid */
.sampler-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1rem;
  margin-top: 2rem;
}

/* Individual Pad Styling */
.pad {
  aspect-ratio: 1 / 1;
  background: linear-gradient(145deg, #333, #222);
  border: 2px solid #444;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: transform 0.1s, box-shadow 0.1s;
  position: relative;
}

.pad:active, .pad.playing {
  transform: scale(0.95);
  background: #00ff88; /* High visibility for accessibility */
  box-shadow: 0 0 15px #00ff88;
  border-color: #fff;
}

.pad-label {
  font-size: 0.75rem;
  text-transform: uppercase;
  font-weight: bold;
  pointer-events: none;
}
</style>
<BaseLayout 
  title="Music Studio" 
  description="Create tracks, battle opponents, and collaborate with artists worldwide"
  activeSection="music"
  includeMusicPlayer={true}
>

  <!-- ============================================ -->
  <!-- STUDIO NAVIGATION TABS -->
  <!-- ============================================ -->
  <section class="studio-header">
    <div class="container mx-auto">
      <div class="studio-nav-tabs">
        <button class="studio-tab active" data-tab="create">
          <span class="tab-icon">üé§</span>
          <span class="tab-label">Create Track</span>
        </button>
        <button class="studio-tab" data-tab="beatmaker">
          <span class="tab-icon">üéπ</span>
          <span class="tab-label">Beat Maker</span>
        </button>
        <button class="studio-tab" data-tab="battles">
          <span class="tab-icon">‚öîÔ∏è</span>
          <span class="tab-label">Rap Battles</span>
          <span class="tab-badge" id="battle-invites">0</span>
        </button>
        <button class="studio-tab" data-tab="collabs">
          <span class="tab-icon">ü§ù</span>
          <span class="tab-label">Collaborations</span>
          <span class="tab-badge" id="collab-requests">0</span>
        </button>

        <!-- ‚úÖ Safe: plain HTML, emoji works -->
        <button class="studio-tab" data-tab="library">
         <span class="tab-icon">üìö</span>
         <span class="tab-label">My Library</span>
        </button>
      </div>
    </div>
  </section>

  <section id="tab-create" class="studio-tab-content active">
    <div class="container mx-auto">
      
      <div class="create-track-layout">
        
        <div class="track-form-container">
          <h2 class="section-title">Upload New Track</h2>
          <p class="section-subtitle">Share your music with the community (+100 XP)</p>

          <form id="track-upload-form" class="track-form">
            
            <div class="form-group">
              <label for="track-title" class="form-label">
                Track Title *
              </label>
              <input 
                type="text" 
                id="track-title" 
                name="title"
                class="form-input" 
                placeholder="My Awesome Track"
                required
                maxlength="200"
              />
              <span class="form-hint">Maximum 200 characters</span>
            </div>

            <!-- Genre Selection -->
            <div class="form-group">
              <label for="track-genre" class="form-label">
                Genre *
              </label>
              <select id="track-genre" name="genre" class="form-select" required>
                <option value="">Select genre...</option>
                <option value="rap">Rap</option>
                <option value="hip-hop">Hip-Hop</option>
                <option value="reggae">Reggae</option>
                <option value="dancehall">Dancehall</option>
                <option value="conscious">Conscious</option>
                <option value="fusion">Fusion</option>
                <option value="afrobeat">Afrobeat</option>
                <option value="other">Other</option>
              </select>
            </div>

            <!-- Audio File Upload -->
            <div class="form-group">
              <label for="audio-file" class="form-label">
                Audio File *
              </label>
              <div class="file-upload-area" id="audio-upload-area">
                <input 
                  type="file" 
                  id="audio-file" 
                  name="audioFile"
                  accept="audio/mp3,audio/wav,audio/m4a,audio/mpeg"
                  required
                  hidden
                />
                <div class="file-upload-content">
                  <div class="upload-icon">üéµ</div>
                  <p class="upload-text">
                    <strong>Click to upload</strong> or drag and drop
                  </p>
                  <p class="upload-hint">
                    MP3, WAV, or M4A (max 20MB)
                  </p>
                </div>
                <div class="file-selected" id="audio-file-selected" style="display: none;">
                  <span class="file-icon">üéµ</span>
                  <span class="file-name" id="audio-file-name"></span>
                  <span class="file-size" id="audio-file-size"></span>
                  <button type="button" class="btn-remove" onclick="removeAudioFile()">√ó</button>
                </div>
              </div>
              <!-- 
              TODO: Add audio preview player here
              Once file is uploaded, show waveform and play button
              -->
            </div>

            <!-- Cover Art Upload (Optional) -->
            <div class="form-group">
              <label for="cover-art" class="form-label">
                Cover Art (Optional)
              </label>
              <div class="file-upload-area small" id="cover-upload-area">
                <input 
                  type="file" 
                  id="cover-art" 
                  name="coverArt"
                  accept="image/jpeg,image/png,image/webp"
                  hidden
                />
                <div class="file-upload-content">
                  <div class="upload-icon">üñºÔ∏è</div>
                  <p class="upload-text">Upload cover art</p>
                  <p class="upload-hint">JPG, PNG, or WebP (max 5MB)</p>
                </div>
                <div class="cover-preview" id="cover-preview" style="display: none;">
                  <img id="cover-preview-img" src="" alt="Cover" />
                  <button type="button" class="btn-remove" onclick="removeCoverArt()">√ó</button>
                </div>
              </div>
            </div>

            <!-- Lyrics -->
            <div class="form-group">
              <label for="track-lyrics" class="form-label">
                Lyrics (Optional)
              </label>
              <textarea 
                id="track-lyrics" 
                name="lyrics"
                class="form-textarea" 
                rows="10"
                placeholder="[Verse 1]
Your lyrics here...

[Chorus]
..."
              ></textarea>
              <div class="form-actions-row">
                <span class="form-hint">Add your lyrics for listeners to follow along</span>
                <button type="button" class="btn-text" onclick="importLyrics()">
                  Import from file
                </button>
              </div>
            </div>

            <!-- Description -->
            <div class="form-group">
              <label for="track-description" class="form-label">
                Description (Optional)
              </label>
              <textarea 
                id="track-description" 
                name="description"
                class="form-textarea" 
                rows="4"
                placeholder="Tell listeners about this track - the story, the inspiration, the message..."
                maxlength="1000"
              ></textarea>
              <span class="form-hint">Maximum 1000 characters</span>
            </div>

            <!-- Collaboration Options -->
            <div class="form-group">
              <div class="form-checkbox">
                <input 
                  type="checkbox" 
                  id="is-collaboration" 
                  name="isCollaboration"
                />
                <label for="is-collaboration">
                  This is a collaboration
                </label>
              </div>
            </div>

            <!-- Collaborators Section (shown if collaboration checked) -->
            <div id="collaborators-section" class="collaborators-section" style="display: none;">
              <label class="form-label">Collaborators</label>
              <div id="collaborators-list" class="collaborators-list">
                <!-- Collaborators will be added here -->
              </div>
              <button 
                type="button" 
                class="btn-secondary small" 
                onclick="window.trackFormManager?.addCollaborator()"
              >
                + Add Collaborator
              </button>
              <p class="form-hint">
                Add wallet addresses of collaborators. They'll receive credit and can share royalties.
              </p>
            </div>

            <!-- NFT Minting Option -->
            <div class="form-group">
              <div class="nft-option-card">
                <div class="nft-option-header">
                  <div class="form-checkbox">
                    <input 
                      type="checkbox" 
                      id="mint-as-nft" 
                      name="mintAsNft"
                    />
                    <label for="mint-as-nft">
                      <strong>Mint as NFT</strong>
                    </label>
                  </div>
                  <span class="badge premium">Premium</span>
                </div>
                <p class="nft-option-description">
                  Create limited edition NFTs of your track. Set royalties, editions, and pricing.
                </p>
                <!-- 
                TODO: Expand to show NFT configuration when checked:
                - Number of editions
                - Price per edition
                - Royalty percentage
                - NFT metadata
                -->
              </div>
            </div>

            <!-- Release Options -->
            <div class="form-group">
              <label class="form-label">Release Options</label>
              <div class="radio-group">
                <div class="form-radio">
                  <input 
                    type="radio" 
                    id="release-now" 
                    name="releaseOption" 
                    value="now"
                    checked
                  />
                  <label for="release-now">Publish now</label>
                </div>
                <div class="form-radio">
                  <input 
                    type="radio" 
                    id="release-draft" 
                    name="releaseOption" 
                    value="draft"
                  />
                  <label for="release-draft">Save as draft</label>
                </div>
                <div class="form-radio">
                  <input 
                    type="radio" 
                    id="release-scheduled" 
                    name="releaseOption" 
                    value="scheduled"
                  />
                  <label for="release-scheduled">Schedule release</label>
                </div>
              </div>
              <!-- 
              TODO: Show date/time picker when "scheduled" selected
              -->
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
              <button type="button" class="btn-secondary" onclick="resetForm()">
                Cancel
              </button>
              <button type="submit" class="btn-primary" id="upload-track-btn">
                <span class="btn-icon">üöÄ</span>
                <span>Upload Track (+100 XP)</span>
              </button>
            </div>

          </form>
        </div>

        <!-- Right: Tips & Preview -->
        <aside class="track-tips-sidebar">
          
          <!-- Upload Tips -->
          <div class="tips-card">
            <h3 class="tips-title">üìù Upload Tips</h3>
            <ul class="tips-list">
              <li>
                <strong>Audio Quality:</strong> Use high-quality audio files (320kbps MP3 or WAV recommended)
              </li>
              <li>
                <strong>Cover Art:</strong> Square images (1:1 ratio) work best. Minimum 1000√ó1000px.
              </li>
              <li>
                <strong>Lyrics:</strong> Include lyrics to help listeners connect with your message
              </li>
              <li>
                <strong>Tags:</strong> Use relevant genre tags to help people discover your music
              </li>
              <li>
                <strong>Collaboration:</strong> Credit all contributors to share XP and royalties fairly
              </li>
            </ul>
          </div>

          <!-- XP Rewards -->
          <div class="rewards-card">
            <h3 class="rewards-title">‚≠ê XP Rewards</h3>
            <div class="reward-item">
              <span class="reward-action">Upload track</span>
              <span class="reward-xp">+100 XP</span>
            </div>
            <div class="reward-item">
              <span class="reward-action">First track</span>
              <span class="reward-xp">+50 XP (bonus)</span>
            </div>
            <div class="reward-item">
              <span class="reward-action">Include lyrics</span>
              <span class="reward-xp">+25 XP (bonus)</span>
            </div>
            <div class="reward-item">
              <span class="reward-action">Collaboration</span>
              <span class="reward-xp">+50 XP (bonus)</span>
            </div>
          </div>

          <!-- Recent Uploads (Community) -->
          <div class="recent-uploads-card">
            <h3 class="recent-title">üéµ Recent Uploads</h3>
            <div id="recent-uploads-list" class="recent-uploads-list">
              <!-- Recent tracks from community -->
            </div>
          </div>

        </aside>

      </div>

    </div>
  </section>

  <!-- ============================================ -->
  <!-- TAB 2: BEAT MAKER / SEQUENCER -->
  <!-- ============================================ -->
  <section id="tab-beatmaker" class="studio-tab-content" style="display: none;">
    <div class="container mx-auto" style="padding: 2rem;">

      <div class="beatmaker-header">
        <h2 style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">
          üéπ Beat Maker & Sequencer
        </h2>
        <p style="color: #666; margin-bottom: 1rem;">
          Create rap backing tracks with our step sequencer or upload short samples to share with your crew.
        </p>

        <!-- Mode Toggle -->
        <div class="beatmaker-mode-toggle" style="margin-bottom: 2rem;">
          <button
            class="mode-toggle-btn active"
            data-mode="generate"
            onclick="window.beatMaker?.switchMode('generate')"
          >
            üéπ Generate Beats
          </button>
          <button
            class="mode-toggle-btn"
            data-mode="upload"
            onclick="window.beatMaker?.switchMode('upload')"
          >
            üì§ Upload Sample
          </button>
        </div>
      </div>

      <!-- GENERATE MODE: Sequencer -->
      <div id="beatmaker-generate-mode" class="beatmaker-mode-content">

      <!-- Sequencer Controls -->
      <div class="sequencer-controls">
        <!-- Main Transport Controls -->
        <div class="controls-row transport-controls">
          <div class="transport-buttons">
            <button id="seq-play-btn" class="seq-btn seq-btn-play" onclick="window.beatMaker?.togglePlayback()" title="Play/Pause (Space)">
              <span id="seq-play-icon">‚ñ∂Ô∏è</span> <span id="seq-play-text">Play</span>
            </button>
            <button class="seq-btn seq-btn-stop" onclick="window.beatMaker?.stop()" title="Stop">
              ‚èπÔ∏è Stop
            </button>
            <button class="seq-btn seq-btn-clear" onclick="window.beatMaker?.clearPattern()" title="Clear All">
              üóëÔ∏è Clear
            </button>
          </div>

          <!-- Playback Position Indicator -->
          <div class="playback-position">
            <div class="position-bar">
              <div class="position-indicator" id="seq-position-indicator" style="left: 0%;"></div>
            </div>
            <div class="position-label">
              Step <span id="current-step-display">-</span> / 16
            </div>
          </div>
        </div>

        <!-- Tempo and Pattern Controls -->
        <div class="controls-row tempo-pattern-controls">
          <div class="control-group tempo-group">
            <label for="seq-tempo">
              BPM: <span id="seq-tempo-display">120</span>
            </label>
            <div class="tempo-controls-container">
              <input
                type="range"
                id="seq-tempo"
                min="60"
                max="180"
                value="120"
                oninput="window.beatMaker?.setTempo(this.value)"
              />
              <button class="tap-tempo-btn" onclick="window.beatMaker?.tapTempo()" title="Tap Tempo (T)">
                üëÜ Tap
              </button>
            </div>
          </div>

          <div class="control-group">
            <label for="seq-volume">Master: <span id="seq-volume-display">70</span>%</label>
            <input
              type="range"
              id="seq-volume"
              min="0"
              max="100"
              value="70"
              oninput="window.beatMaker?.setVolume(this.value)"
            />
          </div>

          <div class="control-group swing-group">
            <label for="seq-swing">Swing: <span id="seq-swing-display">0</span>%</label>
            <input
              type="range"
              id="seq-swing"
              min="0"
              max="100"
              value="0"
              oninput="window.beatMaker?.setSwing(this.value)"
            />
          </div>
        </div>

        <!-- Pattern Management -->
        <div class="controls-row pattern-management">
          <div class="pattern-actions">
            <button class="seq-btn-icon" onclick="window.beatMaker?.undo()" title="Undo (Ctrl+Z)" id="undo-btn" disabled>
              ‚Ü∂ Undo
            </button>
            <button class="seq-btn-icon" onclick="window.beatMaker?.redo()" title="Redo (Ctrl+Y)" id="redo-btn" disabled>
              ‚Ü∑ Redo
            </button>
            <button class="seq-btn-icon" onclick="window.beatMaker?.randomizeAll()" title="Randomize Pattern">
              üé≤ Random
            </button>
            <button class="seq-btn-icon" onclick="window.beatMaker?.savePattern()" title="Save Pattern">
              üíæ Save
            </button>
            <button class="seq-btn-icon" onclick="window.beatMaker?.loadPattern()" title="Load Pattern">
              üìÇ Load
            </button>
          </div>
        </div>

        <!-- Export Controls -->
        <div class="controls-row export-controls">
          <button class="seq-btn seq-btn-secondary" onclick="window.beatMaker?.exportBeat()">
            üíæ Export Beat
          </button>
          <button class="seq-btn seq-btn-secondary" onclick="window.beatMaker?.sharePattern()">
            üîó Share Pattern
          </button>
          <button class="seq-btn seq-btn-primary" onclick="window.beatMaker?.useAsBackingTrack()">
            üéµ Use as Backing Track
          </button>
        </div>

        <!-- Keyboard Shortcuts Helper -->
        <div class="keyboard-shortcuts-hint">
          üí° <strong>Tips:</strong> Space = Play/Pause ‚Ä¢ T = Tap Tempo ‚Ä¢ Ctrl+Z = Undo ‚Ä¢ Drag to paint steps ‚Ä¢ Right-click to erase
        </div>
      </div>

      <!-- Sequencer Grid -->
      <div class="sequencer-grid-container">
        <div class="sequencer-header-row">
          <div class="track-label-cell">Track</div>
          <div class="steps-header">
            ${Array.from({length: 16}, (_, i) => `
              <div class="step-number">${i + 1}</div>
            `).join('')}
          </div>
        </div>

        <!-- Trap Drum - Kick -->
        <div class="sequencer-row" data-track="kick" data-track-color="drums">
          <div class="track-controls">
            <div class="track-label">
              <span class="track-icon">ü•Å</span>
              <span class="track-name">Kick</span>
            </div>
            <div class="track-buttons">
              <button class="track-btn mute-btn" onclick="window.beatMaker?.toggleMute('kick')" title="Mute (M)" data-track="kick">
                M
              </button>
              <button class="track-btn solo-btn" onclick="window.beatMaker?.toggleSolo('kick')" title="Solo (S)" data-track="kick">
                S
              </button>
              <button class="track-btn random-btn" onclick="window.beatMaker?.randomizeTrack('kick')" title="Randomize">
                üé≤
              </button>
            </div>
            <div class="track-volume">
              <input
                type="range"
                class="track-volume-slider"
                min="0"
                max="100"
                value="80"
                data-track="kick"
                oninput="window.beatMaker?.setTrackVolume('kick', this.value)"
                title="Volume"
              />
              <span class="volume-value">80</span>
            </div>
          </div>
          <div class="steps-grid">
            ${Array.from({length: 16}, (_, i) => `
              <button class="step-btn" data-track="kick" data-step="${i}"
                onclick="window.beatMaker?.toggleStep('kick', ${i})"
                onmousedown="window.beatMaker?.startDrag('kick', ${i})"
                onmouseenter="window.beatMaker?.dragStep('kick', ${i})"
                oncontextmenu="window.beatMaker?.eraseStep('kick', ${i}); return false;"
              ></button>
            `).join('')}
          </div>
        </div>

        <!-- Trap Drum - Snare -->
        <div class="sequencer-row" data-track="snare">
          <div class="track-label">
            <span class="track-icon">ü•Å</span>
            <span class="track-name">Snare</span>
          </div>
          <div class="steps-grid">
            ${Array.from({length: 16}, (_, i) => `
              <button class="step-btn" data-track="snare" data-step="${i}" onclick="window.beatMaker?.toggleStep('snare', ${i})"></button>
            `).join('')}
          </div>
        </div>

        <!-- Trap Drum - Hi-Hat -->
        <div class="sequencer-row" data-track="hihat">
          <div class="track-label">
            <span class="track-icon">ü•Å</span>
            <span class="track-name">Hi-Hat</span>
          </div>
          <div class="steps-grid">
            ${Array.from({length: 16}, (_, i) => `
              <button class="step-btn" data-track="hihat" data-step="${i}" onclick="window.beatMaker?.toggleStep('hihat', ${i})"></button>
            `).join('')}
          </div>
        </div>

        <!-- Bass -->
        <div class="sequencer-row" data-track="bass">
          <div class="track-label">
            <span class="track-icon">üé∏</span>
            <span class="track-name">Bass</span>
          </div>
          <div class="steps-grid">
            ${Array.from({length: 16}, (_, i) => `
              <button class="step-btn" data-track="bass" data-step="${i}" onclick="window.beatMaker?.toggleStep('bass', ${i})"></button>
            `).join('')}
          </div>
        </div>

        <!-- Guitar Strum -->
        <div class="sequencer-row" data-track="guitar">
          <div class="track-label">
            <span class="track-icon">üé∏</span>
            <span class="track-name">Guitar</span>
          </div>
          <div class="steps-grid">
            ${Array.from({ length: 16 }, (_, i) => `
          <button
            class="step-btn"
            data-track="guitar"
            data-step="${i}"
            onclick="window.beatMaker?.toggleStep('guitar', ${i})"
          ></button>
          `).join('')}
          </div>

        </div>

        <!-- Clap -->
        <div class="sequencer-row" data-track="clap">
          <div class="track-label">
            <span class="track-icon">üëè</span>
            <span class="track-name">Clap</span>
          </div>
          <div class="steps-grid">
            ${Array.from({length: 16}, (_, i) => `
              <button class="step-btn" data-track="clap" data-step="${i}" onclick="window.beatMaker?.toggleStep('clap', ${i})"></button>
            `).join('')}
          </div>
        </div>

        <!-- Youth Shout -->
        <div class="sequencer-row" data-track="shout">
          <div class="track-label">
            <span class="track-icon">üì£</span>
            <span class="track-name">Shout</span>
          </div>
          <div class="steps-grid">
            ${Array.from({length: 16}, (_, i) => `
              <button class="step-btn" data-track="shout" data-step="${i}" onclick="window.beatMaker?.toggleStep('shout', ${i})"></button>
            `).join('')}
          </div>
        </div>

        <!-- Horn -->
        <div class="sequencer-row" data-track="horn">
          <div class="track-label">
            <span class="track-icon">üé∫</span>
            <span class="track-name">Horn</span>
          </div>
          <div class="steps-grid">
            ${Array.from({length: 16}, (_, i) => `
              <button class="step-btn" data-track="horn" data-step="${i}" onclick="window.beatMaker?.toggleStep('horn', ${i})"></button>
            `).join('')}
          </div>
        </div>

        <!-- Reggaeton Horn -->
        <div class="sequencer-row" data-track="reggaeton">
          <div class="track-label">
            <span class="track-icon">üìØ</span>
            <span class="track-name">Reggaeton</span>
          </div>
          <div class="steps-grid">
            ${Array.from({length: 16}, (_, i) => `
              <button class="step-btn" data-track="reggaeton" data-step="${i}" onclick="window.beatMaker?.toggleStep('reggaeton', ${i})"></button>
            `).join('')}
          </div>
        </div>

        <!-- Water Sound -->
        <div class="sequencer-row" data-track="water">
          <div class="track-label">
            <span class="track-icon">üíß</span>
            <span class="track-name">Water</span>
          </div>
          <div class="steps-grid">
            ${Array.from({length: 16}, (_, i) => `
              <button class="step-btn" data-track="water" data-step="${i}" onclick="window.beatMaker?.toggleStep('water', ${i})"></button>
            `).join('')}
          </div>
        </div>

        <!-- Electricity Sound -->
        <div class="sequencer-row" data-track="electric">
          <div class="track-label">
            <span class="track-icon">‚ö°</span>
            <span class="track-name">Electric</span>
          </div>
          <div class="steps-grid">
            ${Array.from({length: 16}, (_, i) => `
              <button class="step-btn" data-track="electric" data-step="${i}" onclick="window.beatMaker?.toggleStep('electric', ${i})"></button>
            `).join('')}
          </div>
        </div>

        <!-- Book Hits Floor -->
        <div class="sequencer-row" data-track="book">
          <div class="track-label">
            <span class="track-icon">üìö</span>
            <span class="track-name">Book Drop</span>
          </div>
          <div class="steps-grid">
            ${Array.from({length: 16}, (_, i) => `
              <button class="step-btn" data-track="book" data-step="${i}" onclick="window.beatMaker?.toggleStep('book', ${i})"></button>
            `).join('')}
          </div>
        </div>
      </div>

      <!-- Pattern Presets -->
      <div class="pattern-presets" style="margin-top: 2rem;">
        <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">Pattern Presets</h3>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
          <button class="preset-btn" onclick="window.beatMaker?.loadPreset('trap')">üî• Trap Beat</button>
          <button class="preset-btn" onclick="window.beatMaker?.loadPreset('reggaeton')">üå¥ Reggaeton</button>
          <button class="preset-btn" onclick="window.beatMaker?.loadPreset('boom-bap')">üìª Boom Bap</button>
          <button class="preset-btn" onclick="window.beatMaker?.loadPreset('ambient')">üåä Ambient</button>
        </div>
      </div>

      <!-- Tips -->
      <div class="beatmaker-tips" style="margin-top: 2rem; padding: 1.5rem; background: #f9fafb; border-radius: 0.75rem;">
        <h4 style="font-weight: bold; margin-bottom: 0.75rem;">üí° Beat Maker Tips</h4>
        <ul style="list-style: disc; margin-left: 1.5rem; color: #666; line-height: 1.8;">
          <li><strong>Click steps</strong> to activate them - they'll play when the sequencer reaches that step</li>
          <li><strong>Drag to paint:</strong> Hold mouse and drag across steps to quickly fill patterns</li>
          <li><strong>Right-click to erase:</strong> Right-click steps to remove them</li>
          <li><strong>Keyboard shortcuts:</strong> Space = Play/Pause ‚Ä¢ T = Tap Tempo ‚Ä¢ Ctrl+Z = Undo</li>
          <li><strong>Preset patterns:</strong> Try presets to get started, then customize to your style</li>
          <li><strong>Pattern vectors:</strong> Save/share your patterns as lightweight data - others can load and remix!</li>
          <li><strong>Tempo matching:</strong> Adjust BPM to match your flow - slower for storytelling (80-100), faster for hype (130-150)</li>
          <li><strong>Layer sounds:</strong> Combine drums, bass, melody, and FX for complex rhythms</li>
          <li><strong>Mute/Solo:</strong> Use M/S buttons to isolate tracks and perfect your mix</li>
          <li><strong>Swing:</strong> Add groove with the swing control for more human feel</li>
        </ul>
      </div>

      <!-- Pattern Vector Info -->
      <div style="margin-top: 1.5rem; padding: 1.5rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 0.75rem;">
        <h4 style="font-weight: bold; margin-bottom: 0.5rem;">üî¢ Share Pattern Vectors</h4>
        <p style="opacity: 0.9; font-size: 0.875rem;">
          Your beats are stored as pattern vectors (JSON data) - not heavy audio files! This means:
          <strong>Instant sharing</strong>, <strong>easy remixing</strong>, and <strong>tiny file sizes</strong>.
          Hit "üîó Share Pattern" to get a shareable code that anyone can load into their sequencer.
        </p>
      </div>

      </div>
      <!-- END GENERATE MODE -->

      <!-- UPLOAD MODE: Sample Upload & Marketplace -->
      <div id="beatmaker-upload-mode" class="beatmaker-mode-content" style="display: none;">

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">

          <!-- Upload Sample Section -->
          <div class="upload-sample-section">
            <h3 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">
              üì§ Upload Sample
            </h3>
            <p style="color: #666; margin-bottom: 1.5rem;">
              Upload short audio samples (0.1-3 seconds). Samples are stored as vectors for efficient sharing and pattern recreation.
            </p>

            <form id="sample-upload-form" class="sample-upload-form">

              <!-- Sample File Upload -->
              <div class="form-group">
                <label class="form-label">Audio Sample *</label>
                <div class="sample-upload-area" id="sample-upload-area">
                  <input
                    type="file"
                    id="sample-file"
                    name="sampleFile"
                    accept="audio/mp3,audio/wav,audio/m4a,audio/mpeg"
                    required
                    hidden
                  />
                  <div class="file-upload-content">
                    <div class="upload-icon">üéµ</div>
                    <p class="upload-text">
                      <strong>Click to upload</strong> or drag sample
                    </p>
                    <p class="upload-hint">
                      0.1-3 seconds ‚Ä¢ MP3, WAV, M4A (max 2MB)
                    </p>
                  </div>
                  <div class="sample-file-selected" id="sample-file-selected" style="display: none;">
                    <span class="file-icon">üéµ</span>
                    <span class="file-name" id="sample-file-name"></span>
                    <span class="file-duration" id="sample-file-duration"></span>
                    <button type="button" class="btn-remove" onclick="window.beatMaker?.removeSampleFile()">√ó</button>
                  </div>
                </div>
                <div id="sample-preview-player" style="display: none; margin-top: 1rem;">
                  <audio id="sample-audio-element" controls style="width: 100%;"></audio>
                </div>
              </div>

              <!-- Sample Name -->
              <div class="form-group">
                <label for="sample-name" class="form-label">Sample Name *</label>
                <input
                  type="text"
                  id="sample-name"
                  name="sampleName"
                  class="form-input"
                  placeholder="e.g., Heavy Kick, Crisp Snare, Horn Stab"
                  required
                />
              </div>

              <!-- Sample Category -->
              <div class="form-group">
                <label for="sample-category" class="form-label">Category *</label>
                <select id="sample-category" name="category" class="form-select" required>
                  <option value="">Select category...</option>
                  <option value="drums">Drums</option>
                  <option value="bass">Bass</option>
                  <option value="melody">Melody</option>
                  <option value="fx">Sound Effects</option>
                  <option value="vocal">Vocal Samples</option>
                  <option value="percussion">Percussion</option>
                </select>
              </div>

              <!-- Sample Tags -->
              <div class="form-group">
                <label for="sample-tags" class="form-label">Tags (Optional)</label>
                <input
                  type="text"
                  id="sample-tags"
                  name="tags"
                  class="form-input"
                  placeholder="trap, boom-bap, reggaeton, aggressive"
                />
                <span class="form-hint">Comma-separated tags</span>
              </div>

              <!-- Sharing Options -->
              <div class="form-group">
                <label class="form-label">Sharing Options</label>
                <div class="checkbox-group-inline">
                  <label class="form-checkbox">
                    <input type="checkbox" name="sharePublic" checked />
                    Public (Anyone can use)
                  </label>
                  <label class="form-checkbox">
                    <input type="checkbox" name="allowSale" />
                    For Sale
                  </label>
                  <label class="form-checkbox">
                    <input type="checkbox" name="battleCrewOnly" />
                    Battle Crew Only
                  </label>
                </div>
              </div>

              <!-- Price (if for sale) -->
              <div class="form-group" id="sample-price-group" style="display: none;">
                <label for="sample-price" class="form-label">Price (Tokens)</label>
                <input
                  type="number"
                  id="sample-price"
                  name="price"
                  class="form-input"
                  placeholder="100"
                  min="0"
                />
              </div>

              <!-- Submit Button -->
              <button type="submit" class="btn-primary" style="width: 100%;">
                <span class="btn-icon">üöÄ</span>
                <span>Upload Sample (+50 XP)</span>
              </button>

            </form>
          </div>

          <!-- Sample Marketplace / Library -->
          <div class="sample-library-section">
            <h3 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">
              üéµ Sample Library
            </h3>
            <p style="color: #666; margin-bottom: 1.5rem;">
              Browse, preview, and download samples from the community.
            </p>

            <!-- Filter Tabs -->
            <div class="sample-filter-tabs" style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
              <button class="filter-tab active" data-filter="all" onclick="window.beatMaker?.filterSamples('all')">
                All
              </button>
              <button class="filter-tab" data-filter="my-samples" onclick="window.beatMaker?.filterSamples('my-samples')">
                My Samples
              </button>
              <button class="filter-tab" data-filter="crew" onclick="window.beatMaker?.filterSamples('crew')">
                Crew
              </button>
              <button class="filter-tab" data-filter="marketplace" onclick="window.beatMaker?.filterSamples('marketplace')">
                For Sale
              </button>
            </div>

            <!-- Sample Grid -->
            <div id="sample-library-grid" class="sample-library-grid">
              <!-- Sample cards will be loaded here -->
              <div class="sample-card">
                <div class="sample-card-header">
                  <span class="sample-icon">ü•Å</span>
                  <span class="sample-name">Heavy Kick</span>
                </div>
                <div class="sample-card-body">
                  <div class="sample-meta">
                    <span class="sample-category">Drums</span>
                    <span class="sample-duration">2.1s</span>
                  </div>
                  <div class="sample-tags">
                    <span class="tag">trap</span>
                    <span class="tag">hard</span>
                  </div>
                  <div class="sample-author">by <strong>MC_Flow</strong></div>
                </div>
                <div class="sample-card-actions">
                  <button class="sample-action-btn" onclick="window.beatMaker?.previewSample('kick-01')">
                    ‚ñ∂Ô∏è Play
                  </button>
                  <button class="sample-action-btn" onclick="window.beatMaker?.downloadSample('kick-01')">
                    üíæ Download
                  </button>
                  <button class="sample-action-btn" onclick="window.beatMaker?.sendToCrew('kick-01')">
                    üì§ Send to Crew
                  </button>
                </div>
              </div>

              <div class="sample-card">
                <div class="sample-card-header">
                  <span class="sample-icon">üìØ</span>
                  <span class="sample-name">Reggaeton Horn</span>
                </div>
                <div class="sample-card-body">
                  <div class="sample-meta">
                    <span class="sample-category">FX</span>
                    <span class="sample-duration">1.8s</span>
                  </div>
                  <div class="sample-tags">
                    <span class="tag">reggaeton</span>
                    <span class="tag">horn</span>
                  </div>
                  <div class="sample-author">by <strong>BeatMaker_X</strong></div>
                  <div class="sample-price">üí∞ 50 tokens</div>
                </div>
                <div class="sample-card-actions">
                  <button class="sample-action-btn" onclick="window.beatMaker?.previewSample('horn-01')">
                    ‚ñ∂Ô∏è Play
                  </button>
                  <button class="sample-action-btn" onclick="window.beatMaker?.buySample('horn-01')">
                    üí≥ Buy
                  </button>
                </div>
              </div>

              <div class="empty-state" style="display: none;">
                <div style="text-align: center; padding: 3rem; color: #9ca3af;">
                  <div style="font-size: 3rem; margin-bottom: 1rem;">üéµ</div>
                  <p>No samples found</p>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- Upload Tips & Pattern Vectors Info -->
        <div class="sample-upload-tips" style="margin-top: 2rem; padding: 1.5rem; background: #f9fafb; border-radius: 0.75rem;">
          <h4 style="font-weight: bold; margin-bottom: 0.75rem;">üí° Sample & Pattern Vector System</h4>
          <ul style="list-style: disc; margin-left: 1.5rem; color: #666; line-height: 1.8;">
            <li><strong>Short Samples:</strong> Can be as short as 0.1 seconds (one-shots, hits, stabs) or up to 3 seconds (loops, phrases)</li>
            <li><strong>Pattern Vectors:</strong> When you create a beat, the pattern is stored as a lightweight data vector - just the step positions, not heavy audio files</li>
            <li><strong>Efficient Sharing:</strong> Share a 1KB pattern vector instead of a 10MB audio file. Anyone can recreate your beat instantly!</li>
            <li><strong>Remix Culture:</strong> Download pattern vectors, swap samples, adjust timing, and create your own versions</li>
            <li><strong>Battle Crew Patterns:</strong> Share pattern vectors with your crew for collaborative beat-making</li>
            <li><strong>Pattern Marketplace:</strong> Sell unique pattern vectors as "beat blueprints" that others can customize</li>
            <li><strong>Quality:</strong> Upload high-quality audio (44.1kHz+) for samples that will be reused in many patterns</li>
          </ul>
        </div>

        <!-- Pattern Vector Export/Import -->
        <div style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 0.75rem;">
          <h4 style="font-weight: bold; margin-bottom: 1rem;">üî¢ Pattern Vector Format</h4>
          <p style="margin-bottom: 1rem; opacity: 0.9;">
            Your beat patterns are exported as JSON vectors containing step data, tempo, swing, and sample references.
            This format is:
          </p>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 0.5rem;">
              <strong>üì¶ Tiny Size</strong><br/>
              <span style="font-size: 0.875rem; opacity: 0.9;">~1-5KB vs 10-50MB audio</span>
            </div>
            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 0.5rem;">
              <strong>‚ö° Instant Load</strong><br/>
              <span style="font-size: 0.875rem; opacity: 0.9;">Load patterns in milliseconds</span>
            </div>
            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 0.5rem;">
              <strong>üîÑ Remix Friendly</strong><br/>
              <span style="font-size: 0.875rem; opacity: 0.9;">Swap samples, change tempo, modify steps</span>
            </div>
            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 0.5rem;">
              <strong>üåê Easy Sharing</strong><br/>
              <span style="font-size: 0.875rem; opacity: 0.9;">Copy/paste code, QR codes, URLs</span>
            </div>
          </div>
          <button class="btn" style="background: white; color: #667eea; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: bold; border: none; cursor: pointer;" onclick="window.beatMaker?.showPatternVectorExample()">
            üìã View Example Pattern Vector
          </button>
        </div>

      </div>
      <!-- END UPLOAD MODE -->

    </div>
  </section>

  <!-- ============================================ -->
  <!-- TAB 3: RAP BATTLES -->
  <!-- ============================================ -->
  <section id="tab-battles" class="studio-tab-content" style="display: none;">
    <div class="container mx-auto">
      
      <div class="battles-layout">

        <!-- Battle Arena Header -->
        <div class="battles-header">
          <div class="battles-header-content">
            <h2 class="section-title">Rap Battle Arena</h2>
            <p class="section-subtitle">Challenge opponents and prove your skills</p>
          </div>
          <button class="btn-primary" onclick="window.battleManager?.showCreateBattleForm()">
            <span class="btn-icon">‚öîÔ∏è</span>
            Create Challenge
          </button>
        </div>

        <!-- Battle Filters -->
        <div class="battles-filters">
          <div class="filter-tabs">
            <button class="filter-tab active" data-filter="all">All Battles</button>
            <button class="filter-tab" data-filter="open">Open Challenges</button>
            <button class="filter-tab" data-filter="my-battles">My Battles</button>
            <button class="filter-tab" data-filter="live">Live Now</button>
            <button class="filter-tab" data-filter="completed">Completed</button>
          </div>
          
          <div class="filter-options">
            <select class="filter-select" id="battle-category-filter">
              <option value="all">All Categories</option>
              <option value="conscious">Conscious Bars</option>
              <option value="wordplay">Wordplay Wizard</option>
              <option value="flow">Flow Master</option>
              <option value="storytelling">Storyteller</option>
              <option value="kakuma">Kakuma Chronicles</option>
            </select>
            
            <select class="filter-select" id="battle-stake-filter">
              <option value="all">All Stakes</option>
              <option value="free">Free (0 stake)</option>
              <option value="low">Low (1-50 XP)</option>
              <option value="medium">Medium (51-200 XP)</option>
              <option value="high">High (200+ XP)</option>
            </select>
          </div>
        </div>

        <!-- Battles Grid -->
        <div id="battles-grid" class="battles-grid">
          <!--
          Battle cards will be loaded here via JS
          
          Template:
          <div class="battle-card [status]">
            <div class="battle-header">
              <div class="battle-category">üéØ Wordplay Wizard</div>
              <div class="battle-status">Open</div>
            </div>
            
            <div class="battle-participants">
              <div class="participant challenger">
                <div class="participant-avatar">MC</div>
                <div class="participant-info">
                  <div class="participant-name">MC Thunder</div>
                  <div class="participant-level">Level 25</div>
                </div>
              </div>
              
              <div class="battle-vs">VS</div>
              
              <div class="participant opponent">
                <div class="participant-placeholder">?</div>
                <div class="participant-info">
                  <div class="participant-name">Open Challenge</div>
                  <div class="participant-action">Accept challenge</div>
                </div>
              </div>
            </div>
            
            <div class="battle-details">
              <div class="detail-row">
                <span class="detail-label">Rounds:</span>
                <span class="detail-value">3 √ó 16 bars</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Stake:</span>
                <span class="detail-value">100 XP</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Deadline:</span>
                <span class="detail-value">48 hours</span>
              </div>
            </div>
            
            <div class="battle-actions">
              <button class="btn-primary">Accept Challenge (+150 XP if win)</button>
            </div>
          </div>
          -->
        </div>

        <!-- Create Battle Form (Modal) -->
        <div id="create-battle-modal" class="modal-overlay" style="display: none;">
          <div class="modal-content large">
            
            <div class="modal-header">
              <h3>Create Rap Battle Challenge</h3>
              <button class="btn-close" onclick="window.battleManager?.closeCreateBattleForm()">√ó</button>
            </div>

            <form id="create-battle-form" class="battle-form">
              
              <!-- Opponent Selection -->
              <div class="form-group">
                <label class="form-label">Opponent</label>
                <div class="radio-group">
                  <div class="form-radio">
                    <input 
                      type="radio" 
                      id="opponent-open" 
                      name="opponentType" 
                      value="open"
                      checked
                    />
                    <label for="opponent-open">
                      <strong>Open Challenge</strong> - Anyone can accept
                    </label>
                  </div>
                  <div class="form-radio">
                    <input 
                      type="radio" 
                      id="opponent-specific" 
                      name="opponentType" 
                      value="specific"
                    />
                    <label for="opponent-specific">
                      <strong>Challenge Specific User</strong>
                    </label>
                  </div>
                </div>
                
                <!-- Shown when "specific" selected -->
                <div id="specific-opponent-section" style="display: none;">
                  <input 
                    type="text" 
                    id="opponent-wallet" 
                    class="form-input"
                    placeholder="Enter opponent's wallet address or username"
                  />
                </div>
              </div>

              <!-- Battle Category -->
              <div class="form-group">
                <label for="battle-category" class="form-label">Battle Category *</label>
                <select id="battle-category" name="category" class="form-select" required>
                  <option value="">Select category...</option>
                  <option value="conscious">üéØ Conscious Bars - Social/Environmental themes</option>
                  <option value="wordplay">üß© Wordplay Wizard - Technical skill focus</option>
                  <option value="flow">üåä Flow Master - Rhythm and delivery</option>
                  <option value="storytelling">üìñ Storyteller - Narrative rap</option>
                  <option value="kakuma">üèïÔ∏è Kakuma Chronicles - Refugee experience</option>
                  <option value="freestyle">üé≤ Freestyle - Anything goes</option>
                </select>
              </div>

              <!-- Battle Format -->
              <div class="form-group">
                <label class="form-label">Battle Format</label>
                <div class="format-grid">
                  <div class="form-row">
                    <label for="battle-rounds">Rounds:</label>
                    <select id="battle-rounds" name="rounds" class="form-select small">
                      <option value="1">1 Round</option>
                      <option value="2">2 Rounds</option>
                      <option value="3" selected>3 Rounds</option>
                      <option value="5">5 Rounds</option>
                    </select>
                  </div>
                  
                  <div class="form-row">
                    <label for="battle-bars">Bars per round:</label>
                    <select id="battle-bars" name="barsPerRound" class="form-select small">
                      <option value="8">8 bars</option>
                      <option value="16" selected>16 bars</option>
                      <option value="32">32 bars</option>
                    </select>
                  </div>
                  
                  <div class="form-row">
                    <label for="battle-time">Time limit:</label>
                    <select id="battle-time" name="timeLimit" class="form-select small">
                      <option value="24">24 hours</option>
                      <option value="48" selected>48 hours</option>
                      <option value="72">72 hours</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Stake Amount -->
              <div class="form-group">
                <label for="battle-stake" class="form-label">Stake (Optional)</label>
                <div class="stake-input-group">
                  <input 
                    type="number" 
                    id="battle-stake" 
                    name="stake"
                    class="form-input"
                    placeholder="0"
                    min="0"
                    max="1000"
                  />
                  <div class="stake-currency">
                    <select id="stake-currency" name="stakeCurrency" class="form-select">
                      <option value="XP">XP</option>
                      <option value="SOL">SOL</option>
                    </select>
                  </div>
                </div>
                <p class="form-hint">
                  Winner takes all. Leave at 0 for friendly battle.
                </p>
              </div>

              <!-- Battle Theme (Optional) -->
              <div class="form-group">
                <label for="battle-theme" class="form-label">Battle Theme (Optional)</label>
                <input 
                  type="text" 
                  id="battle-theme" 
                  name="theme"
                  class="form-input"
                  placeholder="e.g., Climate Change, Perseverance, Street Life..."
                />
                <p class="form-hint">
                  Set a specific topic for participants to address
                </p>
              </div>

              <!-- Judging Options -->
              <div class="form-group">
                <label class="form-label">Judging Method</label>
                <div class="judging-info">
                  <p>Battles are judged by combination of:</p>
                  <ul>
                    <li>Peer voting (40%)</li>
                    <li>Expert panel (30%)</li>
                    <li>Animal Mentor AI (30%)</li>
                  </ul>
                </div>
              </div>

              <!-- Form Actions -->
              <div class="form-actions">
                <button 
                  type="button" 
                  class="btn-secondary"
                  onclick="window.battleManager?.closeCreateBattleForm()"
                >
                  Cancel
                </button>
                <button type="submit" class="btn-primary">
                  <span class="btn-icon">‚öîÔ∏è</span>
                  Create Challenge
                </button>
              </div>

            </form>

          </div>
        </div>

      </div>

    </div>
  </section>

  <!-- ============================================ -->
  <!-- TAB 3: COLLABORATIONS -->
  <!-- ============================================ -->
  <section id="tab-collabs" class="studio-tab-content" style="display: none;">
    <div class="container mx-auto">
      
      <!-- Collaboration Board Header -->
      <div class="collabs-header">
        <div>
          <h2 class="section-title">Collaboration Board</h2>
          <p class="section-subtitle">Find partners and create together</p>
        </div>
        <button class="btn-primary" onclick="window.collabManager?.showCreateCollabForm()">
          <span class="btn-icon">ü§ù</span>
          Start Collaboration
        </button>
      </div>

      <!-- Collaboration Filters -->
      <div class="collabs-filters">
        <button class="filter-chip active" data-filter="all">All</button>
        <button class="filter-chip" data-filter="need-producer">Need Producer</button>
        <button class="filter-chip" data-filter="need-vocals">Need Vocals</button>
        <button class="filter-chip" data-filter="need-lyrics">Need Lyrics</button>
        <button class="filter-chip" data-filter="reggae">Reggae</button>
        <button class="filter-chip" data-filter="cross-camp">Cross-Camp</button>
      </div>

      <!-- Collaborations Grid -->
      <div id="collabs-grid" class="collabs-grid">
        <!--
        Collaboration cards loaded here
        
        Template:
        <div class="collab-card">
          <div class="collab-header">
            <div class="collab-genre">üå¥ Reggae</div>
            <div class="collab-status">Looking for partners</div>
          </div>
          
          <h3 class="collab-title">Unity Anthem Project</h3>
          <p class="collab-description">
            Creating a reggae anthem about global unity. Need vocalist and producer.
          </p>
          
          <div class="collab-creator">
            <div class="creator-avatar">MC</div>
            <div class="creator-info">
              <div class="creator-name">MC Peace</div>
              <div class="creator-level">Level 30 ‚Ä¢ üèïÔ∏è Kakuma</div>
            </div>
          </div>
          
          <div class="collab-roles">
            <div class="role-tag filled">Lyrics ‚úì</div>
            <div class="role-tag open">Producer needed</div>
            <div class="role-tag open">Vocals needed</div>
          </div>
          
          <div class="collab-actions">
            <button class="btn-primary">Request to Join</button>
            <button class="btn-secondary">View Details</button>
          </div>
        </div>
        -->
      </div>

    </div>
  </section>

  <!-- ============================================ -->
  <!-- TAB 4: MY LIBRARY -->
  <!-- ============================================ -->
  <section id="tab-library" class="studio-tab-content" style="display: none;">
    <div class="container mx-auto">
      
      <h2 class="section-title">My Music Library</h2>

      <!-- Library Stats -->
      <div class="library-stats">
        <div class="lib-stat">
          <div class="lib-stat-value" id="lib-total-tracks">0</div>
          <div class="lib-stat-label">Total Tracks</div>
        </div>
        <div class="lib-stat">
          <div class="lib-stat-value" id="lib-total-plays">0</div>
          <div class="lib-stat-label">Total Plays</div>
        </div>
        <div class="lib-stat">
          <div class="lib-stat-value" id="lib-total-likes">0</div>
          <div class="lib-stat-label">Total Likes</div>
        </div>
      </div>

      <!-- Library Filters -->
      <div class="library-filters">
        <div class="filter-group">
          <label>Sort by:</label>
          <select id="library-sort" class="form-select">
            <option value="recent">Most Recent</option>
            <option value="popular">Most Popular</option>
            <option value="plays">Most Played</option>
            <option value="title">Title (A-Z)</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label>Show:</label>
          <select id="library-filter" class="form-select">
            <option value="all">All Tracks</option>
            <option value="published">Published</option>
            <option value="drafts">Drafts</option>
            <option value="collabs">Collaborations</option>
          </select>
        </div>
      </div>

      <!-- Tracks List -->
      <div id="library-tracks" class="library-tracks">
        <!--
        Track rows loaded here
        
        Template:
        <div class="library-track-row">
          <div class="track-play-btn">‚ñ∂</div>
          <div class="track-cover">
            <img src="/cover.jpg" alt="Cover" />
          </div>
          <div class="track-info">
            <div class="track-title">My Track Name</div>
            <div class="track-meta">
              Rap ‚Ä¢ Published Jan 1, 2025
            </div>
          </div>
          <div class="track-stats">
            <span class="stat">üëÅÔ∏è 234 plays</span>
            <span class="stat">‚ù§Ô∏è 45 likes</span>
          </div>
          <div class="track-actions">
            <button class="btn-icon" title="Edit">‚úèÔ∏è</button>
            <button class="btn-icon" title="Share">üîó</button>
            <button class="btn-icon" title="More">‚ãØ</button>
          </div>
        </div>
        -->
      </div>

    </div>
  </section>

</BaseLayout>

<script>
  // Tab switching logic
  document.querySelectorAll('.studio-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      const tabName = tab.dataset.tab;
      
      // Update active tab
      document.querySelectorAll('.studio-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      // Show corresponding content
      document.querySelectorAll('.studio-tab-content').forEach(content => {
        content.style.display = 'none';
      });
      document.getElementById(`tab-${tabName}`).style.display = 'block';
    });
  });

  // Track upload form handler
  class TrackFormManager {
    constructor() {
      this.audioFile = null;
      this.coverArtFile = null;
      this.collaborators = [];
      this.setupFileHandlers();
    }

    setupFileHandlers() {
      // Audio file handler
      const audioInput = document.getElementById('audio-file');
      if (audioInput) {
        audioInput.addEventListener('change', (e) => this.handleAudioUpload(e));
      }

      // Cover art handler
      const coverInput = document.getElementById('cover-art');
      if (coverInput) {
        coverInput.addEventListener('change', (e) => this.handleCoverArtUpload(e));
      }
    }

    handleAudioUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Validate file size (20MB max)
      if (file.size > 20 * 1024 * 1024) {
        this.showToast('Audio file too large. Maximum size is 20MB.', 'error');
        event.target.value = '';
        return;
      }

      this.audioFile = file;

      // Show file info
      document.getElementById('audio-file-name').textContent = file.name;
      document.getElementById('audio-file-size').textContent = this.formatFileSize(file.size);
      document.querySelector('.file-upload-content').style.display = 'none';
      document.getElementById('audio-file-selected').style.display = 'flex';

      // Create audio preview
      const audioURL = URL.createObjectURL(file);
      this.createAudioPreview(audioURL);
    }

    handleCoverArtUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Validate file size (5MB max)
      if (file.size > 5 * 1024 * 1024) {
        this.showToast('Cover art too large. Maximum size is 5MB.', 'error');
        event.target.value = '';
        return;
      }

      this.coverArtFile = file;

      // Show preview
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById('cover-preview-img').src = e.target.result;
        document.querySelector('#cover-upload-area .file-upload-content').style.display = 'none';
        document.getElementById('cover-preview').style.display = 'flex';
      };
      reader.readAsDataURL(file);
    }

    createAudioPreview(audioURL) {
      // Add audio preview player after file selection
      const existingPlayer = document.getElementById('audio-preview-player');
      if (existingPlayer) existingPlayer.remove();

      const player = document.createElement('div');
      player.id = 'audio-preview-player';
      player.className = 'audio-preview-player';
      player.innerHTML = `
        <div class="audio-preview-header">
          <span>üéµ Preview</span>
          <span class="audio-duration" id="audio-duration">0:00</span>
        </div>
        <audio id="audio-preview-element" src="${audioURL}" controls style="width: 100%; margin-top: 0.5rem;"></audio>
      `;

      const uploadArea = document.getElementById('audio-upload-area');
      uploadArea.parentNode.insertBefore(player, uploadArea.nextSibling);

      // Get duration
      const audioElement = document.getElementById('audio-preview-element');
      audioElement.addEventListener('loadedmetadata', () => {
        const duration = Math.floor(audioElement.duration);
        const minutes = Math.floor(duration / 60);
        const seconds = duration % 60;
        document.getElementById('audio-duration').textContent =
          `${minutes}:${seconds.toString().padStart(2, '0')}`;
      });
    }

    removeAudioFile() {
      this.audioFile = null;
      document.getElementById('audio-file').value = '';
      document.querySelector('.file-upload-content').style.display = 'block';
      document.getElementById('audio-file-selected').style.display = 'none';

      const player = document.getElementById('audio-preview-player');
      if (player) player.remove();
    }

    removeCoverArt() {
      this.coverArtFile = null;
      document.getElementById('cover-art').value = '';
      document.querySelector('#cover-upload-area .file-upload-content').style.display = 'block';
      document.getElementById('cover-preview').style.display = 'none';
    }

    addCollaborator() {
      this.openModal('add-collaborator-modal');
    }

    confirmAddCollaborator() {
      const wallet = document.getElementById('collaborator-wallet').value.trim();
      const role = document.getElementById('collaborator-role').value;
      const share = parseInt(document.getElementById('collaborator-share').value) || 0;

      if (!wallet) {
        this.showToast('Please enter a wallet address', 'error');
        return;
      }

      const collaborator = { wallet, role, share };
      this.collaborators.push(collaborator);

      // Add to UI
      const collabList = document.getElementById('collaborators-list');
      const collabDiv = document.createElement('div');
      collabDiv.className = 'collaborator-item';
      collabDiv.innerHTML = `
        <div class="collaborator-info">
          <strong>${role}</strong>
          <span class="collaborator-wallet">${wallet.substring(0, 8)}...${wallet.substring(wallet.length - 6)}</span>
          <span class="collaborator-share">${share}% share</span>
        </div>
        <button type="button" class="btn-remove-small" onclick="window.trackFormManager?.removeCollaborator(${this.collaborators.length - 1})">√ó</button>
      `;
      collabList.appendChild(collabDiv);

      // Close modal and reset
      this.closeModal('add-collaborator-modal');
      document.getElementById('add-collaborator-form').reset();
    }

    removeCollaborator(index) {
      this.collaborators.splice(index, 1);
      // Re-render list
      const collabList = document.getElementById('collaborators-list');
      collabList.innerHTML = '';
      this.collaborators.forEach((collab, i) => {
        const collabDiv = document.createElement('div');
        collabDiv.className = 'collaborator-item';
        collabDiv.innerHTML = `
          <div class="collaborator-info">
            <strong>${collab.role}</strong>
            <span class="collaborator-wallet">${collab.wallet.substring(0, 8)}...${collab.wallet.substring(collab.wallet.length - 6)}</span>
            <span class="collaborator-share">${collab.share}% share</span>
          </div>
          <button type="button" class="btn-remove-small" onclick="window.trackFormManager?.removeCollaborator(${i})">√ó</button>
        `;
        collabList.appendChild(collabDiv);
      });
    }

    async handleSubmit(event) {
      event.preventDefault();

      if (!this.audioFile) {
        this.showToast('Please upload an audio file', 'error');
        return;
      }

      const form = event.target;
      const formData = new FormData(form);

      // Add files
      formData.append('audioFile', this.audioFile);
      if (this.coverArtFile) {
        formData.append('coverArt', this.coverArtFile);
      }

      // Add collaborators
      formData.append('collaborators', JSON.stringify(this.collaborators));

      // Show loading
      const submitBtn = document.getElementById('upload-track-btn');
      const originalHTML = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span>‚è≥ Uploading...</span>';

      try {
        // TODO: Replace with actual API endpoint
        console.log('Track upload data:', {
          title: formData.get('title'),
          genre: formData.get('genre'),
          hasAudio: !!this.audioFile,
          hasCover: !!this.coverArtFile,
          collaborators: this.collaborators
        });

        // Simulate upload
        await new Promise(resolve => setTimeout(resolve, 2000));

        // Award XP
        if (window.progressManager) {
          window.progressManager.awardXP(100, 'track_upload', 'Track uploaded');
        }

        // Show success
        this.showToast('‚úÖ Track uploaded successfully!', 'success');

        // Reset form
        form.reset();
        this.removeAudioFile();
        this.removeCoverArt();
        this.collaborators = [];
        document.getElementById('collaborators-list').innerHTML = '';

        // Navigate to library
        setTimeout(() => {
          // TODO: Navigate to track detail or library
          window.location.href = '/music?tab=library';
        }, 1500);

      } catch (error) {
        this.showToast('‚ùå Failed to upload track. Please try again.', 'error');
        console.error('Upload error:', error);
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalHTML;
      }
    }

    formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // Modal management
    openModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
    }

    closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
      }
    }

    // Toast notification
    showToast(message, type = 'info') {
      document.querySelectorAll('.toast').forEach(t => t.remove());

      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
  }

  window.trackFormManager = new TrackFormManager();

  // Global functions for onclick handlers
  window.removeAudioFile = () => window.trackFormManager?.removeAudioFile();
  window.removeCoverArt = () => window.trackFormManager?.removeCoverArt();
  window.importLyrics = () => {
    window.trackFormManager?.showToast('Lyrics import feature coming soon!', 'info');
  };
  window.resetForm = () => {
    document.getElementById('track-upload-form')?.reset();
    window.trackFormManager?.removeAudioFile();
    window.trackFormManager?.removeCoverArt();
  };

  // Initialize form listeners
  document.getElementById('track-upload-form')?.addEventListener('submit', (e) => {
    window.trackFormManager.handleSubmit(e);
  });

  // File upload areas
  document.getElementById('audio-upload-area')?.addEventListener('click', () => {
    document.getElementById('audio-file').click();
  });

  document.getElementById('cover-upload-area')?.addEventListener('click', () => {
    document.getElementById('cover-art').click();
  });

  // Show collaborators section when checkbox checked
  document.getElementById('is-collaboration')?.addEventListener('change', (e) => {
    document.getElementById('collaborators-section').style.display = 
      e.target.checked ? 'block' : 'none';
  });

  window.beatMaker = {
    // State
    isPlaying: false,
    currentStep: 0,
    tempo: 120,
    timerId: null,
    lastTickTime: 0,

    // Audio Context
    audioCtx: new (window.AudioContext || window.webkitAudioContext)(),
    samples: {}, // Holds the decoded audio buffers

    // Load samples into memory on initialization
    async initSamples() {
      const sampleMap = {
        kick: '/samples/kick.wav',
        snare: '/samples/snare.wav',
        hihat: '/samples/hihat.wav',
        reggaeton: '/samples/horn.wav',
        shout: '/samples/yo-shout.wav'
      };

      for (const [name, path] of Object.entries(sampleMap)) {
        try {
          const response = await fetch(path);
          const arrayBuffer = await response.arrayBuffer();
          this.samples[name] = await this.audioCtx.decodeAudioData(arrayBuffer);
        } catch (e) {
          console.error(`Failed to load sample: ${name}`, e);
        }
      }
    },

    async togglePlayback() {
      if (Object.keys(this.samples).length === 0) {
        await this.initSamples();
      }

      if (this.audioCtx.state === 'suspended') {
        await this.audioCtx.resume();
      }

      if (this.isPlaying) {
        this.stop();
      } else {
        this.start();
      }
    },

    start() {
      if (this.audioCtx.state === 'suspended') {
        this.audioCtx.resume();
      }
      this.isPlaying = true;
      document.getElementById('seq-play-text').textContent = 'Pause';
      document.getElementById('seq-play-icon').textContent = '‚è∏Ô∏è';
      this.runSequencer();
    },

    stop() {
      this.isPlaying = false;
      cancelAnimationFrame(this.timerId);
      document.getElementById('seq-play-text').textContent = 'Play';
      document.getElementById('seq-play-icon').textContent = '‚ñ∂Ô∏è';
      this.currentStep = 0;
      this.updateVisuals();
    },

    runSequencer() {
      const now = this.audioCtx.currentTime;
      const stepDuration = 60 / this.tempo / 4; // 16th notes

      if (now - this.lastTickTime > stepDuration) {
        this.lastTickTime = now;
        this.playStep(this.currentStep);
        this.updateVisuals();
        
        // Move to next step
        this.currentStep = (this.currentStep + 1) % 16;
      }

      if (this.isPlaying) {
        this.timerId = requestAnimationFrame(() => this.runSequencer());
      }
    },

    playStep(stepIndex) {
      // Find all active buttons for this specific step
      const activePads = document.querySelectorAll(`.step-btn[data-step="${stepIndex}"].active`);

      activePads.forEach(pad => {
        const track = pad.getAttribute('data-track');
        this.triggerSound(track);
      });
    },

    triggerSound(track) {
      // Try to use loaded sample first, fallback to oscillator
      if (this.samples[track]) {
        const source = this.audioCtx.createBufferSource();
        source.buffer = this.samples[track];

        // Add a gain node for volume control per track
        const gainNode = this.audioCtx.createGain();
        const volume = document.querySelector(`.track-volume-slider[data-track="${track}"]`)?.value || 80;
        gainNode.gain.value = volume / 100;

        source.connect(gainNode);
        gainNode.connect(this.audioCtx.destination);

        source.start(0);
      } else {
        // Fallback to simple oscillator if sample not loaded
        const osc = this.audioCtx.createOscillator();
        const gain = this.audioCtx.createGain();

        osc.connect(gain);
        gain.connect(this.audioCtx.destination);

        // Different pitch for different tracks
        const pitches = { kick: 150, snare: 300, hihat: 800, reggaeton: 400, bass: 80, guitar: 220, clap: 600, shout: 500, horn: 350, water: 700, electric: 1200, book: 250 };
        osc.frequency.setValueAtTime(pitches[track] || 200, this.audioCtx.currentTime);

        gain.gain.setValueAtTime(0.1, this.audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, this.audioCtx.currentTime + 0.1);

        osc.start();
        osc.stop(this.audioCtx.currentTime + 0.1);
      }
    },

    toggleStep(track, step) {
      const btn = document.querySelector(`.step-btn[data-track="${track}"][data-step="${step}"]`);
      if (btn) btn.classList.toggle('active');
    },

    setTempo(value) {
      this.tempo = parseInt(value);
      document.getElementById('seq-tempo-display').textContent = value;
    },

    setVolume(value) {
      document.getElementById('seq-volume-display').textContent = value;
    },

    setSwing(value) {
      document.getElementById('seq-swing-display').textContent = value;
    },

    toggleMute(track) {
      console.log('Toggle mute:', track);
    },

    toggleSolo(track) {
      console.log('Toggle solo:', track);
    },

    randomizeTrack(track) {
      for (let i = 0; i < 16; i++) {
        const btn = document.querySelector(`.step-btn[data-track="${track}"][data-step="${i}"]`);
        if (btn && Math.random() > 0.7) {
          btn.classList.add('active');
        }
      }
    },

    setTrackVolume(track, value) {
      const valueSpan = document.querySelector(`.track-volume-slider[data-track="${track}"]`)?.nextElementSibling;
      if (valueSpan) valueSpan.textContent = value;
    },

    clearPattern() {
      document.querySelectorAll('.step-btn.active').forEach(btn => btn.classList.remove('active'));
    },

    randomizeAll() {
      const tracks = ['kick', 'snare', 'hihat', 'bass', 'guitar', 'clap', 'shout', 'horn', 'reggaeton', 'water', 'electric', 'book'];
      tracks.forEach(track => this.randomizeTrack(track));
    },

    tapTempo() {
      console.log('Tap tempo');
    },

    undo() {
      console.log('Undo');
    },

    redo() {
      console.log('Redo');
    },

    savePattern() {
      console.log('Save pattern');
    },

    loadPattern() {
      console.log('Load pattern');
    },

    exportBeat() {
      console.log('Export beat');
    },

    sharePattern() {
      console.log('Share pattern');
    },

    useAsBackingTrack() {
      console.log('Use as backing track');
    },

    loadPreset(preset) {
      console.log('Load preset:', preset);
    },

    switchMode(mode) {
      const generateMode = document.getElementById('beatmaker-generate-mode');
      const uploadMode = document.getElementById('beatmaker-upload-mode');
      const buttons = document.querySelectorAll('.mode-toggle-btn');

      buttons.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });

      if (mode === 'generate') {
        if (generateMode) generateMode.style.display = 'block';
        if (uploadMode) uploadMode.style.display = 'none';
      } else {
        if (generateMode) generateMode.style.display = 'none';
        if (uploadMode) uploadMode.style.display = 'block';
      }
    },

    updateVisuals() {
      // Update the "Step X/16" display
      const display = document.getElementById('current-step-display');
      if (display) display.textContent = this.currentStep + 1;

      // Move the progress indicator bar
      const indicator = document.getElementById('seq-position-indicator');
      if (indicator) {
        indicator.style.left = `${(this.currentStep / 16) * 100}%`;
      }

      // Visual highlight on the buttons
      document.querySelectorAll('.step-btn').forEach(btn => btn.classList.remove('playing'));
      document.querySelectorAll(`.step-btn[data-step="${this.currentStep}"]`).forEach(btn => {
        btn.classList.add('playing');
      });
    }
  };

window.sampleManager = {
    basePath: '/data/music/',
    library: [],

    async init() {
      // 1. Load Base Library from /public/data/music/library.json
      try {
        const response = await fetch(`${this.basePath}library.json`);
        const baseData = await response.json();
        
        // 2. Load User Data from localStorage
        const userData = JSON.parse(localStorage.getItem('user_samples') || '[]');
        
        // 3. Merge and Render
        this.library = [...baseData, ...userData];
        this.renderLibrary();
      } catch (e) {
        console.error("Failed to load base library manifest", e);
      }
    },

    renderLibrary() {
      const container = document.getElementById('sample-list-container');
      container.innerHTML = this.library.map(sample => `
        <div class="sample-row">
          <div class="sample-info">
            <span class="name">${sample.name}</span>
            <span class="origin">${sample.isUser ? 'üë§ User' : 'üì¶ Base'}</span>
          </div>
          <div class="sample-actions">
            <button onclick="window.sampleManager.preview('${sample.url}')">‚ñ∂Ô∏è</button>
            <button onclick="window.sampleManager.assignToSequencer('${sample.id}')">üéπ Use</button>
          </div>
        </div>
      `).join('');
    },

    assignToSequencer(sampleId) {
      const sample = this.library.find(s => s.id == sampleId);
      // Logic to tell window.beatMaker to update a track buffer
      if (window.beatMaker) {
        window.beatMaker.loadSpecificSample('kick', sample.url);
        alert(`Assigned ${sample.name} to Kick track!`);
      }
    }
  };

  document.addEventListener('DOMContentLoaded', () => window.sampleManager.init());


</script>

<style>

/* The vertical line or highlight that moves across the grid */
.step-btn.playing {
  border-color: #00ff88;
  background-color: #333; /* Slightly brighter when playhead passes */
}

/* The Progress Bar Container */
.playback-position {
  width: 100%;
  height: 20px;
  background: #111;
  position: relative;
  margin: 10px 0;
  border-radius: 10px;
  overflow: hidden;
}

.position-bar {
  width: 100%;
  height: 100%;
}

.position-indicator {
  position: absolute;
  top: 0;
  width: 6.25%; /* 1/16th of the width */
  height: 100%;
  background: rgba(0, 255, 136, 0.3);
  transition: left 0.05s linear;
}

/* Add this class via JS inside triggerSound for extra polish */
.track-label.pulse {
  color: #00ff88;
  transform: scale(1.05);
  transition: transform 0.1s;
}

.sequencer-row[data-track-color="drums"] .step-btn.active {
  background: #ff4757; /* Red for drums */
  box-shadow: 0 0 10px #ff4757;
}

.sequencer-row[data-track="reggaeton"] .step-btn.active {
  background: #eccc68; /* Gold for the lead horn */
  box-shadow: 0 0 10px #eccc68;
}

  /* Music studio specific styles */
  .studio-header {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    padding: 2rem 0;
    margin-bottom: 2rem;
  }

  .studio-nav-tabs {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
  }

  .studio-tab {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem 1.5rem;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 0.5rem;
    color: white;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .studio-tab.active {
    background: white;
    color: #f5576c;
  }

  .create-track-layout {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 2rem;
  }

  .track-form {
    background: white;
    padding: 2rem;
    border-radius: 1rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .file-upload-area {
    border: 2px dashed #ddd;
    border-radius: 0.5rem;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
  }

  .file-upload-area:hover {
    border-color: #f5576c;
    background: #fef3f4;
  }

  /* More styles... */
</style>
