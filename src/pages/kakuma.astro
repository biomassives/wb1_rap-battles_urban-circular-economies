---
/**
 * kakuma.astro
 * Kakuma Refugee Camp Impact Dashboard
 * 
 * Features:
 * - View active Kakuma projects
 * - Track your impact on youth
 * - Make donations/support projects
 * - See success stories
 * - Connect with Kakuma youth
 */

import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout 
  title="Kakuma Impact" 
  description="Support Kakuma refugee camp youth through education, music, and sustainable projects"
  activeSection="kakuma"
>

  <!-- ============================================ -->
  <!-- KAKUMA IMPACT HERO -->
  <!-- ============================================ -->
  <section class="kakuma-hero">
    <div class="container mx-auto">
      <div class="hero-content-grid">
        
        <!-- Left: Mission Statement -->
        <div class="hero-mission">
          <h1 class="hero-title">Supporting Kakuma Youth</h1>
          <p class="hero-description">
            Empowering refugee youth in Kakuma camp through music education, 
            environmental training, and income opportunities. Together, we're 
            building futures and breaking barriers.
          </p>
          
          <div class="hero-location">
            <span class="location-icon">üìç</span>
            <span class="location-text">Kakuma Refugee Camp, Kenya</span>
          </div>

          <div class="hero-actions">
            <button class="btn-primary large" onclick="scrollToProjects()">
              View Projects
            </button>
            <button class="btn-secondary large" onclick="showVolunteerModal()">
              Volunteer & Earn
            </button>
          </div>
        </div>

        <!-- Right: Impact Stats -->
        <div class="impact-stats-card">
          <h3 class="stats-title">Our Collective Impact</h3>
          
          <div class="impact-stat-row highlight">
            <div class="impact-stat">
              <div class="stat-number" id="total-youth-impacted">0</div>
              <div class="stat-label">Youth Impacted</div>
            </div>
            <div class="impact-stat">
              <div class="stat-number" id="total-value-generated">$0</div>
              <div class="stat-label">Value Generated</div>
            </div>
          </div>

          <div class="impact-stat-row">
            <div class="impact-stat">
              <div class="stat-number" id="active-projects">0</div>
              <div class="stat-label">Active Projects</div>
            </div>
            <div class="impact-stat">
              <div class="stat-number" id="total-contributors">0</div>
              <div class="stat-label">Contributors</div>
            </div>
          </div>

          <div class="impact-stat-row">
            <div class="impact-stat">
              <div class="stat-number" id="skills-taught">0</div>
              <div class="stat-label">Skills Taught</div>
            </div>
            <div class="impact-stat">
              <div class="stat-number" id="jobs-created">0</div>
              <div class="stat-label">Jobs Created</div>
            </div>
          </div>

          <div class="revenue-allocation">
            <h4>Revenue Allocation to Kakuma:</h4>
            <div class="allocation-item">
              <span>Platform Revenue</span>
              <strong>20%</strong>
            </div>
            <div class="allocation-item">
              <span>NFT Sales</span>
              <strong>30%</strong>
            </div>
            <div class="allocation-item">
              <span>Battle Prizes</span>
              <strong>50%</strong>
            </div>
            <div class="allocation-item">
              <span>Data Collection Fees</span>
              <strong>100%</strong>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- ============================================ -->
  <!-- YOUR KAKUMA IMPACT -->
  <!-- ============================================ -->
  <section class="your-impact-section">
    <div class="container mx-auto">
      
      <h2 class="section-title">Your Personal Impact</h2>

      <div class="your-impact-grid">
        
        <!-- Impact Summary Card -->
        <div class="your-impact-card">
          <div class="card-icon">üåü</div>
          <h3 class="card-title">Youth You've Supported</h3>
          <div class="card-value" id="your-youth-impacted">0</div>
          <p class="card-description">
            Direct and indirect impact through your activities on the platform
          </p>
        </div>

        <!-- Activities Card -->
        <div class="your-impact-card">
          <div class="card-icon">üìä</div>
          <h3 class="card-title">Impact Actions</h3>
          <div class="card-value" id="your-impact-actions">0</div>
          <p class="card-description">
            Total actions that generated support for Kakuma youth
          </p>
        </div>

        <!-- Value Generated Card -->
        <div class="your-impact-card">
          <div class="card-icon">üí∞</div>
          <h3 class="card-title">Value Generated</h3>
          <div class="card-value" id="your-value-generated">$0</div>
          <p class="card-description">
            Economic value created for Kakuma through your participation
          </p>
        </div>

        <!-- Projects Supported Card -->
        <div class="your-impact-card">
          <div class="card-icon">üéØ</div>
          <h3 class="card-title">Projects Supported</h3>
          <div class="card-value" id="your-projects-supported">0</div>
          <p class="card-description">
            Number of Kakuma projects you've contributed to
          </p>
        </div>

      </div>

      <!-- How You're Helping -->
      <div class="helping-breakdown">
        <h3 class="subsection-title">How You're Helping</h3>
        <div id="impact-breakdown-list" class="impact-breakdown-list">
          <!--
          Impact items loaded here
          
          Template:
          <div class="impact-item">
            <div class="impact-icon">üéµ</div>
            <div class="impact-content">
              <h4 class="impact-title">Music Uploads</h4>
              <p class="impact-description">
                30% of royalties from your 3 published tracks support Kakuma music education
              </p>
            </div>
            <div class="impact-value">
              <span class="value-number">$45</span>
              <span class="value-label">contributed</span>
            </div>
          </div>
          -->
        </div>
      </div>

    </div>
  </section>

  <!-- ============================================ -->
  <!-- ACTIVE KAKUMA PROJECTS -->
  <!-- ============================================ -->
  <section id="projects-section" class="kakuma-projects-section">
    <div class="container mx-auto">
      
      <div class="section-header">
        <h2 class="section-title">Active Kakuma Projects</h2>
        <p class="section-subtitle">
          Support ongoing initiatives that create direct impact
        </p>
      </div>

      <!-- Project Filters -->
      <div class="project-filters">
        <button class="filter-chip active" data-filter="all">All Projects</button>
        <button class="filter-chip" data-filter="education">üéì Education</button>
        <button class="filter-chip" data-filter="agriculture">üåæ Agriculture</button>
        <button class="filter-chip" data-filter="energy">‚òÄÔ∏è Energy</button>
        <button class="filter-chip" data-filter="water">üíß Water</button>
        <button class="filter-chip" data-filter="music">üéµ Music & Arts</button>
      </div>

      <!-- Projects Grid -->
      <div id="kakuma-projects-grid" class="kakuma-projects-grid">
        
        <!-- Example Project Card -->
        <!--
        <div class="kakuma-project-card [status-class]">
          <div class="project-image">
            <img src="/project-image.jpg" alt="Project" />
            <div class="project-category-tag">üåæ Agriculture</div>
          </div>
          
          <div class="project-content">
            <h3 class="project-title">Permaculture Garden Initiative</h3>
            <p class="project-description">
              Establishing sustainable food gardens in Kakuma 1 and 2 to improve 
              nutrition and teach permaculture skills to youth
            </p>
            
            <div class="project-location">
              <span class="location-icon">üìç</span>
              Kakuma 1 & 2
            </div>
            
            <div class="project-impact">
              <div class="impact-metric">
                <span class="metric-label">Target Beneficiaries:</span>
                <span class="metric-value">200 youth</span>
              </div>
              <div class="impact-metric">
                <span class="metric-label">Current Reach:</span>
                <span class="metric-value">87 youth (44%)</span>
              </div>
            </div>
            
            <div class="project-funding">
              <div class="funding-progress">
                <div class="funding-bar">
                  <div class="funding-fill" style="width: 65%"></div>
                </div>
                <div class="funding-labels">
                  <span class="funding-raised">$6,500 raised</span>
                  <span class="funding-goal">of $10,000</span>
                </div>
              </div>
            </div>
            
            <div class="project-status">
              <span class="status-badge active">Active</span>
              <span class="timeline">3 months remaining</span>
            </div>
          </div>
          
          <div class="project-actions">
            <button class="btn-primary" onclick="supportProject('project-id')">
              Support Project
            </button>
            <button class="btn-secondary" onclick="viewProjectDetails('project-id')">
              View Details
            </button>
          </div>
        </div>
        -->

      </div>

    </div>
  </section>

  <!-- ============================================ -->
  <!-- SUCCESS STORIES -->
  <!-- ============================================ -->
  <section class="success-stories-section">
    <div class="container mx-auto">
      
      <h2 class="section-title">Success Stories</h2>
      <p class="section-subtitle">
        Meet the youth whose lives have been transformed
      </p>

      <div id="success-stories-grid" class="success-stories-grid">
        
        <!-- Example Story Card -->
        <!--
        <div class="story-card">
          <div class="story-image">
            <img src="/youth-photo.jpg" alt="Youth" />
          </div>
          
          <div class="story-content">
            <h3 class="story-name">Ahmed M.</h3>
            <div class="story-location">Kakuma 2, Kenya</div>
            
            <div class="story-quote">
              "Learning music production changed my life. Now I teach others 
              and earn income from my tracks. Thank you WorldBridger One!"
            </div>
            
            <div class="story-achievements">
              <span class="achievement-tag">üéµ Producer</span>
              <span class="achievement-tag">üéì Certified</span>
              <span class="achievement-tag">üí∞ Earning</span>
            </div>
            
            <div class="story-stats">
              <div class="story-stat">
                <strong>12</strong> tracks produced
              </div>
              <div class="story-stat">
                <strong>$450</strong> earned
              </div>
              <div class="story-stat">
                <strong>8</strong> students taught
              </div>
            </div>
          </div>
        </div>
        -->

      </div>

      <div class="stories-cta">
        <button class="btn-secondary large" onclick="loadMoreStories()">
          Load More Stories
        </button>
      </div>

    </div>
  </section>

  <!-- ============================================ -->
  <!-- HOW TO GET INVOLVED -->
  <!-- ============================================ -->
  <section class="get-involved-section">
    <div class="container mx-auto">
      
      <h2 class="section-title">How You Can Help</h2>

      <div class="involvement-grid">
        
        <div class="involvement-card">
          <div class="involvement-icon">üéµ</div>
          <h3 class="involvement-title">Create Music</h3>
          <p class="involvement-description">
            Upload tracks, battle, collaborate. 30% of your music revenue 
            supports Kakuma youth programs.
          </p>
          <a href="/music" class="involvement-link">Go to Studio ‚Üí</a>
        </div>

        <div class="involvement-card">
          <div class="involvement-icon">üå±</div>
          <h3 class="involvement-title">Share Knowledge</h3>
          <p class="involvement-description">
            Complete courses and share learnings. Teach environmental 
            practices to youth in the camp.
          </p>
          <a href="/learning" class="involvement-link">Browse Courses ‚Üí</a>
        </div>

        <div class="involvement-card">
          <div class="involvement-icon">ü§ù</div>
          <h3 class="involvement-title">Mentor Youth</h3>
          <p class="involvement-description">
            Connect directly with Kakuma youth. Share skills, provide 
            guidance, and build lasting connections.
          </p>
          <button class="involvement-link" onclick="showMentorSignup()">
            Become Mentor ‚Üí
          </button>
        </div>

        <div class="involvement-card">
          <div class="involvement-icon">üéÅ</div>
          <h3 class="involvement-title">Volunteer & Earn NFTs</h3>
          <p class="involvement-description">
            Contribute to specific projects and earn exclusive project NFTs.
            Check floor prices and trade your impact.
          </p>
          <button class="involvement-link" onclick="showVolunteerModal()">
            Volunteer & Earn ‚Üí
          </button>
        </div>

        <div class="involvement-card">
          <div class="involvement-icon">üìä</div>
          <h3 class="involvement-title">Citizen Science</h3>
          <p class="involvement-description">
            Submit environmental observations. Data collection fees go 
            directly to youth contributors.
          </p>
          <a href="/learning#projects" class="involvement-link">Submit Data ‚Üí</a>
        </div>

        <div class="involvement-card">
          <div class="involvement-icon">üåê</div>
          <h3 class="involvement-title">Spread the Word</h3>
          <p class="involvement-description">
            Share projects, success stories, and opportunities. Help us 
            reach more supporters.
          </p>
          <button class="involvement-link" onclick="shareKakuma()">
            Share Now ‚Üí
          </button>
        </div>

      </div>

    </div>
  </section>

  <!-- ============================================ -->
  <!-- VOLUNTEER & EARN MODAL -->
  <!-- ============================================ -->
  <div id="volunteer-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">

      <div class="modal-header">
        <h3>Volunteer & Earn Project NFTs</h3>
        <button class="btn-close" onclick="closeVolunteerModal()">√ó</button>
      </div>

      <form id="volunteer-form" class="volunteer-form">
        
        <!-- Project Selection -->
        <div class="form-group">
          <label class="form-label">Select Project *</label>
          <select id="volunteer-project" class="form-select" required>
            <option value="">Choose a project...</option>
            <!-- Projects loaded dynamically -->
          </select>
        </div>

        <!-- Project NFT Floor Price Display -->
        <div id="nft-floor-price-display" class="nft-floor-price" style="display: none;">
          <div class="floor-price-card">
            <div class="floor-price-header">
              <span class="floor-price-label">Project NFT Floor Price</span>
              <span class="floor-price-value" id="floor-price-value">--</span>
            </div>
            <div class="floor-price-stats">
              <div class="stat-item">
                <span class="stat-label">24h Volume:</span>
                <span class="stat-value" id="volume-24h">--</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Total Minted:</span>
                <span class="stat-value" id="total-minted">--</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Contribution Amount -->
        <div class="form-group">
          <label class="form-label">Contribution Amount *</label>

          <!-- Quick amounts -->
          <div class="quick-amounts">
            <button type="button" class="quick-amount" data-amount="10">$10</button>
            <button type="button" class="quick-amount" data-amount="25">$25</button>
            <button type="button" class="quick-amount" data-amount="50">$50</button>
            <button type="button" class="quick-amount" data-amount="100">$100</button>
            <button type="button" class="quick-amount" data-amount="custom">Custom</button>
          </div>

          <!-- Custom amount input -->
          <div class="amount-input-group">
            <span class="currency-symbol">$</span>
            <input
              type="number"
              id="volunteer-amount"
              class="form-input"
              placeholder="0.00"
              min="1"
              step="0.01"
              required
            />
            <select id="volunteer-currency" class="form-select currency-select">
              <option value="USD">USD</option>
              <option value="SOL">SOL</option>
            </select>
          </div>
        </div>

        <!-- Recurring Option -->
        <div class="form-group">
          <div class="form-checkbox">
            <input type="checkbox" id="volunteer-recurring" />
            <label for="volunteer-recurring">
              Make this a recurring monthly contribution
            </label>
          </div>
        </div>

        <!-- NFT Rewards Preview -->
        <div class="nft-rewards-preview">
          <h4>üéÅ You'll Earn:</h4>
          <div id="nft-rewards-text" class="nft-rewards-text">
            <!-- Generated based on amount -->
          </div>
        </div>

        <!-- Optional Message -->
        <div class="form-group">
          <label for="volunteer-message" class="form-label">
            Message (Optional)
          </label>
          <textarea
            id="volunteer-message"
            class="form-textarea"
            rows="3"
            placeholder="Add a message of encouragement for the youth..."
          ></textarea>
        </div>

        <!-- Anonymous Option -->
        <div class="form-group">
          <div class="form-checkbox">
            <input type="checkbox" id="volunteer-anonymous" />
            <label for="volunteer-anonymous">
              Contribute anonymously
            </label>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button
            type="button"
            class="btn-secondary"
            onclick="closeVolunteerModal()"
          >
            Cancel
          </button>
          <button type="submit" class="btn-primary">
            <span class="btn-icon">üéÅ</span>
            Contribute & Earn NFT
          </button>
        </div>

        <p class="form-note">
          100% of your contribution goes to the project. You'll receive an exclusive
          project NFT that represents your impact.
        </p>

      </form>

    </div>
  </div>

</BaseLayout>

<script>
  /**
   * Kakuma Impact Manager
   */
  class KakumaImpactManager {
    constructor() {
      this.projects = [];
      this.userImpact = null;
      this.globalStats = null;
    }

    async initialize() {
      await this.loadGlobalStats();
      await this.loadKakumaProjects();
      
      const walletAddress = window.walletManager?.connectedWallet;
      if (walletAddress) {
        await this.loadUserImpact(walletAddress);
      }
      
      this.renderAll();
    }

    async loadGlobalStats() {
      try {
        const response = await fetch('/api/kakuma/global-stats');
        const data = await response.json();
        
        if (data.success) {
          this.globalStats = data.stats;
        }
      } catch (error) {
        console.error('Failed to load global stats:', error);
      }
    }

    async loadKakumaProjects() {
      try {
        // Use generic projects API with Kakuma filter
        const response = await fetch('/api/projects/list?initiative=kakuma&status=active');
        const data = await response.json();

        if (data.success) {
          this.projects = data.projects;
        }
      } catch (error) {
        console.error('Failed to load projects:', error);
        // Set empty projects so UI shows fallback
        this.projects = [];
      }
    }

    async loadUserImpact(walletAddress) {
      try {
        const response = await fetch(
          `/api/kakuma/user-impact?walletAddress=${walletAddress}`
        );
        const data = await response.json();

        if (data.success) {
          this.userImpact = data;
        }
      } catch (error) {
        console.error('Failed to load user impact:', error);
      }
    }

    renderAll() {
      this.renderGlobalStats();
      this.renderUserImpact();
      this.renderProjects();
    }

    renderGlobalStats() {
      if (!this.globalStats) return;

      document.getElementById('total-youth-impacted').textContent = 
        this.globalStats.totalYouth || 0;
      document.getElementById('total-value-generated').textContent = 
        `$${this.globalStats.totalValue || 0}`;
      document.getElementById('active-projects').textContent = 
        this.globalStats.activeProjects || 0;
      document.getElementById('total-contributors').textContent = 
        this.globalStats.contributors || 0;
      document.getElementById('skills-taught').textContent = 
        this.globalStats.skillsTaught || 0;
      document.getElementById('jobs-created').textContent = 
        this.globalStats.jobsCreated || 0;
    }

    renderUserImpact() {
      if (!this.userImpact) return;

      document.getElementById('your-youth-impacted').textContent = 
        this.userImpact.youthImpacted || 0;
      document.getElementById('your-impact-actions').textContent = 
        this.userImpact.totalActions || 0;
      document.getElementById('your-value-generated').textContent = 
        `$${this.userImpact.valueGenerated || 0}`;
      document.getElementById('your-projects-supported').textContent = 
        this.userImpact.projectsSupported || 0;
    }

    renderProjects(filterCategory = 'all') {
      const container = document.getElementById('kakuma-projects-grid');

      if (!this.projects || this.projects.length === 0) {
        container.innerHTML = '<p class="empty-state">No active projects found</p>';
        return;
      }

      // Filter projects by category
      let filteredProjects = this.projects;
      if (filterCategory !== 'all') {
        filteredProjects = this.projects.filter(p => p.category === filterCategory);
      }

      if (filteredProjects.length === 0) {
        container.innerHTML = `<p class="empty-state">No ${filterCategory} projects found</p>`;
        return;
      }

      // Render project cards
      container.innerHTML = filteredProjects.map(project => {
        const fundingPercent = Math.round((project.funding_raised / project.funding_goal) * 100);
        const beneficiaryPercent = project.current_beneficiaries
          ? Math.round((project.current_beneficiaries / project.target_beneficiaries) * 100)
          : 0;

        const categoryIcons = {
          education: 'üéì',
          agriculture: 'üåæ',
          energy: '‚òÄÔ∏è',
          water: 'üíß',
          music: 'üéµ'
        };

        const categoryIcon = categoryIcons[project.category] || 'üì¶';

        return `
          <div class="kakuma-project-card" data-category="${project.category}">
            <div class="project-image">
              <img src="${project.image_url || '/images/placeholder-project.jpg'}" alt="${project.title}" />
              <div class="project-category-tag">${categoryIcon} ${project.category}</div>
            </div>

            <div class="project-content">
              <h3 class="project-title">${project.title}</h3>
              <p class="project-description">
                ${project.description}
              </p>

              <div class="project-location">
                <span class="location-icon">üìç</span>
                ${project.location || 'Kakuma Camp'}
              </div>

              <div class="project-impact">
                <div class="impact-metric">
                  <span class="metric-label">Target Beneficiaries:</span>
                  <span class="metric-value">${project.target_beneficiaries} youth</span>
                </div>
                ${project.current_beneficiaries ? `
                  <div class="impact-metric">
                    <span class="metric-label">Current Reach:</span>
                    <span class="metric-value">${project.current_beneficiaries} youth (${beneficiaryPercent}%)</span>
                  </div>
                ` : ''}
              </div>

              <div class="project-funding">
                <div class="funding-progress">
                  <div class="funding-bar">
                    <div class="funding-fill" style="width: ${fundingPercent}%"></div>
                  </div>
                  <div class="funding-labels">
                    <span class="funding-raised">$${project.funding_raised.toLocaleString()} raised</span>
                    <span class="funding-goal">of $${project.funding_goal.toLocaleString()}</span>
                  </div>
                </div>
              </div>

              <div class="project-status">
                <span class="status-badge ${project.status}">${project.status}</span>
                ${project.timeline_remaining ? `<span class="timeline">${project.timeline_remaining}</span>` : ''}
              </div>
            </div>

            <div class="project-actions">
              <button class="btn-primary" onclick="supportProject('${project.id}')">
                Support Project
              </button>
              <button class="btn-secondary" onclick="viewProjectDetails('${project.id}')">
                View Details
              </button>
            </div>
          </div>
        `;
      }).join('');

      // Populate donation modal project selector
      this.populateProjectSelector();
    }

    populateProjectSelector() {
      const selector = document.getElementById('volunteer-project');
      if (!selector || !this.projects) return;

      // Add all projects to selector
      const projectOptions = this.projects.map(project =>
        `<option value="${project.id}" data-floor-price="${project.nft_floor_price || 0}">${project.title}</option>`
      ).join('');

      selector.innerHTML = '<option value="">Choose a project...</option>' + projectOptions;
    }

    getProjectNFTData(projectId) {
      const project = this.projects.find(p => p.id === projectId);
      if (!project) return null;

      // Mock NFT data - replace with real API call
      return {
        floorPrice: project.nft_floor_price || (Math.random() * 5 + 0.5).toFixed(2),
        volume24h: (Math.random() * 100 + 10).toFixed(1),
        totalMinted: Math.floor(Math.random() * 500 + 50)
      };
    }
  }

  window.kakumaImpactManager = new KakumaImpactManager();

  // Initialize when ready
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
      window.kakumaImpactManager.initialize();
    }, 500);
  });

  // Modal functions
  function showVolunteerModal() {
    document.getElementById('volunteer-modal').style.display = 'flex';
  }

  function closeVolunteerModal() {
    document.getElementById('volunteer-modal').style.display = 'none';
    document.getElementById('nft-floor-price-display').style.display = 'none';
  }

  function scrollToProjects() {
    document.getElementById('projects-section').scrollIntoView({ behavior: 'smooth' });
  }

  // Project selection - show NFT floor price
  document.getElementById('volunteer-project')?.addEventListener('change', (e) => {
    const projectId = e.target.value;
    if (!projectId) {
      document.getElementById('nft-floor-price-display').style.display = 'none';
      return;
    }

    const nftData = window.kakumaImpactManager.getProjectNFTData(projectId);
    if (nftData) {
      document.getElementById('floor-price-value').textContent = `${nftData.floorPrice} SOL`;
      document.getElementById('volume-24h').textContent = `${nftData.volume24h} SOL`;
      document.getElementById('total-minted').textContent = nftData.totalMinted;
      document.getElementById('nft-floor-price-display').style.display = 'block';
    }
  });

  // Project filter buttons
  document.querySelectorAll('.filter-chip').forEach(btn => {
    btn.addEventListener('click', () => {
      // Update active state
      document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      // Filter projects
      const category = btn.dataset.filter;
      window.kakumaImpactManager.renderProjects(category);
    });
  });

  // Quick amount buttons
  document.querySelectorAll('.quick-amount').forEach(btn => {
    btn.addEventListener('click', () => {
      const amount = btn.dataset.amount;
      if (amount === 'custom') {
        document.getElementById('volunteer-amount').focus();
      } else {
        document.getElementById('volunteer-amount').value = amount;
      }

      // Update active state
      document.querySelectorAll('.quick-amount').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      // Update NFT rewards preview
      updateNFTRewardsPreview(amount);
    });
  });

  // Project interaction functions
  function supportProject(projectId) {
    // Open volunteer modal with project pre-selected
    document.getElementById('volunteer-project').value = projectId;

    // Trigger change event to show NFT floor price
    const event = new Event('change');
    document.getElementById('volunteer-project').dispatchEvent(event);

    showVolunteerModal();
  }

  function viewProjectDetails(projectId) {
    // Find the project
    const project = window.kakumaImpactManager.projects.find(p => p.id === projectId);
    if (!project) return;

    const nftData = window.kakumaImpactManager.getProjectNFTData(projectId);

    // TODO: Show project details modal or navigate to project page
    alert(`Project Details: ${project.title}\n\n${project.description}\n\nFunding: $${project.funding_raised.toLocaleString()} / $${project.funding_goal.toLocaleString()}\n\nNFT Floor Price: ${nftData.floorPrice} SOL\n24h Volume: ${nftData.volume24h} SOL\nTotal NFTs Minted: ${nftData.totalMinted}`);
  }

  // NFT rewards preview based on contribution amount
  function updateNFTRewardsPreview(amount) {
    const previewEl = document.getElementById('nft-rewards-text');
    if (!amount || amount === 'custom') {
      previewEl.innerHTML = 'Enter an amount to see your NFT rewards';
      return;
    }

    const rewards = [];

    // Base NFT for any contribution
    rewards.push('üé® <strong>1 Project NFT</strong> - Commemorative impact badge');

    // XP rewards
    const xpAmount = amount * 10;
    rewards.push(`‚≠ê <strong>${xpAmount} XP</strong> - Level up your profile`);

    // Tier-based rewards
    if (amount >= 10) rewards.push('ü•â <strong>Bronze Contributor Badge</strong>');
    if (amount >= 25) rewards.push('ü•à <strong>Silver Contributor Badge</strong>');
    if (amount >= 50) rewards.push('ü•á <strong>Gold Contributor Badge</strong>');
    if (amount >= 100) rewards.push('üíé <strong>Diamond Contributor Badge</strong> + Special perks');
    if (amount >= 500) rewards.push('üëë <strong>Platinum Sponsor NFT</strong> + Exclusive access');

    previewEl.innerHTML = rewards.join('<br>');
  }

  // Volunteer contribution form submission
  document.getElementById('volunteer-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = {
      projectId: document.getElementById('volunteer-project').value,
      amount: parseFloat(document.getElementById('volunteer-amount').value),
      currency: document.getElementById('volunteer-currency').value,
      recurring: document.getElementById('volunteer-recurring').checked,
      message: document.getElementById('volunteer-message').value,
      anonymous: document.getElementById('volunteer-anonymous').checked,
      walletAddress: window.walletManager?.connectedWallet,
      mintNFT: true // Flag to mint project NFT
    };

    if (!formData.projectId || !formData.amount) {
      alert('Please select a project and enter an amount');
      return;
    }

    if (!formData.walletAddress || formData.walletAddress.startsWith('anon_')) {
      alert('Please connect a real wallet to receive your project NFT');
      return;
    }

    try {
      const response = await fetch('/api/donations/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });

      const data = await response.json();

      if (data.success) {
        const nftMessage = data.nft_minted
          ? `\n\nüéÅ Your project NFT has been minted and sent to your wallet!`
          : `\n\nüéÅ Your project NFT will be minted shortly.`;

        alert(`Thank you for volunteering! Your contribution makes a real difference.${nftMessage}\n\nXP Earned: ${data.xp_earned || 0}`);
        closeVolunteerModal();
        document.getElementById('volunteer-form').reset();

        // Reload user impact
        if (window.walletManager?.connectedWallet) {
          await window.kakumaImpactManager.loadUserImpact(window.walletManager.connectedWallet);
          window.kakumaImpactManager.renderUserImpact();
        }
      } else {
        alert('Contribution failed: ' + (data.error || 'Unknown error'));
      }
    } catch (error) {
      console.error('Contribution error:', error);
      alert('Failed to process contribution. Please try again.');
    }
  });
</script>

<style>
  .kakuma-hero {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    padding: 4rem 0;
  }

  .hero-content-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 3rem;
    align-items: center;
  }

  .impact-stats-card {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    padding: 2rem;
    border-radius: 1rem;
  }

  .your-impact-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 2rem;
    margin-top: 2rem;
  }

  .your-impact-card {
    background: white;
    padding: 2rem;
    border-radius: 1rem;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .kakuma-projects-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 2rem;
    margin-top: 2rem;
  }

  .involvement-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2rem;
    margin-top: 2rem;
  }

  .involvement-card {
    background: white;
    padding: 2rem;
    border-radius: 1rem;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  /* Project Cards */
  .kakuma-project-card {
    background: white;
    border-radius: 1rem;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .kakuma-project-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
  }

  .project-image {
    position: relative;
    height: 200px;
    overflow: hidden;
  }

  .project-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .project-category-tag {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: rgba(255, 255, 255, 0.95);
    padding: 0.5rem 1rem;
    border-radius: 2rem;
    font-weight: 600;
    font-size: 0.875rem;
    text-transform: capitalize;
  }

  .project-content {
    padding: 1.5rem;
  }

  .project-title {
    font-size: 1.25rem;
    font-weight: bold;
    margin-bottom: 0.75rem;
    color: #1f2937;
  }

  .project-description {
    color: #6b7280;
    margin-bottom: 1rem;
    line-height: 1.5;
  }

  .project-location {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #6b7280;
    font-size: 0.875rem;
    margin-bottom: 1rem;
  }

  .project-impact {
    background: #f9fafb;
    padding: 1rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
  }

  .impact-metric {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
  }

  .impact-metric:last-child {
    margin-bottom: 0;
  }

  .metric-label {
    color: #6b7280;
    font-size: 0.875rem;
  }

  .metric-value {
    font-weight: 600;
    color: #1f2937;
  }

  .project-funding {
    margin-bottom: 1rem;
  }

  .funding-bar {
    height: 8px;
    background: #e5e7eb;
    border-radius: 1rem;
    overflow: hidden;
    margin-bottom: 0.5rem;
  }

  .funding-fill {
    height: 100%;
    background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
    border-radius: 1rem;
    transition: width 0.3s;
  }

  .funding-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.875rem;
  }

  .funding-raised {
    font-weight: 600;
    color: #1f2937;
  }

  .funding-goal {
    color: #6b7280;
  }

  .project-status {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .status-badge.active {
    background: #d1fae5;
    color: #065f46;
  }

  .status-badge.completed {
    background: #dbeafe;
    color: #1e40af;
  }

  .timeline {
    color: #6b7280;
    font-size: 0.875rem;
  }

  .project-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
    padding: 1.5rem;
    border-top: 1px solid #e5e7eb;
  }

  /* Project Filters */
  .project-filters {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    margin-top: 1.5rem;
  }

  .filter-chip {
    padding: 0.5rem 1rem;
    border-radius: 2rem;
    border: 2px solid #e5e7eb;
    background: white;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
  }

  .filter-chip:hover {
    border-color: #f093fb;
    background: #fef3fd;
  }

  .filter-chip.active {
    border-color: #f093fb;
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .modal-content {
    background: white;
    border-radius: 1rem;
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
  }

  .btn-close {
    background: none;
    border: none;
    font-size: 2rem;
    cursor: pointer;
    color: #6b7280;
    line-height: 1;
  }

  .donate-form {
    padding: 1.5rem;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #1f2937;
  }

  .form-select,
  .form-input,
  .form-textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    font-size: 1rem;
  }

  .quick-amounts {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .quick-amount {
    flex: 1;
    padding: 0.75rem;
    border: 2px solid #e5e7eb;
    background: white;
    border-radius: 0.5rem;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
  }

  .quick-amount:hover,
  .quick-amount.active {
    border-color: #f093fb;
    background: #fef3fd;
  }

  .amount-input-group {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }

  .currency-symbol {
    font-size: 1.25rem;
    font-weight: 600;
    color: #6b7280;
  }

  .currency-select {
    width: auto;
    min-width: 100px;
  }

  .form-checkbox {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* NFT Floor Price Display */
  .nft-floor-price {
    margin-bottom: 1.5rem;
  }

  .floor-price-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.25rem;
    border-radius: 0.75rem;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }

  .floor-price-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  }

  .floor-price-label {
    font-size: 0.875rem;
    opacity: 0.9;
  }

  .floor-price-value {
    font-size: 1.5rem;
    font-weight: 700;
  }

  .floor-price-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .stat-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .stat-label {
    font-size: 0.75rem;
    opacity: 0.8;
  }

  .stat-value {
    font-size: 1rem;
    font-weight: 600;
  }

  /* NFT Rewards Preview */
  .nft-rewards-preview {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    padding: 1rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
    border: 2px solid #fbbf24;
  }

  .nft-rewards-preview h4 {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #92400e;
  }

  .nft-rewards-text {
    color: #78350f;
    line-height: 1.8;
  }

  .nft-rewards-text strong {
    color: #92400e;
  }

  .impact-preview {
    background: #f0fdf4;
    padding: 1rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
  }

  .impact-preview h4 {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #065f46;
  }

  .impact-preview-text {
    color: #047857;
    line-height: 1.6;
  }

  .form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
  }

  .form-note {
    text-align: center;
    color: #6b7280;
    font-size: 0.875rem;
    margin-top: 1rem;
  }

  .btn-primary,
  .btn-secondary {
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
  }

  .btn-primary {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    flex: 1;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(240, 147, 251, 0.4);
  }

  .btn-secondary {
    background: #e5e7eb;
    color: #374151;
  }

  .btn-secondary:hover {
    background: #d1d5db;
  }

  .empty-state {
    text-align: center;
    padding: 3rem;
    color: #6b7280;
    font-size: 1.125rem;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .hero-content-grid {
      grid-template-columns: 1fr;
    }

    .your-impact-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .kakuma-projects-grid {
      grid-template-columns: 1fr;
    }

    .involvement-grid {
      grid-template-columns: 1fr;
    }

    .project-actions {
      grid-template-columns: 1fr;
    }
  }
</style>
