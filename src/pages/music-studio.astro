---
/**
 * Music Studio - Simplified Beat Production
 * Focus: Sampler pads, sequencer, import/export, Strudel integration
 */

import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout
  title="Music Studio"
  description="Create beats with sampler pads and live coding"
  activeSection="music"
>
  <div class="studio-container">

    <!-- Simple Header -->
    <header class="studio-header">
      <h1>üéµ Music Studio</h1>
      <nav class="header-nav">
        <a href="/battle" class="nav-link">ü•ä Battles</a>
        <a href="/profile" class="nav-link">üë§ Profile</a>
        <a href="/" class="nav-link">üè† Home</a>
      </nav>
    </header>

    <!-- Main Studio Workspace -->
    <div class="studio-workspace">

      <!-- Left: Controls -->
      <aside class="studio-sidebar">
        <section class="control-section">
          <h3>‚öôÔ∏è Controls</h3>

          <div class="control-group">
            <label>BPM</label>
            <div class="bpm-control">
              <button id="bpm-down" class="bpm-btn">-</button>
              <input type="number" id="bpm-input" value="120" min="60" max="200" />
              <button id="bpm-up" class="bpm-btn">+</button>
            </div>
            <input type="range" id="bpm-slider" min="60" max="200" value="120" />
          </div>

          <div class="control-group">
            <label>Volume</label>
            <input type="range" id="master-volume" min="0" max="100" value="80" />
            <span id="volume-display">80%</span>
          </div>

          <div class="transport-buttons">
            <button id="play-btn" class="btn-transport">‚ñ∂Ô∏è Play</button>
            <button id="stop-btn" class="btn-transport">‚èπÔ∏è Stop</button>
            <button id="record-btn" class="btn-transport record">üî¥ Record</button>
          </div>
        </section>

        <section class="control-section">
          <h3>üíæ Sequence</h3>
          <button id="clear-btn" class="btn-action">üóëÔ∏è Clear</button>
          <button id="export-btn" class="btn-action">üì§ Export</button>
          <button id="import-btn" class="btn-action">üì• Import</button>
          <input type="file" id="import-file" accept=".json" style="display: none;" />
        </section>

        <section class="control-section">
          <h3>üéπ Sound Bank</h3>
          <select id="bank-select" class="bank-selector">
            <option value="drums">ü•Å Drums</option>
            <option value="synth">üéπ Synth</option>
            <option value="bass">üé∏ Bass</option>
            <option value="fx">‚ú® FX</option>
          </select>
        </section>

        <section class="control-section">
          <h3>üìä Info</h3>
          <div class="info-display">
            <div class="info-item">
              <span>Voices:</span>
              <span id="voice-count">0/8</span>
            </div>
            <div class="info-item">
              <span>Mode:</span>
              <span id="mode-display">Synth</span>
            </div>
          </div>
        </section>
      </aside>

      <!-- Center: Pads & Sequencer -->
      <main class="studio-main">

        <!-- Sequencer Display Toggle -->
        <div class="sequencer-toggle">
          <label>
            <input type="checkbox" id="show-sequencer" checked />
            <span>Show Sequencer</span>
          </label>
        </div>

        <!-- 16-Step Sequencer -->
        <section id="sequencer-section" class="sequencer-section">
          <div class="sequencer-header">
            <h3>16-Step Sequencer</h3>
            <div class="step-numbers">
              <span>1</span><span>2</span><span>3</span><span>4</span>
              <span>5</span><span>6</span><span>7</span><span>8</span>
              <span>9</span><span>10</span><span>11</span><span>12</span>
              <span>13</span><span>14</span><span>15</span><span>16</span>
            </div>
          </div>
          <div id="sequencer-grid" class="sequencer-grid">
            <!-- Generated by JS -->
          </div>
        </section>

        <!-- 16 Sampler Pads -->
        <section class="pads-section">
          <h3>Sampler Pads</h3>
          <div id="sampler-pads" class="pad-grid">
            <!-- Generated by JS -->
          </div>
        </section>

      </main>

      <!-- Right: Strudel (Future) -->
      <aside class="studio-sidebar strudel-panel">
        <section class="control-section">
          <h3>‚ú® Strudel</h3>
          <p class="info-text">Live coding integration coming soon</p>

          <div class="strudel-preview">
            <label>Pattern:</label>
            <textarea id="strudel-code" rows="6" placeholder='s("bd sd, hh*8").cpm(120)'></textarea>
            <button id="strudel-play" class="btn-action">‚ñ∂Ô∏è Play Pattern</button>
          </div>
        </section>

        <section class="control-section">
          <h3>üìö Presets</h3>
          <div class="preset-list">
            <button class="preset-btn" data-bpm="72">Reggae (72)</button>
            <button class="preset-btn" data-bpm="85">Hip Hop (85)</button>
            <button class="preset-btn" data-bpm="120">House (120)</button>
            <button class="preset-btn" data-bpm="140">Trap (140)</button>
          </div>
        </section>
      </aside>

    </div>

  </div>
</BaseLayout>

<!-- Load Strudel -->
<script src="https://unpkg.com/@strudel/web@1.0.3"></script>

<script>
console.log('üéµ Music Studio loading...');

/**
 * Simplified Music Studio
 */
class MusicStudio {
  constructor() {
    this.audioContext = null;
    this.pads = [];
    this.selectedPad = null;
    this.bpm = 120;
    this.isPlaying = false;
    this.isRecording = false;
    this.currentStep = 0;
    this.sequencerData = [];
    this.masterVolume = 0.8;
    this.intervalId = null;
    this.currentBank = 'drums';
    this.strudelReady = false;

    // Performance
    this.activeOscillators = [];
    this.maxPolyphony = 8;

    // Sound banks with better frequencies
    this.soundBanks = {
      drums: [
        60,   // Kick
        200,  // Snare
        400,  // Hi-hat
        300,  // Clap
        100,  // Tom 1
        120,  // Tom 2
        600,  // Crash
        500,  // Ride
        80,   // Floor Tom
        150,  // Rim
        250,  // Cowbell
        350,  // Wood Block
        180,  // Clave
        220,  // Tambourine
        280,  // Shaker
        320   // Cabasa
      ],
      synth: [
        261.63, // C4
        293.66, // D4
        329.63, // E4
        349.23, // F4
        392.00, // G4
        440.00, // A4
        493.88, // B4
        523.25, // C5
        587.33, // D5
        659.25, // E5
        698.46, // F5
        783.99, // G5
        880.00, // A5
        987.77, // B5
        1046.50, // C6
        1174.66  // D6
      ],
      bass: [
        55, 58, 62, 65, 69, 73, 77, 82,
        87, 92, 98, 103, 110, 116, 123, 130
      ],
      fx: [
        200, 400, 600, 800, 1000, 1200, 1400, 1600,
        300, 500, 700, 900, 1100, 1300, 1500, 1700
      ]
    };

    this.padNames = [
      'Kick', 'Snare', 'HiHat', 'Clap',
      'Tom1', 'Tom2', 'Crash', 'Ride',
      'Tom3', 'Rim', 'Bell', 'Wood',
      'Clav', 'Tamb', 'Shake', 'Caba'
    ];

    this.init();
  }

  async init() {
    console.log('üéõÔ∏è Initializing Music Studio...');

    // Audio Context
    try {
      this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
      console.log('‚úÖ Audio context created');
    } catch (error) {
      console.error('‚ùå Audio context error:', error);
      return;
    }

    // Strudel
    if (typeof initStrudel !== 'undefined') {
      try {
        initStrudel();
        this.strudelReady = true;
        console.log('‚úÖ Strudel ready');
      } catch (error) {
        console.error('‚ö†Ô∏è Strudel init error:', error);
      }
    }

    // Initialize sequencer data
    for (let i = 0; i < 16; i++) {
      this.sequencerData[i] = new Array(16).fill(false);
    }

    // Generate UI
    this.generatePads();
    this.generateSequencer();
    this.setupEventListeners();

    console.log('‚úÖ Music Studio ready');
  }

  generatePads() {
    const padGrid = document.getElementById('sampler-pads');
    if (!padGrid) {
      console.error('‚ùå Pad grid not found');
      return;
    }

    // Clear existing
    padGrid.innerHTML = '';
    this.pads = [];

    // Gradient colors
    const colors = [
      'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', // Purple
      'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', // Pink
      'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)', // Cyan
      'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)', // Green
      'linear-gradient(135deg, #fa709a 0%, #fee140 100%)', // Sunset
      'linear-gradient(135deg, #30cfd0 0%, #330867 100%)', // Ocean
      'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)', // Pastel
      'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)', // Rose
      'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)', // Peach
      'linear-gradient(135deg, #ff6e7f 0%, #bfe9ff 100%)', // Sky
      'linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)', // Lavender
      'linear-gradient(135deg, #f8b195 0%, #f67280 100%)', // Coral
      'linear-gradient(135deg, #d299c2 0%, #fef9d7 100%)', // Cream
      'linear-gradient(135deg, #fddb92 0%, #d1fdff 100%)', // Mint
      'linear-gradient(135deg, #9890e3 0%, #b1f4cf 100%)', // Sage
      'linear-gradient(135deg, #ebc0fd 0%, #d9ded8 100%)'  // Gray
    ];

    for (let i = 0; i < 16; i++) {
      const pad = document.createElement('div');
      pad.className = 'pad';
      pad.dataset.index = i;
      pad.style.background = colors[i];

      pad.innerHTML = `
        <div class="pad-content">
          <div class="pad-number">${i + 1}</div>
          <div class="pad-label">${this.padNames[i]}</div>
        </div>
      `;

      // Events
      pad.addEventListener('click', () => {
        this.selectPad(i);
        this.playPad(i);
      });

      padGrid.appendChild(pad);
      this.pads.push(pad);
    }

    console.log(`‚úÖ Generated ${this.pads.length} pads`);
  }

  generateSequencer() {
    const grid = document.getElementById('sequencer-grid');
    if (!grid) return;

    grid.innerHTML = '';

    for (let padIndex = 0; padIndex < 16; padIndex++) {
      // Instrument label
      const label = document.createElement('div');
      label.className = 'seq-label';
      label.textContent = this.padNames[padIndex];
      label.dataset.pad = padIndex;
      label.addEventListener('click', () => this.selectPad(padIndex));
      grid.appendChild(label);

      // 16 step cells
      for (let step = 0; step < 16; step++) {
        const cell = document.createElement('div');
        cell.className = 'seq-cell';
        cell.dataset.pad = padIndex;
        cell.dataset.step = step;

        // Beat markers every 4 steps
        if (step % 4 === 0) {
          cell.classList.add('beat-marker');
        }

        cell.addEventListener('click', () => this.toggleStep(padIndex, step));
        grid.appendChild(cell);
      }
    }

    console.log('‚úÖ Sequencer generated');
  }

  selectPad(index) {
    this.pads.forEach(p => p.classList.remove('selected'));
    this.selectedPad = index;
    this.pads[index].classList.add('selected');

    // Highlight in sequencer
    document.querySelectorAll('.seq-label').forEach(l => l.classList.remove('selected'));
    const label = document.querySelector(`.seq-label[data-pad="${index}"]`);
    if (label) label.classList.add('selected');

    console.log(`‚úì Selected pad ${index + 1}: ${this.padNames[index]}`);
  }

  playPad(index) {
    const pad = this.pads[index];
    if (!pad) return;

    // Visual feedback
    pad.classList.add('active');
    setTimeout(() => pad.classList.remove('active'), 150);

    // If recording, add to current step
    if (this.isRecording && this.isPlaying) {
      this.sequencerData[index][this.currentStep] = true;
      this.updateCell(index, this.currentStep);
    }

    // Play sound
    this.playSound(index);

    console.log(`üéµ Pad ${index + 1}: ${this.padNames[index]}`);
  }

  playSound(index) {
    if (!this.audioContext) return;

    // Resume context if needed
    if (this.audioContext.state === 'suspended') {
      this.audioContext.resume().then(() => this.playSound(index));
      return;
    }

    // Polyphony limiting
    if (this.activeOscillators.length >= this.maxPolyphony) {
      const oldest = this.activeOscillators.shift();
      if (oldest?.osc) {
        try {
          oldest.osc.stop();
          oldest.osc.disconnect();
        } catch (e) {}
      }
    }

    const freq = this.soundBanks[this.currentBank][index];
    const now = this.audioContext.currentTime;

    try {
      const osc = this.audioContext.createOscillator();
      const gain = this.audioContext.createGain();

      // Waveform by bank
      const waveforms = {
        drums: 'triangle',
        synth: 'sine',
        bass: 'sawtooth',
        fx: 'square'
      };

      osc.type = waveforms[this.currentBank] || 'sine';
      osc.frequency.value = freq;

      gain.gain.setValueAtTime(this.masterVolume, now);
      gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);

      osc.connect(gain);
      gain.connect(this.audioContext.destination);

      osc.start(now);
      osc.stop(now + 0.3);

      this.activeOscillators.push({ osc, stopTime: now + 0.3 });

      setTimeout(() => {
        const idx = this.activeOscillators.findIndex(o => o.osc === osc);
        if (idx !== -1) this.activeOscillators.splice(idx, 1);
        this.updateVoiceCount();
      }, 350);

      this.updateVoiceCount();
    } catch (error) {
      console.error('Sound error:', error);
    }
  }

  updateVoiceCount() {
    const display = document.getElementById('voice-count');
    if (display) {
      const count = this.activeOscillators.length;
      display.textContent = `${count}/${this.maxPolyphony}`;

      if (count >= this.maxPolyphony) {
        display.style.color = '#ef4444';
      } else if (count >= this.maxPolyphony * 0.7) {
        display.style.color = '#f59e0b';
      } else {
        display.style.color = '#10b981';
      }
    }
  }

  toggleStep(padIndex, step) {
    this.sequencerData[padIndex][step] = !this.sequencerData[padIndex][step];
    this.updateCell(padIndex, step);
  }

  updateCell(padIndex, step) {
    const cell = document.querySelector(
      `.seq-cell[data-pad="${padIndex}"][data-step="${step}"]`
    );
    if (cell) {
      cell.classList.toggle('active', this.sequencerData[padIndex][step]);
    }
  }

  play() {
    if (this.isPlaying) return;

    this.isPlaying = true;
    this.currentStep = 0;

    if (this.audioContext?.state === 'suspended') {
      this.audioContext.resume();
    }

    const stepDuration = (60000 / this.bpm) / 4; // 16th notes

    this.intervalId = setInterval(() => {
      this.playStep();
      this.currentStep = (this.currentStep + 1) % 16;
    }, stepDuration);

    document.getElementById('play-btn').classList.add('playing');
    console.log('‚ñ∂Ô∏è Playing');
  }

  stop() {
    if (this.intervalId) {
      clearInterval(this.intervalId);
      this.intervalId = null;
    }

    this.isPlaying = false;
    this.isRecording = false;
    this.currentStep = 0;

    document.getElementById('play-btn').classList.remove('playing');
    document.getElementById('record-btn').classList.remove('recording');
    document.querySelectorAll('.seq-cell.playing').forEach(c => c.classList.remove('playing'));

    console.log('‚èπÔ∏è Stopped');
  }

  playStep() {
    // Clear previous
    document.querySelectorAll('.seq-cell.playing').forEach(c => c.classList.remove('playing'));

    // Highlight current step
    const cells = document.querySelectorAll(`.seq-cell[data-step="${this.currentStep}"]`);
    cells.forEach(c => c.classList.add('playing'));

    // Play active pads
    for (let padIndex = 0; padIndex < 16; padIndex++) {
      if (this.sequencerData[padIndex][this.currentStep]) {
        this.playPad(padIndex);
      }
    }
  }

  toggleRecord() {
    this.isRecording = !this.isRecording;

    const btn = document.getElementById('record-btn');
    if (this.isRecording) {
      btn.classList.add('recording');
      if (!this.isPlaying) this.play();
      console.log('üî¥ Recording');
    } else {
      btn.classList.remove('recording');
      console.log('‚èπÔ∏è Record stopped');
    }
  }

  clearSequence() {
    if (!confirm('Clear entire sequence?')) return;

    for (let i = 0; i < 16; i++) {
      this.sequencerData[i] = new Array(16).fill(false);
    }

    document.querySelectorAll('.seq-cell.active').forEach(c => c.classList.remove('active'));
    console.log('üóëÔ∏è Sequence cleared');
  }

  exportSequence() {
    const sequence = {
      name: `Sequence ${new Date().toISOString()}`,
      bpm: this.bpm,
      bank: this.currentBank,
      data: this.sequencerData,
      padNames: this.padNames,
      created: new Date().toISOString()
    };

    const json = JSON.stringify(sequence, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = `sequence_${Date.now()}.json`;
    a.click();

    URL.revokeObjectURL(url);
    console.log('üì§ Sequence exported');
  }

  importSequence(file) {
    const reader = new FileReader();

    reader.onload = (e) => {
      try {
        const sequence = JSON.parse(e.target.result);

        if (!sequence.data || !Array.isArray(sequence.data)) {
          throw new Error('Invalid sequence format');
        }

        this.sequencerData = sequence.data;
        this.bpm = sequence.bpm || 120;
        this.currentBank = sequence.bank || 'drums';

        // Update UI
        document.getElementById('bpm-input').value = this.bpm;
        document.getElementById('bpm-slider').value = this.bpm;
        document.getElementById('bank-select').value = this.currentBank;

        // Update cells
        for (let i = 0; i < 16; i++) {
          for (let j = 0; j < 16; j++) {
            this.updateCell(i, j);
          }
        }

        console.log('üì• Sequence imported');
        alert('Sequence imported successfully!');
      } catch (error) {
        console.error('Import error:', error);
        alert('Failed to import sequence: ' + error.message);
      }
    };

    reader.readAsText(file);
  }

  setBPM(bpm) {
    this.bpm = Math.max(60, Math.min(200, bpm));
    document.getElementById('bpm-input').value = this.bpm;
    document.getElementById('bpm-slider').value = this.bpm;

    if (this.isPlaying) {
      this.stop();
      this.play();
    }
  }

  setBank(bank) {
    this.currentBank = bank;
    document.getElementById('mode-display').textContent = bank.charAt(0).toUpperCase() + bank.slice(1);
    console.log(`üéπ Bank: ${bank}`);
  }

  playStrudelCode() {
    if (!this.strudelReady) {
      alert('Strudel not ready');
      return;
    }

    const code = document.getElementById('strudel-code').value.trim();
    if (!code) {
      alert('Enter Strudel code first');
      return;
    }

    try {
      hush();
      eval(code + '.play()');
      console.log('‚ú® Strudel playing');
    } catch (error) {
      console.error('Strudel error:', error);
      alert('Strudel error: ' + error.message);
    }
  }

  setupEventListeners() {
    // Transport
    document.getElementById('play-btn')?.addEventListener('click', () => this.play());
    document.getElementById('stop-btn')?.addEventListener('click', () => this.stop());
    document.getElementById('record-btn')?.addEventListener('click', () => this.toggleRecord());

    // BPM
    document.getElementById('bpm-up')?.addEventListener('click', () => this.setBPM(this.bpm + 1));
    document.getElementById('bpm-down')?.addEventListener('click', () => this.setBPM(this.bpm - 1));

    document.getElementById('bpm-input')?.addEventListener('change', (e) => {
      this.setBPM(parseInt(e.target.value) || 120);
    });

    document.getElementById('bpm-slider')?.addEventListener('input', (e) => {
      this.setBPM(parseInt(e.target.value));
    });

    // Volume
    document.getElementById('master-volume')?.addEventListener('input', (e) => {
      this.masterVolume = e.target.value / 100;
      document.getElementById('volume-display').textContent = `${e.target.value}%`;
    });

    // Bank
    document.getElementById('bank-select')?.addEventListener('change', (e) => {
      this.setBank(e.target.value);
    });

    // Sequence
    document.getElementById('clear-btn')?.addEventListener('click', () => this.clearSequence());
    document.getElementById('export-btn')?.addEventListener('click', () => this.exportSequence());

    document.getElementById('import-btn')?.addEventListener('click', () => {
      document.getElementById('import-file').click();
    });

    document.getElementById('import-file')?.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) this.importSequence(file);
      e.target.value = '';
    });

    // Sequencer toggle
    document.getElementById('show-sequencer')?.addEventListener('change', (e) => {
      const section = document.getElementById('sequencer-section');
      section.style.display = e.target.checked ? 'block' : 'none';
    });

    // Strudel
    document.getElementById('strudel-play')?.addEventListener('click', () => this.playStrudelCode());

    // Presets
    document.querySelectorAll('.preset-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const bpm = parseInt(btn.dataset.bpm);
        this.setBPM(bpm);
      });
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

      if (e.code === 'Space') {
        e.preventDefault();
        if (this.isPlaying) this.stop();
        else this.play();
      }
    });
  }
}

// Initialize
function initStudio() {
  if (!window.musicStudio) {
    window.musicStudio = new MusicStudio();
    console.log('‚úÖ Music Studio initialized');
  }
}

document.addEventListener('DOMContentLoaded', initStudio);
document.addEventListener('astro:page-load', initStudio);

if (document.readyState !== 'loading') {
  initStudio();
}
</script>

<style>
  * {
    box-sizing: border-box;
  }

  .studio-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 100%);
    color: white;
    display: flex;
    flex-direction: column;
  }

  /* Header */
  .studio-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 2rem;
    background: rgba(0, 0, 0, 0.3);
    border-bottom: 2px solid rgba(255, 255, 255, 0.1);
  }

  .studio-header h1 {
    margin: 0;
    font-size: 1.75rem;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .header-nav {
    display: flex;
    gap: 1rem;
  }

  .nav-link {
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    color: white;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.2s;
  }

  .nav-link:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
  }

  /* Workspace */
  .studio-workspace {
    flex: 1;
    display: flex;
    gap: 1rem;
    padding: 1rem;
    overflow: hidden;
  }

  .studio-sidebar {
    width: 280px;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    overflow-y: auto;
  }

  .studio-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    overflow-y: auto;
  }

  /* Control Sections */
  .control-section {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.75rem;
    padding: 1.5rem;
  }

  .control-section h3 {
    margin: 0 0 1rem 0;
    font-size: 1rem;
    color: #667eea;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .control-group {
    margin-bottom: 1.5rem;
  }

  .control-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.8);
  }

  .bpm-control {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }

  .bpm-btn {
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    color: white;
    font-size: 1.25rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .bpm-btn:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  #bpm-input {
    flex: 1;
    padding: 0.5rem;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    color: white;
    font-size: 1.25rem;
    text-align: center;
    font-weight: 700;
  }

  input[type="range"] {
    width: 100%;
    margin: 0.5rem 0;
  }

  .transport-buttons {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .btn-transport {
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-transport:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
  }

  .btn-transport.playing {
    background: #10b981;
    border-color: #10b981;
  }

  .btn-transport.record.recording {
    background: #ef4444;
    border-color: #ef4444;
    animation: pulse 1s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  .btn-action {
    width: 100%;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    background: rgba(102, 126, 234, 0.2);
    border: 1px solid #667eea;
    border-radius: 0.5rem;
    color: #667eea;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-action:hover {
    background: rgba(102, 126, 234, 0.3);
    transform: translateY(-2px);
  }

  .bank-selector {
    width: 100%;
    padding: 0.75rem;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    color: white;
    font-weight: 600;
    cursor: pointer;
  }

  .info-display {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .info-item {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 0.5rem;
    font-size: 0.875rem;
  }

  .info-text {
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.6);
    margin-bottom: 1rem;
  }

  .strudel-preview textarea {
    width: 100%;
    padding: 0.75rem;
    background: rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(0, 255, 0, 0.3);
    border-radius: 0.5rem;
    color: #0f0;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
    resize: vertical;
  }

  .preset-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .preset-btn {
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.5rem;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .preset-btn:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  /* Sequencer Toggle */
  .sequencer-toggle {
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
  }

  .sequencer-toggle label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
  }

  /* Sequencer */
  .sequencer-section {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.75rem;
    padding: 1.5rem;
  }

  .sequencer-header {
    margin-bottom: 1rem;
  }

  .sequencer-header h3 {
    margin: 0 0 0.75rem 0;
    color: #667eea;
  }

  .step-numbers {
    display: grid;
    grid-template-columns: repeat(16, 1fr);
    gap: 2px;
    font-size: 0.75rem;
    text-align: center;
    color: rgba(255, 255, 255, 0.5);
    margin-bottom: 0.5rem;
  }

  .sequencer-grid {
    display: grid;
    grid-template-columns: 80px repeat(16, 1fr);
    gap: 2px;
    background: rgba(0, 0, 0, 0.3);
    padding: 4px;
    border-radius: 0.5rem;
  }

  .seq-label {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .seq-label:hover, .seq-label.selected {
    background: rgba(102, 126, 234, 0.3);
    color: #667eea;
  }

  .seq-cell {
    aspect-ratio: 1;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .seq-cell:hover {
    background: rgba(255, 255, 255, 0.15);
    transform: scale(1.1);
  }

  .seq-cell.beat-marker {
    border-color: rgba(102, 126, 234, 0.3);
  }

  .seq-cell.active {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-color: #667eea;
    box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
  }

  .seq-cell.playing {
    background: rgba(16, 185, 129, 0.5);
    border-color: #10b981;
    border-width: 2px;
    animation: cellPulse 0.3s;
  }

  @keyframes cellPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
  }

  /* Sampler Pads */
  .pads-section {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.75rem;
    padding: 1.5rem;
  }

  .pads-section h3 {
    margin: 0 0 1rem 0;
    color: #667eea;
  }

  .pad-grid {
    display: grid !important;
    grid-template-columns: repeat(4, 1fr) !important;
    grid-template-rows: repeat(4, 1fr) !important;
    gap: 1rem;
    width: 100%;
    aspect-ratio: 1;
  }

  .pad {
    width: 100%;
    height: 100%;
    min-height: 80px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 1rem;
    display: flex !important;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  .pad::before {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.2);
    transition: all 0.2s;
  }

  .pad:hover {
    transform: translateY(-4px);
    border-color: rgba(255, 255, 255, 0.6);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
  }

  .pad:hover::before {
    background: rgba(255, 255, 255, 0.1);
  }

  .pad.selected {
    border-color: white;
    border-width: 4px;
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
  }

  .pad.active {
    transform: scale(0.95);
    box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.8);
  }

  .pad.active::before {
    background: rgba(255, 255, 255, 0.3);
  }

  .pad-content {
    position: relative;
    z-index: 1;
    text-align: center;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
  }

  .pad-number {
    font-size: 2.5rem;
    font-weight: 900;
    color: white;
    line-height: 1;
  }

  .pad-label {
    font-size: 0.875rem;
    font-weight: 700;
    color: white;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 0.5rem;
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .studio-workspace {
      flex-direction: column;
    }

    .studio-sidebar, .strudel-panel {
      width: 100%;
    }

    .pad-grid {
      aspect-ratio: auto;
      min-height: 400px;
    }
  }

  @media (max-width: 768px) {
    .pad-number {
      font-size: 1.75rem;
    }

    .pad-label {
      font-size: 0.75rem;
    }
  }
</style>
