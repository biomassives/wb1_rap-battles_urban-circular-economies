---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Strudel Sample Preparatory">

<style>
  :root {
    --strudel-orange: #ff5f00;
    --nile-green: #00ffcc;
    --dark-edge: #0a0a0c;
  }

  .app-container { max-width: 950px; margin: 2rem auto; color: white; font-family: 'Input Mono', monospace; }

  /* Tier 1: Domains */
  .domain-selector {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
  }
  .domain-card {
    flex: 1;
    padding: 15px;
    background: #1a1a1c;
    border: 2px solid #333;
    border-radius: 12px;
    text-align: center;
    cursor: pointer;
    transition: 0.3s;
  }
  .domain-card.active { border-color: var(--strudel-orange); background: rgba(255, 95, 0, 0.1); }

  /* Tier 2: Objects */
  .object-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 10px;
    margin-bottom: 20px;
    background: #000;
    padding: 15px;
    border-radius: 12px;
    min-height: 80px;
  }
  .obj-btn {
    aspect-ratio: 1;
    background: #222;
    border: 1px solid #444;
    border-radius: 8px;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
  }
  .obj-btn.active { background: var(--nile-green); color: black; border-color: white; }

  /* The Band */
  .recorder-band {
    display: flex;
    align-items: center;
    background: var(--dark-edge);
    padding: 20px;
    border-radius: 16px;
    gap: 15px;
    border: 1px solid #333;
  }
  .vis-box { flex: 1; height: 60px; background: #000; border-radius: 8px; }
  
  .rec-trigger {
    width: 60px; height: 60px; border-radius: 50%; border: none;
    background: #ff4444; color: white; cursor: pointer;
  }
  .rec-trigger.recording { border-radius: 12px; animation: pulse 1s infinite; }

  /* Strudel Export Area */
  .export-zone { margin-top: 30px; background: #1a1a1c; padding: 20px; border-radius: 12px; }
  code { display: block; background: #000; padding: 15px; border-radius: 6px; color: var(--nile-green); font-size: 0.8rem; overflow-x: auto;}

  @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
</style>

<div class="app-container">
  <h3>Tier 1: Select Domain</h3>
  <div class="domain-selector">
    <div class="domain-card active" data-domain="bios"><strong>BIOSPHERE</strong><br><small>Birds, Flora, Water</small></div>
    <div class="domain-card" data-domain="lithos"><strong>LITHOSPHERE</strong><br><small>Rocks, Soil, Seismic</small></div>
    <div class="domain-card" data-domain="cosmos"><strong>COSMOSPHERE</strong><br><small>Stars, Night, Atmosphere</small></div>
  </div>

  <h3>Tier 2: Select Object</h3>
  <div class="object-grid" id="object-grid">
    </div>

  <div class="recorder-band">
    <button id="rec-btn" class="rec-trigger">‚óè</button>
    <div class="vis-box"><canvas id="vis"></canvas></div>
    <button id="save-btn" class="rec-trigger" style="background:var(--nile-green); color: black;" disabled>DONE</button>
  </div>

  <div class="export-zone">
    <h4>Strudel Code Output</h4>
    <p style="font-size: 0.7rem; color: #888;">Paste this into <a href="https://strudel.cc" target="_blank" style="color:var(--strudel-orange)">Strudel.cc</a></p>
    <code id="strudel-code">
      samples({ 
        /* record samples to generate code */ 
      })
    </code>
    <button id="download-samples" style="margin-top:10px;" class="domain-card">Download Sample Map (.json)</button>
  </div>
</div>

<script>
  /** 1. DATA STRUCTURES **/
  const domains = {
    bios: ["üê¶", "üåø", "üåä", "üêù", "üê∏"],
    lithos: ["ü™®", "üèîÔ∏è", "üíé", "üß±"],
    cosmos: ["‚≠ê", "üåô", "‚òÑÔ∏è", "üõ∞Ô∏è"]
  };

  let activeDomain = "bios";
  let activeObject = "üê¶";
  let mediaRecorder, chunks = [], animationId;

  /** 2. DOMAIN & OBJECT NAVIGATION **/
  const objGrid = document.getElementById('object-grid');
  
  function renderObjects() {
    objGrid.innerHTML = domains[activeDomain].map(obj => `
      <button class="obj-btn ${obj === activeObject ? 'active' : ''}" data-obj="${obj}">${obj}</button>
    `).join('');
    
    document.querySelectorAll('.obj-btn').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.obj-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        activeObject = btn.dataset.obj;
      }
    });
  }

  document.querySelectorAll('.domain-card').forEach(card => {
    card.onclick = () => {
      document.querySelectorAll('.domain-card').forEach(c => c.classList.remove('active'));
      card.classList.add('active');
      activeDomain = card.dataset.domain;
      activeObject = domains[activeDomain][0]; // Reset to first object
      renderObjects();
    };
  });

  /** 3. AUDIO VISUALS **/
  const canvas = document.getElementById('vis');
  const ctx = canvas.getContext('2d');

  function startVis(stream) {
    const ac = new AudioContext();
    const src = ac.createMediaStreamSource(stream);
    const anal = ac.createAnalyser();
    anal.fftSize = 64;
    src.connect(anal);
    const data = new Uint8Array(anal.frequencyBinCount);

    const draw = () => {
      animationId = requestAnimationFrame(draw);
      anal.getByteFrequencyData(data);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      data.forEach((v, i) => {
        ctx.fillStyle = `rgb(0, 255, 204, ${v/255 + 0.2})`;
        const h = (v/255) * canvas.height;
        ctx.fillRect(i * (canvas.width/data.length), (canvas.height-h)/2, 4, h);
      });
    };
    draw();
  }

  /** 4. RECORDING & STRUDEL GENERATION **/
  const recBtn = document.getElementById('rec-btn');
  const saveBtn = document.getElementById('save-btn');

  recBtn.onclick = async () => {
    if (recBtn.classList.contains('recording')) {
      mediaRecorder.stop();
      cancelAnimationFrame(animationId);
      recBtn.classList.remove('recording');
      saveBtn.disabled = false;
    } else {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      startVis(stream);
      mediaRecorder = new MediaRecorder(stream);
      chunks = [];
      mediaRecorder.ondataavailable = e => chunks.push(e.data);
      mediaRecorder.start();
      recBtn.classList.add('recording');
    }
  };

  saveBtn.onclick = async () => {
    const blob = new Blob(chunks, { type: 'audio/webm' });
    // In a real app, you'd save this to IndexedDB. 
    // For the "Strudel Prep", we add it to a local sample map.
    updateStrudelCode(activeObject, blob);
    saveBtn.disabled = true;
  };

  const sampleLibrary = {}; // { "üê¶": [blob, blob], "‚≠ê": [blob] }

  function updateStrudelCode(obj, blob) {
    if (!sampleLibrary[obj]) sampleLibrary[obj] = [];
    sampleLibrary[obj].push(URL.createObjectURL(blob));

    const codeLines = Object.entries(sampleLibrary).map(([key, urls]) => {
      return `  "${key}": [\n    ${urls.map(u => `"${u}"`).join(',\n    ')}\n  ]`;
    });

    document.getElementById('strudel-code').innerText = `samples({\n${codeLines.join(',\n')}\n})`;
  }

  // Init
  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;
  renderObjects();
</script>

</BaseLayout>
