---
/**
 * Improved Sampler MVP Beta
 * - Custom sound bank uploads
 * - Live singing + sampler recording
 * - Battle output export
 * - Streamlined battle workflow
 */

import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout
  title="Improved Sampler Beta"
  description="Create beats, record vocals, and export for rap battles"
  activeSection="music"
>
  <div class="improved-sampler-page">
    <!-- Header -->
    <header class="sampler-header">
      <div class="header-left">
        <h1>Battle Sampler</h1>
        <span class="beta-badge">BETA</span>
      </div>
      <div class="header-actions">
        <button id="help-btn" class="btn-icon" title="Help">?</button>
        <a href="/battle-voting" class="btn-secondary">View Battles</a>
        <a href="/" class="btn-ghost">Back</a>
      </div>
    </header>

    <!-- Main Layout: 3 Columns -->
    <div class="sampler-layout">

      <!-- Left: Sound Banks -->
      <aside class="banks-panel">
        <div class="panel-header">
          <h2>Sound Banks</h2>
          <button id="add-bank-btn" class="btn-sm btn-primary">+ New Bank</button>
        </div>

        <!-- Bank List -->
        <div class="bank-list" id="bank-list">
          <div class="bank-item active" data-bank="drums">
            <span class="bank-icon">ü•Å</span>
            <span class="bank-name">Drums</span>
            <span class="bank-count">16</span>
          </div>
          <div class="bank-item" data-bank="bass">
            <span class="bank-icon">üé∏</span>
            <span class="bank-name">Bass</span>
            <span class="bank-count">8</span>
          </div>
          <div class="bank-item" data-bank="synth">
            <span class="bank-icon">üéπ</span>
            <span class="bank-name">Synth</span>
            <span class="bank-count">12</span>
          </div>
          <div class="bank-item" data-bank="fx">
            <span class="bank-icon">‚ú®</span>
            <span class="bank-name">FX</span>
            <span class="bank-count">8</span>
          </div>
        </div>

        <!-- Custom Banks Section -->
        <div class="custom-banks-section">
          <h3>My Banks</h3>
          <div id="custom-bank-list" class="custom-bank-list">
            <!-- Custom banks will be added here -->
          </div>

          <!-- Upload Section -->
          <div class="upload-zone" id="upload-zone">
            <input type="file" id="sound-upload" accept="audio/*" multiple style="display: none;">
            <div class="upload-content">
              <span class="upload-icon">üì§</span>
              <span>Drop sounds here or click to upload</span>
            </div>
          </div>
        </div>
      </aside>

      <!-- Center: Pads + Sequencer -->
      <main class="sampler-main">

        <!-- Transport Bar -->
        <div class="transport-bar">
          <div class="transport-controls">
            <button id="play-btn" class="transport-btn">‚ñ∂</button>
            <button id="stop-btn" class="transport-btn">‚èπ</button>
            <button id="record-seq-btn" class="transport-btn record-btn">‚óè</button>
          </div>

          <div class="bpm-control">
            <button id="bpm-down" class="bpm-btn">-</button>
            <div class="bpm-display">
              <span id="bpm-value">120</span>
              <span class="bpm-label">BPM</span>
            </div>
            <button id="bpm-up" class="bpm-btn">+</button>
          </div>

          <div class="transport-actions">
            <button id="clear-seq-btn" class="btn-sm btn-ghost">Clear</button>
            <button id="save-seq-btn" class="btn-sm btn-secondary">Save Beat</button>
          </div>
        </div>

        <!-- 16 Pads Grid -->
        <div class="pads-container">
          <h3>Sampler Pads <span class="hint">Click to play, drag sounds to load</span></h3>
          <div id="pad-grid" class="pad-grid">
            <!-- 16 pads generated by JS -->
          </div>
        </div>

        <!-- Mini Sequencer -->
        <div class="sequencer-container">
          <div class="sequencer-header">
            <h3>16-Step Sequencer</h3>
            <div class="step-indicators" id="step-indicators">
              <!-- Step numbers generated by JS -->
            </div>
          </div>
          <div id="sequencer-grid" class="sequencer-grid">
            <!-- 16 rows x 16 steps generated by JS -->
          </div>
        </div>

      </main>

      <!-- Right: Recording & Battle Export -->
      <aside class="recording-panel">
        <div class="panel-header">
          <h2>Battle Recording</h2>
        </div>

        <!-- Recording Section -->
        <div class="recording-section">
          <div class="mic-status" id="mic-status">
            <span class="mic-icon">üé§</span>
            <span class="status-text">Mic Ready</span>
          </div>

          <div class="recording-controls">
            <button id="record-battle-btn" class="btn-record-main">
              <span class="record-icon">‚è∫</span>
              <span>Record Battle Entry</span>
            </button>
            <div class="recording-timer" id="recording-timer" style="display: none;">
              <span class="timer-value">00:00</span>
              <span class="timer-label">Recording...</span>
            </div>
          </div>

          <!-- Recording Options -->
          <div class="recording-options">
            <label class="option-toggle">
              <input type="checkbox" id="include-beat" checked>
              <span>Include beat in recording</span>
            </label>
            <label class="option-toggle">
              <input type="checkbox" id="countdown-enabled" checked>
              <span>3-second countdown</span>
            </label>
            <div class="option-row">
              <label>Max Duration:</label>
              <select id="max-duration">
                <option value="30">30 seconds</option>
                <option value="60" selected>1 minute</option>
                <option value="90">90 seconds</option>
                <option value="120">2 minutes</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Recorded Takes -->
        <div class="takes-section">
          <h3>Recorded Takes</h3>
          <div id="takes-list" class="takes-list">
            <div class="empty-state">No recordings yet</div>
          </div>
        </div>

        <!-- Battle Export -->
        <div class="export-section">
          <h3>Export to Battle</h3>

          <div class="battle-metadata">
            <input type="text" id="battle-title" placeholder="Battle entry title..." class="input-field">
            <select id="battle-round" class="input-field">
              <option value="opener">Opening Round</option>
              <option value="verse1">Verse 1</option>
              <option value="verse2">Verse 2</option>
              <option value="rebuttal">Rebuttal</option>
              <option value="closer">Closing</option>
            </select>
          </div>

          <button id="export-battle-btn" class="btn-primary btn-full" disabled>
            Export for Battle
          </button>

          <div class="export-info">
            <small>Exports beat + vocals as a single battle entry</small>
          </div>
        </div>

        <!-- Quick Battle Link -->
        <div class="quick-actions">
          <a href="/rap-battle" class="btn-secondary btn-full">
            Join Active Battle
          </a>
          <a href="/battle-voting" class="btn-ghost btn-full">
            Vote on Battles
          </a>
        </div>
      </aside>

    </div>

    <!-- Add Bank Modal -->
    <div id="add-bank-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Create New Sound Bank</h3>
          <button class="modal-close" onclick="closeAddBankModal()">&times;</button>
        </div>
        <div class="modal-body">
          <input type="text" id="new-bank-name" placeholder="Bank name..." class="input-field">
          <div class="emoji-picker">
            <span class="emoji-option" data-emoji="üéπ">üéπ</span>
            <span class="emoji-option" data-emoji="ü•Å">ü•Å</span>
            <span class="emoji-option" data-emoji="üé∏">üé∏</span>
            <span class="emoji-option" data-emoji="üé∫">üé∫</span>
            <span class="emoji-option" data-emoji="üé∑">üé∑</span>
            <span class="emoji-option" data-emoji="üîä">üîä</span>
            <span class="emoji-option" data-emoji="üéµ">üéµ</span>
            <span class="emoji-option" data-emoji="‚ö°">‚ö°</span>
          </div>
          <input type="hidden" id="new-bank-icon" value="üéµ">
        </div>
        <div class="modal-footer">
          <button class="btn-ghost" onclick="closeAddBankModal()">Cancel</button>
          <button class="btn-primary" onclick="createNewBank()">Create Bank</button>
        </div>
      </div>
    </div>

    <!-- Countdown Overlay -->
    <div id="countdown-overlay" class="countdown-overlay" style="display: none;">
      <div class="countdown-number" id="countdown-number">3</div>
    </div>

  </div>
</BaseLayout>

<!-- Load Strudel for pattern playback -->
<script src="https://unpkg.com/@strudel/web@1.0.3"></script>

<script>
console.log('üéõÔ∏è Improved Sampler Beta loading...');

/**
 * ImprovedSampler - Battle-focused sampler with recording
 */
class ImprovedSampler {
  constructor() {
    this.audioContext = null;
    this.bpm = 120;
    this.isPlaying = false;
    this.isRecording = false;
    this.currentStep = 0;
    this.intervalId = null;

    // Pads and sounds
    this.pads = [];
    this.padSounds = {};
    this.sequencerData = [];

    // Banks
    this.banks = {
      drums: this.createDrumBank(),
      bass: this.createBassBank(),
      synth: this.createSynthBank(),
      fx: this.createFXBank()
    };
    this.currentBank = 'drums';
    this.customBanks = {};

    // Recording
    this.mediaRecorder = null;
    this.recordedChunks = [];
    this.takes = [];
    this.selectedTake = null;

    // Audio nodes
    this.masterGain = null;
    this.recordingDestination = null;

    this.init();
  }

  createDrumBank() {
    return {
      name: 'Drums',
      icon: 'ü•Å',
      sounds: [
        { name: 'Kick', freq: 60, type: 'sine', decay: 0.3 },
        { name: 'Snare', freq: 200, type: 'triangle', decay: 0.15 },
        { name: 'HiHat', freq: 800, type: 'square', decay: 0.05 },
        { name: 'Clap', freq: 300, type: 'sawtooth', decay: 0.1 },
        { name: 'Tom Hi', freq: 180, type: 'sine', decay: 0.2 },
        { name: 'Tom Mid', freq: 140, type: 'sine', decay: 0.2 },
        { name: 'Tom Lo', freq: 100, type: 'sine', decay: 0.25 },
        { name: 'Crash', freq: 600, type: 'square', decay: 0.4 },
        { name: 'Ride', freq: 500, type: 'triangle', decay: 0.3 },
        { name: 'Rim', freq: 400, type: 'square', decay: 0.05 },
        { name: 'Cowbell', freq: 560, type: 'square', decay: 0.1 },
        { name: 'Shaker', freq: 1200, type: 'sawtooth', decay: 0.03 },
        { name: '808 Kick', freq: 45, type: 'sine', decay: 0.5 },
        { name: '808 Snare', freq: 180, type: 'triangle', decay: 0.2 },
        { name: 'Perc 1', freq: 350, type: 'sine', decay: 0.1 },
        { name: 'Perc 2', freq: 450, type: 'triangle', decay: 0.1 }
      ]
    };
  }

  createBassBank() {
    return {
      name: 'Bass',
      icon: 'üé∏',
      sounds: [
        { name: 'Sub', freq: 40, type: 'sine', decay: 0.4 },
        { name: 'Bass C', freq: 65, type: 'sawtooth', decay: 0.3 },
        { name: 'Bass D', freq: 73, type: 'sawtooth', decay: 0.3 },
        { name: 'Bass E', freq: 82, type: 'sawtooth', decay: 0.3 },
        { name: 'Bass F', freq: 87, type: 'sawtooth', decay: 0.3 },
        { name: 'Bass G', freq: 98, type: 'sawtooth', decay: 0.3 },
        { name: 'Bass A', freq: 110, type: 'sawtooth', decay: 0.3 },
        { name: 'Bass B', freq: 123, type: 'sawtooth', decay: 0.3 },
        { name: 'Wobble', freq: 55, type: 'square', decay: 0.5 },
        { name: 'Growl', freq: 70, type: 'sawtooth', decay: 0.4 },
        { name: 'Pluck', freq: 100, type: 'triangle', decay: 0.15 },
        { name: 'Thump', freq: 50, type: 'sine', decay: 0.25 },
        { name: 'Reese', freq: 60, type: 'sawtooth', decay: 0.6 },
        { name: 'Acid', freq: 80, type: 'square', decay: 0.3 },
        { name: 'Muted', freq: 90, type: 'triangle', decay: 0.1 },
        { name: 'Slap', freq: 120, type: 'sawtooth', decay: 0.08 }
      ]
    };
  }

  createSynthBank() {
    return {
      name: 'Synth',
      icon: 'üéπ',
      sounds: [
        { name: 'Lead C4', freq: 261, type: 'sawtooth', decay: 0.3 },
        { name: 'Lead D4', freq: 293, type: 'sawtooth', decay: 0.3 },
        { name: 'Lead E4', freq: 329, type: 'sawtooth', decay: 0.3 },
        { name: 'Lead F4', freq: 349, type: 'sawtooth', decay: 0.3 },
        { name: 'Lead G4', freq: 392, type: 'sawtooth', decay: 0.3 },
        { name: 'Lead A4', freq: 440, type: 'sawtooth', decay: 0.3 },
        { name: 'Lead B4', freq: 493, type: 'sawtooth', decay: 0.3 },
        { name: 'Lead C5', freq: 523, type: 'sawtooth', decay: 0.3 },
        { name: 'Pad 1', freq: 220, type: 'sine', decay: 0.8 },
        { name: 'Pad 2', freq: 330, type: 'sine', decay: 0.8 },
        { name: 'Stab 1', freq: 400, type: 'square', decay: 0.1 },
        { name: 'Stab 2', freq: 500, type: 'square', decay: 0.1 },
        { name: 'Bell', freq: 880, type: 'sine', decay: 0.5 },
        { name: 'Pluck', freq: 600, type: 'triangle', decay: 0.12 },
        { name: 'Strings', freq: 440, type: 'sawtooth', decay: 1.0 },
        { name: 'Brass', freq: 350, type: 'square', decay: 0.4 }
      ]
    };
  }

  createFXBank() {
    return {
      name: 'FX',
      icon: '‚ú®',
      sounds: [
        { name: 'Rise', freq: 200, type: 'sawtooth', decay: 1.0, pitch: 1.5 },
        { name: 'Fall', freq: 800, type: 'sawtooth', decay: 0.5, pitch: 0.5 },
        { name: 'Laser', freq: 1000, type: 'square', decay: 0.2, pitch: 0.3 },
        { name: 'Zap', freq: 1500, type: 'sawtooth', decay: 0.1 },
        { name: 'Boom', freq: 60, type: 'sine', decay: 0.8 },
        { name: 'Swoosh', freq: 400, type: 'sawtooth', decay: 0.3 },
        { name: 'Blip', freq: 1200, type: 'sine', decay: 0.05 },
        { name: 'Beep', freq: 880, type: 'square', decay: 0.1 },
        { name: 'Noise', freq: 0, type: 'noise', decay: 0.2 },
        { name: 'Static', freq: 0, type: 'noise', decay: 0.5 },
        { name: 'Reverse', freq: 300, type: 'triangle', decay: 0.4 },
        { name: 'Impact', freq: 80, type: 'sine', decay: 0.6 },
        { name: 'Whoosh', freq: 200, type: 'sawtooth', decay: 0.4 },
        { name: 'Siren', freq: 600, type: 'sine', decay: 0.8, pitch: 1.3 },
        { name: 'Glitch', freq: 0, type: 'noise', decay: 0.1 },
        { name: 'Click', freq: 2000, type: 'square', decay: 0.02 }
      ]
    };
  }

  async init() {
    console.log('üîß Initializing Improved Sampler...');

    // Create audio context
    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
    this.masterGain = this.audioContext.createGain();
    this.masterGain.connect(this.audioContext.destination);

    // Initialize sequencer data (16 pads x 16 steps)
    for (let i = 0; i < 16; i++) {
      this.sequencerData[i] = new Array(16).fill(false);
    }

    // Load custom banks from storage
    this.loadCustomBanks();

    // Generate UI
    this.generatePads();
    this.generateSequencer();
    this.setupEventListeners();
    this.setupDragAndDrop();

    console.log('‚úÖ Improved Sampler initialized');
  }

  generatePads() {
    const grid = document.getElementById('pad-grid');
    if (!grid) return;

    grid.innerHTML = '';
    const bank = this.banks[this.currentBank];

    for (let i = 0; i < 16; i++) {
      const sound = bank.sounds[i];
      const pad = document.createElement('div');
      pad.className = 'pad';
      pad.dataset.index = i;
      pad.innerHTML = `
        <div class="pad-number">${i + 1}</div>
        <div class="pad-name">${sound?.name || 'Empty'}</div>
        <div class="pad-loaded-indicator"></div>
      `;

      pad.addEventListener('mousedown', () => this.playPad(i));
      pad.addEventListener('touchstart', (e) => {
        e.preventDefault();
        this.playPad(i);
      });

      grid.appendChild(pad);
      this.pads[i] = pad;
    }
  }

  generateSequencer() {
    const grid = document.getElementById('sequencer-grid');
    const indicators = document.getElementById('step-indicators');
    if (!grid || !indicators) return;

    grid.innerHTML = '';
    indicators.innerHTML = '';

    // Step indicators
    for (let s = 0; s < 16; s++) {
      const indicator = document.createElement('span');
      indicator.className = 'step-num' + (s % 4 === 0 ? ' beat' : '');
      indicator.textContent = s + 1;
      indicators.appendChild(indicator);
    }

    // Sequencer rows (one per pad)
    for (let p = 0; p < 16; p++) {
      for (let s = 0; s < 16; s++) {
        const cell = document.createElement('div');
        cell.className = 'seq-cell' + (s % 4 === 0 ? ' beat-marker' : '');
        cell.dataset.pad = p;
        cell.dataset.step = s;

        cell.addEventListener('click', () => this.toggleStep(p, s));
        grid.appendChild(cell);
      }
    }
  }

  playPad(index) {
    const pad = this.pads[index];
    if (!pad) return;

    // Visual feedback
    pad.classList.add('active');
    setTimeout(() => pad.classList.remove('active'), 150);

    // Check for loaded audio buffer first
    if (this.padSounds[index]) {
      this.playBuffer(this.padSounds[index]);
    } else {
      // Play synth sound
      this.playSynthSound(index);
    }

    // Record to sequencer if recording
    if (this.isRecording && this.isPlaying) {
      this.sequencerData[index][this.currentStep] = true;
      this.updateSequencerCell(index, this.currentStep);
    }
  }

  playSynthSound(index) {
    if (this.audioContext.state === 'suspended') {
      this.audioContext.resume();
    }

    const bank = this.banks[this.currentBank];
    const sound = bank.sounds[index];
    if (!sound) return;

    const now = this.audioContext.currentTime;

    if (sound.type === 'noise') {
      // White noise
      const bufferSize = this.audioContext.sampleRate * sound.decay;
      const buffer = this.audioContext.createBuffer(1, bufferSize, this.audioContext.sampleRate);
      const data = buffer.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) {
        data[i] = Math.random() * 2 - 1;
      }
      const noise = this.audioContext.createBufferSource();
      noise.buffer = buffer;
      const gain = this.audioContext.createGain();
      gain.gain.setValueAtTime(0.5, now);
      gain.gain.exponentialRampToValueAtTime(0.01, now + sound.decay);
      noise.connect(gain);
      gain.connect(this.masterGain);
      noise.start();
    } else {
      const osc = this.audioContext.createOscillator();
      const gain = this.audioContext.createGain();

      osc.type = sound.type;
      osc.frequency.setValueAtTime(sound.freq, now);

      // Pitch envelope if specified
      if (sound.pitch) {
        osc.frequency.exponentialRampToValueAtTime(
          sound.freq * sound.pitch,
          now + sound.decay
        );
      }

      gain.gain.setValueAtTime(0.5, now);
      gain.gain.exponentialRampToValueAtTime(0.01, now + sound.decay);

      osc.connect(gain);
      gain.connect(this.masterGain);

      osc.start(now);
      osc.stop(now + sound.decay + 0.1);
    }
  }

  playBuffer(buffer) {
    const source = this.audioContext.createBufferSource();
    source.buffer = buffer;
    source.connect(this.masterGain);
    source.start();
  }

  toggleStep(padIndex, stepIndex) {
    this.sequencerData[padIndex][stepIndex] = !this.sequencerData[padIndex][stepIndex];
    this.updateSequencerCell(padIndex, stepIndex);
  }

  updateSequencerCell(padIndex, stepIndex) {
    const cell = document.querySelector(
      `.seq-cell[data-pad="${padIndex}"][data-step="${stepIndex}"]`
    );
    if (cell) {
      cell.classList.toggle('active', this.sequencerData[padIndex][stepIndex]);
    }
  }

  play() {
    if (this.isPlaying) return;
    this.isPlaying = true;
    this.currentStep = 0;

    if (this.audioContext.state === 'suspended') {
      this.audioContext.resume();
    }

    const stepDuration = (60000 / this.bpm) / 4;

    this.intervalId = setInterval(() => {
      this.playStep();
      this.currentStep = (this.currentStep + 1) % 16;
    }, stepDuration);

    document.getElementById('play-btn')?.classList.add('playing');
  }

  stop() {
    if (this.intervalId) {
      clearInterval(this.intervalId);
      this.intervalId = null;
    }
    this.isPlaying = false;
    this.currentStep = 0;
    this.clearStepHighlights();
    document.getElementById('play-btn')?.classList.remove('playing');
  }

  playStep() {
    this.clearStepHighlights();

    // Highlight current step
    document.querySelectorAll(`.seq-cell[data-step="${this.currentStep}"]`)
      .forEach(cell => cell.classList.add('playing'));

    document.querySelectorAll('.step-num')[this.currentStep]?.classList.add('current');

    // Play sounds for this step
    for (let p = 0; p < 16; p++) {
      if (this.sequencerData[p][this.currentStep]) {
        this.playPad(p);
      }
    }
  }

  clearStepHighlights() {
    document.querySelectorAll('.seq-cell.playing').forEach(c => c.classList.remove('playing'));
    document.querySelectorAll('.step-num.current').forEach(s => s.classList.remove('current'));
  }

  setBPM(bpm) {
    this.bpm = Math.max(60, Math.min(200, bpm));
    document.getElementById('bpm-value').textContent = this.bpm;

    if (this.isPlaying) {
      this.stop();
      this.play();
    }
  }

  switchBank(bankName) {
    if (this.banks[bankName] || this.customBanks[bankName]) {
      this.currentBank = bankName;

      // Update UI
      document.querySelectorAll('.bank-item').forEach(item => {
        item.classList.toggle('active', item.dataset.bank === bankName);
      });

      this.generatePads();
      console.log(`üéπ Switched to ${bankName} bank`);
    }
  }

  // Recording functionality
  async startBattleRecording() {
    const countdownEnabled = document.getElementById('countdown-enabled')?.checked;
    const includeBeat = document.getElementById('include-beat')?.checked;
    const maxDuration = parseInt(document.getElementById('max-duration')?.value || '60');

    // Show countdown if enabled
    if (countdownEnabled) {
      await this.showCountdown();
    }

    // Start the beat if enabled
    if (includeBeat && !this.isPlaying) {
      this.play();
    }

    // Get microphone access
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

      // Create MediaRecorder
      let combinedStream = stream;

      // If including beat, mix mic with audio output
      if (includeBeat) {
        const dest = this.audioContext.createMediaStreamDestination();
        this.masterGain.connect(dest);

        // Combine mic and beat
        const audioContext = new AudioContext();
        const micSource = audioContext.createMediaStreamSource(stream);
        const beatSource = audioContext.createMediaStreamSource(dest.stream);
        const merger = audioContext.createChannelMerger(2);

        micSource.connect(merger, 0, 0);
        beatSource.connect(merger, 0, 1);

        const combinedDest = audioContext.createMediaStreamDestination();
        merger.connect(combinedDest);
        combinedStream = combinedDest.stream;
      }

      this.mediaRecorder = new MediaRecorder(combinedStream);
      this.recordedChunks = [];

      this.mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) {
          this.recordedChunks.push(e.data);
        }
      };

      this.mediaRecorder.onstop = () => {
        this.handleRecordingComplete();
      };

      this.mediaRecorder.start();
      this.isBattleRecording = true;
      this.updateRecordingUI(true);

      // Start timer
      this.startRecordingTimer(maxDuration);

      // Auto-stop after max duration
      setTimeout(() => {
        if (this.isBattleRecording) {
          this.stopBattleRecording();
        }
      }, maxDuration * 1000);

    } catch (error) {
      console.error('Microphone access denied:', error);
      alert('Microphone access is required for recording. Please allow microphone access and try again.');
    }
  }

  stopBattleRecording() {
    if (this.mediaRecorder && this.isBattleRecording) {
      this.mediaRecorder.stop();
      this.isBattleRecording = false;
      this.updateRecordingUI(false);

      // Stop timer
      if (this.timerInterval) {
        clearInterval(this.timerInterval);
        this.timerInterval = null;
      }
    }
  }

  handleRecordingComplete() {
    const blob = new Blob(this.recordedChunks, { type: 'audio/webm' });
    const url = URL.createObjectURL(blob);

    const take = {
      id: Date.now(),
      blob,
      url,
      duration: this.recordingDuration || 0,
      timestamp: new Date().toISOString(),
      bpm: this.bpm,
      bank: this.currentBank
    };

    this.takes.push(take);
    this.renderTakes();

    // Enable export button
    document.getElementById('export-battle-btn').disabled = false;

    console.log('‚úÖ Recording saved:', take.id);
  }

  startRecordingTimer(maxDuration) {
    const timerEl = document.getElementById('recording-timer');
    const timerValue = timerEl?.querySelector('.timer-value');

    timerEl.style.display = 'block';
    this.recordingDuration = 0;

    this.timerInterval = setInterval(() => {
      this.recordingDuration++;
      const mins = Math.floor(this.recordingDuration / 60).toString().padStart(2, '0');
      const secs = (this.recordingDuration % 60).toString().padStart(2, '0');
      timerValue.textContent = `${mins}:${secs}`;

      if (this.recordingDuration >= maxDuration) {
        this.stopBattleRecording();
      }
    }, 1000);
  }

  updateRecordingUI(isRecording) {
    const btn = document.getElementById('record-battle-btn');
    const timer = document.getElementById('recording-timer');
    const micStatus = document.getElementById('mic-status');

    if (isRecording) {
      btn.classList.add('recording');
      btn.innerHTML = '<span class="record-icon">‚èπ</span><span>Stop Recording</span>';
      micStatus.classList.add('recording');
      micStatus.querySelector('.status-text').textContent = 'Recording...';
    } else {
      btn.classList.remove('recording');
      btn.innerHTML = '<span class="record-icon">‚è∫</span><span>Record Battle Entry</span>';
      timer.style.display = 'none';
      micStatus.classList.remove('recording');
      micStatus.querySelector('.status-text').textContent = 'Mic Ready';
    }
  }

  async showCountdown() {
    return new Promise(resolve => {
      const overlay = document.getElementById('countdown-overlay');
      const number = document.getElementById('countdown-number');

      overlay.style.display = 'flex';
      let count = 3;
      number.textContent = count;

      const interval = setInterval(() => {
        count--;
        if (count > 0) {
          number.textContent = count;
        } else {
          clearInterval(interval);
          overlay.style.display = 'none';
          resolve();
        }
      }, 1000);
    });
  }

  renderTakes() {
    const list = document.getElementById('takes-list');
    if (!list) return;

    if (this.takes.length === 0) {
      list.innerHTML = '<div class="empty-state">No recordings yet</div>';
      return;
    }

    list.innerHTML = this.takes.map((take, index) => `
      <div class="take-item ${this.selectedTake?.id === take.id ? 'selected' : ''}" data-take-id="${take.id}">
        <div class="take-info">
          <span class="take-number">Take ${index + 1}</span>
          <span class="take-duration">${Math.floor(take.duration / 60)}:${(take.duration % 60).toString().padStart(2, '0')}</span>
        </div>
        <div class="take-actions">
          <button class="btn-sm btn-ghost play-take" data-id="${take.id}">‚ñ∂</button>
          <button class="btn-sm btn-ghost select-take" data-id="${take.id}">‚úì</button>
          <button class="btn-sm btn-ghost delete-take" data-id="${take.id}">‚úï</button>
        </div>
        <audio src="${take.url}" style="display: none;"></audio>
      </div>
    `).join('');

    // Add event listeners
    list.querySelectorAll('.play-take').forEach(btn => {
      btn.addEventListener('click', () => {
        const take = this.takes.find(t => t.id === parseInt(btn.dataset.id));
        if (take) {
          const audio = list.querySelector(`[data-take-id="${take.id}"] audio`);
          audio?.play();
        }
      });
    });

    list.querySelectorAll('.select-take').forEach(btn => {
      btn.addEventListener('click', () => {
        this.selectedTake = this.takes.find(t => t.id === parseInt(btn.dataset.id));
        this.renderTakes();
      });
    });

    list.querySelectorAll('.delete-take').forEach(btn => {
      btn.addEventListener('click', () => {
        this.takes = this.takes.filter(t => t.id !== parseInt(btn.dataset.id));
        if (this.selectedTake?.id === parseInt(btn.dataset.id)) {
          this.selectedTake = null;
        }
        this.renderTakes();
        document.getElementById('export-battle-btn').disabled = this.takes.length === 0;
      });
    });
  }

  // Export for battle
  async exportForBattle() {
    const take = this.selectedTake || this.takes[this.takes.length - 1];
    if (!take) {
      alert('Please record a take first.');
      return;
    }

    const title = document.getElementById('battle-title')?.value || `Battle Entry ${Date.now()}`;
    const round = document.getElementById('battle-round')?.value || 'verse1';

    // Get user wallet
    const userWallet = localStorage.getItem('connectedWallet') ||
                       localStorage.getItem('anonymousWallet');

    if (!userWallet) {
      alert('Please connect a wallet first to export battle entries.');
      return;
    }

    // Show loading state
    const exportBtn = document.getElementById('export-battle-btn');
    const originalText = exportBtn?.innerHTML;
    if (exportBtn) {
      exportBtn.innerHTML = 'Exporting...';
      exportBtn.disabled = true;
    }

    // Create battle entry metadata
    const battleEntry = {
      id: `battle_${Date.now()}`,
      title,
      round,
      audioBlob: take.blob,
      audioUrl: take.url,
      duration: take.duration,
      bpm: this.bpm,
      bank: this.currentBank,
      sequenceData: this.sequencerData,
      timestamp: new Date().toISOString(),
      status: 'ready',
      userWallet
    };

    // Store blob in IndexedDB for larger storage (do this first for local playback)
    await this.saveBlobToIndexedDB(battleEntry.id, take.blob);

    // Save to localStorage as fallback
    const battleEntries = JSON.parse(localStorage.getItem('battleEntries') || '[]');
    battleEntries.push({
      ...battleEntry,
      audioBlob: null // Can't store blob in localStorage
    });
    localStorage.setItem('battleEntries', JSON.stringify(battleEntries));

    // Try to create/join a battle via the API
    let apiSuccess = false;
    let createdBattleId = null;

    try {
      // First, try to create a new battle or find an open one
      const createResponse = await fetch('/api/battles/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          challengerWallet: userWallet,
          category: 'freestyle',
          rounds: 1,
          barsPerRound: 16,
          timeLimit: '24h',
          title: title
        })
      });

      const createData = await createResponse.json();

      if (createData.success) {
        createdBattleId = createData.battle.id;
        console.log('Created battle:', createdBattleId);

        // Now submit the entry to this battle
        // Note: In a real app, you'd upload the audio blob to a storage service first
        // For now, we'll use the local URL as a placeholder
        const submitResponse = await fetch('/api/battles/submit-entry', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            battleId: createdBattleId,
            userWallet: userWallet,
            round: 1,
            audioUrl: battleEntry.audioUrl, // This is a blob URL, would need to be uploaded
            lyrics: null,
            roundType: round
          })
        });

        const submitData = await submitResponse.json();

        if (submitData.success) {
          apiSuccess = true;
          console.log('Submitted entry to battle:', submitData);

          // Award XP locally for immediate feedback
          if (window.progressManager && submitData.xpAwarded) {
            window.progressManager.awardXPLocally(
              userWallet,
              submitData.xpAwarded,
              'battle_submission',
              'Submitted a battle verse'
            );
          }
        }
      }
    } catch (error) {
      console.warn('API export failed, using local storage:', error.message);
    }

    // Restore button
    if (exportBtn) {
      exportBtn.innerHTML = originalText;
      exportBtn.disabled = false;
    }

    // Show success
    if (apiSuccess) {
      this.showToast('Battle entry saved to database! +25 XP', 'success');
    } else {
      this.showToast('Battle entry saved locally! (Database offline)', 'success');
    }

    // Offer to go to battle voting
    const destination = createdBattleId ? `/battle-voting` : '/battle-voting';
    if (confirm('Battle entry saved! Go to battle voting page?')) {
      window.location.href = destination;
    }
  }

  async saveBlobToIndexedDB(id, blob) {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open('BattleDB', 1);

      request.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains('recordings')) {
          db.createObjectStore('recordings', { keyPath: 'id' });
        }
      };

      request.onsuccess = (e) => {
        const db = e.target.result;
        const tx = db.transaction('recordings', 'readwrite');
        const store = tx.objectStore('recordings');
        store.put({ id, blob, timestamp: Date.now() });
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
      };

      request.onerror = () => reject(request.error);
    });
  }

  // Custom banks
  loadCustomBanks() {
    const saved = localStorage.getItem('customSoundBanks');
    if (saved) {
      this.customBanks = JSON.parse(saved);
      this.renderCustomBanks();
    }
  }

  saveCustomBanks() {
    localStorage.setItem('customSoundBanks', JSON.stringify(this.customBanks));
  }

  createCustomBank(name, icon) {
    const id = `custom_${Date.now()}`;
    this.customBanks[id] = {
      name,
      icon,
      sounds: []
    };
    this.saveCustomBanks();
    this.renderCustomBanks();
    return id;
  }

  renderCustomBanks() {
    const list = document.getElementById('custom-bank-list');
    if (!list) return;

    list.innerHTML = Object.entries(this.customBanks).map(([id, bank]) => `
      <div class="bank-item" data-bank="${id}">
        <span class="bank-icon">${bank.icon}</span>
        <span class="bank-name">${bank.name}</span>
        <span class="bank-count">${bank.sounds.length}</span>
      </div>
    `).join('');

    list.querySelectorAll('.bank-item').forEach(item => {
      item.addEventListener('click', () => {
        this.switchBank(item.dataset.bank);
      });
    });
  }

  // Drag and drop for sound uploads
  setupDragAndDrop() {
    const uploadZone = document.getElementById('upload-zone');
    const fileInput = document.getElementById('sound-upload');

    uploadZone?.addEventListener('click', () => fileInput?.click());

    uploadZone?.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('drag-over');
    });

    uploadZone?.addEventListener('dragleave', () => {
      uploadZone.classList.remove('drag-over');
    });

    uploadZone?.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('drag-over');
      const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('audio/'));
      this.handleSoundUploads(files);
    });

    fileInput?.addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      this.handleSoundUploads(files);
    });

    // Pad drop zones
    this.pads.forEach((pad, index) => {
      pad.addEventListener('dragover', (e) => {
        e.preventDefault();
        pad.classList.add('drag-over');
      });

      pad.addEventListener('dragleave', () => {
        pad.classList.remove('drag-over');
      });

      pad.addEventListener('drop', (e) => {
        e.preventDefault();
        pad.classList.remove('drag-over');
        const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('audio/'));
        if (files[0]) {
          this.loadSoundToPad(files[0], index);
        }
      });
    });
  }

  async handleSoundUploads(files) {
    for (const file of files) {
      const emptyPadIndex = this.findEmptyPad();
      if (emptyPadIndex !== -1) {
        await this.loadSoundToPad(file, emptyPadIndex);
      }
    }
  }

  findEmptyPad() {
    for (let i = 0; i < 16; i++) {
      if (!this.padSounds[i]) return i;
    }
    return -1;
  }

  async loadSoundToPad(file, padIndex) {
    try {
      const arrayBuffer = await file.arrayBuffer();
      const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);

      this.padSounds[padIndex] = audioBuffer;

      // Update pad UI
      const pad = this.pads[padIndex];
      pad.querySelector('.pad-name').textContent = file.name.replace(/\.[^/.]+$/, '').substring(0, 10);
      pad.classList.add('loaded');
      pad.querySelector('.pad-loaded-indicator').style.display = 'block';

      console.log(`‚úÖ Loaded ${file.name} to pad ${padIndex + 1}`);
    } catch (error) {
      console.error('Error loading sound:', error);
    }
  }

  // Event listeners
  setupEventListeners() {
    // Transport controls
    document.getElementById('play-btn')?.addEventListener('click', () => {
      if (this.isPlaying) {
        this.stop();
      } else {
        this.play();
      }
    });

    document.getElementById('stop-btn')?.addEventListener('click', () => this.stop());

    document.getElementById('record-seq-btn')?.addEventListener('click', () => {
      this.isRecording = !this.isRecording;
      document.getElementById('record-seq-btn')?.classList.toggle('active', this.isRecording);
      if (this.isRecording && !this.isPlaying) {
        this.play();
      }
    });

    // BPM controls
    document.getElementById('bpm-up')?.addEventListener('click', () => this.setBPM(this.bpm + 5));
    document.getElementById('bpm-down')?.addEventListener('click', () => this.setBPM(this.bpm - 5));

    // Clear/Save
    document.getElementById('clear-seq-btn')?.addEventListener('click', () => {
      for (let i = 0; i < 16; i++) {
        this.sequencerData[i] = new Array(16).fill(false);
      }
      document.querySelectorAll('.seq-cell.active').forEach(c => c.classList.remove('active'));
    });

    document.getElementById('save-seq-btn')?.addEventListener('click', () => this.saveBeat());

    // Bank selection
    document.querySelectorAll('.bank-item').forEach(item => {
      item.addEventListener('click', () => {
        this.switchBank(item.dataset.bank);
      });
    });

    // Add bank modal
    document.getElementById('add-bank-btn')?.addEventListener('click', () => {
      document.getElementById('add-bank-modal').style.display = 'flex';
    });

    // Emoji picker
    document.querySelectorAll('.emoji-option').forEach(option => {
      option.addEventListener('click', () => {
        document.querySelectorAll('.emoji-option').forEach(o => o.classList.remove('selected'));
        option.classList.add('selected');
        document.getElementById('new-bank-icon').value = option.dataset.emoji;
      });
    });

    // Battle recording
    document.getElementById('record-battle-btn')?.addEventListener('click', () => {
      if (this.isBattleRecording) {
        this.stopBattleRecording();
      } else {
        this.startBattleRecording();
      }
    });

    // Export
    document.getElementById('export-battle-btn')?.addEventListener('click', () => this.exportForBattle());
  }

  saveBeat() {
    const sequence = {
      id: Date.now(),
      name: `Beat_${new Date().toLocaleTimeString()}`,
      bpm: this.bpm,
      bank: this.currentBank,
      data: this.sequencerData,
      timestamp: Date.now()
    };

    const savedBeats = JSON.parse(localStorage.getItem('savedBeats') || '[]');
    savedBeats.push(sequence);
    localStorage.setItem('savedBeats', JSON.stringify(savedBeats));

    this.showToast('Beat saved!', 'success');
  }

  showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }
}

// Modal functions
window.closeAddBankModal = () => {
  document.getElementById('add-bank-modal').style.display = 'none';
};

window.createNewBank = () => {
  const name = document.getElementById('new-bank-name')?.value;
  const icon = document.getElementById('new-bank-icon')?.value || 'üéµ';

  if (!name) {
    alert('Please enter a bank name');
    return;
  }

  window.improvedSampler?.createCustomBank(name, icon);
  window.closeAddBankModal();
};

// Initialize
function initImprovedSampler() {
  if (!window.improvedSampler) {
    window.improvedSampler = new ImprovedSampler();
    console.log('‚úÖ Improved Sampler ready');
  }
}

document.addEventListener('DOMContentLoaded', initImprovedSampler);
document.addEventListener('astro:page-load', initImprovedSampler);

if (document.readyState !== 'loading') {
  initImprovedSampler();
}
</script>

<style>
  .improved-sampler-page {
    min-height: 100vh;
    background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
    color: white;
    padding: 1rem;
  }

  /* Header */
  .sampler-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 1rem;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .sampler-header h1 {
    font-size: 1.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, #58a6ff, #7c3aed);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin: 0;
  }

  .beta-badge {
    padding: 0.25rem 0.5rem;
    background: rgba(124, 58, 237, 0.3);
    border: 1px solid #7c3aed;
    border-radius: 0.25rem;
    font-size: 0.625rem;
    font-weight: 700;
    color: #7c3aed;
  }

  .header-actions {
    display: flex;
    gap: 0.5rem;
  }

  /* Layout */
  .sampler-layout {
    display: grid;
    grid-template-columns: 220px 1fr 280px;
    gap: 1rem;
    height: calc(100vh - 100px);
  }

  /* Panels */
  .banks-panel,
  .recording-panel {
    background: rgba(20, 20, 30, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.75rem;
    padding: 1rem;
    overflow-y: auto;
  }

  .panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .panel-header h2 {
    font-size: 1rem;
    font-weight: 600;
    color: #58a6ff;
    margin: 0;
  }

  /* Bank List */
  .bank-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }

  .bank-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .bank-item:hover {
    background: rgba(88, 166, 255, 0.1);
    border-color: rgba(88, 166, 255, 0.3);
  }

  .bank-item.active {
    background: rgba(88, 166, 255, 0.2);
    border-color: #58a6ff;
  }

  .bank-icon {
    font-size: 1.25rem;
  }

  .bank-name {
    flex: 1;
    font-weight: 500;
  }

  .bank-count {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.5);
  }

  /* Upload Zone */
  .upload-zone {
    border: 2px dashed rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    padding: 1.5rem 1rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .upload-zone:hover,
  .upload-zone.drag-over {
    border-color: #58a6ff;
    background: rgba(88, 166, 255, 0.1);
  }

  .upload-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.875rem;
  }

  .upload-icon {
    font-size: 1.5rem;
  }

  /* Main Section */
  .sampler-main {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  /* Transport Bar */
  .transport-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    background: rgba(20, 20, 30, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.75rem;
  }

  .transport-controls {
    display: flex;
    gap: 0.5rem;
  }

  .transport-btn {
    width: 44px;
    height: 44px;
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    color: white;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .transport-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: #58a6ff;
  }

  .transport-btn.playing {
    background: rgba(16, 185, 129, 0.3);
    border-color: #10b981;
  }

  .transport-btn.record-btn {
    color: #ef4444;
    border-color: rgba(239, 68, 68, 0.5);
  }

  .transport-btn.record-btn.active {
    background: rgba(239, 68, 68, 0.3);
    animation: pulse-red 1s infinite;
  }

  @keyframes pulse-red {
    0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
    50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
  }

  /* BPM Control */
  .bpm-control {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .bpm-btn {
    width: 32px;
    height: 32px;
    background: rgba(88, 166, 255, 0.2);
    border: 1px solid #58a6ff;
    border-radius: 0.25rem;
    color: #58a6ff;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .bpm-btn:hover {
    background: rgba(88, 166, 255, 0.3);
  }

  .bpm-display {
    text-align: center;
    padding: 0.5rem 1rem;
    background: #000;
    border: 2px solid #58a6ff;
    border-radius: 0.5rem;
  }

  #bpm-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #58a6ff;
    font-family: 'Courier New', monospace;
  }

  .bpm-label {
    font-size: 0.625rem;
    color: rgba(88, 166, 255, 0.6);
    text-transform: uppercase;
    display: block;
  }

  /* Pads Container */
  .pads-container {
    background: rgba(20, 20, 30, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.75rem;
    padding: 1rem;
  }

  .pads-container h3 {
    font-size: 0.875rem;
    font-weight: 600;
    margin: 0 0 0.75rem;
    color: #58a6ff;
  }

  .pads-container .hint {
    font-weight: 400;
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.5);
  }

  .pad-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.5rem;
  }

  .pad {
    aspect-ratio: 1;
    background: linear-gradient(135deg, rgba(88, 166, 255, 0.1), rgba(124, 58, 237, 0.1));
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.15s ease;
    position: relative;
  }

  .pad:hover {
    border-color: #58a6ff;
    transform: scale(1.02);
  }

  .pad.active {
    background: rgba(88, 166, 255, 0.3);
    border-color: #58a6ff;
    box-shadow: 0 0 20px rgba(88, 166, 255, 0.5);
  }

  .pad.loaded {
    border-color: #10b981;
  }

  .pad.drag-over {
    border-color: #f59e0b;
    background: rgba(245, 158, 11, 0.2);
  }

  .pad-number {
    font-size: 0.875rem;
    font-weight: 700;
    color: rgba(255, 255, 255, 0.4);
  }

  .pad-name {
    font-size: 0.625rem;
    color: rgba(255, 255, 255, 0.7);
    margin-top: 0.25rem;
    text-align: center;
  }

  .pad-loaded-indicator {
    display: none;
    position: absolute;
    top: 4px;
    right: 4px;
    width: 8px;
    height: 8px;
    background: #10b981;
    border-radius: 50%;
  }

  /* Sequencer */
  .sequencer-container {
    background: rgba(20, 20, 30, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.75rem;
    padding: 1rem;
    flex: 1;
    overflow-y: auto;
  }

  .sequencer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }

  .sequencer-header h3 {
    font-size: 0.875rem;
    font-weight: 600;
    margin: 0;
    color: #58a6ff;
  }

  .step-indicators {
    display: flex;
    gap: 2px;
  }

  .step-num {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.625rem;
    color: rgba(255, 255, 255, 0.4);
    border-radius: 2px;
  }

  .step-num.beat {
    color: rgba(88, 166, 255, 0.8);
  }

  .step-num.current {
    background: #10b981;
    color: white;
  }

  .sequencer-grid {
    display: grid;
    grid-template-columns: repeat(16, 1fr);
    gap: 2px;
  }

  .seq-cell {
    aspect-ratio: 1;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 2px;
    cursor: pointer;
    transition: all 0.1s ease;
    min-height: 18px;
  }

  .seq-cell:hover {
    background: rgba(88, 166, 255, 0.2);
  }

  .seq-cell.beat-marker {
    border-left: 2px solid rgba(88, 166, 255, 0.3);
  }

  .seq-cell.active {
    background: #58a6ff;
    box-shadow: 0 0 8px rgba(88, 166, 255, 0.5);
  }

  .seq-cell.playing {
    border-color: #10b981;
    box-shadow: inset 0 0 8px rgba(16, 185, 129, 0.5);
  }

  /* Recording Panel */
  .recording-section {
    margin-bottom: 1.5rem;
  }

  .mic-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.3);
    border-radius: 0.5rem;
    margin-bottom: 1rem;
  }

  .mic-status.recording {
    background: rgba(239, 68, 68, 0.1);
    border-color: #ef4444;
    animation: pulse-glow 1s infinite;
  }

  @keyframes pulse-glow {
    0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.3); }
    50% { box-shadow: 0 0 15px 5px rgba(239, 68, 68, 0.1); }
  }

  .mic-icon {
    font-size: 1.25rem;
  }

  .status-text {
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.8);
  }

  .btn-record-main {
    width: 100%;
    padding: 1rem;
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border: none;
    border-radius: 0.5rem;
    color: white;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
  }

  .btn-record-main:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
  }

  .btn-record-main.recording {
    background: linear-gradient(135deg, #10b981, #059669);
  }

  .record-icon {
    font-size: 1.25rem;
  }

  .recording-timer {
    text-align: center;
    padding: 1rem;
    background: rgba(239, 68, 68, 0.1);
    border-radius: 0.5rem;
    margin-top: 0.75rem;
  }

  .timer-value {
    font-size: 2rem;
    font-weight: 700;
    font-family: 'Courier New', monospace;
    color: #ef4444;
  }

  .timer-label {
    display: block;
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.6);
    margin-top: 0.25rem;
  }

  /* Recording Options */
  .recording-options {
    margin-top: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .option-toggle {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.8);
    cursor: pointer;
  }

  .option-toggle input {
    accent-color: #58a6ff;
  }

  .option-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.8);
  }

  .option-row select {
    padding: 0.25rem 0.5rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.25rem;
    color: white;
    font-size: 0.875rem;
  }

  /* Takes Section */
  .takes-section {
    margin-bottom: 1.5rem;
  }

  .takes-section h3,
  .export-section h3 {
    font-size: 0.875rem;
    font-weight: 600;
    color: #58a6ff;
    margin: 0 0 0.75rem;
  }

  .takes-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    max-height: 200px;
    overflow-y: auto;
  }

  .take-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.5rem;
    transition: all 0.2s ease;
  }

  .take-item.selected {
    border-color: #58a6ff;
    background: rgba(88, 166, 255, 0.1);
  }

  .take-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .take-number {
    font-weight: 600;
    font-size: 0.875rem;
  }

  .take-duration {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.5);
  }

  .take-actions {
    display: flex;
    gap: 0.25rem;
  }

  .empty-state {
    padding: 2rem 1rem;
    text-align: center;
    color: rgba(255, 255, 255, 0.4);
    font-size: 0.875rem;
  }

  /* Export Section */
  .export-section {
    margin-bottom: 1.5rem;
  }

  .battle-metadata {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
  }

  .input-field {
    width: 100%;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    color: white;
    font-size: 0.875rem;
  }

  .input-field:focus {
    outline: none;
    border-color: #58a6ff;
  }

  .export-info {
    margin-top: 0.5rem;
    text-align: center;
    color: rgba(255, 255, 255, 0.5);
  }

  /* Quick Actions */
  .quick-actions {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: auto;
  }

  /* Buttons */
  .btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
    border-radius: 0.375rem;
  }

  .btn-primary {
    background: linear-gradient(135deg, #58a6ff, #7c3aed);
    border: none;
    color: white;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(88, 166, 255, 0.4);
  }

  .btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .btn-secondary {
    background: rgba(88, 166, 255, 0.2);
    border: 1px solid #58a6ff;
    color: #58a6ff;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .btn-secondary:hover {
    background: rgba(88, 166, 255, 0.3);
  }

  .btn-ghost {
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: rgba(255, 255, 255, 0.8);
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-weight: 500;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .btn-ghost:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.3);
  }

  .btn-icon {
    width: 36px;
    height: 36px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .btn-icon:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .btn-full {
    width: 100%;
  }

  /* Modal */
  .modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .modal-content {
    background: #1a1a2e;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 1rem;
    width: 90%;
    max-width: 400px;
    overflow: hidden;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .modal-header h3 {
    margin: 0;
    font-size: 1.125rem;
  }

  .modal-close {
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.6);
    font-size: 1.5rem;
    cursor: pointer;
  }

  .modal-body {
    padding: 1rem;
  }

  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    padding: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }

  .emoji-picker {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
  }

  .emoji-option {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid transparent;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .emoji-option:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .emoji-option.selected {
    border-color: #58a6ff;
    background: rgba(88, 166, 255, 0.2);
  }

  /* Countdown Overlay */
  .countdown-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
  }

  .countdown-number {
    font-size: 10rem;
    font-weight: 900;
    color: #ef4444;
    text-shadow: 0 0 50px rgba(239, 68, 68, 0.5);
    animation: countdown-pulse 1s ease-in-out infinite;
  }

  @keyframes countdown-pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.8; }
  }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    padding: 1rem 1.5rem;
    background: rgba(20, 20, 30, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.75rem;
    color: white;
    font-weight: 500;
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 3000;
  }

  .toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }

  .toast-success {
    border-color: #10b981;
    box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
  }

  /* Custom Banks Section */
  .custom-banks-section {
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }

  .custom-banks-section h3 {
    font-size: 0.875rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.6);
    margin: 0 0 0.75rem;
  }

  .custom-bank-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .sampler-layout {
      grid-template-columns: 1fr;
      height: auto;
    }

    .banks-panel,
    .recording-panel {
      max-height: 300px;
    }
  }

  @media (max-width: 640px) {
    .pad-grid {
      gap: 0.25rem;
    }

    .transport-bar {
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .sequencer-grid {
      gap: 1px;
    }

    .seq-cell {
      min-height: 14px;
    }
  }
</style>
