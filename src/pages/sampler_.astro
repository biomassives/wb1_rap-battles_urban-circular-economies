---
/**
 * Sampler Page - Professional Music Sampler with Strudel Integration
 * 16 pads, 16-step sequencer, BPM control, sound loading
 * NEW: Local tracks, NFT samples, Strudel patterns
 */

import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout
  title="Music Sampler & Mixer"
  description="Create beats with the WorldBridger sampler - Load tracks, NFTs, and Strudel patterns"
  activeSection="music"
>
  <div class="sampler-page">
    <div class="sampler-header">
      <h1>üéõÔ∏è WorldBridger Sampler</h1>
      <div class="header-actions">
        <button id="toggle-samples-btn" class="btn-header">üìö Samples</button>
        <a href="/" class="back-link">‚Üê Back</a>
      </div>
    </div>

    <div class="sampler-workspace">

      <!-- Left Panel: Transport & BPM Controls -->
      <div class="control-panel collapsed">
        <button class="panel-toggle" data-panel="control-panel">
          <span class="toggle-icon">‚óÄ</span>
          <span class="toggle-label">Controls</span>
        </button>
        <div class="panel-content">
        <div class="transport-section">
          <h3>Transport</h3>
          <div class="transport-controls">
            <button id="play-btn" class="transport-btn play">
              <span class="btn-icon">‚ñ∂</span>
              <span>Play</span>
            </button>
            <button id="pause-btn" class="transport-btn pause">
              <span class="btn-icon">‚è∏</span>
              <span>Pause</span>
            </button>
            <button id="stop-btn" class="transport-btn stop">
              <span class="btn-icon">‚èπ</span>
              <span>Stop</span>
            </button>
          </div>
        </div>

        <!-- BPM Digital Dial -->
        <div class="bpm-section">
          <h3>BPM</h3>
          <div class="bpm-display">
            <div class="digital-readout" id="bpm-display">120</div>
            <div class="bpm-label">Beats Per Minute</div>
          </div>
          <div class="bpm-controls">
            <button id="bpm-down" class="bpm-btn">-</button>
            <input type="range" id="bpm-slider" min="60" max="200" value="120" />
            <button id="bpm-up" class="bpm-btn">+</button>
          </div>
          <div class="bpm-presets">
            <button class="preset-btn genre-preset" data-bpm="72" data-genre="Reggae">
              <span class="genre-icon">üå¥</span>
              <span>Reggae<br/>72</span>
            </button>
            <button class="preset-btn genre-preset" data-bpm="85" data-genre="Hip Hop">
              <span class="genre-icon">üé§</span>
              <span>Hip Hop<br/>85</span>
            </button>
            <button class="preset-btn genre-preset" data-bpm="95" data-genre="Blues">
              <span class="genre-icon">üé∏</span>
              <span>Blues<br/>95</span>
            </button>
            <button class="preset-btn genre-preset" data-bpm="110" data-genre="Country">
              <span class="genre-icon">ü§†</span>
              <span>Country<br/>110</span>
            </button>
            <button class="preset-btn genre-preset" data-bpm="140" data-genre="Rap">
              <span class="genre-icon">üî•</span>
              <span>Rap<br/>140</span>
            </button>
            <button class="preset-btn genre-preset" data-bpm="128" data-genre="House">
              <span class="genre-icon">üè†</span>
              <span>House<br/>128</span>
            </button>
          </div>
        </div>

        <!-- Master Controls -->
        <div class="master-section">
          <h3>Master</h3>
          <div class="volume-control">
            <label>Volume</label>
            <input type="range" id="master-volume" min="0" max="100" value="70" />
            <span id="volume-display">70%</span>
          </div>
          <button id="clear-all" class="btn-clear">Clear All</button>
        </div>
        </div>
      </div>

      <!-- Center: Sequencer & Pads -->
      <div class="main-section">

        <!-- 16-Step Sequencer (ABOVE pads) -->
        <div class="sequencer-section">
          <div class="sequencer-header">
            <h3>16-Bar Sequencer</h3>
            <div class="sequencer-controls">
              <button id="record-btn" class="btn-record-big">
                <span class="record-dot"></span>
                <span>RECORD</span>
              </button>
              <button id="clear-sequence" class="btn-clear-sequence">Clear</button>
              <button id="save-sequence" class="btn-save-sequence">
                üíæ Save for NFT
              </button>
            </div>
          </div>

          <!-- Mode & Banks Selector -->
          <div class="banks-section">
            <div class="mode-selector">
              <label for="mode-select">Mode:</label>
              <select id="mode-select" class="mode-selector-dropdown">
                <option value="synth">üéπ Synth Mode</option>
                <option value="audio">üéß Audio Mode</option>
                <option value="strudel">‚ú® Strudel Mode</option>
              </select>
            </div>

            <div class="bank-selector-container" id="bank-selector-container">
              <label for="bank-select">Bank:</label>
              <select id="bank-select" class="bank-selector">
                <option value="synth">üéπ Synth Bank</option>
                <option value="drums">ü•Å Drum Kit</option>
                <option value="bass">üé∏ Bass Bank</option>
                <option value="fx">‚ú® FX Bank</option>
              </select>
            </div>

            <div class="voice-meter">
              <span class="voice-label">Voices:</span>
              <span id="voice-count" class="voice-count">0/8</span>
            </div>
          </div>

          <!-- Step numbers -->
          <div class="step-indicators">
            <div class="instrument-label-header">Instrument</div>
            <div class="step-numbers">
              <span>1</span><span>2</span><span>3</span><span>4</span>
              <span>5</span><span>6</span><span>7</span><span>8</span>
              <span>9</span><span>10</span><span>11</span><span>12</span>
              <span>13</span><span>14</span><span>15</span><span>16</span>
            </div>
          </div>

          <!-- Sequencer Grid: 16 instruments √ó 16 steps -->
          <div id="sequencer-grid" class="sequencer-grid">
            <!-- Generated by JS: 16 instruments √ó 16 steps = 256 cells -->
          </div>
        </div>

        <!-- 16 Sampler Pads (BELOW sequencer) -->
        <div class="pads-section">
          <h3>Sampler Pads - Click to Play, Drag Samples to Load</h3>
          <div id="sampler-pads" class="pad-grid">
            <!-- Generated by JS -->
          </div>
        </div>

      </div>

      <!-- Right Panel: Sample Browser -->
      <div class="samples-panel" id="samples-panel">
        <button class="panel-toggle" data-panel="samples-panel">
          <span class="toggle-icon">‚óÄ</span>
          <span class="toggle-label">Sample Library</span>
        </button>
        <div class="panel-content">
          <h3>Sample Library</h3>

          <!-- Tab Navigation -->
          <div class="sample-tabs">
            <button class="tab-btn active" data-tab="tracks">
              üéµ My Tracks
            </button>
            <button class="tab-btn" data-tab="nfts">
              üé® NFTs
            </button>
            <button class="tab-btn" data-tab="upload">
              üìÅ Upload
            </button>
            <button class="tab-btn" data-tab="strudel">
              ‚ú® Strudel
            </button>
          </div>

          <!-- Tab Contents -->
          <div class="tab-content active" id="tab-tracks">
            <div class="track-browser-container">
              <div class="loading-message">Loading tracks...</div>
            </div>
          </div>

          <div class="tab-content" id="tab-nfts">
            <div class="nft-browser-container">
              <div class="nft-grid" id="nft-grid">
                <div class="loading-message">Loading NFTs...</div>
              </div>
            </div>
          </div>

          <div class="tab-content" id="tab-upload">
            <div class="upload-section">
              <button id="upload-sample-btn" class="btn-upload">
                üì§ Upload Audio File
              </button>
              <input type="file" id="sample-file-input" accept="audio/*" style="display: none;" multiple />
              <div id="upload-info" class="upload-info">
                Upload audio files to use in pads
              </div>
              <div id="uploaded-files" class="uploaded-files-list"></div>
            </div>
          </div>

          <div class="tab-content" id="tab-strudel">
            <div class="strudel-generator">
              <h4>Generate Beat</h4>
              <div class="generator-controls">
                <div class="control-group">
                  <label>Style:</label>
                  <select id="strudel-style">
                    <option value="rap">Rap</option>
                    <option value="trap">Trap</option>
                    <option value="boom_bap">Boom Bap</option>
                    <option value="drill">Drill</option>
                    <option value="reggae">Reggae</option>
                    <option value="dancehall">Dancehall</option>
                    <option value="afrobeat">Afrobeat</option>
                    <option value="house">House</option>
                  </select>
                </div>
                <div class="control-group">
                  <label>Complexity:</label>
                  <select id="strudel-complexity">
                    <option value="simple">Simple</option>
                    <option value="medium" selected>Medium</option>
                    <option value="complex">Complex</option>
                  </select>
                </div>
                <button id="generate-strudel-btn" class="btn-generate">
                  ‚ö° Generate Pattern
                </button>
              </div>
              <div id="strudel-pattern-display" class="pattern-display" style="display: none;">
                <label>Generated Pattern:</label>
                <pre id="strudel-pattern-code"></pre>
                <div class="pattern-actions">
                  <button id="play-strudel-pattern" class="btn-play">‚ñ∂ Play</button>
                  <button id="load-strudel-to-pad" class="btn-load">üì• Load to Selected Pad</button>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<!-- Load Strudel -->
<script src="https://unpkg.com/@strudel/web@1.0.3"></script>

<!-- Load Strudel Integration Scripts -->
<script is:inline src="/scripts/track-to-strudel-converter.js"></script>
<script is:inline src="/scripts/sampler-local-tracks.js"></script>
<script is:inline src="/scripts/nft-strudel-player.js"></script>
<script is:inline src="/scripts/battle-strudel-player.js"></script>

<script>
console.log('üöÄ Sampler with Strudel integration loading...');

/**
 * Enhanced Professional Sampler with Offline Storage Integration
 */
class ProfessionalSampler {
  constructor() {
    this.audioContext = null;
    this.pads = [];
    this.selectedPad = null;
    this.bpm = 120;
    this.isPlaying = false;
    this.isRecording = false;
    this.currentStep = 0;
    this.sequencerData = [];
    this.padSounds = {};
    this.padModes = {}; // 'synth', 'audio', or 'strudel'
    this.padStrudelPatterns = {}; // Strudel code for each pad
    this.masterVolume = 0.7;
    this.intervalId = null;
    this.currentBank = 'synth';
    this.currentMode = 'synth';
    this.uploadedFiles = [];

    // Performance optimization
    this.activeOscillators = [];
    this.maxPolyphony = 8;
    this.lastLogTime = 0;
    this.pendingDisplayUpdates = new Set();

    this.session = {
  bpm: 120,
  bank: 'synth',
  mode: 'synth',
  pads: Array.from({ length: 16 }, () => ({
    mode: 'synth',
    label: null,
    audio: null,
    strudel: null
  })),
  sequence: Array.from({ length: 16 }, () => Array(16).fill(false)),
  lastUpdated: Date.now()
};


    // Preset sound banks
    this.soundBanks = {
      synth: [60, 120, 180, 100, 80, 100, 250, 300, 55, 220, 440, 330, 150, 200, 180, 160],
      drums: [40, 150, 200, 180, 65, 75, 300, 280, 50, 100, 250, 160, 120, 140, 190, 170],
      bass: [55, 58, 62, 65, 69, 73, 77, 82, 87, 92, 98, 103, 110, 116, 123, 130],
      fx: [200, 400, 600, 800, 1000, 1200, 1400, 1600, 300, 500, 700, 900, 1100, 1300, 1500, 1700]
    };

    this.init();
  }

  async init() {
    console.log('üîß Starting enhanced sampler init...');

    // Initialize Web Audio
    try {
      this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
      console.log('‚úÖ Audio context created');
    } catch (error) {
      console.error('‚ùå Failed to create audio context:', error);
    }

    // Initialize Strudel
    if (typeof initStrudel !== 'undefined') {
      try {
        initStrudel();
        console.log('‚úÖ Strudel initialized');
      } catch (error) {
        console.error('‚ùå Strudel init error:', error);
      }
    }

    // Wait for storage managers
    await this.waitForManagers();

    // Initialize sequencer data
    for (let i = 0; i < 16; i++) {
      this.sequencerData[i] = new Array(16).fill(false);
      this.padModes[i] = 'synth';
    }

    // Generate UI
    this.generatePads();
    this.generateSequencer();
    this.setupEventListeners();
    this.setupDragAndDrop();

    // Load samples from local storage
    await this.loadLocalSamples();

    console.log('‚úÖ Enhanced Sampler Initialized');
  }

  async waitForManagers() {
    let attempts = 0;
    while (!window.localDB?.db && attempts < 50) {
      await new Promise(r => setTimeout(r, 100));
      attempts++;
    }
    console.log('‚úÖ Storage managers ready');
  }

  async loadLocalSamples() {
    // Load tracks
    if (window.samplerLocalTracks) {
      await window.samplerLocalTracks.initialize();
      const tracks = await window.samplerLocalTracks.loadLocalTracks();
      this.renderTrackBrowser(tracks);
    }

    // Load NFTs
    if (window.nftStrudelPlayer) {
      await window.nftStrudelPlayer.initialize();
      const nfts = await window.nftStrudelPlayer.getUserMusicNFTs();
      this.renderNFTBrowser(nfts);
    }
  }

  renderTrackBrowser(tracks) {
    const container = document.querySelector('.track-browser-container');
    if (!container || !tracks) return;

    if (tracks.length === 0) {
      container.innerHTML = '<div class="no-items">No tracks found. Create some in the studio!</div>';
      return;
    }

    let html = '<div class="track-list">';
    tracks.forEach(track => {
      const hasStrudel = track.strudelPattern ? '‚ú®' : '';
      const hasAudio = track.audioFileUrl ? 'üéß' : '';

      html += `
        <div class="track-item" draggable="true" data-track-id="${track.id}" data-type="track">
          <div class="track-icon">${hasStrudel || hasAudio || 'üéµ'}</div>
          <div class="track-info">
            <div class="track-title">${track.title}</div>
            <div class="track-meta">${track.genre}${track.bpm ? ` ‚Ä¢ ${track.bpm} BPM` : ''}</div>
          </div>
          ${hasStrudel ? '<span class="badge">STRUDEL</span>' : ''}
        </div>
      `;
    });
    html += '</div>';
    container.innerHTML = html;

    // Add drag listeners
    document.querySelectorAll('.track-item').forEach(item => {
      item.addEventListener('dragstart', (e) => this.handleDragStart(e));
    });
  }

  renderNFTBrowser(nfts) {
    const container = document.getElementById('nft-grid');
    if (!container || !nfts) return;

    if (nfts.length === 0) {
      container.innerHTML = '<div class="no-items">No music NFTs found</div>';
      return;
    }

    let html = '';
    nfts.forEach(nft => {
      html += `
        <div class="nft-item" draggable="true" data-nft-id="${nft.id}" data-type="nft">
          <img src="${nft.metadata?.image || '/images/default-nft.png'}" alt="${nft.name}" />
          <div class="nft-name">${nft.name}</div>
        </div>
      `;
    });
    container.innerHTML = html;

    // Add drag listeners
    document.querySelectorAll('.nft-item').forEach(item => {
      item.addEventListener('dragstart', (e) => this.handleDragStart(e));
    });
  }

  setupDragAndDrop() {
    // Make pads drop targets
    this.pads.forEach((pad, index) => {
      pad.addEventListener('dragover', (e) => {
        e.preventDefault();
        pad.classList.add('drag-over');
      });

      pad.addEventListener('dragleave', () => {
        pad.classList.remove('drag-over');
      });

      pad.addEventListener('drop', (e) => {
        e.preventDefault();
        pad.classList.remove('drag-over');
        this.handleDrop(e, index);
      });
    });
  }

  handleDragStart(e) {
    const type = e.target.dataset.type;
    const id = e.target.dataset.trackId || e.target.dataset.nftId;
    e.dataTransfer.setData('type', type);
    e.dataTransfer.setData('id', id);
    console.log(`üì¶ Dragging ${type} with ID: ${id}`);
  }

  async handleDrop(e, padIndex) {
    const type = e.dataTransfer.getData('type');
    const id = parseInt(e.dataTransfer.getData('id'));

    console.log(`üì• Dropped ${type} ${id} on pad ${padIndex}`);

    if (type === 'track') {
      await this.loadTrackToPad(id, padIndex);
    } else if (type === 'nft') {
      await this.loadNFTToPad(id, padIndex);
    } else if (type === 'file') {
      await this.loadFileToPad(id, padIndex);
    }
  }

  async loadTrackToPad(trackId, padIndex) {
    if (!window.samplerLocalTracks) return;

    const track = window.samplerLocalTracks.getTrack(trackId);
    if (!track) return;

    console.log(`üéµ Loading track "${track.title}" to pad ${padIndex}`);

    // Check if track has Strudel pattern
    if (track.strudelPattern) {
      this.padStrudelPatterns[padIndex] = track.strudelPattern;
      this.padModes[padIndex] = 'strudel';
      this.updatePadLabel(padIndex, track.title, '‚ú®');
    } else if (track.audioFileUrl) {
      // Load audio URL
      await this.loadAudioURL(track.audioFileUrl, padIndex);
      this.padModes[padIndex] = 'audio';
      this.updatePadLabel(padIndex, track.title, 'üéß');
    } else {
      // Generate Strudel pattern from track
      if (window.trackToStrudelConverter) {
        const pattern = window.trackToStrudelConverter.convert(track);
        this.padStrudelPatterns[padIndex] = pattern;
        this.padModes[padIndex] = 'strudel';
        this.updatePadLabel(padIndex, track.title, '‚ö°');
      }
    }

    this.pads[padIndex].classList.add('loaded');
  }

  async loadNFTToPad(nftId, padIndex) {
    if (!window.nftStrudelPlayer) return;

    const nft = await window.nftStrudelPlayer.getNFT(nftId);
    if (!nft) return;

    console.log(`üé® Loading NFT "${nft.name}" to pad ${padIndex}`);

    // Check if NFT has Strudel pattern
    if (nft.metadata?.strudelPattern) {
      this.padStrudelPatterns[padIndex] = nft.metadata.strudelPattern;
      this.padModes[padIndex] = 'strudel';
      this.updatePadLabel(padIndex, nft.name, '‚ú®');
    } else if (nft.metadata?.animation_url || nft.metadata?.audio_url) {
      const url = nft.metadata.animation_url || nft.metadata.audio_url;
      await this.loadAudioURL(url, padIndex);
      this.padModes[padIndex] = 'audio';
      this.updatePadLabel(padIndex, nft.name, 'üéß');
    } else {
      // Generate pattern from NFT metadata
      const pattern = window.nftStrudelPlayer.generatePatternFromNFT(nft);
      this.padStrudelPatterns[padIndex] = pattern;
      this.padModes[padIndex] = 'strudel';
      this.updatePadLabel(padIndex, nft.name, '‚ö°');
    }

    this.pads[padIndex].classList.add('loaded');
  }

  async loadAudioURL(url, padIndex) {
    try {
      const response = await fetch(url);
      const arrayBuffer = await response.arrayBuffer();
      const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);
      this.padSounds[padIndex] = audioBuffer;
      console.log(`‚úÖ Audio loaded for pad ${padIndex}`);
    } catch (error) {
      console.error('Error loading audio:', error);
    }
  }

  updatePadLabel(padIndex, title, icon) {
    const pad = this.pads[padIndex];
    const label = pad.querySelector('.pad-label');
    if (label) {
      label.textContent = `${icon} ${title.substring(0, 8)}`;
    }
  }

  generatePads() {
    const padGrid = document.getElementById('sampler-pads');
    if (!padGrid) {
      console.error('‚ùå sampler-pads element not found!');
      return;
    }

    const padLabels = [
      'Kick', 'Snare', 'Hi-Hat', 'Clap',
      'Tom 1', 'Tom 2', 'Crash', 'Ride',
      'Bass', 'Synth', 'Lead', 'Pad',
      'FX 1', 'FX 2', 'Voice', 'Sample'
    ];

    const padColors = [
      'linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%)',
      'linear-gradient(135deg, #1e40af 0%, #60a5fa 100%)',
      'linear-gradient(135deg, #2563eb 0%, #93c5fd 100%)',
      'linear-gradient(135deg, #1d4ed8 0%, #7dd3fc 100%)',
      'linear-gradient(135deg, #1e3a8a 0%, #60a5fa 100%)',
      'linear-gradient(135deg, #3b82f6 0%, #93c5fd 100%)',
      'linear-gradient(135deg, #0ea5e9 0%, #7dd3fc 100%)',
      'linear-gradient(135deg, #0284c7 0%, #38bdf8 100%)',
      'linear-gradient(135deg, #1e40af 0%, #3b82f6 100%)',
      'linear-gradient(135deg, #2563eb 0%, #60a5fa 100%)',
      'linear-gradient(135deg, #1d4ed8 0%, #93c5fd 100%)',
      'linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%)',
      'linear-gradient(135deg, #0284c7 0%, #7dd3fc 100%)',
      'linear-gradient(135deg, #1e3a8a 0%, #93c5fd 100%)',
      'linear-gradient(135deg, #3b82f6 0%, #7dd3fc 100%)',
      'linear-gradient(135deg, #2563eb 0%, #38bdf8 100%)'
    ];

    for (let i = 0; i < 16; i++) {
      const pad = document.createElement('div');
      pad.className = 'pad';
      pad.dataset.index = i;
      pad.dataset.pad = i;
      pad.style.background = padColors[i];
      pad.innerHTML = `
        <div class="pad-overlay"></div>
        <div class="pad-content">
          <div class="pad-number">${i + 1}</div>
          <div class="pad-label">${padLabels[i]}</div>
        </div>
      `;

      pad.addEventListener('click', () => this.selectPad(i));
      pad.addEventListener('mousedown', () => this.playPad(i));
      pad.addEventListener('touchstart', (e) => {
        e.preventDefault();
        this.playPad(i);
      });

      padGrid.appendChild(pad);
      this.pads.push(pad);
    }

    console.log(`‚úÖ Generated ${this.pads.length} pads`);
  }

  generateSequencer() {
    const sequencerGrid = document.getElementById('sequencer-grid');
    if (!sequencerGrid) return;

    const instrumentNames = [
      'Kick', 'Snare', 'Hi-Hat', 'Clap',
      'Tom 1', 'Tom 2', 'Crash', 'Ride',
      'Bass', 'Synth', 'Lead', 'Pad',
      'FX 1', 'FX 2', 'Voice', 'Sample'
    ];

    for (let padIndex = 0; padIndex < 16; padIndex++) {
      const label = document.createElement('div');
      label.className = 'instrument-label';
      label.textContent = instrumentNames[padIndex];
      label.dataset.pad = padIndex;
      label.addEventListener('click', () => this.selectPad(padIndex));
      sequencerGrid.appendChild(label);

      for (let step = 0; step < 16; step++) {
        const cell = document.createElement('div');
        cell.className = 'seq-cell';
        cell.dataset.pad = padIndex;
        cell.dataset.step = step;
        cell.dataset.instrument = instrumentNames[padIndex];

        if (step % 4 === 0) {
          cell.classList.add('beat-marker');
        }

        const consoleDisplay = document.createElement('div');
        consoleDisplay.className = 'cell-console';
        cell.appendChild(consoleDisplay);

        cell.addEventListener('click', () => this.toggleStep(padIndex, step));
        sequencerGrid.appendChild(cell);
      }
    }

    console.log('‚úÖ Sequencer generated');
  }

  selectPad(index) {
    this.pads.forEach(p => p.classList.remove('selected'));
    document.querySelectorAll('.instrument-label').forEach(l => l.classList.remove('selected'));

    this.selectedPad = index;
    this.pads[index].classList.add('selected');

    const label = document.querySelector(`.instrument-label[data-pad="${index}"]`);
    if (label) label.classList.add('selected');

    console.log(`‚úì Selected pad ${index + 1} (Mode: ${this.padModes[index]})`);
  }

  playPad(index) {
    const pad = this.pads[index];
    if (!pad) return;

    // Visual feedback
    pad.classList.add('active');
    setTimeout(() => pad.classList.remove('active'), 150);

    const label = document.querySelector(`.instrument-label[data-pad="${index}"]`);
    if (label) {
      label.classList.add('playing');
      setTimeout(() => label.classList.remove('playing'), 300);
    }

    // If recording, add to sequence
    if (this.isRecording && this.isPlaying) {
      this.sequencerData[index][this.currentStep] = true;
      this.updateSequencerCell(index, this.currentStep);
    }

    // Play based on pad mode
    const mode = this.padModes[index];
    if (mode === 'strudel' && this.padStrudelPatterns[index]) {
      this.playStrudelPad(index);
    } else if (mode === 'audio' && this.padSounds[index]) {
      this.playSoundBuffer(this.padSounds[index]);
    } else {
      this.playSynthSound(index);
    }

    console.log(`üéµ Playing pad ${index + 1} (${mode})`);
  }

  playStrudelPad(index) {
    if (!this.padStrudelPatterns[index]) return;

    try {
      hush();
      eval(this.padStrudelPatterns[index] + '.play()');
    } catch (error) {
      console.error('Strudel playback error:', error);
    }
  }

  playSynthSound(index) {
    if (!this.audioContext) return;

    if (this.audioContext.state === 'suspended') {
      this.audioContext.resume().then(() => this.playSynthSound(index));
      return;
    }

    if (this.activeOscillators.length >= this.maxPolyphony) {
      const oldestOsc = this.activeOscillators.shift();
      if (oldestOsc?.oscillator) {
        try {
          oldestOsc.oscillator.stop();
          oldestOsc.oscillator.disconnect();
        } catch (e) {}
      }
    }

    const frequencies = this.soundBanks[this.currentBank];

    try {
      const osc = this.audioContext.createOscillator();
      const gain = this.audioContext.createGain();

      const waveforms = {
        synth: 'sine',
        drums: 'triangle',
        bass: 'sawtooth',
        fx: 'square'
      };

      osc.type = waveforms[this.currentBank] || 'sine';
      osc.frequency.value = frequencies[index];

      gain.gain.setValueAtTime(this.masterVolume, this.audioContext.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.2);

      osc.connect(gain);
      gain.connect(this.audioContext.destination);

      const startTime = this.audioContext.currentTime;
      const stopTime = startTime + 0.2;

      osc.start(startTime);
      osc.stop(stopTime);

      const oscData = { oscillator: osc, stopTime };
      this.activeOscillators.push(oscData);

      setTimeout(() => {
        const idx = this.activeOscillators.indexOf(oscData);
        if (idx !== -1) this.activeOscillators.splice(idx, 1);
      }, 250);

      this.updateVoiceMeter();
    } catch (error) {
      console.error('Error playing sound:', error);
    }
  }

  playSoundBuffer(buffer) {
    if (!this.audioContext || !buffer) return;

    const source = this.audioContext.createBufferSource();
    const gain = this.audioContext.createGain();

    source.buffer = buffer;
    gain.gain.value = this.masterVolume;

    source.connect(gain);
    gain.connect(this.audioContext.destination);

    source.start();
  }

  updateVoiceMeter() {
    const voiceCount = document.getElementById('voice-count');
    if (voiceCount) {
      const count = this.activeOscillators.length;
      voiceCount.textContent = `${count}/${this.maxPolyphony}`;

      if (count >= this.maxPolyphony) {
        voiceCount.style.color = '#ef4444';
      } else if (count >= this.maxPolyphony * 0.7) {
        voiceCount.style.color = '#fbbf24';
      } else {
        voiceCount.style.color = '#10b981';
      }
    }
  }

  updateSequencerCell(padIndex, step) {
    const cellKey = `${padIndex}-${step}`;
    this.pendingDisplayUpdates.add(cellKey);

    if (!this.updateScheduled) {
      this.updateScheduled = true;
      requestAnimationFrame(() => {
        this.processPendingDisplayUpdates();
        this.updateScheduled = false;
      });
    }
  }

  processPendingDisplayUpdates() {
    const updates = Array.from(this.pendingDisplayUpdates);
    this.pendingDisplayUpdates.clear();

    updates.forEach(cellKey => {
      const [padIndex, step] = cellKey.split('-').map(Number);
      const cell = document.querySelector(
        `.seq-cell[data-pad="${padIndex}"][data-step="${step}"]`
      );

      if (cell) {
        const isActive = this.sequencerData[padIndex][step];
        cell.classList.toggle('active', isActive);

        const consoleDisplay = cell.querySelector('.cell-console');
        if (consoleDisplay) {
          if (isActive) {
            const mode = this.padModes[padIndex];
            consoleDisplay.innerHTML = `
              <div class="console-line">${cell.dataset.instrument}</div>
              <div class="console-line">${mode.toUpperCase()}</div>
            `;
          } else {
            consoleDisplay.innerHTML = '';
          }
        }
      }
    });
  }

  toggleStep(padIndex, step) {
    this.sequencerData[padIndex][step] = !this.sequencerData[padIndex][step];
    this.updateSequencerCell(padIndex, step);
  }

  play() {
    if (this.isPlaying) return;
    this.isPlaying = true;
    this.currentStep = 0;

    if (this.audioContext.state === 'suspended') {
      this.audioContext.resume();
    }

    const stepDuration = (60000 / this.bpm) / 4;

    this.intervalId = setInterval(() => {
      this.playStep();
      this.currentStep = (this.currentStep + 1) % 16;
    }, stepDuration);

    document.getElementById('play-btn').classList.add('playing');
  }

  pause() {
    if (this.intervalId) {
      clearInterval(this.intervalId);
      this.intervalId = null;
    }
    this.isPlaying = false;
    document.getElementById('play-btn').classList.remove('playing');
  }

  stop() {
    this.pause();
    this.currentStep = 0;
    this.clearStepIndicators();
  }

  playStep() {
    this.clearStepIndicators();

    const currentStepCells = document.querySelectorAll(`.seq-cell[data-step="${this.currentStep}"]`);
    currentStepCells.forEach(cell => cell.classList.add('playing'));

    const stepNumbers = document.querySelectorAll('.step-numbers span');
    if (stepNumbers[this.currentStep]) {
      stepNumbers[this.currentStep].classList.add('playing-step');
    }

    for (let padIndex = 0; padIndex < 16; padIndex++) {
      if (this.sequencerData[padIndex][this.currentStep]) {
        this.playPad(padIndex);
      }
    }
  }

  clearStepIndicators() {
    document.querySelectorAll('.seq-cell.playing')
      .forEach(cell => cell.classList.remove('playing'));
    document.querySelectorAll('.step-numbers span')
      .forEach(span => span.classList.remove('playing-step'));
  }

  setBPM(bpm) {
    this.bpm = Math.max(60, Math.min(200, bpm));
    document.getElementById('bpm-display').textContent = this.bpm;
    document.getElementById('bpm-slider').value = this.bpm;

    if (this.isPlaying) {
      this.pause();
      this.play();
    }
  }

  switchBank(bankName) {
    if (this.soundBanks[bankName]) {
      this.currentBank = bankName;
      console.log(`üéπ Switched to ${bankName} bank`);
    }
  }

  toggleRecord() {
    this.isRecording = !this.isRecording;

    const recordBtn = document.getElementById('record-btn');
    if (this.isRecording) {
      recordBtn.classList.add('recording');
      console.log('üî¥ Recording enabled');
      if (!this.isPlaying) {
        this.play();
      }
    } else {
      recordBtn.classList.remove('recording');
      console.log('‚èπÔ∏è Recording stopped');
    }
  }

  clearAll() {
    for (let i = 0; i < 16; i++) {
      this.sequencerData[i] = new Array(16).fill(false);
    }

    document.querySelectorAll('.seq-cell.active')
      .forEach(cell => cell.classList.remove('active'));

    console.log('üóëÔ∏è Sequencer cleared');
  }

  saveSequence() {
    let totalNotes = 0;
    const notesPerInstrument = [];
    for (let i = 0; i < 16; i++) {
      let count = 0;
      for (let j = 0; j < 16; j++) {
        if (this.sequencerData[i][j]) count++;
      }
      notesPerInstrument.push(count);
      totalNotes += count;
    }

    const sequenceId = Date.now().toString(36) + Math.random().toString(36).substr(2);

    // Generate combined Strudel pattern from all active pads
    const strudelPattern = this.generateCombinedStrudelPattern();

    const sequence = {
      name: `Sequence ${new Date().toLocaleString()}`,
      bpm: this.bpm,
      bank: this.currentBank,
      mode: this.currentMode,
      data: this.sequencerData,
      padModes: this.padModes,
      padStrudelPatterns: this.padStrudelPatterns,
      combinedStrudelPattern: strudelPattern,
      timestamp: Date.now(),
      id: sequenceId,
      stats: {
        totalNotes,
        notesPerInstrument,
        duration: (60 / this.bpm) * 4 * 4
      }
    };

    // Save to sequence history
    const savedSequences = JSON.parse(localStorage.getItem('samplerSequences') || '[]');
    savedSequences.push(sequence);
    localStorage.setItem('samplerSequences', JSON.stringify(savedSequences));

    // NFT-ready metadata for other pages (recorder, etc.)
    const nftMetadata = {
      id: sequenceId,
      name: sequence.name,
      type: 'sampler_sequence',
      bpm: this.bpm,
      bank: this.currentBank,
      mode: this.currentMode,
      strudelPattern: strudelPattern,
      sequenceData: this.sequencerData,
      padModes: this.padModes,
      padStrudelPatterns: this.padStrudelPatterns,
      timestamp: Date.now(),
      duration: sequence.stats.duration,
      totalNotes: totalNotes,
      // NFT attributes
      attributes: [
        { trait_type: 'Type', value: 'Sampler Sequence' },
        { trait_type: 'BPM', value: this.bpm },
        { trait_type: 'Bank', value: this.currentBank },
        { trait_type: 'Total Notes', value: totalNotes },
        { trait_type: 'Duration', value: `${sequence.stats.duration.toFixed(1)}s` }
      ]
    };

    // Store as last saved sequence for easy access
    localStorage.setItem('lastSavedSequence', JSON.stringify(nftMetadata));

    // Store in NFT backing tracks collection
    const backingTracks = JSON.parse(localStorage.getItem('nftBackingTracks') || '[]');
    backingTracks.unshift(nftMetadata); // Add to beginning
    // Keep only last 20 backing tracks
    if (backingTracks.length > 20) backingTracks.pop();
    localStorage.setItem('nftBackingTracks', JSON.stringify(backingTracks));

    console.log('üíæ Sequence saved:', sequence.id);

    // Show toast notification instead of alert
    this.showToast(`Sequence saved! ${totalNotes} notes @ ${this.bpm} BPM`, 'success');

    if (window.formAdapter) {
      window.formAdapter.awardXP(window.walletManager?.connectedWallet, 50, 'music_creation', 'Saved sampler sequence');
    }

    return sequence;
  }

  /**
   * Generate a combined Strudel pattern from all active sequencer steps
   */
  generateCombinedStrudelPattern() {
    const instrumentNames = [
      'bd', 'sd', 'hh', 'cp',
      'tom:1', 'tom:2', 'cr', 'rd',
      'bass:0', 'synth:0', 'lead:0', 'pad:0',
      'fx:0', 'fx:1', 'vocal:0', 'samp:0'
    ];

    const patterns = [];

    for (let padIndex = 0; padIndex < 16; padIndex++) {
      const steps = this.sequencerData[padIndex];
      const activeSteps = steps.map((active, i) => active ? i : -1).filter(i => i >= 0);

      if (activeSteps.length === 0) continue;

      // Check if this pad has a custom Strudel pattern
      if (this.padModes[padIndex] === 'strudel' && this.padStrudelPatterns[padIndex]) {
        // Use the custom pattern but apply step timing
        patterns.push(`// Pad ${padIndex + 1}: Custom Strudel`);
        patterns.push(this.padStrudelPatterns[padIndex]);
      } else {
        // Generate pattern from steps
        const instrument = instrumentNames[padIndex];
        const stepPattern = steps.map((active, i) => active ? 'x' : '~').join(' ');
        patterns.push(`s("${instrument}").struct("${stepPattern}")`);
      }
    }

    if (patterns.length === 0) {
      return `// Empty sequence\nsilence`;
    }

    return `// Generated from Sampler @ ${this.bpm} BPM\nsetcpm(${this.bpm / 4})\n\nstack(\n  ${patterns.join(',\n  ')}\n)`;
  }

  /**
   * Show toast notification
   */
  showToast(message, type = 'info') {
    // Try using the global toast system first
    if (window.uiManager && typeof window.uiManager.showXPToast === 'function') {
      window.uiManager.showXPToast({ xp: { earned: 0, total: 0 }, level: { current: 0, leveledUp: false } });
    }

    // Create custom toast for sampler
    const existingToast = document.getElementById('sampler-toast');
    if (existingToast) existingToast.remove();

    const toast = document.createElement('div');
    toast.id = 'sampler-toast';
    toast.className = `sampler-toast sampler-toast-${type}`;
    toast.innerHTML = `
      <div class="toast-icon">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</div>
      <div class="toast-message">${message}</div>
    `;

    document.body.appendChild(toast);

    // Trigger animation
    requestAnimationFrame(() => {
      toast.classList.add('show');
    });

    // Auto-dismiss
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  setupEventListeners() {
    // Panel toggles
    document.querySelectorAll('.panel-toggle').forEach(btn => {
      btn.addEventListener('click', () => {
        const panelClass = btn.dataset.panel;
        const panel = document.querySelector(`.${panelClass}`);
        const icon = btn.querySelector('.toggle-icon');

        panel.classList.toggle('collapsed');

        if (panelClass === 'control-panel' || panelClass === 'samples-panel') {
          icon.textContent = panel.classList.contains('collapsed') ? '‚ñ∂' : '‚óÄ';
        }
      });
    });

    // Samples panel toggle from header
    document.getElementById('toggle-samples-btn')?.addEventListener('click', () => {
      const panel = document.getElementById('samples-panel');
      panel.classList.toggle('collapsed');
    });

    // Transport
    document.getElementById('play-btn')?.addEventListener('click', () => this.play());
    document.getElementById('pause-btn')?.addEventListener('click', () => this.pause());
    document.getElementById('stop-btn')?.addEventListener('click', () => this.stop());
    document.getElementById('record-btn')?.addEventListener('click', () => this.toggleRecord());
    document.getElementById('clear-sequence')?.addEventListener('click', () => {
      if (confirm('Clear the entire sequence?')) this.clearAll();
    });

    // BPM
    document.getElementById('bpm-up')?.addEventListener('click', () => this.setBPM(this.bpm + 1));
    document.getElementById('bpm-down')?.addEventListener('click', () => this.setBPM(this.bpm - 1));
    document.getElementById('bpm-slider')?.addEventListener('input', (e) => {
      this.setBPM(parseInt(e.target.value));
    });

    document.querySelectorAll('.preset-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const bpm = parseInt(btn.dataset.bpm);
        this.setBPM(bpm);
        document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      });
    });

    // Master volume
    document.getElementById('master-volume')?.addEventListener('input', (e) => {
      this.masterVolume = e.target.value / 100;
      document.getElementById('volume-display').textContent = `${e.target.value}%`;
    });

    document.getElementById('clear-all')?.addEventListener('click', () => {
      if (confirm('Clear entire sequencer?')) this.clearAll();
    });

    // Bank selector
    document.getElementById('bank-select')?.addEventListener('change', (e) => {
      this.switchBank(e.target.value);
    });

    // Mode selector
    document.getElementById('mode-select')?.addEventListener('change', (e) => {
      this.currentMode = e.target.value;
      const bankContainer = document.getElementById('bank-selector-container');
      if (e.target.value === 'synth') {
        bankContainer.style.display = 'flex';
      } else {
        bankContainer.style.display = 'none';
      }
      console.log(`üîÑ Mode switched to: ${e.target.value}`);
    });

    // Save sequence
    document.getElementById('save-sequence')?.addEventListener('click', () => this.saveSequence());

    // Tab navigation
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tabName = btn.dataset.tab;

        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        btn.classList.add('active');
        document.getElementById(`tab-${tabName}`).classList.add('active');
      });
    });

    // Upload sample
    document.getElementById('upload-sample-btn')?.addEventListener('click', () => {
      document.getElementById('sample-file-input').click();
    });

    document.getElementById('sample-file-input')?.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files);
      for (const file of files) {
        await this.handleUploadedFile(file);
      }
    });

    // Strudel generator
    document.getElementById('generate-strudel-btn')?.addEventListener('click', () => {
      this.generateStrudelPattern();
    });

    document.getElementById('play-strudel-pattern')?.addEventListener('click', () => {
      const pattern = document.getElementById('strudel-pattern-code').textContent;
      if (pattern) {
        try {
          hush();
          eval(pattern + '.play()');
        } catch (error) {
          console.error('Strudel error:', error);
        }
      }
    });

    document.getElementById('load-strudel-to-pad')?.addEventListener('click', () => {
      if (this.selectedPad === null) {
        alert('Please select a pad first');
        return;
      }

      const pattern = document.getElementById('strudel-pattern-code').textContent;
      if (pattern) {
        this.padStrudelPatterns[this.selectedPad] = pattern;
        this.padModes[this.selectedPad] = 'strudel';
        this.updatePadLabel(this.selectedPad, 'Strudel', '‚ú®');
        this.pads[this.selectedPad].classList.add('loaded');
        console.log(`‚ú® Strudel pattern loaded to pad ${this.selectedPad + 1}`);
      }
    });
  }

  async handleUploadedFile(file) {
    try {
      const arrayBuffer = await file.arrayBuffer();
      const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);

      const fileData = {
        id: this.uploadedFiles.length,
        name: file.name,
        buffer: audioBuffer
      };

      this.uploadedFiles.push(fileData);
      this.renderUploadedFiles();

      console.log(`‚úÖ Uploaded: ${file.name}`);
    } catch (error) {
      console.error('Error uploading file:', error);
      alert(`Failed to load ${file.name}`);
    }
  }

  renderUploadedFiles() {
    const container = document.getElementById('uploaded-files');
    if (!container) return;

    if (this.uploadedFiles.length === 0) {
      container.innerHTML = '';
      return;
    }

    let html = '<div class="file-list">';
    this.uploadedFiles.forEach(file => {
      html += `
        <div class="file-item" draggable="true" data-file-id="${file.id}" data-type="file">
          <span>üéß ${file.name}</span>
        </div>
      `;
    });
    html += '</div>';
    container.innerHTML = html;

    // Add drag listeners
    document.querySelectorAll('.file-item').forEach(item => {
      item.addEventListener('dragstart', (e) => this.handleDragStart(e));
    });
  }

  async loadFileToPad(fileId, padIndex) {
    const file = this.uploadedFiles[fileId];
    if (!file) return;

    this.padSounds[padIndex] = file.buffer;
    this.padModes[padIndex] = 'audio';
    this.updatePadLabel(padIndex, file.name, 'üéß');
    this.pads[padIndex].classList.add('loaded');
    console.log(`üéß Loaded ${file.name} to pad ${padIndex + 1}`);
  }

  generateStrudelPattern() {
    const style = document.getElementById('strudel-style').value;
    const complexity = document.getElementById('strudel-complexity').value;

    if (!window.battleStrudelPlayer) {
      alert('Strudel not available');
      return;
    }

    const pattern = window.battleStrudelPlayer.createBattleBeat(this.bpm, style, { complexity });

    document.getElementById('strudel-pattern-code').textContent = pattern;
    document.getElementById('strudel-pattern-display').style.display = 'block';

    console.log(`‚ö° Generated ${style} pattern (${complexity})`);
  }
}

// Initialize sampler
function initSampler() {
  const padGrid = document.getElementById('sampler-pads');
  if (padGrid && !window.sampler) {
    window.sampler = new ProfessionalSampler();
    console.log('‚úÖ Enhanced Sampler initialized');
  }
}

document.addEventListener('DOMContentLoaded', initSampler);
document.addEventListener('astro:page-load', initSampler);

if (document.readyState !== 'loading') {
  initSampler();
}
</script>

<style>
  /* Previous styles remain the same, adding new styles for sample browser */

  .sampler-page {
    min-height: 100vh;
    height: 100vh;
    padding: 0.5rem;
    background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .sampler-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    color: white;
    padding: 0.5rem;
  }

  .header-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }

  .btn-header {
    padding: 0.5rem 1rem;
    background: rgba(88, 166, 255, 0.2);
    border: 2px solid #58a6ff;
    border-radius: 0.5rem;
    color: #58a6ff;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn-header:hover {
    background: rgba(88, 166, 255, 0.3);
    transform: translateY(-2px);
  }

  .sampler-header h1 {
    font-size: 1.5rem;
    background: linear-gradient(135deg, #58a6ff, #7c3aed);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin: 0;
  }

  .back-link {
    padding: 0.5rem 0.75rem;
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    color: white;
    text-decoration: none;
    transition: all 0.3s ease;
    font-weight: 600;
    font-size: 0.875rem;
  }

  .back-link:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
  }

  .sampler-workspace {
    display: flex;
    gap: 0.5rem;
    flex: 1;
    overflow: hidden;
  }

  /* Sample Browser Panel */
  .samples-panel {
    background: rgba(20, 20, 30, 0.8);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.5rem;
    color: white;
    position: relative;
    transition: all 0.3s ease;
    width: 320px;
    display: flex;
    flex-direction: column;
  }

  .samples-panel.collapsed {
    width: 0 !important;
    min-width: 0 !important;
    padding: 0 !important;
    margin: 0 !important;
    border: none !important;
    overflow: hidden !important;
  }

  .samples-panel h3 {
    font-size: 1rem;
    margin-bottom: 1rem;
    color: #58a6ff;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .sample-tabs {
    display: flex;
    gap: 0.25rem;
    margin-bottom: 1rem;
    border-bottom: 2px solid rgba(255, 255, 255, 0.1);
  }

  .tab-btn {
    flex: 1;
    padding: 0.75rem 0.5rem;
    background: rgba(255, 255, 255, 0.05);
    border: none;
    border-bottom: 3px solid transparent;
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .tab-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.9);
  }

  .tab-btn.active {
    background: rgba(88, 166, 255, 0.2);
    border-bottom-color: #58a6ff;
    color: #58a6ff;
  }

  .tab-content {
    display: none;
    flex: 1;
    overflow-y: auto;
  }

  .tab-content.active {
    display: block;
  }

  /* Track Browser */
  .track-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .track-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.375rem;
    cursor: grab;
    transition: all 0.2s ease;
  }

  .track-item:hover {
    background: rgba(88, 166, 255, 0.2);
    border-color: #58a6ff;
    transform: translateX(4px);
  }

  .track-item:active {
    cursor: grabbing;
  }

  .track-icon {
    font-size: 1.5rem;
  }

  .track-info {
    flex: 1;
    min-width: 0;
  }

  .track-title {
    font-weight: 600;
    font-size: 0.875rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .track-meta {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.6);
    margin-top: 0.25rem;
  }

  .badge {
    padding: 0.25rem 0.5rem;
    background: rgba(124, 58, 237, 0.3);
    border: 1px solid #7c3aed;
    border-radius: 0.25rem;
    font-size: 0.625rem;
    font-weight: 700;
    color: #7c3aed;
  }

  /* NFT Browser */
  .nft-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
  }

  .nft-item {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.5rem;
    overflow: hidden;
    cursor: grab;
    transition: all 0.2s ease;
  }

  .nft-item:hover {
    border-color: #58a6ff;
    transform: scale(1.05);
  }

  .nft-item:active {
    cursor: grabbing;
  }

  .nft-item img {
    width: 100%;
    aspect-ratio: 1;
    object-fit: cover;
  }

  .nft-name {
    padding: 0.5rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Upload Section */
  .upload-section {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .btn-upload {
    width: 100%;
    padding: 1rem;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border: none;
    border-radius: 0.5rem;
    color: white;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-upload:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
  }

  .upload-info {
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.6);
    text-align: center;
  }

  .file-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .file-item {
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.375rem;
    font-size: 0.875rem;
    cursor: grab;
    transition: all 0.2s ease;
  }

  .file-item:hover {
    background: rgba(88, 166, 255, 0.2);
    border-color: #58a6ff;
  }

  .file-item:active {
    cursor: grabbing;
  }

  /* Strudel Generator */
  .strudel-generator {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .strudel-generator h4 {
    font-size: 0.875rem;
    color: #58a6ff;
    text-transform: uppercase;
    margin: 0;
  }

  .generator-controls {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .control-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .control-group label {
    font-size: 0.75rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.8);
  }

  .control-group select {
    padding: 0.5rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.375rem;
    color: white;
    font-size: 0.875rem;
  }

  .btn-generate {
    padding: 0.75rem;
    background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%);
    border: none;
    border-radius: 0.5rem;
    color: white;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-generate:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);
  }

  .pattern-display {
    background: #000;
    border: 1px solid #58a6ff;
    border-radius: 0.375rem;
    padding: 0.75rem;
  }

  .pattern-display label {
    display: block;
    font-size: 0.75rem;
    font-weight: 600;
    color: #58a6ff;
    margin-bottom: 0.5rem;
  }

  .pattern-display pre {
    margin: 0 0 0.75rem 0;
    padding: 0.75rem;
    background: rgba(0, 255, 0, 0.05);
    border: 1px dashed #0f0;
    border-radius: 0.25rem;
    color: #0f0;
    font-family: 'Courier New', monospace;
    font-size: 0.75rem;
    overflow-x: auto;
    text-shadow: 0 0 2px #0f0;
  }

  .pattern-actions {
    display: flex;
    gap: 0.5rem;
  }

  .btn-play, .btn-load {
    flex: 1;
    padding: 0.5rem;
    border: none;
    border-radius: 0.375rem;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-play {
    background: #10b981;
    color: white;
  }

  .btn-play:hover {
    background: #059669;
  }

  .btn-load {
    background: #58a6ff;
    color: white;
  }

  .btn-load:hover {
    background: #3b82f6;
  }

  /* Loading & Empty States */
  .loading-message, .no-items {
    padding: 2rem 1rem;
    text-align: center;
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.875rem;
  }

  /* Pad Drag Over State */
  .pad.drag-over {
    border-color: #58a6ff !important;
    border-width: 4px !important;
    box-shadow: 0 0 30px rgba(88, 166, 255, 0.8);
  }

  .pad.loaded {
    border-color: #10b981;
  }

  /* Mode Selector */
  .mode-selector {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .mode-selector label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #58a6ff;
  }

  .mode-selector-dropdown {
    padding: 0.5rem;
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.375rem;
    color: white;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
  }

  /* Rest of the existing styles... */
  /* (Include all the existing CSS from the original sampler.astro file) */

  /* Control Panel */
  .control-panel {
    background: rgba(20, 20, 30, 0.8);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.5rem;
    color: white;
    position: relative;
    transition: all 0.3s ease;
    width: 280px;
    display: flex;
    flex-direction: column;
  }

  .control-panel.collapsed {
    width: 40px;
  }

  .control-panel.collapsed .panel-content {
    display: none;
  }

  .panel-toggle {
    position: absolute;
    right: -15px;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(88, 166, 255, 0.9);
    border: 2px solid #58a6ff;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
    transition: all 0.2s ease;
  }

  .panel-toggle:hover {
    background: #58a6ff;
    transform: translateY(-50%) scale(1.1);
  }

  .toggle-icon {
    font-size: 0.75rem;
    color: white;
  }

  .control-panel.collapsed .toggle-icon {
    transform: rotate(180deg);
  }

  .toggle-label {
    writing-mode: vertical-rl;
    text-orientation: mixed;
    font-size: 0.75rem;
    font-weight: 600;
    color: white;
    margin-top: 0.5rem;
  }

  .panel-content {
    padding: 1rem;
    overflow-y: auto;
    flex: 1;
  }

  /* Transport Section */
  .transport-section {
    margin-bottom: 1.5rem;
  }

  .transport-section h3,
  .bpm-section h3,
  .master-section h3 {
    font-size: 0.875rem;
    margin-bottom: 0.75rem;
    color: #58a6ff;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .transport-controls {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .transport-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem;
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    background: rgba(255, 255, 255, 0.05);
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .transport-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateY(-2px);
  }

  .transport-btn.play {
    border-color: #10b981;
    color: #10b981;
  }

  .transport-btn.play:hover {
    background: rgba(16, 185, 129, 0.2);
  }

  .transport-btn.pause {
    border-color: #f59e0b;
    color: #f59e0b;
  }

  .transport-btn.pause:hover {
    background: rgba(245, 158, 11, 0.2);
  }

  .transport-btn.stop {
    border-color: #ef4444;
    color: #ef4444;
  }

  .transport-btn.stop:hover {
    background: rgba(239, 68, 68, 0.2);
  }

  .transport-btn.active {
    background: rgba(16, 185, 129, 0.3);
    border-color: #10b981;
  }

  .btn-icon {
    font-size: 1.25rem;
  }

  /* BPM Section */
  .bpm-section {
    margin-bottom: 1.5rem;
  }

  .bpm-display {
    background: #000;
    border: 3px solid #58a6ff;
    border-radius: 0.5rem;
    padding: 1rem;
    text-align: center;
    margin-bottom: 1rem;
    box-shadow: 0 0 20px rgba(88, 166, 255, 0.3),
                inset 0 0 10px rgba(88, 166, 255, 0.1);
  }

  .digital-readout {
    font-size: 2.5rem;
    font-weight: 700;
    color: #58a6ff;
    font-family: 'Courier New', monospace;
    text-shadow: 0 0 10px #58a6ff, 0 0 20px #58a6ff;
    letter-spacing: 4px;
  }

  .bpm-label {
    font-size: 0.625rem;
    color: rgba(88, 166, 255, 0.6);
    margin-top: 0.25rem;
    text-transform: uppercase;
    letter-spacing: 2px;
  }

  .bpm-controls {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    margin-bottom: 1rem;
  }

  .bpm-btn {
    width: 40px;
    height: 40px;
    background: rgba(88, 166, 255, 0.2);
    border: 2px solid #58a6ff;
    border-radius: 0.375rem;
    color: #58a6ff;
    font-size: 1.25rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .bpm-btn:hover {
    background: rgba(88, 166, 255, 0.3);
    transform: scale(1.1);
  }

  .bpm-btn:active {
    transform: scale(0.95);
  }

  #bpm-slider {
    flex: 1;
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    outline: none;
    cursor: pointer;
  }

  #bpm-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    background: #58a6ff;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 0 10px #58a6ff;
  }

  #bpm-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: #58a6ff;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 0 10px #58a6ff;
  }

  .bpm-presets {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
  }

  .preset-btn {
    padding: 0.5rem 0.25rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.375rem;
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.625rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
  }

  .preset-btn:hover {
    background: rgba(88, 166, 255, 0.2);
    border-color: #58a6ff;
    color: #58a6ff;
    transform: scale(1.05);
  }

  .genre-icon {
    display: block;
    font-size: 1.5rem;
    margin-bottom: 0.25rem;
  }

  /* Master Section */
  .master-section {
    margin-bottom: 1rem;
  }

  .volume-control {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .volume-control label {
    font-size: 0.75rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.8);
  }

  .volume-control input[type="range"] {
    width: 100%;
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    outline: none;
    cursor: pointer;
  }

  .volume-control input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    background: #10b981;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 0 10px #10b981;
  }

  .volume-control input[type="range"]::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: #10b981;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 0 10px #10b981;
  }

  #volume-display {
    text-align: right;
    font-weight: 700;
    color: #10b981;
  }

  .btn-clear {
    width: 100%;
    padding: 0.75rem;
    background: rgba(239, 68, 68, 0.2);
    border: 2px solid #ef4444;
    border-radius: 0.5rem;
    color: #ef4444;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-clear:hover {
    background: rgba(239, 68, 68, 0.3);
    transform: translateY(-2px);
  }

  /* Main Section */
  .main-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    overflow: hidden;
  }

  /* Pad Grid */
  .pad-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.5rem;
    padding: 0.5rem;
    background: rgba(20, 20, 30, 0.6);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.5rem;
  }

  .pad {
    aspect-ratio: 1;
    background: rgba(255, 255, 255, 0.05);
    border: 3px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 700;
    color: rgba(255, 255, 255, 0.5);
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    user-select: none;
  }

  .pad:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: #58a6ff;
    transform: scale(1.05);
  }

  .pad:active {
    transform: scale(0.95);
  }

  .pad.loaded {
    border-color: #10b981;
    background: rgba(16, 185, 129, 0.1);
    color: white;
  }

  .pad.loaded:hover {
    background: rgba(16, 185, 129, 0.2);
    box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
  }

  .pad.active {
    background: rgba(88, 166, 255, 0.3);
    border-color: #58a6ff;
    color: white;
    box-shadow: 0 0 30px rgba(88, 166, 255, 0.6);
  }

  .pad.playing {
    animation: pulse 0.3s ease;
  }

  @keyframes pulse {
    0%, 100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.1);
      box-shadow: 0 0 40px rgba(88, 166, 255, 0.8);
    }
  }

  .pad-label {
    position: absolute;
    bottom: 0.5rem;
    left: 0.5rem;
    right: 0.5rem;
    font-size: 0.625rem;
    text-align: center;
    background: rgba(0, 0, 0, 0.7);
    padding: 0.25rem;
    border-radius: 0.25rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Sequencer */
  .sequencer-section {
    background: rgba(20, 20, 30, 0.8);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.5rem;
    padding: 0.75rem;
  }

  .sequencer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    color: white;
  }

  .sequencer-header h3 {
    font-size: 0.875rem;
    color: #58a6ff;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin: 0;
  }

  .step-display {
    font-size: 0.75rem;
    font-weight: 600;
    color: #10b981;
  }

  .sequencer-grid {
    display: grid;
    grid-template-columns: repeat(16, 1fr);
    gap: 2px;
    margin-bottom: 0.5rem;
  }

  .step {
    aspect-ratio: 1;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 2px;
    cursor: pointer;
    transition: all 0.1s ease;
  }

  .step:hover {
    background: rgba(88, 166, 255, 0.2);
  }

  .step.active {
    background: #58a6ff;
    box-shadow: 0 0 10px #58a6ff;
  }

  .step.current {
    border: 2px solid #10b981;
    box-shadow: 0 0 15px #10b981;
  }

  .step.active.current {
    background: #10b981;
    box-shadow: 0 0 20px #10b981;
  }

  /* Sequencer Controls */
  .sequencer-controls {
    display: flex;
    gap: 0.5rem;
    justify-content: space-between;
  }

  .btn-seq {
    flex: 1;
    padding: 0.5rem;
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.375rem;
    background: rgba(255, 255, 255, 0.05);
    color: white;
    font-weight: 600;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-seq:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateY(-2px);
  }

  .btn-seq-clear {
    border-color: #ef4444;
    color: #ef4444;
  }

  .btn-seq-clear:hover {
    background: rgba(239, 68, 68, 0.2);
  }

  .btn-seq-random {
    border-color: #7c3aed;
    color: #7c3aed;
  }

  .btn-seq-random:hover {
    background: rgba(124, 58, 237, 0.2);
  }

  .btn-seq-save {
    border-color: #10b981;
    color: #10b981;
  }

  .btn-seq-save:hover {
    background: rgba(16, 185, 129, 0.2);
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .sampler-workspace {
      flex-direction: column;
    }

    .control-panel,
    .samples-panel {
      width: 100%;
    }

    .control-panel.collapsed,
    .samples-panel.collapsed {
      height: 0;
      min-height: 0;
    }

    .pad-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  @media (max-width: 640px) {
    .pad-grid {
      grid-template-columns: repeat(4, 1fr);
      gap: 0.25rem;
      padding: 0.25rem;
    }

    .pad {
      font-size: 1rem;
    }

    .sequencer-grid {
      gap: 1px;
    }

    .bpm-presets {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  /* Toast Notification Styles */
  .sampler-toast {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 1.5rem;
    background: linear-gradient(135deg, rgba(20, 20, 30, 0.95) 0%, rgba(30, 30, 50, 0.95) 100%);
    border: 2px solid rgba(88, 166, 255, 0.5);
    border-radius: 0.75rem;
    color: white;
    font-weight: 600;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5),
                0 0 20px rgba(88, 166, 255, 0.3);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    z-index: 10000;
    backdrop-filter: blur(10px);
  }

  .sampler-toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }

  .sampler-toast-success {
    border-color: #10b981;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5),
                0 0 20px rgba(16, 185, 129, 0.4);
  }

  .sampler-toast-error {
    border-color: #ef4444;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5),
                0 0 20px rgba(239, 68, 68, 0.4);
  }

  .toast-icon {
    font-size: 1.5rem;
  }

  .toast-message {
    font-size: 0.95rem;
    letter-spacing: 0.5px;
  }
</style>
