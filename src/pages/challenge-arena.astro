---
/**
 * Challenge Arena - Public Challenge Hub
 * Browse, create, join, and vote on challenges
 * Acts as a moderated community forum for competitions
 */
import BaseLayout from '../layouts/BaseLayout.astro';

export const prerender = false;
---

<BaseLayout
  title="Challenge Arena"
  description="Browse and join public challenges - Beat battles, rap battles, remix challenges and more"
  activeSection="music"
>
  <div class="arena-page">

    <!-- Header -->
    <header class="arena-header">
      <div class="header-left">
        <h1>Challenge Arena</h1>
        <p class="subtitle">Compete. Create. Conquer.</p>
      </div>
      <div class="header-actions">
        <button class="btn-create" id="btn-create-challenge" onclick="window.openChallengeCreateModal && window.openChallengeCreateModal()">
          + Create Challenge
        </button>
        <a href="/beat-playground" class="btn-secondary-link">Beat Playground</a>
        <a href="/battle-voting" class="btn-ghost-link">Battle Voting</a>
      </div>
    </header>

    <!-- Join by Code -->
    <div class="join-bar">
      <div class="join-bar-inner">
        <span class="join-label">Have an invite code?</span>
        <input type="text" id="join-code-input" maxlength="6" placeholder="ABC123" class="join-input" />
        <button id="btn-join-code" class="btn-join-code">Join</button>
      </div>
    </div>

    <!-- Filter Tabs -->
    <div class="filter-section">
      <div class="filter-tabs" id="type-filters">
        <button class="filter-tab active" data-type="all">All</button>
        <button class="filter-tab" data-type="beat_battle">Beat Battle</button>
        <button class="filter-tab" data-type="rap_battle">Rap Battle</button>
        <button class="filter-tab" data-type="remix_challenge">Remix</button>
        <button class="filter-tab" data-type="freestyle">Freestyle</button>
      </div>
      <div class="filter-right">
        <div class="search-box">
          <input type="text" id="search-input" placeholder="Search challenges..." class="search-input" />
        </div>
        <select id="status-filter" class="status-select">
          <option value="all">All Status</option>
          <option value="pending">Open</option>
          <option value="in_progress">In Progress</option>
          <option value="voting">Voting</option>
          <option value="completed">Completed</option>
        </select>
      </div>
    </div>

    <!-- Main Content -->
    <main class="arena-main">
      <!-- Challenge Grid -->
      <div class="challenge-grid" id="challenge-grid">
        <div class="loading-state" id="loading-state">Loading challenges...</div>
      </div>

      <!-- Load More -->
      <div class="load-more-row" id="load-more-row" style="display: none;">
        <button class="btn-load-more" id="btn-load-more">Load More</button>
      </div>

      <!-- Empty State -->
      <div class="empty-state" id="empty-state" style="display: none;">
        <div class="empty-icon">üèüÔ∏è</div>
        <h3>No challenges yet</h3>
        <p>Be the first to create a challenge!</p>
        <button class="btn-create" onclick="window.openChallengeCreateModal && window.openChallengeCreateModal()">Create Challenge</button>
      </div>
    </main>

    <!-- My Challenges Section -->
    <section class="my-challenges-section" id="my-challenges-section" style="display: none;">
      <h2 class="section-title">My Challenges</h2>
      <div class="my-challenges-grid" id="my-challenges-grid"></div>
    </section>

  </div>

  <style>
    .arena-page {
      min-height: 100vh;
      background: #05070a;
      color: #e0e0e0;
      padding: 0 1rem 3rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Header */
    .arena-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem 0;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .arena-header h1 {
      font-size: 2rem;
      color: #fff;
      margin: 0;
      background: linear-gradient(135deg, #00e5ff, #00ff9c);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      color: #666;
      margin: 0.25rem 0 0;
      font-size: 0.95rem;
    }

    .header-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn-create {
      padding: 0.6rem 1.25rem;
      background: linear-gradient(135deg, #00e5ff, #00ff9c);
      color: #0b0f17;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-create:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(0, 229, 255, 0.3);
    }

    .btn-secondary-link, .btn-ghost-link {
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.85rem;
      text-decoration: none;
      font-weight: 500;
      transition: all 0.2s;
    }
    .btn-secondary-link {
      background: rgba(0, 229, 255, 0.1);
      border: 1px solid rgba(0, 229, 255, 0.3);
      color: #00e5ff;
    }
    .btn-ghost-link {
      background: transparent;
      border: 1px solid #333;
      color: #888;
    }
    .btn-secondary-link:hover { background: rgba(0, 229, 255, 0.15); }
    .btn-ghost-link:hover { border-color: #555; color: #aaa; }

    /* Join Bar */
    .join-bar {
      background: #0b0f17;
      border: 1px solid #1a2035;
      border-radius: 10px;
      padding: 0.75rem 1rem;
      margin-bottom: 1rem;
    }

    .join-bar-inner {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .join-label {
      color: #888;
      font-size: 0.85rem;
      white-space: nowrap;
    }

    .join-input {
      background: #0f1520;
      border: 1px solid #1a2035;
      color: #fff;
      padding: 0.45rem 0.75rem;
      border-radius: 6px;
      font-family: monospace;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      width: 110px;
      text-align: center;
    }
    .join-input:focus { outline: none; border-color: #00e5ff; }

    .btn-join-code {
      padding: 0.45rem 1rem;
      background: #00e5ff;
      color: #0b0f17;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .btn-join-code:hover { opacity: 0.9; }

    /* Filters */
    .filter-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.25rem;
      flex-wrap: wrap;
    }

    .filter-tabs {
      display: flex;
      gap: 0.25rem;
      flex-wrap: wrap;
    }

    .filter-tab {
      padding: 0.4rem 0.9rem;
      background: transparent;
      border: 1px solid #1a2035;
      color: #888;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .filter-tab:hover { border-color: #00e5ff; color: #00e5ff; }
    .filter-tab.active {
      background: rgba(0, 229, 255, 0.15);
      border-color: #00e5ff;
      color: #00e5ff;
    }

    .filter-right {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .search-input {
      background: #0f1520;
      border: 1px solid #1a2035;
      color: #fff;
      padding: 0.4rem 0.75rem;
      border-radius: 6px;
      font-size: 0.85rem;
      width: 180px;
    }
    .search-input:focus { outline: none; border-color: #00e5ff; }

    .status-select {
      background: #0f1520;
      border: 1px solid #1a2035;
      color: #fff;
      padding: 0.4rem 0.5rem;
      border-radius: 6px;
      font-size: 0.8rem;
    }

    /* Challenge Grid */
    .challenge-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1rem;
    }

    .loading-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 3rem;
      color: #666;
    }

    /* Challenge Card */
    .challenge-card {
      background: #0b0f17;
      border: 1px solid #1a2035;
      border-radius: 12px;
      padding: 1.25rem;
      transition: all 0.2s;
      cursor: pointer;
      position: relative;
    }
    .challenge-card:hover {
      border-color: rgba(0, 229, 255, 0.4);
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    .challenge-card.featured {
      border-color: rgba(0, 255, 156, 0.4);
      box-shadow: 0 0 15px rgba(0, 255, 156, 0.1);
    }

    .card-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .card-type-badge {
      font-size: 0.75rem;
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      background: rgba(0, 229, 255, 0.1);
      color: #00e5ff;
    }

    .card-status {
      font-size: 0.7rem;
      padding: 0.15rem 0.5rem;
      border-radius: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .card-status.pending { background: rgba(255, 193, 7, 0.15); color: #ffc107; }
    .card-status.accepted { background: rgba(0, 255, 156, 0.15); color: #00ff9c; }
    .card-status.in_progress { background: rgba(0, 229, 255, 0.15); color: #00e5ff; }
    .card-status.voting { background: rgba(255, 107, 107, 0.15); color: #ff6b6b; }
    .card-status.completed { background: rgba(128, 128, 128, 0.15); color: #888; }

    .card-title {
      font-size: 1.1rem;
      color: #fff;
      margin: 0 0 0.5rem;
      font-weight: 600;
      line-height: 1.3;
    }

    .card-creator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .card-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, #00e5ff, #00ff9c);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: bold;
      color: #0b0f17;
    }

    .card-creator-name { color: #aaa; font-size: 0.85rem; }

    .card-stats {
      display: flex;
      gap: 1rem;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
    }

    .card-stat {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }
    .card-stat-label {
      color: #555;
      font-size: 0.65rem;
      text-transform: uppercase;
    }
    .card-stat-value {
      color: #ccc;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .card-bottom {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 0.75rem;
      border-top: 1px solid #1a2035;
    }

    .card-time {
      color: #666;
      font-size: 0.75rem;
    }

    .card-actions {
      display: flex;
      gap: 0.4rem;
    }

    .card-btn {
      padding: 0.3rem 0.8rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    .card-btn.join {
      background: #00e5ff;
      color: #0b0f17;
    }
    .card-btn.view {
      background: rgba(0, 229, 255, 0.1);
      border: 1px solid rgba(0, 229, 255, 0.3);
      color: #00e5ff;
    }
    .card-btn.vote {
      background: rgba(255, 107, 107, 0.1);
      border: 1px solid rgba(255, 107, 107, 0.3);
      color: #ff6b6b;
    }
    .card-btn:hover { opacity: 0.85; }

    .card-beat-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      background: rgba(0, 255, 156, 0.08);
      padding: 0.15rem 0.5rem;
      border-radius: 10px;
      font-size: 0.7rem;
      color: #00ff9c;
      margin-bottom: 0.5rem;
    }

    .card-flag-btn {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      background: none;
      border: none;
      color: #333;
      cursor: pointer;
      font-size: 0.75rem;
      padding: 0.2rem;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .challenge-card:hover .card-flag-btn { opacity: 1; }
    .card-flag-btn:hover { color: #ff6b6b; }

    /* Load More */
    .load-more-row {
      text-align: center;
      padding: 1.5rem;
    }

    .btn-load-more {
      padding: 0.6rem 2rem;
      background: transparent;
      border: 1px solid #1a2035;
      color: #00e5ff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    .btn-load-more:hover {
      border-color: #00e5ff;
      background: rgba(0, 229, 255, 0.05);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
    }
    .empty-icon { font-size: 3rem; margin-bottom: 1rem; }
    .empty-state h3 { color: #fff; margin: 0 0 0.5rem; }
    .empty-state p { color: #666; margin: 0 0 1.5rem; }

    /* My Challenges */
    .my-challenges-section {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid #1a2035;
    }

    .section-title {
      color: #fff;
      font-size: 1.25rem;
      margin: 0 0 1rem;
    }

    .my-challenges-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }

    /* Toast */
    .arena-toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: #0b0f17;
      border: 1px solid #00ff9c;
      color: #00ff9c;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 500;
      z-index: 1000;
      transition: opacity 0.3s;
    }

    @media (max-width: 768px) {
      .arena-header { flex-direction: column; align-items: flex-start; }
      .filter-section { flex-direction: column; align-items: stretch; }
      .filter-right { justify-content: space-between; }
      .challenge-grid { grid-template-columns: 1fr; }
    }
  </style>

  <script is:inline>
  (function() {
    // State
    let challenges = [];
    let currentType = 'all';
    let currentStatus = 'all';
    let currentSearch = '';
    let currentOffset = 0;
    const LIMIT = 20;
    let totalCount = 0;

    const typeLabels = {
      rap_battle: 'Rap Battle',
      beat_battle: 'Beat Battle',
      remix_challenge: 'Remix',
      freestyle: 'Freestyle',
      learning_race: 'Learning',
      eco_challenge: 'Eco'
    };

    const typeIcons = {
      rap_battle: 'üé§',
      beat_battle: 'ü•Å',
      remix_challenge: 'üéß',
      freestyle: 'üî•',
      learning_race: 'üìö',
      eco_challenge: 'üå±'
    };

    // Fetch challenges from API
    async function fetchChallenges(append) {
      if (!append) {
        currentOffset = 0;
        challenges = [];
      }

      const params = new URLSearchParams({
        limit: LIMIT,
        offset: currentOffset
      });

      if (currentType !== 'all') params.set('type', currentType);
      if (currentStatus !== 'all') params.set('status', currentStatus);
      if (currentSearch) params.set('search', currentSearch);

      const wallet = localStorage.getItem('connectedWallet') || localStorage.getItem('anonymousWallet');
      if (wallet) params.set('walletAddress', wallet);

      try {
        const res = await fetch(`/api/challenges/list?${params}`);
        const data = await res.json();

        if (data.success) {
          if (append) {
            challenges = challenges.concat(data.challenges);
          } else {
            challenges = data.challenges;
          }
          totalCount = data.pagination?.total || 0;
          renderChallenges();
          updateLoadMore(data.pagination?.hasMore);
        } else {
          // Fallback to localStorage challenges
          loadLocalChallenges();
        }
      } catch (err) {
        console.warn('API fetch failed, using local:', err.message);
        loadLocalChallenges();
      }
    }

    function loadLocalChallenges() {
      try {
        const local = JSON.parse(localStorage.getItem('wb1_challenges') || '[]');
        challenges = local.map(c => ({
          id: c.dbId || c.id,
          inviteCode: c.inviteCode || c.invite_code,
          title: c.title || 'Untitled',
          description: c.description || '',
          type: c.type || 'rap_battle',
          mode: c.mode || '1v1',
          category: c.category || 'general',
          stakes: c.stakes || { type: 'xp', amount: 50 },
          hasBeat: !!c.beatConfig,
          maxParticipants: c.maxParticipants || 2,
          participantCount: c.participants?.length || 1,
          submissionCount: c.submissions?.length || 0,
          totalVotes: 0,
          status: c.state || c.status || 'pending',
          createdAt: c.creator?.createdAt || new Date().toISOString(),
          expiresAt: c.timing?.expiresAt,
          joinUrl: `/challenge/join/${c.inviteCode || c.invite_code}`,
          creator: {
            wallet: c.creator?.wallet,
            name: c.creator?.username || 'You',
            avatar: null
          }
        }));
        renderChallenges();
      } catch (e) {
        console.error('Local load error:', e);
        showEmpty();
      }
    }

    function renderChallenges() {
      const grid = document.getElementById('challenge-grid');
      const loading = document.getElementById('loading-state');
      const empty = document.getElementById('empty-state');

      if (loading) loading.style.display = 'none';

      if (challenges.length === 0) {
        showEmpty();
        return;
      }

      if (empty) empty.style.display = 'none';

      grid.innerHTML = challenges.map(c => {
        const timeStr = getTimeString(c);
        const statusClass = c.status?.replace(/\s/g, '_') || 'pending';
        const icon = typeIcons[c.type] || '‚öîÔ∏è';
        const typeLabel = typeLabels[c.type] || c.type;

        let actionBtn = '';
        if (c.status === 'pending' || c.status === 'accepted') {
          actionBtn = `<button class="card-btn join" data-action="join" data-code="${c.inviteCode}">Join</button>`;
        } else if (c.status === 'voting') {
          actionBtn = `<button class="card-btn vote" data-action="view" data-id="${c.id}">Vote</button>`;
        } else {
          actionBtn = `<button class="card-btn view" data-action="view" data-id="${c.id}">View</button>`;
        }

        return `
          <div class="challenge-card${c.isFeatured ? ' featured' : ''}" data-id="${c.id}" data-code="${c.inviteCode}">
            <button class="card-flag-btn" data-action="flag" data-id="${c.id}" title="Report">‚öë</button>
            <div class="card-top">
              <span class="card-type-badge">${icon} ${typeLabel}</span>
              <span class="card-status ${statusClass}">${c.status}</span>
            </div>
            <h3 class="card-title">${escapeHtml(c.title)}</h3>
            ${c.hasBeat ? '<div class="card-beat-badge">üéµ Beat attached</div>' : ''}
            <div class="card-creator">
              <div class="card-avatar">${c.creator?.name?.charAt(0)?.toUpperCase() || 'C'}</div>
              <span class="card-creator-name">${escapeHtml(c.creator?.name || 'Unknown')}</span>
            </div>
            <div class="card-stats">
              <div class="card-stat">
                <span class="card-stat-label">Mode</span>
                <span class="card-stat-value">${c.mode || '1v1'}</span>
              </div>
              <div class="card-stat">
                <span class="card-stat-label">Stakes</span>
                <span class="card-stat-value">${c.stakes?.amount || 0} ${(c.stakes?.type || 'XP').toUpperCase()}</span>
              </div>
              <div class="card-stat">
                <span class="card-stat-label">Players</span>
                <span class="card-stat-value">${c.participantCount || 0} / ${c.maxParticipants || 2}</span>
              </div>
              ${c.submissionCount > 0 ? `
              <div class="card-stat">
                <span class="card-stat-label">Entries</span>
                <span class="card-stat-value">${c.submissionCount}</span>
              </div>` : ''}
              ${c.totalVotes > 0 ? `
              <div class="card-stat">
                <span class="card-stat-label">Votes</span>
                <span class="card-stat-value">${c.totalVotes}</span>
              </div>` : ''}
            </div>
            <div class="card-bottom">
              <span class="card-time">${timeStr}</span>
              <div class="card-actions">
                ${actionBtn}
              </div>
            </div>
          </div>
        `;
      }).join('');

      // Attach event listeners
      grid.querySelectorAll('[data-action="join"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const code = btn.dataset.code;
          if (code) window.location.href = `/challenge/join/${code}`;
        });
      });

      grid.querySelectorAll('[data-action="view"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const id = btn.dataset.id;
          const card = btn.closest('.challenge-card');
          const code = card?.dataset.code;
          if (code) window.location.href = `/challenge/join/${code}`;
        });
      });

      grid.querySelectorAll('[data-action="flag"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const id = btn.dataset.id;
          if (confirm('Report this challenge for moderation?')) {
            showToast('Reported. Moderators will review.');
          }
        });
      });

      grid.querySelectorAll('.challenge-card').forEach(card => {
        card.addEventListener('click', () => {
          const code = card.dataset.code;
          if (code) window.location.href = `/challenge/join/${code}`;
        });
      });
    }

    function showEmpty() {
      const grid = document.getElementById('challenge-grid');
      const loading = document.getElementById('loading-state');
      const empty = document.getElementById('empty-state');
      if (loading) loading.style.display = 'none';
      if (grid) grid.innerHTML = '';
      if (empty) empty.style.display = 'block';
    }

    function updateLoadMore(hasMore) {
      const row = document.getElementById('load-more-row');
      if (row) row.style.display = hasMore ? 'block' : 'none';
    }

    function getTimeString(c) {
      if (!c.expiresAt) return '';
      const remaining = new Date(c.expiresAt) - Date.now();
      if (remaining <= 0) return 'Expired';
      const hours = Math.floor(remaining / (1000 * 60 * 60));
      if (hours > 24) {
        return `${Math.floor(hours / 24)}d left`;
      }
      return `${hours}h left`;
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    // My challenges
    async function loadMyChallenges() {
      const wallet = localStorage.getItem('connectedWallet') || localStorage.getItem('anonymousWallet');
      if (!wallet) return;

      try {
        const res = await fetch(`/api/challenges/list?walletAddress=${wallet}&limit=10`);
        const data = await res.json();

        if (data.success && data.challenges.length > 0) {
          const section = document.getElementById('my-challenges-section');
          const grid = document.getElementById('my-challenges-grid');
          if (!section || !grid) return;

          section.style.display = 'block';
          grid.innerHTML = data.challenges.map(c => `
            <div class="challenge-card" onclick="window.location.href='/challenge/join/${c.inviteCode}'" style="cursor:pointer;">
              <div class="card-top">
                <span class="card-type-badge">${typeIcons[c.type] || '‚öîÔ∏è'} ${typeLabels[c.type] || c.type}</span>
                <span class="card-status ${c.status}">${c.status}</span>
              </div>
              <h3 class="card-title">${escapeHtml(c.title)}</h3>
              <div class="card-bottom">
                <span class="card-time">${getTimeString(c)}</span>
                <span class="card-stat-value">${c.participantCount || 0} / ${c.maxParticipants || 2} players</span>
              </div>
            </div>
          `).join('');
        }
      } catch (e) {
        console.warn('My challenges load failed:', e.message);
      }
    }

    // Event Listeners
    // Type filter tabs
    document.querySelectorAll('#type-filters .filter-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('#type-filters .filter-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentType = tab.dataset.type;
        fetchChallenges(false);
      });
    });

    // Status filter
    document.getElementById('status-filter')?.addEventListener('change', (e) => {
      currentStatus = e.target.value;
      fetchChallenges(false);
    });

    // Search
    let searchTimeout;
    document.getElementById('search-input')?.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        currentSearch = e.target.value.trim();
        fetchChallenges(false);
      }, 400);
    });

    // Load more
    document.getElementById('btn-load-more')?.addEventListener('click', () => {
      currentOffset += LIMIT;
      fetchChallenges(true);
    });

    // Join by code
    document.getElementById('btn-join-code')?.addEventListener('click', () => {
      const input = document.getElementById('join-code-input');
      const code = input?.value?.trim().toUpperCase();
      if (code && code.length >= 4) {
        window.location.href = `/challenge/join/${code}`;
      } else {
        showToast('Enter a valid invite code');
      }
    });

    document.getElementById('join-code-input')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') document.getElementById('btn-join-code')?.click();
    });

    function showToast(message) {
      const existing = document.querySelector('.arena-toast');
      if (existing) existing.remove();
      const toast = document.createElement('div');
      toast.className = 'arena-toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 2500);
    }

    // Initial load
    fetchChallenges(false);
    loadMyChallenges();
  })();
  </script>

</BaseLayout>
