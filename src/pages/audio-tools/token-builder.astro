---
import BaseLayout from '../../layouts/BaseLayout.astro';

// Default "Seed" metadata for a new partner token
const defaultCode = `s("bd*4, [~ cp]*2").room(0.5)`;
---

<BaseLayout title="Token Builder | Worldbridger One" activeSection="audio-tools">
  <div class="nft-gallery-page scanlines builder-layout">
    <div class="container mx-auto">
      
      <header class="gallery-header pixel-border arcade-screen">
        <div class="header-badge">
          <span class="neon-text blink">▶ PARTNER SDK ◀</span>
        </div>
        <h1 class="gallery-title glitch">
          <span class="block">TOKEN</span>
          <span class="block neon-text">BUILDER</span>
        </h1>
        <p class="gallery-subtitle mono">
          > LIVE METADATA INJECTION • INTEROPERABLE AUDIO DNA
        </p>
      </header>

      <div class="builder-grid">
        <section class="console-panel card-retro-neon">
          <h2 class="mono text-cyan mb-4">// METADATA_INPUT</h2>
          
          <div class="input-group">
            <label class="mono text-xs">PARTNER SERIES NAME</label>
            <input type="text" id="seriesName" class="builder-input" placeholder="e.g. Cyber-Forest" />
          </div>

          <div class="input-group">
            <label class="mono text-xs">PFP / GEN-ART URL (SVG/PNG)</label>
            <input type="text" id="artUrl" class="builder-input" placeholder="https://..." />
          </div>

          <div class="input-group">
            <label class="mono text-xs">STRUDEL BIO-CODE (AUDIO DNA)</label>
            <textarea id="strudelCode" class="builder-textarea mono">{defaultCode}</textarea>
          </div>

          <div class="builder-actions">
            <button id="previewBtn" class="btn-retro-neon w-full mb-2">RUN SIMULATION</button>
            <button id="hushBtn" class="btn-retro w-full">STOP AUDIO</button>
          </div>
        </section>

        <section class="preview-panel">
          <h2 class="mono text-center mb-4">LIVE PREVIEW</h2>
          
          <article id="previewCard" class="nft-card card-retro-neon" style="--rarity-color: #00ff88; --rarity-glow: 0 0 15px #00ff88;">
            <div class="card-header">
              <div class="card-number mono">#TMP-001</div>
              <div class="card-rarity mono" id="previewRarity">PARTNER DRAFT</div>
            </div>

            <div class="card-preview">
               <div id="artDisplay" class="art-placeholder">
                  <span class="blink">WAITING FOR ASSETS...</span>
               </div>
            </div>

            <div class="card-info">
              <h3 id="previewTitle" class="card-name mono">Untitled Token</h3>
              <div class="code-box-preview mono">
                <code id="codeDisplay">{defaultCode}</code>
              </div>
            </div>
          </article>

          <div class="export-zone mt-6">
            <button id="exportBtn" class="btn-retro w-full">GENERATE WHITE-LABEL JSON</button>
          </div>
        </section>
      </div>

    </div>
  </div>
</BaseLayout>

<script src="https://unpkg.com/@strudel/web@1.0.3"></script>

<script is:inline>
  // Ensure Strudel loads correctly for WB1
  let strudelInitialized = false;

  function initBuilder() {
    if (typeof initStrudel === 'undefined') {
      setTimeout(initBuilder, 100);
      return;
    }
    initStrudel();
    strudelInitialized = true;
    console.log("WB1 Token Builder Engine Ready.");
  }

  // UI Elements
  const codeInput = document.getElementById('strudelCode');
  const previewBtn = document.getElementById('previewBtn');
  const hushBtn = document.getElementById('hushBtn');
  const artInput = document.getElementById('artUrl');
  const titleInput = document.getElementById('seriesName');

  // Preview Elements
  const artDisplay = document.getElementById('artDisplay');
  const previewTitle = document.getElementById('previewTitle');
  const codeDisplay = document.getElementById('codeDisplay');

  // Real-time UI Sync
  titleInput.addEventListener('input', (e) => {
    previewTitle.innerText = e.target.value || "Untitled Token";
  });

  artInput.addEventListener('input', (e) => {
    if (e.target.value) {
      artDisplay.innerHTML = `<img src="${e.target.value}" style="width:100%; height:100%; object-fit:cover;" />`;
    }
  });

  // Execute Logic
  previewBtn.addEventListener('click', () => {
    const code = codeInput.value;
    codeDisplay.innerText = code;
    
    try {
      hush();
      eval(code + '.play()');
      previewBtn.classList.add('playing-neon');
    } catch (err) {
      alert("DNA CODE ERROR: " + err.message);
    }
  });

  hushBtn.addEventListener('click', () => {
    hush();
    previewBtn.classList.remove('playing-neon');
  });

  window.onload = initBuilder;
</script>

<style>
  .builder-grid {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 3rem;
    padding: 2rem 0;
  }

  @media (max-width: 900px) {
    .builder-grid { grid-template-columns: 1fr; }
  }

  .console-panel {
    background: #0a0a0a;
    padding: 2rem;
    border: 1px solid #333;
  }

  .input-group { margin-bottom: 1.5rem; }

  .builder-input, .builder-textarea {
    width: 100%;
    background: #000;
    border: 1px solid #444;
    color: #00ff88;
    padding: 10px;
    margin-top: 5px;
  }

  .builder-textarea {
    height: 150px;
    resize: vertical;
    font-family: monospace;
  }

  .art-placeholder {
    height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #111;
    color: #444;
    font-family: monospace;
    border: 1px dashed #333;
  }

  .code-box-preview {
    background: #000;
    padding: 10px;
    font-size: 0.7rem;
    color: #888;
    margin-top: 10px;
    border-left: 2px solid var(--rarity-color);
    overflow: hidden;
  }

  .playing-neon {
    background: #00ff88 !important;
    color: #000 !important;
    box-shadow: 0 0 20px #00ff88;
  }

  .w-full { width: 100%; }
</style>
