---
/**
 * rapper-template-builder-v2.astro
 * ENHANCED: SVG Template Builder with Game Theory & Generative Calibration
 *
 * NEW Features:
 * - Game theory: Rarity system, stats, power levels
 * - NO skin tone picker (auto-generated for diversity)
 * - Expanded animal spirits (20+ animals across 5 categories)
 * - Generative calibrator with real-time rarity calculation
 * - Live stats display showing character attributes
 * - Trait combination scoring
 */
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout
  title="Rapper Card Builder"
  description="Create custom geodesic rapper PFP cards with game theory mechanics"
  activeSection="gallery"
>

<div class="builder-page scanlines">
  <div class="container mx-auto">

    <!-- Header -->
    <header class="builder-header pixel-border arcade-screen">
      <div class="header-badge">
        <span class="neon-text blink">üé® CHARACTER FORGE v2.0 üé®</span>
      </div>
      <h1 class="builder-title glitch">
        <span class="block">RAPPER CARD</span>
        <span class="block neon-text">BUILDER</span>
      </h1>
      <p class="builder-subtitle mono">
        > CUSTOMIZE_CHARACTER()<br/>
        > CALCULATE_RARITY()<br/>
        > EXPORT_NFT()<br/>
        <span class="text-cyan blink">‚ñà</span>
      </p>
    </header>

    <!-- Main Workspace -->
    <div class="workspace">

      <!-- Left: Controls -->
      <aside class="controls-panel card-retro">
        <h2 class="panel-title mono neon-text">[ CONTROLS ]</h2>

        <!-- Gender -->
        <div class="control-section">
          <h3 class="section-label mono">GENDER:</h3>
          <div class="button-group">
            <button class="toggle-btn active" data-gender="male" onclick="setGender('male')">
              <span class="btn-icon">üë®</span>
              <span class="btn-label">MALE</span>
            </button>
            <button class="toggle-btn" data-gender="female" onclick="setGender('female')">
              <span class="btn-icon">üë©</span>
              <span class="btn-label">FEMALE</span>
            </button>
          </div>
        </div>

        <!-- Animal Spirit (EXPANDED) -->
        <div class="control-section">
          <h3 class="section-label mono">ANIMAL SPIRIT (22 Total):</h3>

          <details class="spirit-category" open>
            <summary class="category-header mono">üêì FARM (6)</summary>
            <div class="spirit-grid">
              <button class="spirit-btn active" data-animal="chicken" onclick="setAnimal('chicken')">
                üêì<span>Chicken</span>
              </button>
              <button class="spirit-btn" data-animal="cat" onclick="setAnimal('cat')">
                üê±<span>Cat</span>
              </button>
              <button class="spirit-btn" data-animal="goat" onclick="setAnimal('goat')">
                üêê<span>Goat</span>
              </button>
              <button class="spirit-btn" data-animal="dog" onclick="setAnimal('dog')">
                üêï<span>Dog</span>
              </button>
              <button class="spirit-btn" data-animal="bunny" onclick="setAnimal('bunny')">
                üê∞<span>Bunny</span>
              </button>
              <button class="spirit-btn" data-animal="horse" onclick="setAnimal('horse')">
                üê¥<span>Horse</span>
              </button>
            </div>
          </details>

          <details class="spirit-category">
            <summary class="category-header mono">ü¶Ö SKY (5)</summary>
            <div class="spirit-grid">
              <button class="spirit-btn" data-animal="pigeon" onclick="setAnimal('pigeon')">
                üïäÔ∏è<span>Pigeon</span>
              </button>
              <button class="spirit-btn" data-animal="cooperhawk" onclick="setAnimal('cooperhawk')">
                ü¶Ö<span>Hawk</span>
              </button>
              <button class="spirit-btn" data-animal="eagle" onclick="setAnimal('eagle')">
                ü¶Ö<span>Eagle</span>
              </button>
              <button class="spirit-btn" data-animal="owl" onclick="setAnimal('owl')">
                ü¶â<span>Owl</span>
              </button>
              <button class="spirit-btn" data-animal="crow" onclick="setAnimal('crow')">
                üê¶‚Äç‚¨õ<span>Crow</span>
              </button>
            </div>
          </details>

          <details class="spirit-category">
            <summary class="category-header mono">ü¶Å WILD (5)</summary>
            <div class="spirit-grid">
              <button class="spirit-btn" data-animal="lion" onclick="setAnimal('lion')">
                ü¶Å<span>Lion</span>
              </button>
              <button class="spirit-btn" data-animal="coywolf" onclick="setAnimal('coywolf')">
                üê∫<span>Coywolf</span>
              </button>
              <button class="spirit-btn" data-animal="bear" onclick="setAnimal('bear')">
                üêª<span>Bear</span>
              </button>
              <button class="spirit-btn" data-animal="panther" onclick="setAnimal('panther')">
                üêÜ<span>Panther</span>
              </button>
              <button class="spirit-btn" data-animal="fox" onclick="setAnimal('fox')">
                ü¶ä<span>Fox</span>
              </button>
            </div>
          </details>

          <details class="spirit-category">
            <summary class="category-header mono">üêç REPTILE (3)</summary>
            <div class="spirit-grid">
              <button class="spirit-btn" data-animal="snake" onclick="setAnimal('snake')">
                üêç<span>Snake</span>
              </button>
              <button class="spirit-btn" data-animal="lizard" onclick="setAnimal('lizard')">
                ü¶é<span>Lizard</span>
              </button>
              <button class="spirit-btn" data-animal="turtle" onclick="setAnimal('turtle')">
                üê¢<span>Turtle</span>
              </button>
            </div>
          </details>

          <details class="spirit-category">
            <summary class="category-header mono">ü¶ã INSECT (3)</summary>
            <div class="spirit-grid">
              <button class="spirit-btn" data-animal="butterfly" onclick="setAnimal('butterfly')">
                ü¶ã<span>Butterfly</span>
              </button>
              <button class="spirit-btn" data-animal="bee" onclick="setAnimal('bee')">
                üêù<span>Bee</span>
              </button>
              <button class="spirit-btn" data-animal="mantis" onclick="setAnimal('mantis')">
                ü¶ó<span>Mantis</span>
              </button>
            </div>
          </details>
        </div>

        <!-- Hairstyle -->
        <div class="control-section">
          <h3 class="section-label mono">HAIRSTYLE:</h3>
          <select id="hairstyle" class="control-select mono" onchange="updatePreview()">
            <option value="dreads">Dreadlocks</option>
            <option value="fade">Fade Cut</option>
            <option value="afro">Afro</option>
            <option value="braids">Braids</option>
            <option value="bun">Top Bun</option>
            <option value="waves">Waves</option>
            <option value="mohawk">Mohawk</option>
            <option value="cornrows">Cornrows</option>
          </select>
        </div>

        <!-- Accessories -->
        <div class="control-section">
          <h3 class="section-label mono">ACCESSORIES:</h3>
          <label class="checkbox-label mono">
            <input type="checkbox" id="sunglasses" checked onchange="updatePreview()">
            <span class="checkbox-custom"></span>
            <span>üòé Sunglasses</span>
          </label>
          <label class="checkbox-label mono">
            <input type="checkbox" id="chain" checked onchange="updatePreview()">
            <span class="checkbox-custom"></span>
            <span>üìø Gold Chain</span>
          </label>
          <label class="checkbox-label mono">
            <input type="checkbox" id="earrings" checked onchange="updatePreview()">
            <span class="checkbox-custom"></span>
            <span>üíé Earrings</span>
          </label>
          <label class="checkbox-label mono">
            <input type="checkbox" id="hat" onchange="updatePreview()">
            <span class="checkbox-custom"></span>
            <span>üß¢ Hat</span>
          </label>
        </div>

        <!-- Actions -->
        <div class="control-section">
          <button class="btn-action btn-retro mono" onclick="randomize()">
            <span class="btn-icon">üé≤</span>
            <span>RANDOM</span>
          </button>
          <button class="btn-action btn-retro-neon mono" onclick="exportSVG()">
            <span class="btn-icon">üíæ</span>
            <span>EXPORT NFT</span>
          </button>
        </div>
      </aside>

      <!-- Center: Preview + Stats -->
      <main class="preview-panel card-retro-neon">
        <h2 class="panel-title mono neon-text">[ PREVIEW ]</h2>
        <div id="svgPreview" class="svg-preview">
          <!-- SVG injected here -->
        </div>

        <!-- Character Info -->
        <div class="preview-info mono">
          <div class="info-row">
            <span class="info-label">Spirit:</span>
            <span class="info-value text-neon" id="infoAnimal">Chicken</span>
          </div>
          <div class="info-row">
            <span class="info-label">Gender:</span>
            <span class="info-value" id="infoGender">Male</span>
          </div>
          <div class="info-row">
            <span class="info-label">Style:</span>
            <span class="info-value" id="infoHair">Dreadlocks</span>
          </div>
        </div>

        <!-- GAME THEORY STATS DISPLAY -->
        <div class="stats-panel card-retro mono">
          <h3 class="stats-title mono">
            <span class="text-neon">‚ö° CHARACTER STATS ‚ö°</span>
          </h3>

          <!-- Rarity Badge -->
          <div class="rarity-display">
            <div class="rarity-badge" id="rarityBadge">
              <span class="rarity-tier">COMMON</span>
              <span class="rarity-score">Rarity: 0%</span>
            </div>
            <div class="power-level" id="powerLevel">
              POWER LVL: 0
            </div>
          </div>

          <!-- Stat Bars -->
          <div class="stat-bars">
            <div class="stat-row">
              <span class="stat-name">FLOW:</span>
              <div class="stat-bar">
                <div class="stat-fill" id="statFlow" style="width: 50%"></div>
              </div>
              <span class="stat-value" id="statFlowVal">50</span>
            </div>
            <div class="stat-row">
              <span class="stat-name">BARS:</span>
              <div class="stat-bar">
                <div class="stat-fill" id="statBars" style="width: 50%"></div>
              </div>
              <span class="stat-value" id="statBarsVal">50</span>
            </div>
            <div class="stat-row">
              <span class="stat-name">VIBES:</span>
              <div class="stat-bar">
                <div class="stat-fill" id="statVibes" style="width: 50%"></div>
              </div>
              <span class="stat-value" id="statVibesVal">50</span>
            </div>
            <div class="stat-row">
              <span class="stat-name">DRIP:</span>
              <div class="stat-bar">
                <div class="stat-fill" id="statDrip" style="width: 50%"></div>
              </div>
              <span class="stat-value" id="statDripVal">50</span>
            </div>
            <div class="stat-row">
              <span class="stat-name">AURA:</span>
              <div class="stat-bar">
                <div class="stat-fill" id="statAura" style="width: 50%"></div>
              </div>
              <span class="stat-value" id="statAuraVal">50</span>
            </div>
          </div>

          <!-- Trait Bonuses -->
          <div class="trait-bonuses">
            <h4 class="trait-title">ACTIVE BONUSES:</h4>
            <div id="activeBonuses" class="bonus-list">
              <!-- Bonuses injected here -->
            </div>
          </div>
        </div>
      </main>

      <!-- Right: Generative Calibrator -->
      <aside class="calibrator-panel card-retro ska-pattern">
        <h2 class="panel-title mono neon-text">[ CALIBRATOR ]</h2>

        <!-- Calibration Metrics -->
        <div class="calibration-section">
          <h3 class="calibration-title mono">üéØ RARITY BREAKDOWN</h3>
          <div class="calibration-meters">
            <div class="meter-row">
              <span class="meter-label">Base Traits:</span>
              <div class="meter-bar">
                <div class="meter-fill" id="meterBase" style="width: 0%"></div>
              </div>
              <span class="meter-percent" id="meterBaseVal">0%</span>
            </div>
            <div class="meter-row">
              <span class="meter-label">Accessories:</span>
              <div class="meter-bar">
                <div class="meter-fill" id="meterAcc" style="width: 0%"></div>
              </div>
              <span class="meter-percent" id="meterAccVal">0%</span>
            </div>
            <div class="meter-row">
              <span class="meter-label">Combo Bonus:</span>
              <div class="meter-bar">
                <div class="meter-fill" id="meterCombo" style="width: 0%"></div>
              </div>
              <span class="meter-percent" id="meterComboVal">0%</span>
            </div>
          </div>

          <!-- Rarity Distribution -->
          <div class="rarity-distribution">
            <h4 class="distribution-title">RARITY CHANCE:</h4>
            <div class="distribution-grid">
              <div class="rarity-item rarity-common">
                <span class="rarity-name">COMMON</span>
                <span class="rarity-chance" id="chanceCommon">60%</span>
              </div>
              <div class="rarity-item rarity-uncommon">
                <span class="rarity-name">UNCOMMON</span>
                <span class="rarity-chance" id="chanceUncommon">25%</span>
              </div>
              <div class="rarity-item rarity-rare">
                <span class="rarity-name">RARE</span>
                <span class="rarity-chance" id="chanceRare">10%</span>
              </div>
              <div class="rarity-item rarity-epic">
                <span class="rarity-name">EPIC</span>
                <span class="rarity-chance" id="chanceEpic">4%</span>
              </div>
              <div class="rarity-item rarity-legendary">
                <span class="rarity-name">LEGENDARY</span>
                <span class="rarity-chance" id="chanceLegendary">1%</span>
              </div>
            </div>
          </div>

          <!-- Generation Tips -->
          <div class="generation-tips">
            <h4 class="tips-heading">üí° BOOST RARITY:</h4>
            <ul class="tips-list mono">
              <li id="tip1">‚Üí Try rare animal spirits</li>
              <li id="tip2">‚Üí Stack multiple accessories</li>
              <li id="tip3">‚Üí Unique hairstyle combos</li>
            </ul>
          </div>
        </div>

        <!-- Preset Gallery -->
        <div class="presets-section">
          <h3 class="presets-heading mono">SAVED BUILDS:</h3>
          <div class="presets-grid" id="presetsGrid">
            <!-- Presets loaded here -->
          </div>
          <button class="btn-action btn-retro mono" onclick="savePreset()">
            <span class="btn-icon">üíæ</span>
            <span>SAVE BUILD</span>
          </button>
        </div>
      </aside>

    </div>

    <!-- Tips -->
    <section class="tips-section card-retro-neon">
      <h3 class="tips-title mono">üí° FEATURES v2.0:</h3>
      <ul class="tips-list mono">
        <li>‚Üí <strong>Game Theory:</strong> Each character has unique stats and rarity tiers</li>
        <li>‚Üí <strong>22 Animal Spirits:</strong> 5 categories (Farm, Sky, Wild, Reptile, Insect)</li>
        <li>‚Üí <strong>Generative Calibrator:</strong> Real-time rarity calculation and combo bonuses</li>
        <li>‚Üí <strong>No Skin Tone Picker:</strong> Auto-generated for diversity and inclusivity</li>
        <li>‚Üí <strong>Power Levels:</strong> Combined stat score determines character strength</li>
        <li>‚Üí <strong>Export as NFT:</strong> High-quality SVG ready for minting</li>
      </ul>
    </section>

    <!-- Nav -->
    <nav class="builder-nav">
      <a href="/nft-gallery" class="btn-retro">‚Üê NFT GALLERY</a>
      <a href="/rapper-template-builder" class="btn-retro">CLASSIC BUILDER</a>
      <a href="/" class="btn-retro">HOME ‚Üí</a>
    </nav>

  </div>
</div>

<script>
  // Current configuration
  let config = {
    gender: 'male',
    animal: 'chicken',
    hairstyle: 'dreads',
    skinTone: '#8d5524', // Auto-generated, not user-controlled
    accessories: {
      sunglasses: true,
      chain: true,
      earrings: true,
      hat: false
    }
  };

  // GAME THEORY DATA
  const ANIMAL_RARITY = {
    // Farm (Common-Uncommon)
    chicken: { rarity: 1, category: 'farm', flow: 40, bars: 50, vibes: 70, drip: 30, aura: 40 },
    cat: { rarity: 2, category: 'farm', flow: 60, bars: 55, vibes: 65, drip: 50, aura: 60 },
    goat: { rarity: 2, category: 'farm', flow: 55, bars: 60, vibes: 60, drip: 45, aura: 55 },
    dog: { rarity: 1, category: 'farm', flow: 50, bars: 45, vibes: 80, drip: 40, aura: 50 },
    bunny: { rarity: 2, category: 'farm', flow: 65, bars: 40, vibes: 75, drip: 60, aura: 55 },
    horse: { rarity: 3, category: 'farm', flow: 70, bars: 65, vibes: 60, drip: 55, aura: 65 },

    // Sky (Uncommon-Rare)
    pigeon: { rarity: 2, category: 'sky', flow: 55, bars: 50, vibes: 70, drip: 45, aura: 60 },
    cooperhawk: { rarity: 4, category: 'sky', flow: 75, bars: 80, vibes: 65, drip: 70, aura: 75 },
    eagle: { rarity: 5, category: 'sky', flow: 85, bars: 85, vibes: 70, drip: 80, aura: 85 },
    owl: { rarity: 4, category: 'sky', flow: 70, bars: 75, vibes: 80, drip: 65, aura: 80 },
    crow: { rarity: 3, category: 'sky', flow: 65, bars: 70, vibes: 75, drip: 60, aura: 70 },

    // Wild (Rare-Epic)
    lion: { rarity: 5, category: 'wild', flow: 90, bars: 85, vibes: 75, drip: 85, aura: 90 },
    coywolf: { rarity: 4, category: 'wild', flow: 80, bars: 80, vibes: 70, drip: 75, aura: 80 },
    bear: { rarity: 5, category: 'wild', flow: 75, bars: 90, vibes: 65, drip: 70, aura: 85 },
    panther: { rarity: 6, category: 'wild', flow: 85, bars: 85, vibes: 80, drip: 90, aura: 90 },
    fox: { rarity: 4, category: 'wild', flow: 80, bars: 75, vibes: 85, drip: 80, aura: 75 },

    // Reptile (Rare)
    snake: { rarity: 4, category: 'reptile', flow: 85, bars: 70, vibes: 60, drip: 75, aura: 80 },
    lizard: { rarity: 3, category: 'reptile', flow: 70, bars: 65, vibes: 70, drip: 65, aura: 70 },
    turtle: { rarity: 3, category: 'reptile', flow: 60, bars: 80, vibes: 65, drip: 55, aura: 75 },

    // Insect (Epic-Legendary)
    butterfly: { rarity: 5, category: 'insect', flow: 95, bars: 70, vibes: 90, drip: 85, aura: 85 },
    bee: { rarity: 6, category: 'insect', flow: 85, bars: 85, vibes: 85, drip: 80, aura: 90 },
    mantis: { rarity: 7, category: 'insect', flow: 90, bars: 95, vibes: 75, drip: 90, aura: 95 }
  };

  const HAIRSTYLE_BONUS = {
    dreads: { drip: 15, aura: 10 },
    fade: { flow: 10, drip: 5 },
    afro: { vibes: 20, aura: 15 },
    braids: { drip: 12, bars: 8 },
    bun: { vibes: 10, aura: 12 },
    waves: { flow: 15, drip: 10 },
    mohawk: { bars: 15, aura: 20 },
    cornrows: { drip: 18, bars: 10 }
  };

  const ACCESSORY_BONUS = {
    sunglasses: { drip: 20, aura: 10 },
    chain: { drip: 25, vibes: 10 },
    earrings: { drip: 15, vibes: 15 },
    hat: { drip: 18, bars: 5 }
  };

  // Auto-generate diverse skin tones
  const SKIN_TONES = [
    '#3d2817', '#5c3d2e', '#8d5524', '#c68642', '#e0ac69', '#f1c27d',
    '#4a3528', '#6b4423', '#a0673b', '#d29b6e', '#f3d5b5'
  ];

  // Set gender (global)
  window.setGender = function(gender) {
    config.gender = gender;

    // Update button states
    document.querySelectorAll('[data-gender]').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.gender === gender);
    });

    updatePreview();
  }

  // Set animal spirit (global)
  window.setAnimal = function(animal) {
    config.animal = animal;

    // Update button states
    document.querySelectorAll('[data-animal]').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.animal === animal);
    });

    updatePreview();
  }

  // Update preview (main function - global)
  window.updatePreview = function() {
    config.hairstyle = document.getElementById('hairstyle').value;
    config.accessories = {
      sunglasses: document.getElementById('sunglasses').checked,
      chain: document.getElementById('chain').checked,
      earrings: document.getElementById('earrings').checked,
      hat: document.getElementById('hat').checked
    };

    // Generate and display SVG
    const svg = generateSVG(config);
    document.getElementById('svgPreview').innerHTML = svg;

    // Update info
    document.getElementById('infoAnimal').textContent = config.animal.charAt(0).toUpperCase() + config.animal.slice(1);
    document.getElementById('infoGender').textContent = config.gender.charAt(0).toUpperCase() + config.gender.slice(1);
    document.getElementById('infoHair').textContent = {
      'dreads': 'Dreadlocks',
      'fade': 'Fade Cut',
      'afro': 'Afro',
      'braids': 'Braids',
      'bun': 'Top Bun',
      'waves': 'Waves',
      'mohawk': 'Mohawk',
      'cornrows': 'Cornrows'
    }[config.hairstyle];

    // Calculate and display game theory stats
    updateGameTheoryStats();
    updateGenerativeCalibrator();
  }

  // Internal alias for updatePreview
  const updatePreview = window.updatePreview;

  // Calculate game theory stats
  function updateGameTheoryStats() {
    const animalData = ANIMAL_RARITY[config.animal];
    const hairBonus = HAIRSTYLE_BONUS[config.hairstyle];

    // Calculate base stats
    let stats = {
      flow: animalData.flow + (hairBonus.flow || 0),
      bars: animalData.bars + (hairBonus.bars || 0),
      vibes: animalData.vibes + (hairBonus.vibes || 0),
      drip: animalData.drip + (hairBonus.drip || 0),
      aura: animalData.aura + (hairBonus.aura || 0)
    };

    // Add accessory bonuses
    let activeBonuses = [];
    Object.keys(config.accessories).forEach(acc => {
      if (config.accessories[acc] && ACCESSORY_BONUS[acc]) {
        const bonus = ACCESSORY_BONUS[acc];
        Object.keys(bonus).forEach(stat => {
          stats[stat] = (stats[stat] || 0) + bonus[stat];
          activeBonuses.push(`+${bonus[stat]} ${stat.toUpperCase()} (${acc})`);
        });
      }
    });

    // Cap stats at 100
    Object.keys(stats).forEach(stat => {
      stats[stat] = Math.min(100, stats[stat]);
    });

    // Calculate power level (sum of all stats)
    const powerLevel = Math.floor(
      stats.flow + stats.bars + stats.vibes + stats.drip + stats.aura
    );

    // Calculate rarity tier
    const rarityScore = calculateRarityScore();
    const rarityTier = getRarityTier(rarityScore);

    // Update UI
    updateStatBars(stats);
    updateRarityDisplay(rarityTier, rarityScore, powerLevel);
    updateActiveBonuses(activeBonuses);
  }

  // Update stat bars
  function updateStatBars(stats) {
    ['flow', 'bars', 'vibes', 'drip', 'aura'].forEach(stat => {
      const value = stats[stat];
      const fillEl = document.getElementById(`stat${stat.charAt(0).toUpperCase() + stat.slice(1)}`);
      const valEl = document.getElementById(`stat${stat.charAt(0).toUpperCase() + stat.slice(1)}Val`);

      if (fillEl && valEl) {
        fillEl.style.width = `${value}%`;
        valEl.textContent = Math.floor(value);

        // Color based on value
        if (value >= 80) {
          fillEl.style.background = 'var(--color-neon-green)';
        } else if (value >= 60) {
          fillEl.style.background = '#00ffff';
        } else {
          fillEl.style.background = '#888';
        }
      }
    });
  }

  // Calculate rarity score
  function calculateRarityScore() {
    const animalData = ANIMAL_RARITY[config.animal];
    let score = animalData.rarity * 10; // Base: 10-70

    // Hairstyle rarity (some are rarer)
    const rareHairs = { mohawk: 15, cornrows: 12, afro: 10 };
    score += rareHairs[config.hairstyle] || 5;

    // Accessory count bonus
    const accCount = Object.values(config.accessories).filter(v => v).length;
    score += accCount * 5;

    // Combo bonuses
    if (config.accessories.sunglasses && config.accessories.chain) score += 8;
    if (config.accessories.earrings && config.accessories.hat) score += 10;
    if (accCount === 4) score += 15; // Full drip bonus

    return Math.min(100, score);
  }

  // Get rarity tier from score
  function getRarityTier(score) {
    if (score >= 85) return 'LEGENDARY';
    if (score >= 70) return 'EPIC';
    if (score >= 50) return 'RARE';
    if (score >= 30) return 'UNCOMMON';
    return 'COMMON';
  }

  // Update rarity display
  function updateRarityDisplay(tier, score, powerLevel) {
    const badge = document.getElementById('rarityBadge');
    const powerEl = document.getElementById('powerLevel');

    if (badge) {
      badge.querySelector('.rarity-tier').textContent = tier;
      badge.querySelector('.rarity-score').textContent = `Rarity: ${score}%`;

      // Update badge class
      badge.className = 'rarity-badge rarity-' + tier.toLowerCase();
    }

    if (powerEl) {
      powerEl.textContent = `POWER LVL: ${powerLevel}`;
      powerEl.className = 'power-level power-' + tier.toLowerCase();
    }
  }

  // Update active bonuses list
  function updateActiveBonuses(bonuses) {
    const bonusEl = document.getElementById('activeBonuses');
    if (!bonusEl) return;

    if (bonuses.length === 0) {
      bonusEl.innerHTML = '<div class="bonus-item">No active bonuses</div>';
    } else {
      bonusEl.innerHTML = bonuses.map(b =>
        `<div class="bonus-item text-cyan">‚Üí ${b}</div>`
      ).join('');
    }
  }

  // Update generative calibrator
  function updateGenerativeCalibrator() {
    const animalData = ANIMAL_RARITY[config.animal];
    const baseScore = animalData.rarity * 5;
    const accCount = Object.values(config.accessories).filter(v => v).length;
    const accScore = accCount * 8;
    const comboScore = calculateComboBonus();

    // Update meters
    updateMeter('meterBase', baseScore);
    updateMeter('meterAcc', accScore);
    updateMeter('meterCombo', comboScore);

    // Update rarity chances (simplified distribution)
    const totalScore = baseScore + accScore + comboScore;
    updateRarityChances(totalScore);

    // Update tips
    updateCalibrationTips();
  }

  // Update meter
  function updateMeter(id, value) {
    const fillEl = document.getElementById(id);
    const valEl = document.getElementById(id + 'Val');
    if (fillEl && valEl) {
      fillEl.style.width = `${Math.min(100, value)}%`;
      valEl.textContent = `${Math.floor(value)}%`;
    }
  }

  // Calculate combo bonus
  function calculateComboBonus() {
    let bonus = 0;
    const { sunglasses, chain, earrings, hat } = config.accessories;

    if (sunglasses && chain) bonus += 10;
    if (earrings && hat) bonus += 12;
    if (sunglasses && earrings && chain) bonus += 15;

    const accCount = Object.values(config.accessories).filter(v => v).length;
    if (accCount === 4) bonus += 20;

    return bonus;
  }

  // Update rarity chances
  function updateRarityChances(score) {
    // Simplified probability model
    const chances = {
      common: Math.max(5, 60 - score),
      uncommon: Math.min(35, 25 + (score * 0.3)),
      rare: Math.min(25, 10 + (score * 0.25)),
      epic: Math.min(15, 4 + (score * 0.15)),
      legendary: Math.min(10, 1 + (score * 0.1))
    };

    // Normalize to 100%
    const total = Object.values(chances).reduce((a, b) => a + b, 0);
    Object.keys(chances).forEach(key => {
      chances[key] = Math.floor((chances[key] / total) * 100);
    });

    // Update UI
    document.getElementById('chanceCommon').textContent = `${chances.common}%`;
    document.getElementById('chanceUncommon').textContent = `${chances.uncommon}%`;
    document.getElementById('chanceRare').textContent = `${chances.rare}%`;
    document.getElementById('chanceEpic').textContent = `${chances.epic}%`;
    document.getElementById('chanceLegendary').textContent = `${chances.legendary}%`;
  }

  // Update calibration tips
  function updateCalibrationTips() {
    const tips = [];
    const animalData = ANIMAL_RARITY[config.animal];
    const accCount = Object.values(config.accessories).filter(v => v).length;

    if (animalData.rarity < 5) {
      tips.push('‚Üí Try Epic/Legendary animals');
    } else {
      tips.push('‚Üí Great animal choice! üî•');
    }

    if (accCount < 3) {
      tips.push('‚Üí Add more accessories');
    } else if (accCount === 4) {
      tips.push('‚Üí Full drip! Max bonus! üíé');
    } else {
      tips.push('‚Üí One more accessory for max!');
    }

    const rareHairs = ['mohawk', 'cornrows', 'afro'];
    if (!rareHairs.includes(config.hairstyle)) {
      tips.push('‚Üí Mohawk/Cornrows boost rarity');
    } else {
      tips.push('‚Üí Rare hairstyle selected! ‚≠ê');
    }

    document.getElementById('tip1').textContent = tips[0] || '‚Üí Looking good!';
    document.getElementById('tip2').textContent = tips[1] || '‚Üí Keep experimenting';
    document.getElementById('tip3').textContent = tips[2] || '‚Üí Nice build!';
  }

  // Generate SVG (simplified - uses same structure as before)
  function generateSVG(cfg) {
    const skinColor = cfg.skinTone;
    const shadowColor = adjustBrightness(skinColor, -30);
    const highlightColor = adjustBrightness(skinColor, 20);

    return `
<svg viewBox="0 0 400 500" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="skinGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:${highlightColor}" />
      <stop offset="100%" style="stop-color:${skinColor}" />
    </linearGradient>
    <filter id="glow">
      <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
      <feMerge>
        <feMergeNode in="coloredBlur"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
  </defs>

  <!-- Background -->
  <rect width="400" height="500" fill="#0a0a0a"/>
  <rect width="400" height="500" fill="url(#skinGrad)" opacity="0.1"/>

  <!-- Face (geodesic polygon) -->
  <g transform="translate(200, 250)">
    ${cfg.gender === 'male' ? `
      <polygon points="0,-120 60,-100 80,-50 75,20 50,80 0,95 -50,80 -75,20 -80,-50 -60,-100"
               fill="url(#skinGrad)" stroke="${shadowColor}" stroke-width="3"/>
    ` : `
      <polygon points="0,-120 55,-105 70,-55 70,15 45,75 0,90 -45,75 -70,15 -70,-55 -55,-105"
               fill="url(#skinGrad)" stroke="${shadowColor}" stroke-width="3"/>
    `}

    <!-- Eyes -->
    <ellipse cx="-25" cy="-20" rx="8" ry="12" fill="white"/>
    <ellipse cx="25" cy="-20" rx="8" ry="12" fill="white"/>
    <circle cx="-25" cy="-20" r="5" fill="black"/>
    <circle cx="25" cy="-20" r="5" fill="black"/>

    <!-- Nose -->
    <polygon points="-5,0 5,0 3,20 -3,20" fill="${shadowColor}" opacity="0.6"/>

    <!-- Mouth -->
    <path d="M -20,40 Q 0,50 20,40" stroke="${shadowColor}" stroke-width="3" fill="none" stroke-linecap="round"/>

    <!-- Hair (simplified) -->
    ${getHairSVG(cfg.hairstyle, cfg.gender)}

    <!-- Accessories -->
    ${cfg.accessories.sunglasses ? `
      <rect x="-40" y="-30" width="30" height="15" fill="black" opacity="0.8" rx="3"/>
      <rect x="10" y="-30" width="30" height="15" fill="black" opacity="0.8" rx="3"/>
      <line x1="-10" y1="-22" x2="10" y2="-22" stroke="black" stroke-width="2"/>
    ` : ''}

    ${cfg.accessories.chain ? `
      <g transform="translate(0, 95)">
        <circle cx="-15" cy="10" r="4" fill="gold"/>
        <circle cx="0" cy="15" r="5" fill="gold"/>
        <circle cx="15" cy="10" r="4" fill="gold"/>
        <path d="M -15,10 L 0,15 L 15,10" stroke="gold" stroke-width="2" fill="none"/>
      </g>
    ` : ''}

    ${cfg.accessories.earrings ? `
      <circle cx="-70" cy="0" r="5" fill="#00ffff" filter="url(#glow)"/>
      <circle cx="70" cy="0" r="5" fill="#00ffff" filter="url(#glow)"/>
    ` : ''}

    ${cfg.accessories.hat ? `
      <g transform="translate(0, -120)">
        <ellipse cx="0" cy="0" rx="65" ry="15" fill="#333"/>
        <rect x="-40" y="-40" width="80" height="40" fill="#444" rx="5"/>
      </g>
    ` : ''}
  </g>

  <!-- Animal Spirit Indicator -->
  <text x="200" y="480" font-family="monospace" font-size="24" fill="#00ff00" text-anchor="middle" filter="url(#glow)">
    ${getAnimalEmoji(cfg.animal)} ${cfg.animal.toUpperCase()}
  </text>
</svg>
    `.trim();
  }

  // Get hair SVG
  function getHairSVG(style, gender) {
    const hairStyles = {
      'dreads': `<g fill="#1a1a1a">
        <rect x="-50" y="-130" width="12" height="60" rx="6"/>
        <rect x="-30" y="-135" width="12" height="65" rx="6"/>
        <rect x="-10" y="-135" width="12" height="65" rx="6"/>
        <rect x="10" y="-135" width="12" height="65" rx="6"/>
        <rect x="30" y="-130" width="12" height="60" rx="6"/>
      </g>`,
      'fade': `<ellipse cx="0" cy="-100" rx="70" ry="40" fill="#1a1a1a"/>`,
      'afro': `<circle cx="0" cy="-80" r="70" fill="#1a1a1a"/>`,
      'braids': `<g fill="#1a1a1a">
        <path d="M -60,-120 L -55,-80" stroke="#1a1a1a" stroke-width="8"/>
        <path d="M -40,-125 L -35,-85" stroke="#1a1a1a" stroke-width="8"/>
        <path d="M -20,-125 L -15,-85" stroke="#1a1a1a" stroke-width="8"/>
        <path d="M 0,-125 L 0,-85" stroke="#1a1a1a" stroke-width="8"/>
        <path d="M 20,-125 L 15,-85" stroke="#1a1a1a" stroke-width="8"/>
        <path d="M 40,-125 L 35,-85" stroke="#1a1a1a" stroke-width="8"/>
        <path d="M 60,-120 L 55,-80" stroke="#1a1a1a" stroke-width="8"/>
      </g>`,
      'bun': `<g>
        <ellipse cx="0" cy="-100" rx="70" ry="35" fill="#1a1a1a"/>
        <circle cx="0" cy="-140" r="30" fill="#1a1a1a"/>
      </g>`,
      'waves': `<ellipse cx="0" cy="-95" rx="75" ry="45" fill="#1a1a1a"/>`,
      'mohawk': `<g fill="#1a1a1a">
        <rect x="-8" y="-150" width="16" height="80" rx="8"/>
        <polygon points="0,-150 15,-140 0,-130 -15,-140" fill="#ff0000" opacity="0.3"/>
      </g>`,
      'cornrows': `<g fill="#1a1a1a">
        ${Array.from({length: 6}, (_, i) => {
          const x = -40 + (i * 16);
          return `<path d="M ${x},-120 Q ${x},-80 ${x},-40" stroke="#1a1a1a" stroke-width="6" fill="none"/>`;
        }).join('')}
      </g>`
    };
    return hairStyles[style] || hairStyles['dreads'];
  }

  // Get animal emoji
  function getAnimalEmoji(animal) {
    const emojis = {
      'chicken': 'üêì', 'cat': 'üê±', 'goat': 'üêê', 'dog': 'üêï', 'bunny': 'üê∞', 'horse': 'üê¥',
      'pigeon': 'üïäÔ∏è', 'cooperhawk': 'ü¶Ö', 'eagle': 'ü¶Ö', 'owl': 'ü¶â', 'crow': 'üê¶‚Äç‚¨õ',
      'lion': 'ü¶Å', 'coywolf': 'üê∫', 'bear': 'üêª', 'panther': 'üêÜ', 'fox': 'ü¶ä',
      'snake': 'üêç', 'lizard': 'ü¶é', 'turtle': 'üê¢',
      'butterfly': 'ü¶ã', 'bee': 'üêù', 'mantis': 'ü¶ó'
    };
    return emojis[animal] || 'üêì';
  }

  // Adjust brightness
  function adjustBrightness(hex, percent) {
    const num = parseInt(hex.replace('#', ''), 16);
    const amt = Math.round(2.55 * percent);
    const R = Math.min(255, Math.max(0, (num >> 16) + amt));
    const G = Math.min(255, Math.max(0, (num >> 8 & 0x00FF) + amt));
    const B = Math.min(255, Math.max(0, (num & 0x0000FF) + amt));
    return `#${(0x1000000 + (R << 16) + (G << 8) + B).toString(16).slice(1)}`;
  }

  // Randomize (global)
  window.randomize = function() {
    const animals = Object.keys(ANIMAL_RARITY);
    const hairstyles = ['dreads', 'fade', 'afro', 'braids', 'bun', 'waves', 'mohawk', 'cornrows'];

    window.setGender(Math.random() > 0.5 ? 'male' : 'female');
    window.setAnimal(animals[Math.floor(Math.random() * animals.length)]);
    document.getElementById('hairstyle').value = hairstyles[Math.floor(Math.random() * hairstyles.length)];

    // Auto-generate skin tone
    config.skinTone = SKIN_TONES[Math.floor(Math.random() * SKIN_TONES.length)];

    document.getElementById('sunglasses').checked = Math.random() > 0.5;
    document.getElementById('chain').checked = Math.random() > 0.5;
    document.getElementById('earrings').checked = Math.random() > 0.5;
    document.getElementById('hat').checked = Math.random() > 0.3;

    updatePreview();
  }

  // Export SVG (global)
  window.exportSVG = function() {
    const svg = document.getElementById('svgPreview').innerHTML;
    const rarityScore = calculateRarityScore();
    const rarityTier = getRarityTier(rarityScore);

    const blob = new Blob([svg], { type: 'image/svg+xml' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `rapper-nft-${rarityTier}-${config.animal}-${config.gender}-${Date.now()}.svg`;
    a.click();
    URL.revokeObjectURL(url);
  }

  // Save preset (global)
  window.savePreset = function() {
    const presets = JSON.parse(localStorage.getItem('rapperPresets') || '[]');
    const rarityScore = calculateRarityScore();
    const rarityTier = getRarityTier(rarityScore);

    presets.push({
      ...config,
      timestamp: Date.now(),
      rarity: rarityTier,
      score: rarityScore
    });
    localStorage.setItem('rapperPresets', JSON.stringify(presets.slice(-10))); // Keep last 10
    loadPresets();
  }

  // Load presets
  function loadPresets() {
    const presets = JSON.parse(localStorage.getItem('rapperPresets') || '[]');
    const grid = document.getElementById('presetsGrid');
    grid.innerHTML = presets.slice(-6).map((preset, i) => `
      <div class="preset-card rarity-${preset.rarity.toLowerCase()}" onclick='applyPreset(${JSON.stringify(preset)})'>
        <div class="preset-preview">${getAnimalEmoji(preset.animal)}</div>
        <div class="preset-label mono">${preset.rarity}</div>
        <div class="preset-score mono">${preset.score}%</div>
      </div>
    `).join('');
  }

  // Apply preset
  window.applyPreset = function(preset) {
    config = { ...preset };
    setGender(preset.gender);
    setAnimal(preset.animal);
    document.getElementById('hairstyle').value = preset.hairstyle;
    document.getElementById('sunglasses').checked = preset.accessories.sunglasses;
    document.getElementById('chain').checked = preset.accessories.chain;
    document.getElementById('earrings').checked = preset.accessories.earrings;
    document.getElementById('hat').checked = preset.accessories.hat;
    updatePreview();
  };

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    // Set random skin tone on load for diversity
    config.skinTone = SKIN_TONES[Math.floor(Math.random() * SKIN_TONES.length)];

    updatePreview();
    loadPresets();
  });
</script>

<style>
  .builder-page {
    min-height: 100vh;
    background: var(--color-black);
    padding: 3rem 2rem;
  }

  /* Header */
  .builder-header {
    text-align: center;
    padding: 3rem 2rem;
    margin-bottom: 3rem;
    background: var(--color-near-black);
  }

  .header-badge {
    margin-bottom: 1.5rem;
    font-size: 1.5rem;
  }

  .builder-title {
    font-size: 3.5rem;
    font-weight: 900;
    margin-bottom: 1.5rem;
    font-family: var(--font-mono);
    letter-spacing: 4px;
    line-height: 1.1;
  }

  .builder-subtitle {
    font-size: 1.25rem;
    line-height: 2;
  }

  /* Workspace */
  .workspace {
    display: grid;
    grid-template-columns: 300px 1fr 300px;
    gap: 2rem;
    margin-bottom: 3rem;
  }

  .panel-title {
    font-size: 1.25rem;
    font-weight: 900;
    margin-bottom: 2rem;
    text-align: center;
    letter-spacing: 2px;
  }

  /* Controls */
  .controls-panel {
    padding: 2rem;
    max-height: 90vh;
    overflow-y: auto;
  }

  .control-section {
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 2px solid var(--color-dark-gray);
  }

  .control-section:last-child {
    border-bottom: none;
  }

  .section-label {
    font-size: 0.875rem;
    font-weight: 700;
    margin-bottom: 1rem;
    color: var(--color-white);
    letter-spacing: 1px;
  }

  /* Button Groups */
  .button-group {
    display: flex;
    gap: 0.5rem;
  }

  .toggle-btn {
    flex: 1;
    padding: 0.75rem;
    background: var(--color-dark-gray);
    color: var(--color-white);
    border: 2px solid var(--color-white);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    font-family: var(--font-mono);
    font-size: 0.75rem;
    font-weight: 700;
  }

  .toggle-btn .btn-icon {
    font-size: 1.5rem;
  }

  .toggle-btn:hover {
    background: var(--color-gray);
    transform: translateY(-2px);
  }

  .toggle-btn.active {
    background: var(--color-neon-green);
    color: var(--color-black);
    box-shadow: 0 0 20px var(--color-neon-green-glow);
  }

  /* Spirit Categories */
  .spirit-category {
    margin-bottom: 1rem;
  }

  .category-header {
    padding: 0.75rem;
    background: var(--color-dark-gray);
    border: 2px solid var(--color-white);
    cursor: pointer;
    font-weight: 700;
    list-style: none;
  }

  .category-header:hover {
    background: var(--color-gray);
  }

  .spirit-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
    padding: 1rem 0.5rem;
  }

  .spirit-btn {
    padding: 0.75rem 0.5rem;
    background: var(--color-dark-gray);
    color: var(--color-white);
    border: 2px solid var(--color-white);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 1.25rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
  }

  .spirit-btn span {
    font-size: 0.75rem;
    font-family: var(--font-mono);
  }

  .spirit-btn:hover {
    transform: scale(1.05);
    background: var(--color-gray);
  }

  .spirit-btn.active {
    background: var(--color-neon-green);
    color: var(--color-black);
    box-shadow: 0 0 15px var(--color-neon-green-glow);
  }

  /* Select */
  .control-select {
    width: 100%;
    padding: 0.75rem;
    background: var(--color-black);
    color: var(--color-white);
    border: 2px solid var(--color-white);
    font-family: var(--font-mono);
    cursor: pointer;
  }

  .control-select:focus {
    outline: none;
    border-color: var(--color-neon-green);
    box-shadow: 0 0 10px var(--color-neon-green-glow);
  }

  /* Checkboxes */
  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0;
    cursor: pointer;
    user-select: none;
  }

  .checkbox-label input[type="checkbox"] {
    display: none;
  }

  .checkbox-custom {
    width: 20px;
    height: 20px;
    border: 2px solid var(--color-white);
    background: var(--color-black);
    position: relative;
    flex-shrink: 0;
  }

  .checkbox-label input:checked + .checkbox-custom {
    background: var(--color-neon-green);
  }

  .checkbox-label input:checked + .checkbox-custom::after {
    content: '‚úì';
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-black);
    font-weight: 900;
  }

  /* Action Buttons */
  .btn-action {
    width: 100%;
    padding: 1rem;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    font-size: 1rem;
  }

  .btn-action .btn-icon {
    font-size: 1.25rem;
  }

  /* Preview */
  .preview-panel {
    padding: 2rem;
    display: flex;
    flex-direction: column;
  }

  .svg-preview {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-black);
    border: 2px solid var(--color-white);
    margin-bottom: 2rem;
    min-height: 400px;
  }

  .svg-preview svg {
    max-width: 100%;
    max-height: 100%;
  }

  .preview-info {
    padding: 1.5rem;
    background: var(--color-black);
    border: 2px solid var(--color-neon-green);
    margin-bottom: 2rem;
  }

  .info-row {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--color-dark-gray);
  }

  .info-row:last-child {
    border-bottom: none;
  }

  .info-label {
    color: var(--color-light-gray);
  }

  .info-value {
    font-weight: 700;
  }

  /* GAME THEORY STATS PANEL */
  .stats-panel {
    padding: 1.5rem;
    background: var(--color-near-black);
    border: 2px solid var(--color-cyan);
  }

  .stats-title {
    text-align: center;
    font-size: 1.125rem;
    margin-bottom: 1.5rem;
    letter-spacing: 2px;
  }

  .rarity-display {
    margin-bottom: 1.5rem;
  }

  .rarity-badge {
    text-align: center;
    padding: 1rem;
    border: 3px solid var(--color-white);
    margin-bottom: 0.75rem;
  }

  .rarity-tier {
    display: block;
    font-size: 1.25rem;
    font-weight: 900;
    letter-spacing: 2px;
    margin-bottom: 0.25rem;
  }

  .rarity-score {
    display: block;
    font-size: 0.875rem;
    color: var(--color-light-gray);
  }

  .rarity-badge.rarity-common { border-color: #888; }
  .rarity-badge.rarity-common .rarity-tier { color: #888; }

  .rarity-badge.rarity-uncommon { border-color: #4ade80; }
  .rarity-badge.rarity-uncommon .rarity-tier { color: #4ade80; }

  .rarity-badge.rarity-rare { border-color: #3b82f6; }
  .rarity-badge.rarity-rare .rarity-tier { color: #3b82f6; }

  .rarity-badge.rarity-epic { border-color: #a855f7; }
  .rarity-badge.rarity-epic .rarity-tier { color: #a855f7; }

  .rarity-badge.rarity-legendary { border-color: #fbbf24; }
  .rarity-badge.rarity-legendary .rarity-tier { color: #fbbf24; }

  .power-level {
    text-align: center;
    padding: 0.75rem;
    font-size: 1.125rem;
    font-weight: 900;
    background: var(--color-black);
    border: 2px solid var(--color-neon-green);
  }

  /* Stat Bars */
  .stat-bars {
    margin-bottom: 1.5rem;
  }

  .stat-row {
    display: grid;
    grid-template-columns: 60px 1fr 40px;
    gap: 0.75rem;
    align-items: center;
    margin-bottom: 0.75rem;
  }

  .stat-name {
    font-size: 0.875rem;
    font-weight: 700;
    color: var(--color-cyan);
  }

  .stat-bar {
    height: 20px;
    background: var(--color-dark-gray);
    border: 2px solid var(--color-white);
    position: relative;
    overflow: hidden;
  }

  .stat-fill {
    height: 100%;
    background: var(--color-neon-green);
    transition: width 0.5s ease;
  }

  .stat-value {
    font-size: 0.875rem;
    font-weight: 700;
    text-align: right;
  }

  /* Trait Bonuses */
  .trait-bonuses {
    padding-top: 1rem;
    border-top: 2px solid var(--color-dark-gray);
  }

  .trait-title {
    font-size: 0.875rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
    color: var(--color-cyan);
  }

  .bonus-list {
    font-size: 0.75rem;
  }

  .bonus-item {
    padding: 0.25rem 0;
  }

  /* GENERATIVE CALIBRATOR */
  .calibrator-panel {
    padding: 2rem;
    max-height: 90vh;
    overflow-y: auto;
  }

  .calibration-section {
    margin-bottom: 2rem;
  }

  .calibration-title {
    font-size: 1rem;
    font-weight: 900;
    margin-bottom: 1rem;
    color: var(--color-neon-green);
    text-align: center;
    letter-spacing: 1px;
  }

  .calibration-meters {
    margin-bottom: 1.5rem;
  }

  .meter-row {
    display: grid;
    grid-template-columns: 80px 1fr 45px;
    gap: 0.5rem;
    align-items: center;
    margin-bottom: 0.75rem;
  }

  .meter-label {
    font-size: 0.75rem;
    font-weight: 700;
  }

  .meter-bar {
    height: 16px;
    background: var(--color-dark-gray);
    border: 2px solid var(--color-white);
    position: relative;
    overflow: hidden;
  }

  .meter-fill {
    height: 100%;
    background: var(--color-cyan);
    transition: width 0.5s ease;
  }

  .meter-percent {
    font-size: 0.75rem;
    font-weight: 700;
    text-align: right;
  }

  /* Rarity Distribution */
  .rarity-distribution {
    margin-bottom: 1.5rem;
  }

  .distribution-title {
    font-size: 0.875rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
    text-align: center;
  }

  .distribution-grid {
    display: grid;
    gap: 0.5rem;
  }

  .rarity-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0.75rem;
    border: 2px solid var(--color-white);
  }

  .rarity-name {
    font-size: 0.75rem;
    font-weight: 700;
  }

  .rarity-chance {
    font-size: 0.75rem;
    font-weight: 900;
  }

  .rarity-item.rarity-common { border-color: #888; }
  .rarity-item.rarity-uncommon { border-color: #4ade80; }
  .rarity-item.rarity-rare { border-color: #3b82f6; }
  .rarity-item.rarity-epic { border-color: #a855f7; }
  .rarity-item.rarity-legendary { border-color: #fbbf24; }

  /* Generation Tips */
  .generation-tips {
    margin-bottom: 1.5rem;
  }

  .tips-heading {
    font-size: 0.875rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
    color: var(--color-cyan);
  }

  .tips-list {
    list-style: none;
    padding: 0;
    font-size: 0.75rem;
    line-height: 1.75;
  }

  /* Presets */
  .presets-section {
    padding-top: 1.5rem;
    border-top: 2px solid var(--color-dark-gray);
  }

  .presets-heading {
    font-size: 0.875rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
    text-align: center;
  }

  .presets-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .preset-card {
    aspect-ratio: 1;
    background: var(--color-black);
    border: 2px solid var(--color-white);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
  }

  .preset-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 0 15px var(--color-neon-green-glow);
  }

  .preset-preview {
    font-size: 2rem;
  }

  .preset-label {
    font-size: 0.625rem;
    font-weight: 700;
  }

  .preset-score {
    font-size: 0.625rem;
    color: var(--color-light-gray);
  }

  /* Tips Section */
  .tips-section {
    padding: 2rem;
    margin-bottom: 3rem;
  }

  .tips-title {
    font-size: 1.25rem;
    font-weight: 900;
    margin-bottom: 1.5rem;
    color: var(--color-neon-green);
  }

  .tips-list {
    list-style: none;
    padding: 0;
    line-height: 2;
  }

  .tips-list li {
    color: var(--color-off-white);
  }

  /* Navigation */
  .builder-nav {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  /* Mobile */
  @media (max-width: 1024px) {
    .workspace {
      grid-template-columns: 1fr;
    }

    .builder-title {
      font-size: 2rem;
    }
  }

  @media (max-width: 768px) {
    .button-group {
      flex-direction: column;
    }

    .spirit-grid {
      grid-template-columns: 1fr;
    }

    .presets-grid {
      grid-template-columns: repeat(3, 1fr);
    }

    .builder-nav {
      flex-direction: column;
    }

    .builder-nav a {
      width: 100%;
      text-align: center;
    }
  }
</style>

</BaseLayout>
