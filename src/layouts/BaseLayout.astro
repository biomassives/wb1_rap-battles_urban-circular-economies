---
/**
 * BaseLayout.astro
 * Central template for all pages in the Hobby Farm Gamification System
 *
 * Props:
 * - title: Page title
 * - description: Meta description
 * - includeMusicPlayer: Boolean to include music player component
 * - activeSection: String for navigation highlighting
 */
import "../styles/mission-control.css";

// Wallet Security Components
import SecurityEducationModal from '../components/SecurityEducationModal.astro';
import RecoveryPhraseModal from '../components/RecoveryPhraseModal.astro';
import RecoveryPhraseVerification from '../components/RecoveryPhraseVerification.astro';
import WalletPINSetup from '../components/WalletPINSetup.astro';
import WalletUnlockModal from '../components/WalletUnlockModal.astro';

// Challenge System
import ChallengeModal from '../components/ChallengeModal.astro';

interface Props {
  title: string;
  description?: string;
  includeMusicPlayer?: boolean;
  activeSection?: string;
  theme?: 'dark' | 'light'; // Add theme prop
} 

  const { 
  title, 
  description = "Hobby Farm NFT Collection - Music, Environmental Science & Nairobi Urban Youth Empowerment",
  subdescription = "Biodiversity Token Transparency & Education Tooling",
  includeMusicPlayer = false,
  activeSection = 'home'
} = Astro.props;

const currentYear = new Date().getFullYear();
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content={description}>
  <title>{title} | Hobby Farm Gamification</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <script is:inline src="/scripts/form-storage.js"></script>
  
  <script is:inline>
    // Initialize Theme immediately to prevent flash of un-glitched content
    const savedTheme = localStorage.getItem('mission_theme_pref') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);
  </script>

  <script src="https://unpkg.com/@solana/web3.js@1.87.6/lib/index.iife.min.js" is:inline></script>
  
  <script is:inline src="/scripts/mission-bridge.js"></script>
  <!-- Preconnect to external resources -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  
  <!-- Local CSS (emulated Tailwind + custom) -->
  <link rel="stylesheet" href="/styles/dark-theme.css">
  <link rel="stylesheet" href="/styles/global.css">
  <link rel="stylesheet" href="/styles/gamification.css">

  <!-- WORLDBRIDGER ONE Bubble Text & Spore Styles -->
  <style>
    :root {
      --wb-bubble-top: #70d6ff;
      --wb-bubble-bottom: #ff9770;
      --wb-lcd-neon: #39ff14;
      --wb-glass: rgba(255, 255, 255, 0.05);
    }

    /* Branded Header Container */
    .worldbridger-brand {
      position: relative;
      padding: 0.25rem 0;
      text-align: left;
      z-index: 5;
      text-decoration: none;
      display: inline-block;
      transition: transform 0.3s ease;
    }

    .worldbridger-brand:hover {
      transform: scale(1.02);
    }

    /* 3D Bubble Text Effect - Compact for Navigation */
    .worldbridger-title {
      font-size: clamp(1.2rem, 3vw, 1.8rem);
      font-weight: 900;
      text-transform: uppercase;
      margin: 0;
      background: linear-gradient(180deg, var(--wb-bubble-top), var(--wb-bubble-bottom));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow:
        -1px -1px 0px rgba(255,0,0,0.25),
        1px 1px 0px rgba(0,255,255,0.25);
      letter-spacing: -1px;
      filter: url(#organic-glow);
      line-height: 1.1;
      cursor: pointer;
      user-select: none;
    }

    .worldbridger-title .one {
      display: inline;
      font-size: clamp(1.4rem, 4vw, 2.2rem);
      margin-left: 0.25rem;
    }

    /* Mobile: Stack the text vertically */
    @media (max-width: 480px) {
      .worldbridger-title .one {
        display: block;
        margin-left: 0;
        margin-top: -0.2rem;
      }
    }

    /* Fallback shadow for browsers without background-clip */
    @supports not (-webkit-background-clip: text) {
      .worldbridger-title {
        color: var(--wb-bubble-top);
        text-shadow:
          -2px -2px 0px rgba(255,0,0,0.3),
          2px 2px 0px rgba(0,255,255,0.3),
          0px 5px 0px #2d1b4d,
          0px 10px 0px #1a1a2e,
          0px 20px 30px rgba(0,0,0,0.8);
      }
    }

    /* Drifting Spores (Bioluminescent Particles) */
    .spore {
      position: fixed;
      background: white;
      border-radius: 50%;
      filter: blur(1px);
      box-shadow: 0 0 10px #fff, 0 0 20px var(--wb-bubble-top);
      animation: spore-drift 20s infinite ease-in-out;
      z-index: 1;
      pointer-events: none;
    }

    @keyframes spore-drift {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 0;
      }
      10% {
        opacity: 0.6;
      }
      90% {
        opacity: 0.3;
      }
      100% {
        transform: translate(100px, -100vh) scale(1.5);
        opacity: 0;
      }
    }

    /* Subtle CRT Scanline Overlay (optional, disable if too intense) */
    .scanline-overlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.03) 50%);
      background-size: 100% 4px;
      z-index: 9999;
      pointer-events: none;
      opacity: 0.3;
    }

    /* Hide spores on reduced motion preference */
    @media (prefers-reduced-motion: reduce) {
      .spore {
        animation: none;
        opacity: 0.3;
      }
      .scanline-overlay {
        display: none;
      }
    }

    /* Welcome Back Banner for Returning Users */
    .wb1-welcome-banner {
      position: fixed;
      top: 80px;
      right: 20px;
      max-width: 320px;
      padding: 16px 20px;
      background: linear-gradient(135deg, rgba(112, 214, 255, 0.15), rgba(255, 151, 112, 0.15));
      border: 1px solid rgba(112, 214, 255, 0.3);
      border-radius: 12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      animation: slideInRight 0.5s ease-out;
      transition: opacity 0.3s, transform 0.3s;
    }

    .wb1-welcome-banner.hiding {
      opacity: 0;
      transform: translateX(100%);
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .wb1-welcome-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .wb1-welcome-icon {
      font-size: 1.5rem;
    }

    .wb1-welcome-title {
      font-size: 1rem;
      font-weight: 700;
      color: var(--wb-bubble-top);
      margin: 0;
    }

    .wb1-welcome-message {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.8);
      margin: 0 0 12px 0;
      line-height: 1.4;
    }

    .wb1-welcome-stats {
      display: flex;
      gap: 16px;
      padding-top: 10px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .wb1-stat {
      text-align: center;
    }

    .wb1-stat-value {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--wb-bubble-bottom);
    }

    .wb1-stat-label {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: rgba(255, 255, 255, 0.5);
    }

    .wb1-welcome-close {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.5);
      cursor: pointer;
      font-size: 1.2rem;
      line-height: 1;
      padding: 4px;
      transition: color 0.2s;
    }

    .wb1-welcome-close:hover {
      color: white;
    }

    /* Collaboration badge in header */
    .collab-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: rgba(112, 214, 255, 0.2);
      border-radius: 12px;
      font-size: 0.7rem;
      color: var(--wb-bubble-top);
    }

    .collab-badge-count {
      background: var(--wb-bubble-bottom);
      color: #000;
      padding: 2px 6px;
      border-radius: 8px;
      font-weight: 700;
    }

    /* ============================================ */
    /* SPACE INVADER MENU BAR - 1982 ARCADE STYLE  */
    /* ============================================ */

    /* Import pixel font for authentic 1982 feel */
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

    /* The minimal top bar - zero height impact */
    .arcade-menu-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 32px;
      z-index: 10001;
      background: linear-gradient(180deg,
        rgba(0, 0, 0, 0.95) 0%,
        rgba(0, 0, 0, 0.85) 100%);
      border-bottom: 2px solid transparent;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 12px;
      transition: all 0.3s ease;
      /* CRT Scanline effect */
      background-image:
        linear-gradient(180deg, rgba(0,0,0,0.95), rgba(0,0,0,0.85)),
        repeating-linear-gradient(
          0deg,
          transparent,
          transparent 2px,
          rgba(0, 255, 65, 0.03) 2px,
          rgba(0, 255, 65, 0.03) 4px
        );
    }

    .arcade-menu-bar::before {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg,
        transparent 0%,
        #39ff14 20%,
        #00ffff 50%,
        #39ff14 80%,
        transparent 100%);
      opacity: 0.8;
      animation: scanline-glow 3s ease-in-out infinite;
    }

    @keyframes scanline-glow {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }

    /* Left side: Invader + Brand */
    .arcade-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* CSS Pixel Art Space Invader - 11x8 grid */
    .pixel-invader {
      width: 22px;
      height: 16px;
      position: relative;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .pixel-invader-sprite {
      width: 100%;
      height: 100%;
      background-color: #39ff14;
      /* Classic Space Invader shape using CSS clip-path */
      clip-path: polygon(
        /* Row 1 - antennae */
        18% 0%, 27% 0%, 27% 12%, 18% 12%,
        73% 0%, 82% 0%, 82% 12%, 73% 12%,
        /* Row 2 */
        27% 12%, 73% 12%, 73% 25%, 27% 25%,
        /* Row 3 - full width */
        9% 25%, 91% 25%, 91% 37%, 9% 37%,
        /* Row 4 - with eyes */
        0% 37%, 100% 37%, 100% 50%, 0% 50%,
        /* Row 5 */
        0% 50%, 100% 50%, 100% 62%, 0% 62%,
        /* Row 6 - narrower */
        18% 62%, 82% 62%, 82% 75%, 18% 75%,
        /* Row 7 - legs */
        18% 75%, 36% 75%, 36% 100%, 18% 100%,
        64% 75%, 82% 75%, 82% 100%, 64% 100%
      );
      filter: drop-shadow(0 0 6px #39ff14) drop-shadow(0 0 12px #39ff14);
      animation: invader-idle 1s steps(2) infinite;
    }

    /* Alternative: Use box-shadow pixel art for authentic look */
    .pixel-invader-alt {
      width: 2px;
      height: 2px;
      background: transparent;
      /* 11x8 pixel invader using box-shadow */
      box-shadow:
        /* Row 1 - antennae */
        4px 0 0 #39ff14, 18px 0 0 #39ff14,
        /* Row 2 */
        6px 2px 0 #39ff14, 8px 2px 0 #39ff14, 10px 2px 0 #39ff14, 12px 2px 0 #39ff14, 14px 2px 0 #39ff14, 16px 2px 0 #39ff14,
        /* Row 3 */
        2px 4px 0 #39ff14, 4px 4px 0 #39ff14, 6px 4px 0 #39ff14, 8px 4px 0 #39ff14, 10px 4px 0 #39ff14, 12px 4px 0 #39ff14, 14px 4px 0 #39ff14, 16px 4px 0 #39ff14, 18px 4px 0 #39ff14, 20px 4px 0 #39ff14,
        /* Row 4 - with eye holes */
        0px 6px 0 #39ff14, 2px 6px 0 #39ff14, 6px 6px 0 #39ff14, 8px 6px 0 #39ff14, 10px 6px 0 #39ff14, 12px 6px 0 #39ff14, 14px 6px 0 #39ff14, 16px 6px 0 #39ff14, 20px 6px 0 #39ff14, 22px 6px 0 #39ff14,
        /* Row 5 */
        0px 8px 0 #39ff14, 2px 8px 0 #39ff14, 4px 8px 0 #39ff14, 6px 8px 0 #39ff14, 8px 8px 0 #39ff14, 10px 8px 0 #39ff14, 12px 8px 0 #39ff14, 14px 8px 0 #39ff14, 16px 8px 0 #39ff14, 18px 8px 0 #39ff14, 20px 8px 0 #39ff14, 22px 8px 0 #39ff14,
        /* Row 6 */
        4px 10px 0 #39ff14, 6px 10px 0 #39ff14, 8px 10px 0 #39ff14, 10px 10px 0 #39ff14, 12px 10px 0 #39ff14, 14px 10px 0 #39ff14, 16px 10px 0 #39ff14, 18px 10px 0 #39ff14,
        /* Row 7 - legs spread */
        2px 12px 0 #39ff14, 6px 12px 0 #39ff14, 16px 12px 0 #39ff14, 20px 12px 0 #39ff14,
        /* Row 8 - feet */
        0px 14px 0 #39ff14, 2px 14px 0 #39ff14, 20px 14px 0 #39ff14, 22px 14px 0 #39ff14;
      filter: drop-shadow(0 0 4px #39ff14);
      transform: scale(0.9);
    }

    @keyframes invader-idle {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-1px); }
    }

    /* Hover animation - invader comes alive */
    .pixel-invader:hover .pixel-invader-alt {
      animation: invader-march 0.3s steps(2) infinite;
      box-shadow:
        /* Frame 2 - legs together */
        4px 0 0 #39ff14, 18px 0 0 #39ff14,
        6px 2px 0 #39ff14, 8px 2px 0 #39ff14, 10px 2px 0 #39ff14, 12px 2px 0 #39ff14, 14px 2px 0 #39ff14, 16px 2px 0 #39ff14,
        2px 4px 0 #39ff14, 4px 4px 0 #39ff14, 6px 4px 0 #39ff14, 8px 4px 0 #39ff14, 10px 4px 0 #39ff14, 12px 4px 0 #39ff14, 14px 4px 0 #39ff14, 16px 4px 0 #39ff14, 18px 4px 0 #39ff14, 20px 4px 0 #39ff14,
        0px 6px 0 #39ff14, 2px 6px 0 #39ff14, 6px 6px 0 #39ff14, 8px 6px 0 #39ff14, 10px 6px 0 #39ff14, 12px 6px 0 #39ff14, 14px 6px 0 #39ff14, 16px 6px 0 #39ff14, 20px 6px 0 #39ff14, 22px 6px 0 #39ff14,
        0px 8px 0 #39ff14, 2px 8px 0 #39ff14, 4px 8px 0 #39ff14, 6px 8px 0 #39ff14, 8px 8px 0 #39ff14, 10px 8px 0 #39ff14, 12px 8px 0 #39ff14, 14px 8px 0 #39ff14, 16px 8px 0 #39ff14, 18px 8px 0 #39ff14, 20px 8px 0 #39ff14, 22px 8px 0 #39ff14,
        4px 10px 0 #39ff14, 6px 10px 0 #39ff14, 8px 10px 0 #39ff14, 10px 10px 0 #39ff14, 12px 10px 0 #39ff14, 14px 10px 0 #39ff14, 16px 10px 0 #39ff14, 18px 10px 0 #39ff14,
        /* Legs together */
        4px 12px 0 #39ff14, 8px 12px 0 #39ff14, 14px 12px 0 #39ff14, 18px 12px 0 #39ff14,
        6px 14px 0 #39ff14, 8px 14px 0 #39ff14, 14px 14px 0 #39ff14, 16px 14px 0 #39ff14;
      filter: drop-shadow(0 0 8px #39ff14) drop-shadow(0 0 16px #00ffff);
    }

    @keyframes invader-march {
      0%, 100% { transform: scale(0.9) translateX(0); }
      50% { transform: scale(0.9) translateX(2px); }
    }

    /* Glitchy 1982 Pixel Font Brand Name */
    .arcade-brand {
      font-family: 'Press Start 2P', monospace;
      font-size: 9px;
      letter-spacing: 1px;
      color: #39ff14;
      text-shadow:
        0 0 5px #39ff14,
        0 0 10px #39ff14,
        0 0 20px #00ff00,
        2px 2px 0 #003300;
      position: relative;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }

    .arcade-brand::before {
      content: 'WORLDBRIDGER';
      position: absolute;
      left: 0;
      top: 0;
      color: #ff0040;
      clip-path: inset(0 100% 0 0);
      animation: glitch-1 3s infinite linear;
    }

    .arcade-brand::after {
      /* content: 'ONE'; */
      position: absolute;
      right: -28px;
      top: 0;
      color: #00ffff;
      text-shadow:
        0 0 5px #00ffff,
        0 0 10px #00ffff;
      animation: glitch-2 2.5s infinite linear;
    }

    .arcade-brand .brand-one {
      color: #00ffff;
      margin-left: 4px;
      text-shadow:
        0 0 5px #00ffff,
        0 0 10px #00ffff,
        0 0 20px #0088ff;
    }

    @keyframes glitch-1 {
      0%, 90%, 100% { clip-path: inset(0 100% 0 0); }
      92% { clip-path: inset(0 0 0 0); transform: translateX(-2px); }
      94% { clip-path: inset(0 100% 0 0); }
      96% { clip-path: inset(0 0 0 0); transform: translateX(2px); }
      98% { clip-path: inset(0 100% 0 0); }
    }

    @keyframes glitch-2 {
      0%, 85%, 100% { opacity: 1; transform: translateX(0); }
      87% { opacity: 0.8; transform: translateX(1px) skewX(5deg); }
      89% { opacity: 1; transform: translateX(-1px); }
      91% { opacity: 0.9; transform: translateX(0) skewX(-2deg); }
    }

    /* Right side: Menu toggle hint */
    .arcade-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .menu-hint {
      font-family: 'Press Start 2P', monospace;
      font-size: 6px;
      color: rgba(57, 255, 20, 0.5);
      letter-spacing: 0.5px;
      transition: all 0.3s;
    }

    .arcade-menu-bar:hover .menu-hint {
      color: #39ff14;
      text-shadow: 0 0 5px #39ff14;
    }

    .menu-key {
      display: inline-block;
      padding: 2px 6px;
      background: rgba(57, 255, 20, 0.1);
      border: 1px solid rgba(57, 255, 20, 0.3);
      border-radius: 3px;
      font-family: 'Press Start 2P', monospace;
      font-size: 6px;
      color: #39ff14;
      margin-left: 4px;
    }

    /* When menu is expanded */
    .arcade-menu-bar.menu-active {
      background: linear-gradient(180deg,
        rgba(0, 20, 0, 0.98) 0%,
        rgba(0, 10, 0, 0.95) 100%);
    }

    .arcade-menu-bar.menu-active::before {
      background: linear-gradient(90deg,
        #ff0040 0%,
        #39ff14 25%,
        #00ffff 50%,
        #39ff14 75%,
        #ff0040 100%);
      animation: rainbow-scan 2s linear infinite;
    }

    @keyframes rainbow-scan {
      0% { background-position: 0% 50%; }
      100% { background-position: 200% 50%; }
    }

    .arcade-menu-bar.menu-active .arcade-brand {
      animation: brand-pulse 0.5s ease-out;
    }

    @keyframes brand-pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    /* Hide the old toggle elements */
    .space-invader-toggle,
    .toggle-label,
    .screen-space-indicator {
      display: none !important;
    }

    /* Header hidden state */
    .header-main {
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
      margin-top: 32px; /* Space for arcade bar */
    }

    .header-main.header-collapsed {
      transform: translateY(-100%);
      opacity: 0;
      pointer-events: none;
      position: absolute;
    }

    /* When menu is open, show header */
    .header-main.header-expanded {
      transform: translateY(0);
      opacity: 1;
      pointer-events: auto;
      position: relative;
    }

    /* Main content - no padding adjustment needed, arcade bar is tiny */
    .main-content {
      transition: margin-top 0.4s ease;
      margin-top: 0;
    }

    body.menu-collapsed .main-content {
      margin-top: 0;
    }

    /* Mobile responsive */
    @media (max-width: 480px) {
      .arcade-brand {
        font-size: 7px;
      }
      .arcade-brand .brand-one {
        display: none;
      }
      .menu-hint {
        display: none;
      }
      .pixel-invader-alt {
        transform: scale(0.7);
      }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      .pixel-invader-alt,
      .arcade-brand::before,
      .arcade-brand::after,
      .arcade-menu-bar::before {
        animation: none !important;
      }
    }

    /* Challenge navigation buttons */
    .challenge-nav-group {
      display: flex;
      gap: 0.25rem;
    }

    .btn-challenge {
      background: linear-gradient(135deg, rgba(255, 151, 112, 0.2), rgba(112, 214, 255, 0.2));
      border: 1px solid rgba(255, 151, 112, 0.3);
      transition: all 0.3s ease;
    }

    .btn-challenge:hover {
      background: linear-gradient(135deg, rgba(255, 151, 112, 0.4), rgba(112, 214, 255, 0.4));
      transform: scale(1.1);
      box-shadow: 0 0 15px rgba(255, 151, 112, 0.3);
    }

    .btn-invites {
      position: relative;
    }

    .btn-invites .badge-count {
      position: absolute;
      top: -4px;
      right: -4px;
      min-width: 18px;
      height: 18px;
      padding: 0 5px;
      background: #e74c3c;
      border-radius: 9px;
      font-size: 0.7rem;
      font-weight: 700;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: pulse-badge 2s infinite;
    }

    @keyframes pulse-badge {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
  </style>
  
  <script is:inline>
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('ğŸ” LOADING CRYPTO LIBRARIES');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  </script>

  <!-- Load Solana Web3 -->
  <script src="https://unpkg.com/@solana/web3.js@1.87.6/lib/index.iife.min.js" is:inline></script>

  <script is:inline>
    // Check Solana immediately after its script tag
    if (window.solanaWeb3) {
      console.log('âœ… Solana Web3 loaded successfully');
      console.log('Solana version:', window.solanaWeb3.VERSION || 'unknown');
    } else {
      console.error('âŒ Solana Web3 failed to load from unpkg');
    }
  </script>

  <!-- Load Solana NFT Manager -->
  <script src="/scripts/solana-nft-manager.js" is:inline></script>

  <script is:inline>
    // Initialize NFT Manager after page load
    if (typeof SolanaNFTManager !== 'undefined') {
      console.log('âœ… Solana NFT Manager loaded');
    } else {
      console.error('âŒ Solana NFT Manager failed to load');
    }
  </script>

  <!-- Load BIP39 via ES module from esm.sh (converts CommonJS to ES modules) -->
  <script type="module">
    console.log('â³ Loading BIP39 library from esm.sh...');

    try {
      // Import BIP39 as ES module from esm.sh (automatically converts to ESM)
      const bip39Module = await import('https://esm.sh/bip39@3.1.0');
      console.log('âœ… BIP39 module imported');
      console.log('Module keys:', Object.keys(bip39Module));

      // Check if it's a default export or named exports
      const bip39 = bip39Module.default || bip39Module;
      console.log('BIP39 object:', bip39);
      console.log('Available methods:', Object.keys(bip39));

      // Expose to window
      window.bip39 = {
        generateMnemonic: bip39.generateMnemonic || bip39Module.generateMnemonic,
        mnemonicToSeed: bip39.mnemonicToSeed || bip39Module.mnemonicToSeed,
        validateMnemonic: bip39.validateMnemonic || bip39Module.validateMnemonic
      };

      console.log('âœ… BIP39 System Ready');
      console.log('BIP39 functions available:', {
        generateMnemonic: typeof window.bip39.generateMnemonic,
        mnemonicToSeed: typeof window.bip39.mnemonicToSeed,
        validateMnemonic: typeof window.bip39.validateMnemonic
      });

      // Test it
      try {
        const testMnemonic = window.bip39.generateMnemonic(128);
        console.log('âœ… Test mnemonic generated:', testMnemonic.split(' ').length, 'words');
      } catch (e) {
        console.error('âŒ Test mnemonic failed:', e.message);
        console.error('Stack:', e.stack);
      }

      window.dispatchEvent(new CustomEvent('bip39-ready'));
      console.log('ğŸ“¢ BIP39 ready event dispatched');
    } catch (error) {
      console.error('âŒ Failed to load BIP39 module from esm.sh');
      console.error('Error type:', error.name);
      console.error('Error message:', error.message);
      console.error('Error stack:', error.stack);
    }

    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  </script>



  <!-- Wallet Security Utilities -->
  <script is:inline src="/scripts/wallet-crypto.js"></script>
  <script is:inline src="/scripts/wallet-generator.js"></script>

  <!-- E8 Lattice Oracle - Post-Quantum Encryption -->
  <script is:inline src="/scripts/e8-lattice-oracle.js"></script>

  <!-- Offline-First Storage Managers (MUST LOAD IN THIS ORDER) -->
  <script is:inline src="/scripts/crypto-manager.js"></script>
  <script is:inline src="/scripts/local-storage-manager.js"></script>
  <script is:inline src="/scripts/local-db-manager.js"></script>
  <script is:inline src="/scripts/form-storage-adapter.js"></script>

  <!-- WB1 User Manager - Returning User & Collaboration Tracking -->
  <script is:inline src="/scripts/wb1-user-manager.js"></script>

  <!-- WB1 Challenge Manager - Challenge Workflow & Invitations -->
  <script is:inline src="/scripts/wb1-challenge-manager.js"></script>
</head>

<body class="bg-gradient-farm font-sans">

  <!-- SVG Filters for Organic Glow Effect -->
  <svg width="0" height="0" style="position:absolute;">
    <defs>
      <filter id="organic-glow">
        <feTurbulence type="fractalNoise" baseFrequency="0.015" numOctaves="2" result="noise" />
        <feDisplacementMap in="SourceGraphic" in2="noise" scale="2" />
      </filter>
    </defs>
  </svg>

  <!-- Bioluminescent Floating Spores -->
  <div class="spore" style="width: 4px; height: 4px; left: 10%; bottom: -5%; animation-delay: 0s;"></div>
  <div class="spore" style="width: 6px; height: 6px; left: 30%; bottom: -5%; animation-delay: 3s;"></div>
  <div class="spore" style="width: 3px; height: 3px; left: 50%; bottom: -5%; animation-delay: 6s;"></div>
  <div class="spore" style="width: 5px; height: 5px; left: 70%; bottom: -5%; animation-delay: 9s;"></div>
  <div class="spore" style="width: 4px; height: 4px; left: 90%; bottom: -5%; animation-delay: 12s;"></div>

  <!-- Subtle Scanline Overlay -->
  <div class="scanline-overlay"></div>

  <!-- ============================================ -->
  <!-- ARCADE MENU BAR - 1982 SPACE INVADERS STYLE -->
  <!-- ============================================ -->
  <div id="arcade-menu-bar" class="arcade-menu-bar" role="navigation" aria-label="Main menu toggle">
    <!-- Left: Invader + Brand -->
    <div class="arcade-left">
      <!-- Pixel Art Space Invader -->
      <div class="pixel-invader" id="menu-invader" title="Click to toggle menu (or press M)" tabindex="0" role="button" aria-pressed="false">
        <div class="pixel-invader-alt"></div>
      </div>
      <!-- Glitchy Brand Name -->
      <div class="arcade-brand">
        WORLDBRIDGER<span class="brand-one">ONE</span>
      </div>
    </div>
    <!-- Right: Menu hint -->
    <div class="arcade-right">
      <span class="menu-hint">PRESS <span class="menu-key">M</span> FOR MENU</span>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- HEADER & NAVIGATION -->
  <!-- ============================================ -->
  <header class="header-main header-collapsed" id="main-header">
    <div class="container mx-auto flex justify-between items-center">
      <nav class="nav-primary ">
        
        <!-- WORLDBRIDGER ONE Bubble Text Logo -->
        <div class="flex items-center gap-4">
          <a href="/" class="worldbridger-brand" title="WorldBridger One">
            <h1 class="worldbridger-title">
              <span class="one">Welcome</span>
            </h1>
          </a>
        </div>

        <!-- Quick Nav Links -->
        <nav class="hidden md:flex gap-6 text-[10px] uppercase tracking-widest">
          <a href="/rap-battle" class="hover:text-white transition-colors battle-link">âš”ï¸ Battle</a>
          <a href="/beat-playground" class="hover:text-white transition-colors">ğŸ›ï¸ Beats</a>
          <a href="/profile" class="hover:text-white transition-colors">Mission_Control</a>
          <a href="/music" class="hover:text-white transition-colors">Studio</a>
        </nav>

        <!-- Main Navigation - Zen Minimal -->
        <ul class="nav-menu">
          <!-- Battle Dropdown - Primary Flow -->
          <li class="nav-dropdown battle-nav">
            <button class="nav-dropdown-btn battle-btn">
              <span class="nav-icon">âš”ï¸</span>
              <span>BATTLE</span>
              <span class="dropdown-arrow">â–¼</span>
            </button>
            <div class="nav-dropdown-menu">
              <a href="/rap-battle" class="dropdown-item featured">
                <span class="item-icon">ğŸ¤</span>
                <span>Rap Battle Arena</span>
                <span class="item-badge">NEW</span>
              </a>
              <a href="/beat-playground" class="dropdown-item">
                <span class="item-icon">ğŸ›ï¸</span>
                <span>Beat Playground</span>
              </a>
              <a href="/rap-battle?mode=practice" class="dropdown-item">
                <span class="item-icon">ğŸ“</span>
                <span>Practice Mode</span>
              </a>
              <a href="/battle-voting" class="dropdown-item">
                <span class="item-icon">ğŸ—³ï¸</span>
                <span>Vote on Battles</span>
              </a>
              <div class="dropdown-divider"></div>
              <a href="/leaderboard" class="dropdown-item">
                <span class="item-icon">ğŸ†</span>
                <span>Battle Rankings</span>
              </a>
            </div>
          </li>

          <!-- Music Dropdown -->
          <li class="nav-dropdown">
            <button class="nav-dropdown-btn">
              <span class="nav-icon">ğŸµ</span>
              <span>MUSIC</span>
              <span class="dropdown-arrow">â–¼</span>
            </button>
            <div class="nav-dropdown-menu">
              <a href="/moog-sampler" class="dropdown-item">
                <span class="item-icon">â—ˆ</span>
                <span>Moog Synth</span>
              </a>
              <a href="/music" class="dropdown-item">
                <span class="item-icon">ğŸ¹</span>
                <span>Music Studio</span>
              </a>
              <a href="/sampler" class="dropdown-item">
                <span class="item-icon">ğŸ¥</span>
                <span>Sampler Pads</span>
              </a>
              <a href="/improved-sampler" class="dropdown-item featured">
                <span class="item-icon">ğŸ›ï¸</span>
                <span>Battle Sampler</span>
                <span class="item-badge">BETA</span>
              </a>
              <a href="/rapper-template-builder" class="dropdown-item">
                <span class="item-icon">ğŸ“</span>
                <span>Verse Builder</span>
              </a>
            </div>
          </li>

          <!-- Learn Dropdown -->
          <li class="nav-dropdown">
            <button class="nav-dropdown-btn">
              <span class="nav-icon">ğŸ“š</span>
              <span>LEARN</span>
              <span class="dropdown-arrow">â–¼</span>
            </button>
            <div class="nav-dropdown-menu">
              <a href="/about" class="dropdown-item">
                <span class="item-icon">â„¹ï¸</span>
                <span>About (Free Forever)</span>
              </a>
              <div class="dropdown-divider"></div>
              <a href="/learn" class="dropdown-item">
                <span class="item-icon">ğŸ“º</span>
                <span>Approvideo Learning</span>
              </a>
              <a href="/peace" class="dropdown-item">
                <span class="item-icon">â˜®ï¸</span>
                <span>Peace Engineering</span>
              </a>
              <a href="/solutions" class="dropdown-item">
                <span class="item-icon">ğŸ—ƒï¸</span>
                <span>SCD Solutions Hub</span>
              </a>
              <div class="dropdown-divider"></div>
              <a href="/nairobi-youth" class="dropdown-item">
                <span class="item-icon">ğŸŒ†</span>
                <span>Urban & Coastal Youth</span>
              </a>
              <a href="/docs" class="dropdown-item">
                <span class="item-icon">ğŸ“–</span>
                <span>Documentation</span>
              </a>
            </div>
          </li>

          <!-- Community Dropdown -->
          <li class="nav-dropdown">
            <button class="nav-dropdown-btn">
              <span class="nav-icon">ğŸ®</span>
              <span>COMMUNITY</span>
              <span class="dropdown-arrow">â–¼</span>
            </button>
            <div class="nav-dropdown-menu">
              <a href="/" class="dropdown-item">
                <span class="item-icon">ğŸŒ¾</span>
                <span>Collection</span>
              </a>
              <a href="/nft-gallery" class="dropdown-item">
                <span class="item-icon">ğŸ¨</span>
                <span>NFT Gallery</span>
              </a>
              <a href="/progress" class="dropdown-item">
                <span class="item-icon">ğŸ“Š</span>
                <span>Progress</span>
              </a>
              <a href="/leaderboard" class="dropdown-item">
                <span class="item-icon">ğŸ†</span>
                <span>Leaderboard</span>
              </a>
              <div class="dropdown-divider"></div>
              <a href="/data-test" class="dropdown-item">
                <span class="item-icon">ğŸ”§</span>
                <span>Data Test</span>
              </a>
            </div>
          </li>
        </ul>

        <!-- User Actions -->
        <div class="nav-actions">
          <!-- Language Switcher -->
          <div class="language-switcher">
            <button id="language-btn" class="btn-icon btn-language" title="Change Language" onclick="toggleLanguage()">
              <span class="language-icon">ğŸŒ</span>
              <span id="current-language" class="language-code">EN</span>
            </button>
            <div id="language-dropdown" class="dropdown-menu language-menu" style="display: none;">
              <!-- Global Languages Section -->
              <div class="language-section-header">Global Languages</div>
              <button class="language-option" data-lang="en">
                <span class="flag">ğŸ‡¬ğŸ‡§</span>
                <span class="lang-name">English</span>
              </button>
              <button class="language-option" data-lang="es">
                <span class="flag">ğŸ‡ªğŸ‡¸</span>
                <span class="lang-name">EspaÃ±ol</span>
              </button>
              <button class="language-option" data-lang="fr">
                <span class="flag">ğŸ‡«ğŸ‡·</span>
                <span class="lang-name">FranÃ§ais</span>
              </button>
              <button class="language-option" data-lang="sw">
                <span class="flag">ğŸ‡°ğŸ‡ª</span>
                <span class="lang-name">Kiswahili</span>
              </button>
              <button class="language-option" data-lang="ar">
                <span class="flag">ğŸ‡¸ğŸ‡¦</span>
                <span class="lang-name">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</span>
              </button>
              <button class="language-option" data-lang="pt">
                <span class="flag">ğŸ‡§ğŸ‡·</span>
                <span class="lang-name">PortuguÃªs</span>
              </button>
              <button class="language-option" data-lang="zh">
                <span class="flag">ğŸ‡¨ğŸ‡³</span>
                <span class="lang-name">ä¸­æ–‡</span>
              </button>
              <button class="language-option" data-lang="hi">
                <span class="flag">ğŸ‡®ğŸ‡³</span>
                <span class="lang-name">à¤¹à¤¿à¤¨à¥à¤¦à¥€</span>
              </button>

              <!-- Refugee Camp Languages Section -->
              <div class="language-section-header">Refugee Camp Languages</div>
              <button class="language-option" data-lang="ps">
                <span class="flag">ğŸ‡¦ğŸ‡«</span>
                <span class="lang-name">Ù¾ÚšØªÙˆ (Pashto)</span>
              </button>
              <button class="language-option" data-lang="fa">
                <span class="flag">ğŸ‡¦ğŸ‡«</span>
                <span class="lang-name">Ø¯Ø±ÛŒ (Dari)</span>
              </button>
              <button class="language-option" data-lang="so">
                <span class="flag">ğŸ‡¸ğŸ‡´</span>
                <span class="lang-name">Soomaali (Somali)</span>
              </button>
              <button class="language-option" data-lang="ti">
                <span class="flag">ğŸ‡ªğŸ‡·</span>
                <span class="lang-name">á‰µáŒáˆ­áŠ› (Tigrinya)</span>
              </button>
              <button class="language-option" data-lang="my">
                <span class="flag">ğŸ‡²ğŸ‡²</span>
                <span class="lang-name">á€™á€¼á€”á€ºá€™á€¬ (Burmese)</span>
              </button>
              <button class="language-option" data-lang="rw">
                <span class="flag">ğŸ‡·ğŸ‡¼</span>
                <span class="lang-name">Kinyarwanda</span>
              </button>
              <button class="language-option" data-lang="rn">
                <span class="flag">ğŸ‡§ğŸ‡®</span>
                <span class="lang-name">Kirundi</span>
              </button>
              <button class="language-option" data-lang="am">
                <span class="flag">ğŸ‡ªğŸ‡¹</span>
                <span class="lang-name">áŠ áˆ›áˆ­áŠ› (Amharic)</span>
              </button>
            </div>
          </div>

          <!-- Theme Switcher -->
          <button id="theme-toggle" class="btn-icon btn-theme" title="Toggle Dark/Light Mode" onclick="toggleTheme()">
            <span class="theme-icon-dark">ğŸŒ™</span>
            <span class="theme-icon-light" style="display: none;">â˜€ï¸</span>
          </button>

          <!-- XP Display (shown when logged in) -->
          <div id="xp-display" class="xp-badge" style="display: none;">
            <span class="xp-icon">â­</span>
            <span id="current-xp">0</span> XP
            <span class="level-badge">
              Lvl <span id="current-level">1</span>
            </span>
          </div>

          <!-- Challenge Button -->
          <div class="challenge-nav-group">
            <button id="challenge-create-btn" class="btn-icon btn-challenge" title="Create Challenge" onclick="openChallengeCreateModal()">
              <span class="challenge-icon">âš”ï¸</span>
            </button>
            <button id="challenge-invites-btn" class="btn-icon btn-invites" title="Challenge Invites" onclick="showPendingInvites()" style="display: none;">
              <span class="invites-icon">ğŸ“¨</span>
              <span id="challenge-invite-count" class="badge-count">0</span>
            </button>
          </div>

          <!-- Notifications -->
          <button id="notifications-btn" class="btn-icon" style="display: none;">
            <span class="notification-icon">ğŸ””</span>
            <span id="notification-count" class="badge-count">0</span>
          </button>

          <!-- Profile Button -->
          <button id="profile-btn" class="btn-secondary" style="display: none;">
            <span id="profile-username">Profile</span>
          </button>

          <!-- Connect Wallet Button -->
          <button
            id="connect-wallet-btn"
            class="btn-primary"
            onclick="handleConnectWallet()"
          >
            Connect Wallet
          </button>
        </div>

        <!-- Mobile Menu Toggle -->
        <button id="mobile-menu-toggle" class="btn-mobile-menu">
          <span class="hamburger-icon">â˜°</span>
        </button>
      </nav>
    </div>
  </header>

  <!-- ============================================ -->
  <!-- MAIN CONTENT -->
  <!-- ============================================ -->
  <main class="main-content">
    <slot />
  </main>

  <!-- ============================================ -->
  <!-- WALLET SECURITY MODALS -->
  <!-- ============================================ -->
  <SecurityEducationModal />
  <RecoveryPhraseModal />
  <RecoveryPhraseVerification />
  <WalletPINSetup />
  <WalletUnlockModal />

  <!-- ============================================ -->
  <!-- CHALLENGE SYSTEM MODALS -->
  <!-- ============================================ -->
  <ChallengeModal />

  <!-- ============================================ -->
  <!-- FOOTER -->
  <!-- ============================================ -->
  <footer class="footer-main">
    <div class="container mx-auto">
      <div class="footer-grid">
        
        <!-- About Section -->
        <div class="footer-section">
          <h3>WorldBridger One</h3>
          <p>
            Empowering artists and communities through music, environmental science,
            and gamified learning. Supporting Nairobi urban youth.
          </p>
          <div class="social-links">
            <a href="#" class="social-link">Twitter</a>
            <a href="#" class="social-link">Discord</a>
            <a href="#" class="social-link">GitHub</a>
          </div>
        </div>

        <!-- Quick Links -->
        <div class="footer-section">
          <h4>Platform</h4>
          <ul class="footer-links">
            <li><a href="/progress">Your Progress</a></li>
            <li><a href="/music">Music Studio</a></li>
            <li><a href="/learning">Learning Hub</a></li>
            <li><a href="/nairobi-youth">Nairobi Youth</a></li>
          </ul>
        </div>

        <!-- Resources -->
        <div class="footer-section">
          <h4>Resources</h4>
          <ul class="footer-links">
            <li><a href="/docs">Documentation</a></li>
            <li><a href="/courses">All Courses</a></li>
            <li><a href="/achievements">Achievements</a></li>
            <li><a href="/api-docs">API Reference</a></li>
          </ul>
        </div>

        <!-- Support -->
        <div class="footer-section">
          <h4>Support</h4>
          <ul class="footer-links">
            <li><a href="/help">Help Center</a></li>
            <li><a href="/contact">Contact Us</a></li>
            <li><a href="/youth-support">Youth Support</a></li>
            <li><a href="/feedback">Give Feedback</a></li>
          </ul>
        </div>
      </div>

      <!-- Footer Bottom -->
      <div class="footer-bottom">
        <p class="copyright">
          Â© {currentYear} WorldBridger One. Built by Mupy for POREFPC & Nairobi Urban Youth.
          <a href="/license">GPL-3.0 License</a>
        </p>
        <div class="footer-badges">
          <span class="badge">ğŸŒ¾ Open Source</span>
          <span class="badge">ğŸŒ For Good</span>
          <span class="badge">ğŸµ Music + Science</span>
        </div>
      </div>
    </div>
  </footer>

  <!-- ============================================ -->
  <!-- MODALS & OVERLAYS -->
  <!-- ============================================ -->
  
  <!-- Notifications Panel -->
  <div id="notifications-panel" class="panel-overlay" style="display: none;">
    <div class="panel-content">
      <div class="panel-header">
        <h3>Notifications</h3>
        <button class="btn-close" onclick="window.uiManager?.closeNotifications()">Ã—</button>
      </div>
      <div id="notifications-list" class="notifications-list">
        <!-- Notifications will be loaded here -->
      </div>
    </div>
  </div>

  <!-- XP Notification Toast -->
  <div id="xp-toast" class="xp-toast" style="display: none;">
    <!-- XP notifications appear here -->
  </div>

  <!-- Achievement Unlock Modal -->
  <div id="achievement-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content achievement-modal">
      <div class="achievement-animation">
        <div class="achievement-badge" id="achievement-badge">ğŸ†</div>
      </div>
      <h2>Achievement Unlocked!</h2>
      <h3 id="achievement-name"></h3>
      <p id="achievement-description"></p>
      <div class="achievement-reward">
        <span id="achievement-xp">+0 XP</span>
      </div>
      <button class="btn-primary" onclick="window.uiManager?.closeAchievementModal()">
        Awesome!
      </button>
    </div>
  </div>

  <!-- Level Up Modal -->
  <div id="levelup-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content levelup-modal">
      <div class="levelup-animation">
        <div class="level-number" id="new-level">2</div>
        <div class="mentor-change" id="new-mentor">ğŸ“</div>
      </div>
      <h2>Level Up!</h2>
      <h3>You've reached Level <span id="levelup-number">2</span></h3>
      <p id="levelup-stage">Egg Stage</p>
      <div class="mentor-info">
        <h4>Your Mentor: <span id="mentor-name">Chicken</span></h4>
        <p id="mentor-description">Master of foundations and community building</p>
      </div>
      <button class="btn-primary" onclick="window.uiManager?.closeLevelUpModal()">
        Continue Journey
      </button>
    </div>
  </div>

  <!-- Optional Music Player Component -->
  {includeMusicPlayer && (
    <div id="music-player" class="music-player-fixed">
      <!-- Music player will be rendered here -->
    </div>
  )}

  <!-- ============================================ -->
  <!-- CORE JAVASCRIPT CLASSES -->
  <!-- ============================================ -->

  <script is:inline>
    const ThemeManager = {
      toggle() {
        const current = document.documentElement.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('mission_theme_pref', next);
        this.updateDisplay(next);
      },
      updateDisplay(theme) {
        const display = document.getElementById('current-state-display');
        if (display) display.innerText = theme === 'dark' ? 'STABLE' : 'GLITCH_MODE';
      }
    };
    // Sync display on load
    ThemeManager.updateDisplay(localStorage.getItem('mission_theme_pref') || 'dark');
  </script>



  <!-- Direct UI Handlers (using is:inline for immediate availability) -->
  <script is:inline>
    console.log('ğŸ”¥ INLINE HANDLERS LOADING');

    // Debug utility - check wallet state in localStorage
    function checkWalletState() {
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('ğŸ” WALLET STATE CHECK');
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

      const walletCreated = localStorage.getItem('walletCreated');
      const connectedWallet = localStorage.getItem('connectedWallet');
      const anonymousWallet = localStorage.getItem('anonymousWallet');
      const encryptedWallet = localStorage.getItem('encryptedWallet');
      const pinHash = localStorage.getItem('pinHash');

      console.log('walletCreated:', walletCreated);
      console.log('connectedWallet:', connectedWallet);
      console.log('anonymousWallet:', anonymousWallet);
      console.log('encryptedWallet exists:', !!encryptedWallet);
      console.log('pinHash exists:', !!pinHash);
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

      // Check for corrupted state
      if (walletCreated === 'true' && !encryptedWallet) {
        console.warn('âš ï¸ WARNING: walletCreated=true but no encrypted wallet found!');
        console.warn('This is a corrupted state. Run clearWalletState() to fix.');
        return false;
      }

      if (connectedWallet && !anonymousWallet && !encryptedWallet) {
        console.warn('âš ï¸ WARNING: connectedWallet set but no wallet data found!');
        console.warn('This is a corrupted state. Run clearWalletState() to fix.');
        return false;
      }

      return true;
    }

    // Utility to clear all wallet data (for debugging)
    function clearWalletState() {
      console.log('ğŸ§¹ Clearing all wallet state from localStorage...');

      const keysToRemove = [
        'walletCreated',
        'connectedWallet',
        'anonymousWallet',
        'anonymousWalletCreated',
        'encryptedWallet',
        'pinHash',
        'securityEducationCompleted'
      ];

      keysToRemove.forEach(key => {
        if (localStorage.getItem(key)) {
          console.log('  Removing:', key);
          localStorage.removeItem(key);
        }
      });

      console.log('âœ… Wallet state cleared. Reload the page to start fresh.');
      alert('Wallet state cleared! Reload the page to start fresh.');
    }

    // Make utilities available globally for debugging
    window.checkWalletState = checkWalletState;
    window.clearWalletState = clearWalletState;

    // Auto-check on page load
    const walletStateOk = checkWalletState();
    if (!walletStateOk) {
      console.error('âŒ Corrupted wallet state detected!');
      console.error('ğŸ› ï¸ To fix: Open console and run: clearWalletState()');
    }

    // Wallet connection handler
    function handleConnectWallet() {
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('ğŸ”˜ CONNECT WALLET CLICKED');
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

      // Check if already has wallet using the proper wallet detection
      const hasExistingWallet = window.hasWallet && window.hasWallet();
      if (hasExistingWallet) {
        console.log('â„¹ï¸ Wallet already exists, showing unlock modal');
        // Show unlock modal for existing wallet
        if (window.showWalletUnlock) {
          window.showWalletUnlock();
        } else {
          console.error('Unlock modal not loaded');
          alert('Wallet unlock loading... Please refresh and try again.');
        }
        return;
      }

      // Open security education modal
      const securityModal = document.getElementById('securityEducationModal');
      if (securityModal) {
        console.log('âœ… Opening security education modal');
        securityModal.style.display = 'flex';

        // Show the choice screen (first step)
        const choiceScreen = document.getElementById('educationChoice');
        if (choiceScreen) {
          choiceScreen.style.display = 'block';
        }
      } else {
        console.error('âŒ Modal not found');
        alert('Wallet setup modal not found. Please refresh the page.');
      }
    }

    // Theme toggle handler
    function toggleTheme() {
      console.log('ğŸ¨ Theme toggle clicked');
      document.body.classList.toggle('light-theme');
      const isLight = document.body.classList.contains('light-theme');

      // Toggle icons
      const themeDarkIcon = document.querySelector('.theme-icon-dark');
      const themeLightIcon = document.querySelector('.theme-icon-light');
      if (themeDarkIcon) themeDarkIcon.style.display = isLight ? 'none' : 'inline-block';
      if (themeLightIcon) themeLightIcon.style.display = isLight ? 'inline-block' : 'none';

      // Save preference
      localStorage.setItem('theme', isLight ? 'light' : 'dark');
      console.log('âœ… Theme changed to:', isLight ? 'light' : 'dark');
    }

    // Language toggle handler
    function toggleLanguage() {
      console.log('ğŸŒ Language toggle clicked');
      const languageDropdown = document.getElementById('language-dropdown');
      if (languageDropdown) {
        const isVisible = languageDropdown.style.display === 'block';
        languageDropdown.style.display = isVisible ? 'none' : 'block';
      }
    }

    // Load theme on page load
    document.addEventListener('DOMContentLoaded', function() {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      if (savedTheme === 'light') {
        document.body.classList.add('light-theme');
        const themeDarkIcon = document.querySelector('.theme-icon-dark');
        const themeLightIcon = document.querySelector('.theme-icon-light');
        if (themeDarkIcon) themeDarkIcon.style.display = 'none';
        if (themeLightIcon) themeLightIcon.style.display = 'inline-block';
      }
      console.log('ğŸ¨ Initial theme loaded:', savedTheme);
    });

    console.log('âœ… INLINE HANDLERS READY');

    // Generate dynamic bioluminescent spores
    function generateSpores() {
      // Check for reduced motion preference
      if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
        console.log('ğŸŒ¿ Reduced motion detected, skipping spore generation');
        return;
      }

      const body = document.body;
      const existingSpores = document.querySelectorAll('.spore.dynamic-spore');

      // Limit total spores to prevent performance issues
      if (existingSpores.length >= 15) return;

      for (let i = 0; i < 12; i++) {
        const spore = document.createElement('div');
        spore.className = 'spore dynamic-spore';
        spore.style.left = Math.random() * 100 + 'vw';
        spore.style.bottom = '-5%';
        const size = Math.random() * 4 + 2;
        spore.style.width = size + 'px';
        spore.style.height = size + 'px';
        spore.style.animationDelay = Math.random() * 20 + 's';
        spore.style.animationDuration = (15 + Math.random() * 10) + 's';
        body.appendChild(spore);
      }
      console.log('ğŸŒ¿ Bioluminescent spores generated');
    }

    // Generate spores after page load
    if (document.readyState === 'complete') {
      generateSpores();
    } else {
      window.addEventListener('load', generateSpores);
    }

    // ============================================
    // ARCADE MENU BAR - 1982 SPACE INVADERS STYLE
    // ============================================
    function initArcadeMenuBar() {
      const arcadeBar = document.getElementById('arcade-menu-bar');
      const invader = document.getElementById('menu-invader');
      const header = document.getElementById('main-header');
      const menuHint = document.querySelector('.menu-hint');

      if (!arcadeBar || !invader || !header) return;

      // Load saved preference (default: collapsed for max screen space)
      const menuState = localStorage.getItem('wb1_menu_state') || 'collapsed';

      const expandMenu = () => {
        header.classList.remove('header-collapsed');
        header.classList.add('header-expanded');
        arcadeBar.classList.add('menu-active');
        invader.setAttribute('aria-pressed', 'true');
        document.body.classList.remove('menu-collapsed');
        if (menuHint) menuHint.innerHTML = 'PRESS <span class="menu-key">M</span> TO HIDE';
        localStorage.setItem('wb1_menu_state', 'expanded');
        console.log('ğŸ‘¾ MENU_ACTIVATED');
      };

      const collapseMenu = () => {
        header.classList.add('header-collapsed');
        header.classList.remove('header-expanded');
        arcadeBar.classList.remove('menu-active');
        invader.setAttribute('aria-pressed', 'false');
        document.body.classList.add('menu-collapsed');
        if (menuHint) menuHint.innerHTML = 'PRESS <span class="menu-key">M</span> FOR MENU';
        localStorage.setItem('wb1_menu_state', 'collapsed');
        console.log('ğŸ‘¾ MAX_SCREEN_MODE');
      };

      // Set initial state
      if (menuState === 'expanded') {
        expandMenu();
      } else {
        collapseMenu();
      }

      // Click handler for invader
      const toggleMenu = () => {
        const isCollapsed = header.classList.contains('header-collapsed');
        if (isCollapsed) {
          expandMenu();
        } else {
          collapseMenu();
        }
      };

      invader.addEventListener('click', toggleMenu);

      // Also allow clicking the brand name to toggle
      const brand = document.querySelector('.arcade-brand');
      if (brand) {
        brand.addEventListener('click', toggleMenu);
      }

      // Keyboard: Enter/Space on invader
      invader.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggleMenu();
        }
      });

      // Keyboard shortcut: Press 'M' to toggle menu
      document.addEventListener('keydown', (e) => {
        // Only if not typing in an input
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;
        if (e.key.toLowerCase() === 'm' && !e.ctrlKey && !e.metaKey && !e.altKey) {
          toggleMenu();
        }
      });

      // Add hover sound effect (optional - visual feedback via CSS)
      invader.addEventListener('mouseenter', () => {
        invader.style.transform = 'scale(1.1)';
      });
      invader.addEventListener('mouseleave', () => {
        invader.style.transform = 'scale(1)';
      });

      console.log('ğŸ‘¾ ARCADE_MENU_INITIALIZED');
      console.log('   Press M or click the invader to toggle navigation');
    }

    // Initialize on page load
    if (document.readyState === 'complete') {
      initArcadeMenuBar();
    } else {
      window.addEventListener('load', initArcadeMenuBar);
    }
    // Also init on Astro page transitions
    document.addEventListener('astro:page-load', initArcadeMenuBar);

    // Show welcome banner for returning users
    function showWelcomeBanner() {
      // Wait for WB1 User Manager to be ready
      if (!window.wb1User || !window.wb1User.initialized) {
        window.addEventListener('wb1-user-ready', showWelcomeBanner, { once: true });
        return;
      }

      const status = window.wb1User.getUserStatus();

      // Only show for returning users on their first visit today
      if (!status.isReturningUser || !window.wb1User.isFirstVisitToday()) {
        return;
      }

      // Check if already dismissed this session
      if (sessionStorage.getItem('wb1_welcome_dismissed')) {
        return;
      }

      const welcome = window.wb1User.getWelcomeMessage();
      const collabCount = status.collaborations.active;

      const banner = document.createElement('div');
      banner.className = 'wb1-welcome-banner';
      banner.innerHTML = `
        <button class="wb1-welcome-close" onclick="dismissWelcomeBanner()">&times;</button>
        <div class="wb1-welcome-header">
          <span class="wb1-welcome-icon">${welcome.icon}</span>
          <h3 class="wb1-welcome-title">${welcome.title}</h3>
        </div>
        <p class="wb1-welcome-message">${welcome.message}</p>
        <div class="wb1-welcome-stats">
          <div class="wb1-stat">
            <div class="wb1-stat-value">${status.streak.current}</div>
            <div class="wb1-stat-label">Day Streak</div>
          </div>
          <div class="wb1-stat">
            <div class="wb1-stat-value">${status.visitCount}</div>
            <div class="wb1-stat-label">Visits</div>
          </div>
          ${collabCount > 0 ? `
          <div class="wb1-stat">
            <div class="wb1-stat-value">${collabCount}</div>
            <div class="wb1-stat-label">Collabs</div>
          </div>
          ` : ''}
        </div>
      `;

      document.body.appendChild(banner);

      // Auto-dismiss after 8 seconds
      setTimeout(() => {
        if (banner.parentNode) {
          dismissWelcomeBanner();
        }
      }, 8000);

      console.log('ğŸ‰ Welcome banner shown for returning user');
    }

    function dismissWelcomeBanner() {
      const banner = document.querySelector('.wb1-welcome-banner');
      if (banner) {
        banner.classList.add('hiding');
        sessionStorage.setItem('wb1_welcome_dismissed', 'true');
        setTimeout(() => banner.remove(), 300);
      }
    }

    // Expose globally
    window.dismissWelcomeBanner = dismissWelcomeBanner;

    // Show welcome banner after page load
    if (document.readyState === 'complete') {
      setTimeout(showWelcomeBanner, 1000);
    } else {
      window.addEventListener('load', () => setTimeout(showWelcomeBanner, 1000));
    }

    // Update challenge invites badge
    function updateChallengeInvitesBadge() {
      if (!window.wb1Challenges) {
        window.addEventListener('wb1-challenges-ready', updateChallengeInvitesBadge, { once: true });
        return;
      }

      const pendingInvites = window.wb1Challenges.pendingInvites || [];
      const count = pendingInvites.length;
      const btn = document.getElementById('challenge-invites-btn');
      const badge = document.getElementById('challenge-invite-count');

      if (btn && badge) {
        if (count > 0) {
          btn.style.display = 'flex';
          badge.textContent = count > 9 ? '9+' : count;
        } else {
          btn.style.display = 'none';
        }
      }
    }

    // Listen for invite changes
    window.addEventListener('wb1-invite-sent', updateChallengeInvitesBadge);
    window.addEventListener('wb1-challenge-accepted', updateChallengeInvitesBadge);
    window.addEventListener('wb1-challenge-declined', updateChallengeInvitesBadge);

    // Initialize badge on load
    if (document.readyState === 'complete') {
      updateChallengeInvitesBadge();
    } else {
      window.addEventListener('load', updateChallengeInvitesBadge);
    }
  </script>

  <script>
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('ğŸ”¥ BASE LAYOUT SCRIPT LOADING');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('Timestamp:', new Date().toISOString());
    console.log('Location:', window.location.href);
    console.log('User Agent:', navigator.userAgent);

    // ========================================
    // Core Manager Classes (Vanilla JS)
    // ========================================

    /**
     * WalletManager - Handles Solana wallet connections
     */
    class WalletManager {
      constructor() {
        this.connectedWallet = null;
        this.anonymousWallet = null;
        this.isAnonymous = false;
        this.balance = 0;
        this.network = 'testnet';
        this.connection = null;
      }

      async initialize() {
        // Check for Phantom wallet
        if (typeof window.solanaWeb3 !== 'undefined') {
          this.connection = new window.solanaWeb3.Connection(
            'https://api.testnet.solana.com',
            'confirmed'
          );
        }

        // Check if user has created a wallet (encrypted wallet stored locally)
        if (window.hasWallet && window.hasWallet()) {
          const publicKey = window.getWalletPublicKey();
          if (publicKey) {
            console.log('âœ… Found created wallet:', publicKey);
            this.connectedWallet = publicKey;
            this.isAnonymous = false;
            this.walletType = 'Purple Point Wallet';

            // Track with WB1 User Manager
            if (window.wb1User) {
              window.wb1User.addWalletToHistory(publicKey, 'created');
              window.wb1User.setPrimaryWallet(publicKey);
            }

            this.updateUI();
            await window.progressManager?.loadProgress(publicKey);
            return;
          }
        }

        // Check if already connected to a real wallet (external wallet)
        const savedWallet = localStorage.getItem('connectedWallet');
        if (savedWallet && !savedWallet.startsWith('anon_')) {
          // Track external wallet
          if (window.wb1User) {
            window.wb1User.addWalletToHistory(savedWallet, 'external');
          }
          await this.connect(savedWallet);
          return;
        }

        // No real wallet - create or load anonymous wallet
        await this.ensureAnonymousWallet();
      }

      /**
       * Generate or load anonymous wallet for users without credentials
       * This allows users to start earning XP immediately
       */
      async ensureAnonymousWallet() {
        // Check if anonymous wallet already exists
        let anonWallet = localStorage.getItem('anonymousWallet');

        if (!anonWallet) {
          // Generate new anonymous wallet identifier
          anonWallet = 'anon_' + this.generateRandomId();
          localStorage.setItem('anonymousWallet', anonWallet);
          localStorage.setItem('anonymousWalletCreated', new Date().toISOString());

          console.log('Created new anonymous wallet:', anonWallet);
        }

        this.anonymousWallet = anonWallet;
        this.connectedWallet = anonWallet;
        this.isAnonymous = true;

        // Load progress for anonymous wallet
        await window.progressManager?.loadProgress(anonWallet);

        this.updateUI();
        this.showAnonymousBanner();
      }

      /**
       * Generate a random identifier for anonymous wallets
       */
      generateRandomId() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let id = '';
        for (let i = 0; i < 32; i++) {
          id += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return id;
      }

      /**
       * Show banner informing user they're using an anonymous wallet
       */
      showAnonymousBanner() {
        const existingBanner = document.getElementById('anonymous-wallet-banner');
        if (existingBanner) return; // Already showing

        const banner = document.createElement('div');
        banner.id = 'anonymous-wallet-banner';
        banner.className = 'anonymous-banner';
        banner.innerHTML = `
          <div class="anonymous-banner-content">
            <span class="anonymous-icon">ğŸ‘¤</span>
            <div class="anonymous-text">
              <strong>Anonymous Mode</strong>
              <p>You're earning XP anonymously. Connect a wallet to claim your progress!</p>
            </div>
            <button class="btn-primary btn-sm" onclick="window.walletManager?.promptConnectWallet()">
              Connect Wallet
            </button>
            <button class="btn-close-banner" onclick="this.parentElement.parentElement.remove()">Ã—</button>
          </div>
        `;
        document.body.insertBefore(banner, document.body.firstChild);
      }

      /**
       * Prompt user to connect a real wallet
       */
      promptConnectWallet() {
        // Check if user already has a created wallet
        const hasExistingWallet = window.hasWallet && window.hasWallet();
        if (hasExistingWallet) {
          // Show unlock modal
          if (window.showWalletUnlock) {
            window.showWalletUnlock();
          }
          return;
        }

        // Open security education modal to start wallet creation flow
        const securityModal = document.getElementById('securityEducationModal');
        if (securityModal) {
          securityModal.style.display = 'flex';
          securityModal.style.opacity = '1';
          securityModal.style.visibility = 'visible';
          if (typeof window.showSecurityEducation === 'function') {
            window.showSecurityEducation();
          }
        } else {
          alert('Wallet setup loading... Please refresh the page and try again.');
        }
      }

      async connect(walletAddress = null) {
        console.log('ğŸ”— WalletManager.connect() called with:', walletAddress);
        console.log('Current URL:', window.location.href);

        // Connect wallet logic
        // TODO: Implement full Phantom integration

        if (walletAddress) {
          // Check if user was using anonymous wallet
          const hadAnonymousWallet = this.isAnonymous && this.anonymousWallet;

          if (hadAnonymousWallet) {
            // Offer to claim anonymous wallet data
            const shouldClaim = confirm(
              'You have progress saved anonymously. Would you like to transfer it to this wallet?'
            );

            if (shouldClaim) {
              await this.claimAnonymousWallet(walletAddress);
            }
          }

          this.connectedWallet = walletAddress;
          this.isAnonymous = false;
          localStorage.setItem('connectedWallet', walletAddress);

          console.log('âœ… Wallet connected, updating UI...');
          this.updateUI();

          // Load user data
          console.log('ğŸ“Š Loading progress for wallet...');
          await window.progressManager?.loadProgress(walletAddress);

          console.log('âœ… WalletManager.connect() completed');
          console.log('Final URL:', window.location.href);
          return walletAddress;
        }
      }

      /**
       * Transfer anonymous wallet data to a real wallet
       */
      async claimAnonymousWallet(realWalletAddress) {
        if (!this.anonymousWallet) return;

        try {
          // Get anonymous wallet progress
          const anonProgress = localStorage.getItem(`progress_${this.anonymousWallet}`);

          if (anonProgress) {
            // Save to real wallet
            localStorage.setItem(`progress_${realWalletAddress}`, anonProgress);
            console.log('Claimed anonymous progress for:', realWalletAddress);

            // Show success notification
            window.uiManager?.showXPToast(0, 'Anonymous progress claimed successfully! ğŸ‰');
          }

          // Transfer airdrop balance if exists
          const anonBalance = localStorage.getItem(`airdrop_balance_${this.anonymousWallet}`);
          if (anonBalance) {
            localStorage.setItem(`airdrop_balance_${realWalletAddress}`, anonBalance);
          }

          // Clear anonymous wallet data
          localStorage.removeItem('anonymousWallet');
          localStorage.removeItem('anonymousWalletCreated');

        } catch (error) {
          console.error('Error claiming anonymous wallet:', error);
        }
      }

      disconnect() {
        // Don't fully disconnect - revert to anonymous mode
        this.connectedWallet = null;
        this.balance = 0;
        localStorage.removeItem('connectedWallet');

        // Reinitialize with anonymous wallet
        this.ensureAnonymousWallet();
      }

      updateUI() {
        const connectBtn = document.getElementById('connect-wallet-btn');
        const profileBtn = document.getElementById('profile-btn');
        const xpDisplay = document.getElementById('xp-display');
        const notificationsBtn = document.getElementById('notifications-btn');

        if (this.connectedWallet) {
          // Always show profile and XP for both real and anonymous wallets
          if (this.isAnonymous) {
            connectBtn.style.display = 'block';
            connectBtn.textContent = 'Claim Progress';
            connectBtn.className = 'btn-primary btn-pulse';
          } else {
            connectBtn.style.display = 'none';
          }
          profileBtn.style.display = 'block';
          xpDisplay.style.display = 'flex';
          notificationsBtn.style.display = 'block';
        } else {
          connectBtn.style.display = 'block';
          connectBtn.textContent = 'Connect Wallet';
          connectBtn.className = 'btn-primary';
          profileBtn.style.display = 'none';
          xpDisplay.style.display = 'none';
          notificationsBtn.style.display = 'none';
        }
      }
    }

    /**
     * ProgressManager - Handles user XP, levels, and progression
     */
    class ProgressManager {
      constructor() {
        this.currentProgress = null;
      }

      async loadProgress(walletAddress) {
        // ALWAYS load from localStorage first (instant)
        const cached = localStorage.getItem(`progress_${walletAddress}`);
        if (cached) {
          try {
            this.currentProgress = JSON.parse(cached);
            this.updateUI();
            console.log('Progress loaded from localStorage');
          } catch (error) {
            console.error('Failed to parse cached progress:', error);
            this.currentProgress = this.getDefaultProgress(walletAddress);
            this.updateUI();
          }
        } else {
          // No cached data, create default and save it
          this.currentProgress = this.getDefaultProgress(walletAddress);
          localStorage.setItem(`progress_${walletAddress}`, JSON.stringify(this.currentProgress));
          this.updateUI();
          console.log('New progress created and saved to localStorage');
        }

        // Then sync with API in background (non-blocking)
        this.syncProgressFromAPI(walletAddress);
      }

      async syncProgressFromAPI(walletAddress) {
        // Skip API sync for anonymous/test wallets - they only use localStorage
        if (walletAddress?.startsWith('anon_') || walletAddress?.startsWith('TEST_WALLET_')) {
          console.log('ğŸ“ Anonymous wallet detected - using local storage only');
          return;
        }

        try {
          const response = await fetch(
            `/api/gamification/user-progress?walletAddress=${walletAddress}`
          );

          if (response.ok) {
            const data = await response.json();

            if (data.success) {
              // Update if server data is newer/different
              const serverXP = data.progression?.totalXP || 0;
              const localXP = this.currentProgress?.progression?.totalXP || 0;

              if (serverXP > localXP) {
                console.log('Server has newer progress, updating local cache');
                this.currentProgress = data;
                localStorage.setItem(`progress_${walletAddress}`, JSON.stringify(data));
                this.updateUI();
              } else if (localXP > serverXP) {
                console.log('Local progress is ahead of server, will sync on next XP award');
              } else {
                console.log('Progress is in sync');
              }
            }
          } else {
            console.log('API sync unavailable, using local data');
          }
        } catch (error) {
          console.log('API sync error (using local data):', error.message);
        }
      }

      getDefaultProgress(walletAddress) {
        return {
          success: true,
          progression: {
            currentLevel: 1,
            totalXP: 0,
            lifeStage: 'egg',
            animalMentor: 'chicken',
            nextLevel: {
              level: 2,
              xpNeeded: 100,
              percentComplete: 0
            }
          },
          user: {
            wallet_address: walletAddress,
            username: 'User_' + walletAddress.substring(0, 6),
            created_at: new Date().toISOString()
          },
          music: {
            publishedTracks: 0,
            battles: { total: 0, wins: 0, losses: 0, winRate: 0 }
          },
          environmental: {
            coursesCompleted: 0,
            projectsParticipated: 0
          },
          kakumaImpact: {
            youthImpacted: 0,
            totalActions: 0,
            valueGenerated: 0
          },
          achievements: { total: 0, unlocked: [] },
          recentActivity: [],
          dailyWisdom: {
            topic: 'Getting Started',
            wisdom_text: 'Welcome to WorldBridger One! Connect and explore.'
          }
        };
      }

      updateUI() {
        if (!this.currentProgress) return;

        const { progression } = this.currentProgress;
        
        // Update header XP display
        document.getElementById('current-xp').textContent = progression.totalXP;
        document.getElementById('current-level').textContent = progression.currentLevel;
      }

      async awardXP(amount, activityType, description) {
        const walletAddress = window.walletManager?.connectedWallet;
        if (!walletAddress) return;

        // ALWAYS award XP to localStorage first (instant, offline-capable)
        this.awardXPLocally(walletAddress, amount, activityType, description);

        // Then try to sync to API in background (non-blocking)
        this.syncXPToAPI(walletAddress, amount, activityType, description);
      }

      async syncXPToAPI(walletAddress, amount, activityType, description) {
        try {
          const response = await fetch('/api/gamification/award-xp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              walletAddress,
              xpAmount: amount,
              activityType,
              description
            })
          });

          if (response.ok) {
            const data = await response.json();

            if (data.success) {
              console.log('XP synced to database successfully');

              // Check for server-side achievements that localStorage might have missed
              if (data.achievementsUnlocked?.length > 0) {
                console.log('New achievements unlocked:', data.achievementsUnlocked);
                window.uiManager?.showAchievementModal(data.achievementsUnlocked[0]);
              }
            }
          } else {
            console.log('API sync failed, XP saved locally only');
          }
        } catch (error) {
          console.log('API sync error (XP already saved locally):', error.message);
        }
      }

      awardXPLocally(walletAddress, amount, activityType, description) {
        // Get current progress from localStorage or create default
        let progress = this.currentProgress || this.getDefaultProgress(walletAddress);

        // Update XP
        const oldXP = progress.progression.totalXP;
        const oldLevel = progress.progression.currentLevel;
        const newXP = oldXP + amount;

        // Calculate new level (simple formula: level = floor(sqrt(xp / 100)) + 1)
        const newLevel = Math.min(120, Math.floor(Math.sqrt(newXP / 100)) + 1);
        const leveledUp = newLevel > oldLevel;

        // Update progression
        progress.progression.totalXP = newXP;
        progress.progression.currentLevel = newLevel;

        // Update life stage
        if (newLevel >= 76) {
          progress.progression.lifeStage = 'elder';
          progress.progression.animalMentor = 'rabbit';
        } else if (newLevel >= 51) {
          progress.progression.lifeStage = 'adult';
          progress.progression.animalMentor = 'dog';
        } else if (newLevel >= 26) {
          progress.progression.lifeStage = 'juvenile';
          progress.progression.animalMentor = 'pigeon';
        } else if (newLevel >= 11) {
          progress.progression.lifeStage = 'chick';
          progress.progression.animalMentor = 'goat';
        }

        // Calculate next level progress
        const currentLevelXP = newLevel * 100;
        const nextLevelXP = (newLevel + 1) * 100;
        const xpNeeded = nextLevelXP - currentLevelXP;
        const progressXP = newXP - currentLevelXP;
        progress.progression.nextLevel = {
          level: newLevel + 1,
          xpNeeded: xpNeeded,
          percentComplete: Math.round((progressXP / xpNeeded) * 100)
        };

        // Add to recent activity
        if (!progress.recentActivity) progress.recentActivity = [];
        progress.recentActivity.unshift({
          activity_type: activityType,
          description: description,
          xp_earned: amount,
          created_at: new Date().toISOString()
        });
        progress.recentActivity = progress.recentActivity.slice(0, 10); // Keep last 10

        // Save to localStorage
        localStorage.setItem(`progress_${walletAddress}`, JSON.stringify(progress));
        this.currentProgress = progress;
        this.updateUI();

        // Show XP toast
        window.uiManager?.showXPToast({
          xp: { earned: amount, total: newXP },
          level: { current: newLevel, leveledUp: leveledUp }
        });

        // Show level up modal if leveled up
        if (leveledUp) {
          window.uiManager?.showLevelUpModal({
            level: { current: newLevel },
            progression: progress.progression
          });
        }
      }
    }

    /**
     * UIManager - Handles UI interactions, modals, toasts
     */
    class UIManager {
      showXPToast(data) {
        const toast = document.getElementById('xp-toast');
        toast.innerHTML = `
          <div class="xp-earned">+${data.xp.earned} XP</div>
          ${data.level.leveledUp ? `<div class="level-up-mini">Level ${data.level.current}!</div>` : ''}
        `;
        toast.style.display = 'block';
        
        setTimeout(() => {
          toast.style.display = 'none';
        }, 3000);
      }

      showLevelUpModal(data) {
        const modal = document.getElementById('levelup-modal');
        document.getElementById('new-level').textContent = data.level.current;
        document.getElementById('levelup-number').textContent = data.level.current;
        document.getElementById('levelup-stage').textContent = data.progression.lifeStage;
        document.getElementById('new-mentor').textContent = this.getMentorEmoji(data.progression.animalMentor);
        document.getElementById('mentor-name').textContent = this.getMentorName(data.progression.animalMentor);
        document.getElementById('mentor-description').textContent = this.getMentorDescription(data.progression.animalMentor);
        
        modal.style.display = 'flex';
      }

      closeLevelUpModal() {
        document.getElementById('levelup-modal').style.display = 'none';
      }

      showAchievementModal(achievement) {
        const modal = document.getElementById('achievement-modal');
        // TODO: Populate achievement data
        modal.style.display = 'flex';
      }

      closeAchievementModal() {
        document.getElementById('achievement-modal').style.display = 'none';
      }

      closeNotifications() {
        document.getElementById('notifications-panel').style.display = 'none';
      }

      getMentorEmoji(type) {
        const emojis = {
          chicken: 'ğŸ“', cat: 'ğŸ±', goat: 'ğŸ',
          pigeon: 'ğŸ•Šï¸', dog: 'ğŸ•', rabbit: 'ğŸ°'
        };
        return emojis[type] || 'ğŸ“';
      }

      getMentorName(type) {
        const names = {
          chicken: 'Chicken', cat: 'Cat', goat: 'Goat',
          pigeon: 'Pigeon', dog: 'Dog', rabbit: 'Rabbit'
        };
        return names[type] || 'Chicken';
      }


  showSamplerModal() {
  const modal = document.getElementById('sampler-modal');
  if (modal) {
    modal.style.display = 'flex';
    
    // RE-INIT CHECK: If the grid is empty, force the controller to build pads
    const grid = document.getElementById('sampler-pad-grid');
    if (grid && grid.children.length === 0 && window.samplerPadController) {
      window.samplerPadController.generatePads();
    }
    
    // Audio Resume
    if (window.samplerPadController?.audioContext?.state === 'suspended') {
      window.samplerPadController.audioContext.resume();
    }
  }
}

   closeSamplerModal() {
    const modal = document.getElementById('sampler-modal');
    if (modal) modal.style.display = 'none';
  }




      getMentorDescription(type) {
        const descriptions = {
          chicken: 'Master of foundations and community building',
          cat: 'Guide of independence and creative flow',
          goat: 'Teacher of resourcefulness and adaptability',
          pigeon: 'Expert in communication and networking',
          dog: 'Leader of loyalty and community protection',
          rabbit: 'Master of rapid growth and multiplication'
        };
        return descriptions[type] || '';
      }
    }

    // ========================================
    // Initialize Managers
    // ========================================
    window.walletManager = new WalletManager();
    window.progressManager = new ProgressManager();
    window.uiManager = new UIManager();

    // Initialize on page load - using astro:page-load for proper Astro view transition support
    let isInitialized = false;
    const initializeWalletButton = async () => {
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('ğŸ¯ initializeWalletButton CALLED');
      console.log('Time:', new Date().toISOString());
      console.log('isInitialized:', isInitialized);
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

      if (isInitialized) {
        console.log('â­ï¸ Already initialized, skipping...');
        return;
      }
      isInitialized = true;

      console.log('ğŸš€ Page Load - Initializing UI components');
      console.log('Wallet Manager:', window.walletManager);
      await window.walletManager.initialize();
      console.log('âœ… Wallet Manager initialized');

      // Connect wallet button
      const connectBtn = document.getElementById('connect-wallet-btn');
      console.log('ğŸ” Connect wallet button found:', connectBtn ? 'YES' : 'NO');

      if (connectBtn) {
        console.log('ğŸ”— Adding click listener to connect button');

        // Remove any existing listeners to prevent duplicates
        const newConnectBtn = connectBtn.cloneNode(true);
        connectBtn.parentNode.replaceChild(newConnectBtn, connectBtn);

        newConnectBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          e.stopPropagation();

          console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
          console.log('ğŸ”˜ WALLET CONNECT BUTTON CLICKED');
          console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
          console.log('Timestamp:', new Date().toISOString());
          console.log('Button element:', newConnectBtn);

          try {
            // Check if already has wallet using the proper wallet detection
            const hasExistingWallet = window.hasWallet && window.hasWallet();
            if (hasExistingWallet) {
              console.log('â„¹ï¸ Wallet already exists, showing unlock modal...');
              // Show unlock modal for existing wallet
              if (window.showWalletUnlock) {
                window.showWalletUnlock();
              } else {
                console.error('Unlock modal not loaded');
                alert('Wallet unlock loading... Please refresh and try again.');
              }
              return;
            }

            // Open security education modal to start wallet creation flow
            console.log('ğŸ” Looking for security education modal...');
            const securityModal = document.getElementById('securityEducationModal');
            console.log('Modal element:', securityModal);

            if (securityModal) {
              console.log('âœ… Modal found! Opening...');
              console.log('Current display style:', securityModal.style.display);

              // Force modal to display
              securityModal.style.display = 'flex';
              securityModal.style.opacity = '1';
              securityModal.style.visibility = 'visible';
              securityModal.style.zIndex = '9999';

              console.log('New display style:', securityModal.style.display);
              console.log('ğŸ“š Step 1/5: Security Education');

              // Initialize the education flow if function exists
              if (typeof window.showSecurityEducation === 'function') {
                console.log('Calling showSecurityEducation()');
                window.showSecurityEducation();
              } else {
                console.warn('showSecurityEducation function not found');
              }
            } else {
              console.error('âŒ Security education modal not found in DOM');
              console.log('Searching for modals...');
              const allModals = {
                security: document.getElementById('securityEducationModal'),
                recovery: document.getElementById('recoveryPhraseModal'),
                verification: document.getElementById('recoveryVerificationModal'),
                pin: document.getElementById('pinSetupModal')
              };
              console.log('Available modals:', allModals);

              // Fallback: Create a test wallet
              console.log('Using fallback: creating test wallet');
              alert('Wallet security setup is loading. Creating a test wallet for now.');
              const testWallet = 'TEST_WALLET_' + Date.now();
              await window.walletManager.connect(testWallet);
            }
          } catch (error) {
            console.error('âŒ Error in wallet connect handler:', error);
            console.error('Stack trace:', error.stack);
            alert('An error occurred. Please check the console for details.');
          }
        });

        console.log('âœ… Click listener attached successfully');
      } else {
        console.error('âŒ Connect wallet button not found in DOM!');
        console.log('Attempting to find button by class or text...');
        const allButtons = document.querySelectorAll('button');
        console.log('All buttons on page:', allButtons.length);
        allButtons.forEach((btn, i) => {
          console.log(`Button ${i}:`, btn.textContent, btn.id, btn.className);
        });
      }

      // Profile button
      document.getElementById('profile-btn')?.addEventListener('click', () => {
        window.location.href = '/profile';
      });

      // Notifications button
      document.getElementById('notifications-btn')?.addEventListener('click', () => {
        document.getElementById('notifications-panel').style.display = 'block';
      });

      // Theme Switcher
      const themeToggle = document.getElementById('theme-toggle');
      const themeDarkIcon = document.querySelector('.theme-icon-dark');
      const themeLightIcon = document.querySelector('.theme-icon-light');

      // Load saved theme
      const savedTheme = localStorage.getItem('theme') || 'dark';
      if (savedTheme === 'light') {
        document.body.classList.add('light-theme');
        themeDarkIcon.style.display = 'none';
        themeLightIcon.style.display = 'inline-block';
      }

      themeToggle?.addEventListener('click', (e) => {
        console.log('ğŸ¨ Theme toggle clicked');
        document.body.classList.toggle('light-theme');
        const isLight = document.body.classList.contains('light-theme');

        // Toggle icons
        themeDarkIcon.style.display = isLight ? 'none' : 'inline-block';
        themeLightIcon.style.display = isLight ? 'inline-block' : 'none';

        // Save preference
        localStorage.setItem('theme', isLight ? 'light' : 'dark');
        console.log('âœ… Theme changed to:', isLight ? 'light' : 'dark');
      });

      // Language Switcher
      const languageBtn = document.getElementById('language-btn');
      const languageDropdown = document.getElementById('language-dropdown');
      const languageCode = document.getElementById('current-language');
      const languageOptions = document.querySelectorAll('.language-option');

      // Load saved language
      const savedLang = localStorage.getItem('language') || 'en';
      languageCode.textContent = savedLang.toUpperCase();

      // Mark active language
      languageOptions.forEach(option => {
        if (option.dataset.lang === savedLang) {
          option.classList.add('active');
        }
      });

      // Toggle dropdown
      languageBtn?.addEventListener('click', (e) => {
        e.stopPropagation();
        const isVisible = languageDropdown.style.display === 'block';
        languageDropdown.style.display = isVisible ? 'none' : 'block';
      });

      // Language selection
      languageOptions.forEach(option => {
        option.addEventListener('click', () => {
          const lang = option.dataset.lang;

          // Update UI
          languageCode.textContent = lang.toUpperCase();

          // Update active state
          languageOptions.forEach(opt => opt.classList.remove('active'));
          option.classList.add('active');

          // Save preference
          localStorage.setItem('language', lang);

          // Close dropdown
          languageDropdown.style.display = 'none';

          // TODO: Actually translate the page
          console.log(`Language changed to: ${lang}`);
        });
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!languageBtn?.contains(e.target) && !languageDropdown?.contains(e.target)) {
          languageDropdown.style.display = 'none';
        }
      });

      // Dropdown menus - close on click outside
      document.addEventListener('click', (e) => {
        const dropdowns = document.querySelectorAll('.nav-dropdown');
        dropdowns.forEach(dropdown => {
          if (!dropdown.contains(e.target)) {
            const menu = dropdown.querySelector('.nav-dropdown-menu');
            const btn = dropdown.querySelector('.nav-dropdown-btn');
            if (menu) {
              menu.style.display = 'none';
              btn?.classList.remove('active');
            }
          }
        });
      });

      // Dropdown buttons - toggle on click (for mobile/touch)
      document.querySelectorAll('.nav-dropdown-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const dropdown = btn.closest('.nav-dropdown');
          const menu = dropdown.querySelector('.nav-dropdown-menu');
          const isOpen = menu.style.display === 'block';

          // Close all dropdowns and remove active class
          document.querySelectorAll('.nav-dropdown-menu').forEach(m => {
            m.style.display = 'none';
          });
          document.querySelectorAll('.nav-dropdown-btn').forEach(b => {
            b.classList.remove('active');
          });

          // Toggle current dropdown
          if (!isOpen) {
            menu.style.display = 'block';
            btn.classList.add('active');
            console.log('Dropdown opened:', btn.textContent.trim());
          }
        });
      });

      // Mobile menu
      document.getElementById('mobile-menu-toggle')?.addEventListener('click', () => {
        document.querySelector('.nav-menu')?.classList.toggle('active');
      });
    };

    // Call initialization on both Astro page load (for view transitions) and DOMContentLoaded (for direct loads)
    document.addEventListener('astro:page-load', initializeWalletButton);
    document.addEventListener('DOMContentLoaded', initializeWalletButton);
  </script>
</body>
</html>
