---
/**
 * BaseLayout.astro
 * Central template for all pages in the Hobby Farm Gamification System
 * 
 * Props:
 * - title: Page title
 * - description: Meta description
 * - includeMusicPlayer: Boolean to include music player component
 * - activeSection: String for navigation highlighting
 */

interface Props {
  title: string;
  description?: string;
  includeMusicPlayer?: boolean;
  activeSection?: string;
}

const { 
  title, 
  description = "Hobby Farm NFT Collection - Music, Environmental Science & Kakuma Youth Empowerment",
  includeMusicPlayer = false,
  activeSection = 'home'
} = Astro.props;

const currentYear = new Date().getFullYear();
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content={description}>
  <title>{title} | Hobby Farm Gamification</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  
  <!-- Preconnect to external resources -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  
  <!-- Local CSS (emulated Tailwind + custom) -->
  <link rel="stylesheet" href="/styles/global.css">
  <link rel="stylesheet" href="/styles/gamification.css">
  
  <!-- Web3 Dependencies (Solana) -->
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
</head>

<body class="bg-gradient-farm font-sans">
  
  <!-- ============================================ -->
  <!-- HEADER & NAVIGATION -->
  <!-- ============================================ -->
  <header class="header-main">
    <div class="container mx-auto">
      <nav class="nav-primary">
        
        <!-- Logo -->
        <div class="nav-logo">
          <a href="/">
            <span class="logo-icon">üåæ</span>
            <span class="logo-text">Hobby Farm</span>
          </a>
        </div>

        <!-- Main Navigation -->
        <ul class="nav-menu">
          <li class={activeSection === 'home' ? 'active' : ''}>
            <a href="/">Collection</a>
          </li>
          <li class={activeSection === 'progress' ? 'active' : ''}>
            <a href="/progress">
              <span class="nav-icon">üìä</span>
              <span>Progress</span>
            </a>
          </li>
          <li class={activeSection === 'music' ? 'active' : ''}>
            <a href="/music">
              <span class="nav-icon">üéµ</span>
              <span>Music Studio</span>
            </a>
          </li>
          <li class={activeSection === 'learning' ? 'active' : ''}>
            <a href="/learning">
              <span class="nav-icon">üåç</span>
              <span>Learning Hub</span>
            </a>
          </li>
          <li class={activeSection === 'kakuma' ? 'active' : ''}>
            <a href="/kakuma">
              <span class="nav-icon">üèïÔ∏è</span>
              <span>Kakuma Impact</span>
            </a>
          </li>
          <li class={activeSection === 'leaderboard' ? 'active' : ''}>
            <a href="/leaderboard">
              <span class="nav-icon">üèÜ</span>
              <span>Leaderboard</span>
            </a>
          </li>
        </ul>

        <!-- User Actions -->
        <div class="nav-actions">
          <!-- XP Display (shown when logged in) -->
          <div id="xp-display" class="xp-badge" style="display: none;">
            <span class="xp-icon">‚≠ê</span>
            <span id="current-xp">0</span> XP
            <span class="level-badge">
              Lvl <span id="current-level">1</span>
            </span>
          </div>

          <!-- Notifications -->
          <button id="notifications-btn" class="btn-icon" style="display: none;">
            <span class="notification-icon">üîî</span>
            <span id="notification-count" class="badge-count">0</span>
          </button>

          <!-- Profile Button -->
          <button id="profile-btn" class="btn-secondary" style="display: none;">
            <span id="profile-username">Profile</span>
          </button>

          <!-- Connect Wallet Button -->
          <button id="connect-wallet-btn" class="btn-primary">
            Connect Wallet
          </button>
        </div>

        <!-- Mobile Menu Toggle -->
        <button id="mobile-menu-toggle" class="btn-mobile-menu">
          <span class="hamburger-icon">‚ò∞</span>
        </button>
      </nav>
    </div>
  </header>

  <!-- ============================================ -->
  <!-- MAIN CONTENT -->
  <!-- ============================================ -->
  <main class="main-content">
    <slot />
  </main>

  <!-- ============================================ -->
  <!-- FOOTER -->
  <!-- ============================================ -->
  <footer class="footer-main">
    <div class="container mx-auto">
      <div class="footer-grid">
        
        <!-- About Section -->
        <div class="footer-section">
          <h3>WorldBridger One</h3>
          <p>
            Empowering artists and communities through music, environmental science, 
            and gamified learning. Supporting Kakuma refugee camp youth.
          </p>
          <div class="social-links">
            <a href="#" class="social-link">Twitter</a>
            <a href="#" class="social-link">Discord</a>
            <a href="#" class="social-link">GitHub</a>
          </div>
        </div>

        <!-- Quick Links -->
        <div class="footer-section">
          <h4>Platform</h4>
          <ul class="footer-links">
            <li><a href="/progress">Your Progress</a></li>
            <li><a href="/music">Music Studio</a></li>
            <li><a href="/learning">Learning Hub</a></li>
            <li><a href="/kakuma">Kakuma Projects</a></li>
          </ul>
        </div>

        <!-- Resources -->
        <div class="footer-section">
          <h4>Resources</h4>
          <ul class="footer-links">
            <li><a href="/docs">Documentation</a></li>
            <li><a href="/courses">All Courses</a></li>
            <li><a href="/achievements">Achievements</a></li>
            <li><a href="/api-docs">API Reference</a></li>
          </ul>
        </div>

        <!-- Support -->
        <div class="footer-section">
          <h4>Support</h4>
          <ul class="footer-links">
            <li><a href="/help">Help Center</a></li>
            <li><a href="/contact">Contact Us</a></li>
            <li><a href="/kakuma-support">Kakuma Support</a></li>
            <li><a href="/feedback">Give Feedback</a></li>
          </ul>
        </div>
      </div>

      <!-- Footer Bottom -->
      <div class="footer-bottom">
        <p class="copyright">
          ¬© {currentYear} WorldBridger One. Built by Mupy for POREFPC & Kakuma.
          <a href="/license">GPL-3.0 License</a>
        </p>
        <div class="footer-badges">
          <span class="badge">üåæ Open Source</span>
          <span class="badge">üåç For Good</span>
          <span class="badge">üéµ Music + Science</span>
        </div>
      </div>
    </div>
  </footer>

  <!-- ============================================ -->
  <!-- MODALS & OVERLAYS -->
  <!-- ============================================ -->
  
  <!-- Notifications Panel -->
  <div id="notifications-panel" class="panel-overlay" style="display: none;">
    <div class="panel-content">
      <div class="panel-header">
        <h3>Notifications</h3>
        <button class="btn-close" onclick="window.uiManager?.closeNotifications()">√ó</button>
      </div>
      <div id="notifications-list" class="notifications-list">
        <!-- Notifications will be loaded here -->
      </div>
    </div>
  </div>

  <!-- XP Notification Toast -->
  <div id="xp-toast" class="xp-toast" style="display: none;">
    <!-- XP notifications appear here -->
  </div>

  <!-- Achievement Unlock Modal -->
  <div id="achievement-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content achievement-modal">
      <div class="achievement-animation">
        <div class="achievement-badge" id="achievement-badge">üèÜ</div>
      </div>
      <h2>Achievement Unlocked!</h2>
      <h3 id="achievement-name"></h3>
      <p id="achievement-description"></p>
      <div class="achievement-reward">
        <span id="achievement-xp">+0 XP</span>
      </div>
      <button class="btn-primary" onclick="window.uiManager?.closeAchievementModal()">
        Awesome!
      </button>
    </div>
  </div>

  <!-- Level Up Modal -->
  <div id="levelup-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content levelup-modal">
      <div class="levelup-animation">
        <div class="level-number" id="new-level">2</div>
        <div class="mentor-change" id="new-mentor">üêì</div>
      </div>
      <h2>Level Up!</h2>
      <h3>You've reached Level <span id="levelup-number">2</span></h3>
      <p id="levelup-stage">Egg Stage</p>
      <div class="mentor-info">
        <h4>Your Mentor: <span id="mentor-name">Chicken</span></h4>
        <p id="mentor-description">Master of foundations and community building</p>
      </div>
      <button class="btn-primary" onclick="window.uiManager?.closeLevelUpModal()">
        Continue Journey
      </button>
    </div>
  </div>

  <!-- Optional Music Player Component -->
  {includeMusicPlayer && (
    <div id="music-player" class="music-player-fixed">
      <!-- Music player will be rendered here -->
    </div>
  )}

  <!-- ============================================ -->
  <!-- CORE JAVASCRIPT CLASSES -->
  <!-- ============================================ -->
  <script>
    // ========================================
    // Core Manager Classes (Vanilla JS)
    // ========================================

    /**
     * WalletManager - Handles Solana wallet connections
     */
    class WalletManager {
      constructor() {
        this.connectedWallet = null;
        this.balance = 0;
        this.network = 'testnet';
        this.connection = null;
      }

      async initialize() {
        // Check for Phantom wallet
        if (typeof window.solanaWeb3 !== 'undefined') {
          this.connection = new window.solanaWeb3.Connection(
            'https://api.testnet.solana.com',
            'confirmed'
          );
        }
        
        // Check if already connected
        const savedWallet = localStorage.getItem('connectedWallet');
        if (savedWallet) {
          await this.connect(savedWallet);
        }
      }

      async connect(walletAddress = null) {
        // Connect wallet logic
        // TODO: Implement full Phantom integration
        
        if (walletAddress) {
          this.connectedWallet = walletAddress;
          localStorage.setItem('connectedWallet', walletAddress);
          this.updateUI();
          
          // Load user data
          await window.progressManager?.loadProgress(walletAddress);
          
          return walletAddress;
        }
      }

      disconnect() {
        this.connectedWallet = null;
        this.balance = 0;
        localStorage.removeItem('connectedWallet');
        this.updateUI();
      }

      updateUI() {
        const connectBtn = document.getElementById('connect-wallet-btn');
        const profileBtn = document.getElementById('profile-btn');
        const xpDisplay = document.getElementById('xp-display');
        const notificationsBtn = document.getElementById('notifications-btn');

        if (this.connectedWallet) {
          connectBtn.style.display = 'none';
          profileBtn.style.display = 'block';
          xpDisplay.style.display = 'flex';
          notificationsBtn.style.display = 'block';
        } else {
          connectBtn.style.display = 'block';
          profileBtn.style.display = 'none';
          xpDisplay.style.display = 'none';
          notificationsBtn.style.display = 'none';
        }
      }
    }

    /**
     * ProgressManager - Handles user XP, levels, and progression
     */
    class ProgressManager {
      constructor() {
        this.currentProgress = null;
      }

      async loadProgress(walletAddress) {
        try {
          const response = await fetch(
            `/api/gamification/user-progress?walletAddress=${walletAddress}`
          );
          const data = await response.json();
          
          if (data.success) {
            this.currentProgress = data;
            this.updateUI();
          }
        } catch (error) {
          console.error('Failed to load progress:', error);
        }
      }

      updateUI() {
        if (!this.currentProgress) return;

        const { progression } = this.currentProgress;
        
        // Update header XP display
        document.getElementById('current-xp').textContent = progression.totalXP;
        document.getElementById('current-level').textContent = progression.currentLevel;
      }

      async awardXP(amount, activityType, description) {
        const walletAddress = window.walletManager?.connectedWallet;
        if (!walletAddress) return;

        try {
          const response = await fetch('/api/gamification/award-xp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              walletAddress,
              xpAmount: amount,
              activityType,
              description
            })
          });

          const data = await response.json();
          
          if (data.success) {
            // Show XP toast
            window.uiManager?.showXPToast(data);
            
            // Check for level up
            if (data.level.leveledUp) {
              window.uiManager?.showLevelUpModal(data);
            }
            
            // Check for achievements
            if (data.achievementsUnlocked?.length > 0) {
              window.uiManager?.showAchievementModal(data.achievementsUnlocked[0]);
            }
            
            // Reload progress
            await this.loadProgress(walletAddress);
          }
        } catch (error) {
          console.error('Failed to award XP:', error);
        }
      }
    }

    /**
     * UIManager - Handles UI interactions, modals, toasts
     */
    class UIManager {
      showXPToast(data) {
        const toast = document.getElementById('xp-toast');
        toast.innerHTML = `
          <div class="xp-earned">+${data.xp.earned} XP</div>
          ${data.level.leveledUp ? `<div class="level-up-mini">Level ${data.level.current}!</div>` : ''}
        `;
        toast.style.display = 'block';
        
        setTimeout(() => {
          toast.style.display = 'none';
        }, 3000);
      }

      showLevelUpModal(data) {
        const modal = document.getElementById('levelup-modal');
        document.getElementById('new-level').textContent = data.level.current;
        document.getElementById('levelup-number').textContent = data.level.current;
        document.getElementById('levelup-stage').textContent = data.progression.lifeStage;
        document.getElementById('new-mentor').textContent = this.getMentorEmoji(data.progression.animalMentor);
        document.getElementById('mentor-name').textContent = this.getMentorName(data.progression.animalMentor);
        document.getElementById('mentor-description').textContent = this.getMentorDescription(data.progression.animalMentor);
        
        modal.style.display = 'flex';
      }

      closeLevelUpModal() {
        document.getElementById('levelup-modal').style.display = 'none';
      }

      showAchievementModal(achievement) {
        const modal = document.getElementById('achievement-modal');
        // TODO: Populate achievement data
        modal.style.display = 'flex';
      }

      closeAchievementModal() {
        document.getElementById('achievement-modal').style.display = 'none';
      }

      closeNotifications() {
        document.getElementById('notifications-panel').style.display = 'none';
      }

      getMentorEmoji(type) {
        const emojis = {
          chicken: 'üêì', cat: 'üê±', goat: 'üêê',
          pigeon: 'üïäÔ∏è', dog: 'üêï', rabbit: 'üê∞'
        };
        return emojis[type] || 'üêì';
      }

      getMentorName(type) {
        const names = {
          chicken: 'Chicken', cat: 'Cat', goat: 'Goat',
          pigeon: 'Pigeon', dog: 'Dog', rabbit: 'Rabbit'
        };
        return names[type] || 'Chicken';
      }

      getMentorDescription(type) {
        const descriptions = {
          chicken: 'Master of foundations and community building',
          cat: 'Guide of independence and creative flow',
          goat: 'Teacher of resourcefulness and adaptability',
          pigeon: 'Expert in communication and networking',
          dog: 'Leader of loyalty and community protection',
          rabbit: 'Master of rapid growth and multiplication'
        };
        return descriptions[type] || '';
      }
    }

    // ========================================
    // Initialize Managers
    // ========================================
    window.walletManager = new WalletManager();
    window.progressManager = new ProgressManager();
    window.uiManager = new UIManager();

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async () => {
      await window.walletManager.initialize();
      
      // Connect wallet button
      document.getElementById('connect-wallet-btn')?.addEventListener('click', async () => {
        // TODO: Implement full wallet connection
        const testWallet = 'TEST_WALLET_' + Date.now();
        await window.walletManager.connect(testWallet);
      });

      // Profile button
      document.getElementById('profile-btn')?.addEventListener('click', () => {
        window.location.href = '/profile';
      });

      // Notifications button
      document.getElementById('notifications-btn')?.addEventListener('click', () => {
        document.getElementById('notifications-panel').style.display = 'block';
      });

      // Mobile menu
      document.getElementById('mobile-menu-toggle')?.addEventListener('click', () => {
        document.querySelector('.nav-menu')?.classList.toggle('active');
      });
    });
  </script>
</body>
</html>
