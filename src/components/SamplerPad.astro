---
/**
 * SamplerPad.astro
 * Reusable sampler pad component for music creation
 * Can be used standalone, in overlays, or integrated with battles
 *
 * Props:
 * - minimal: Boolean - show minimal text (just numbers, no labels)
 * - battleMode: Boolean - enable battle submission features
 * - overlayMode: Boolean - optimized for overlay display
 */

interface Props {
  minimal?: boolean;
  battleMode?: boolean;
  overlayMode?: boolean;
}

const {
  minimal = false,
  battleMode = false,
  overlayMode = false
} = Astro.props;
---

<div class="sampler-pad-container" data-minimal={minimal} data-battle-mode={battleMode} data-overlay-mode={overlayMode}>
  <div class="sampler-header">
    {!minimal && <h2>üéõÔ∏è Sampler Pads</h2>}
    {battleMode && (
      <div class="battle-indicator">
        <span class="battle-icon">‚öîÔ∏è</span>
        <span>Battle Mode</span>
      </div>
    )}
  </div>

  <div class="pad-grid" id="sampler-pad-grid">
    <!-- Pads will be generated by JavaScript -->
  </div>

  <div class="sampler-controls">
    {!minimal && (
      <div class="control-group">
        <label for="master-volume">Volume</label>
        <input type="range" id="master-volume" min="0" max="100" value="70" />
        <span id="volume-display">70%</span>
      </div>
    )}
    <div class="control-actions">
      <button class="btn-clear" id="clear-pattern">Clear</button>
      {battleMode && (
        <button class="btn-submit" id="submit-battle">Submit to Battle</button>
      )}
      <button class="btn-record" id="toggle-record">
        <span class="record-icon">‚è∫</span>
        <span class="record-label">Record</span>
      </button>
    </div>
  </div>
</div>

<style define:vars={{ minimal, overlayMode }}>
  .sampler-pad-container {
    background: linear-gradient(135deg, #0e1117 0%, #161b22 100%);
    border-radius: 12px;
    padding: 1.5rem;
    color: #e6edf3;
    max-width: 100%;
  }

  .sampler-pad-container[data-overlay-mode="true"] {
    background: #0e1117;
    border: 2px solid #30363d;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
  }

  .sampler-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .sampler-header h2 {
    margin: 0;
    font-size: 1.75rem;
    font-weight: 600;
    background: linear-gradient(135deg, #58a6ff, #7c3aed);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .battle-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(239, 68, 68, 0.2);
    padding: 0.5rem 1rem;
    border-radius: 8px;
    border: 1px solid #ef4444;
    font-weight: 600;
    font-size: 0.875rem;
  }

  .battle-icon {
    font-size: 1.25rem;
  }

  .pad-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }

  .sampler-pad-container[data-minimal="true"] .pad-grid {
    gap: 0.5rem;
  }

  .sampler-pad-container[data-overlay-mode="true"] .pad-grid {
    gap: 1rem;
  }

  :global(.pad) {
    aspect-ratio: 1;
    background: linear-gradient(135deg, #1a1f26 0%, #0d1117 100%);
    border: 2px solid #30363d;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.1s ease;
    position: relative;
    overflow: hidden;
    user-select: none;
  }

  :global(.pad:hover) {
    border-color: #58a6ff;
    transform: scale(1.02);
  }

  :global(.pad.active) {
    background: linear-gradient(135deg, #58a6ff 0%, #7c3aed 100%);
    border-color: #58a6ff;
    box-shadow: 0 0 20px rgba(88, 166, 255, 0.5);
    transform: scale(0.95);
  }

  :global(.pad-number) {
    font-size: 1.5rem;
    font-weight: bold;
    color: #58a6ff;
    margin-bottom: 0.25rem;
  }

  .sampler-pad-container[data-minimal="false"] :global(.pad-number) {
    font-size: 1.75rem;
  }

  :global(.pad-label) {
    font-size: 0.75rem;
    color: #8b949e;
    text-align: center;
    opacity: 1;
    transition: opacity 0.2s;
  }

  .sampler-pad-container[data-minimal="true"] :global(.pad-label) {
    display: none;
  }

  :global(.pad-freq) {
    position: absolute;
    bottom: 4px;
    right: 6px;
    font-size: 0.625rem;
    color: #7c3aed;
    opacity: 0.7;
  }

  .sampler-pad-container[data-minimal="true"] :global(.pad-freq) {
    display: none;
  }

  :global(.pad-recording) {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 8px;
    height: 8px;
    background: #ef4444;
    border-radius: 50%;
    animation: pulse-record 1s infinite;
  }

  @keyframes pulse-record {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  .sampler-controls {
    display: flex;
    gap: 1rem;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
  }

  .control-group {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex: 1;
    min-width: 200px;
  }

  .control-group label {
    font-size: 0.875rem;
    color: #8b949e;
    font-weight: 500;
  }

  .control-group input[type="range"] {
    flex: 1;
    max-width: 150px;
  }

  #volume-display {
    font-size: 0.875rem;
    color: #58a6ff;
    font-weight: 600;
    min-width: 40px;
  }

  .control-actions {
    display: flex;
    gap: 0.75rem;
  }

  button {
    padding: 0.625rem 1.25rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .btn-clear {
    background: #30363d;
    color: #e6edf3;
    border: 1px solid #444c56;
  }

  .btn-clear:hover {
    background: #3d444d;
    border-color: #58a6ff;
  }

  .btn-submit {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
  }

  .btn-submit:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(239, 68, 68, 0.4);
  }

  .btn-record {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
  }

  .btn-record:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(16, 185, 129, 0.4);
  }

  .btn-record.recording {
    background: linear-gradient(135deg, #ef4444, #dc2626);
  }

  .record-icon {
    font-size: 1rem;
  }

  @media (max-width: 640px) {
    .pad-grid {
      grid-template-columns: repeat(4, 1fr);
      gap: 0.5rem;
    }

    :global(.pad-number) {
      font-size: 1.2rem;
    }

    :global(.pad-label) {
      font-size: 0.65rem;
    }

    .sampler-controls {
      flex-direction: column;
      align-items: stretch;
    }

    .control-group {
      width: 100%;
    }

    .control-actions {
      width: 100%;
      justify-content: stretch;
    }

    button {
      flex: 1;
    }
  }
</style>

<script>
  // Initialize sampler pad functionality
  class SamplerPadController {
    constructor(containerId = 'sampler-pad-grid') {
      this.container = document.getElementById(containerId);
      this.audioContext = null;
      this.pads = [];
      this.recording = [];
      this.isRecording = false;
      this.masterVolume = 0.7;

      this.init();
    }

    init() {
      // Initialize Web Audio API with error handling
      try {
        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();

        // Resume audio context if it's suspended (required by some browsers)
        if (this.audioContext.state === 'suspended') {
          // Will resume on first user interaction
          const resumeAudio = () => {
            if (this.audioContext && this.audioContext.state === 'suspended') {
              this.audioContext.resume().catch(err => console.warn('Audio resume failed:', err));
            }
          };

          document.addEventListener('click', resumeAudio, { once: true });
          document.addEventListener('touchstart', resumeAudio, { once: true });
        }
      } catch (error) {
        console.error('Failed to initialize AudioContext:', error);
        // Create a fallback that won't crash
        this.audioContext = null;
        alert('Audio playback is not available in your browser. The sampler will be in visual-only mode.');
      }

      // Generate 16 pads
      this.generatePads();

      // Setup event listeners
      this.setupEventListeners();

      // Setup keyboard shortcuts
      this.setupKeyboardShortcuts();
    }

    generatePads() {
      if (!this.container) return;

      const padLabels = [
        'Kick', 'Snare', 'Hi-Hat', 'Clap',
        'Tom 1', 'Tom 2', 'Crash', 'Ride',
        'Bass', 'Synth', 'Lead', 'Pad',
        'FX 1', 'FX 2', 'Voice', 'Sample'
      ];

      const frequencies = [
        60, 120, 180, 100,
        80, 100, 250, 300,
        55, 220, 440, 330,
        150, 200, 180, 160
      ];

      const containerEl = this.container.closest('.sampler-pad-container');
      const isMinimal = containerEl?.getAttribute('data-minimal') === 'true';

      for (let i = 0; i < 16; i++) {
        const pad = document.createElement('div');
        pad.className = 'pad';
        pad.dataset.index = i;
        pad.dataset.freq = frequencies[i];

        pad.innerHTML = `
          <div class="pad-number">${i + 1}</div>
          ${!isMinimal ? `<div class="pad-label">${padLabels[i]}</div>` : ''}
          ${!isMinimal ? `<div class="pad-freq">${frequencies[i]}Hz</div>` : ''}
        `;

        // Touch and mouse events
        pad.addEventListener('mousedown', () => this.playPad(i, frequencies[i]));
        pad.addEventListener('touchstart', (e) => {
          e.preventDefault();
          this.playPad(i, frequencies[i]);
        });

        this.container.appendChild(pad);
        this.pads.push(pad);
      }
    }

    playPad(index, frequency) {
      if (!this.audioContext) return;

      // Visual feedback
      const pad = this.pads[index];
      pad.classList.add('active');
      setTimeout(() => pad.classList.remove('active'), 150);

      // Generate and play sound
      const oscillator = this.audioContext.createOscillator();
      const gainNode = this.audioContext.createGain();

      oscillator.frequency.value = frequency;
      oscillator.type = 'sine';

      gainNode.gain.setValueAtTime(this.masterVolume, this.audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.3);

      oscillator.connect(gainNode);
      gainNode.connect(this.audioContext.destination);

      oscillator.start();
      oscillator.stop(this.audioContext.currentTime + 0.3);

      // Record if recording
      if (this.isRecording) {
        this.recording.push({
          index,
          frequency,
          time: Date.now()
        });
      }

      // Award XP if progressManager exists
      if (window.progressManager && Math.random() < 0.1) {
        window.progressManager.awardXP(1, 'music_creation', 'Played sampler pad');
      }
    }

    setupEventListeners() {
      // Volume control
      const volumeSlider = document.getElementById('master-volume');
      const volumeDisplay = document.getElementById('volume-display');

      if (volumeSlider && volumeDisplay) {
        volumeSlider.addEventListener('input', (e) => {
          this.masterVolume = e.target.value / 100;
          volumeDisplay.textContent = e.target.value + '%';
        });
      }

      // Clear button
      const clearBtn = document.getElementById('clear-pattern');
      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          this.recording = [];
          console.log('Pattern cleared');
        });
      }

      // Record button
      const recordBtn = document.getElementById('toggle-record');
      if (recordBtn) {
        recordBtn.addEventListener('click', () => {
          this.isRecording = !this.isRecording;
          recordBtn.classList.toggle('recording', this.isRecording);

          const label = recordBtn.querySelector('.record-label');
          if (label) {
            label.textContent = this.isRecording ? 'Recording...' : 'Record';
          }

          if (this.isRecording) {
            this.recording = [];
          }
        });
      }

      // Battle submit button
      const submitBtn = document.getElementById('submit-battle');
      if (submitBtn) {
        submitBtn.addEventListener('click', () => this.submitToBattle());
      }
    }

    setupKeyboardShortcuts() {
      // Map keys to pads (1-9, Q-I, A-K, Z-M)
      const keyMap = {
        '1': 0, '2': 1, '3': 2, '4': 3,
        'q': 4, 'w': 5, 'e': 6, 'r': 7,
        'a': 8, 's': 9, 'd': 10, 'f': 11,
        'z': 12, 'x': 13, 'c': 14, 'v': 15
      };

      document.addEventListener('keydown', (e) => {
        const key = e.key.toLowerCase();
        if (key in keyMap) {
          const index = keyMap[key];
          const freq = parseInt(this.pads[index].dataset.freq);
          this.playPad(index, freq);
        }
      });
    }

    async submitToBattle() {
      if (this.recording.length === 0) {
        alert('Record something first before submitting!');
        return;
      }

      // Emit event for battle integration
      const event = new CustomEvent('sampler-battle-submit', {
        detail: {
          recording: this.recording,
          timestamp: Date.now()
        }
      });
      window.dispatchEvent(event);

      console.log('Submitted to battle:', this.recording);

      // Award XP
      if (window.progressManager) {
        window.progressManager.awardXP(25, 'battle_submission', 'Submitted sampler recording to battle');
      }
    }

    getRecording() {
      return this.recording;
    }
  }

  // Auto-initialize if container exists
  if (document.getElementById('sampler-pad-grid')) {
    window.samplerPadController = new SamplerPadController();
  }
</script>
