---
/**
 * WalletPINSetup.astro
 * User-friendly PIN creation for wallet encryption
 *
 * Usability Features:
 * - Visual PIN dots (no text shown)
 * - Strength indicator
 * - Auto-focus on next digit
 * - Clear error messages
 * - Confirmation step
 * - Helpful hints
 */
---

<div id="pinSetupModal" class="pin-modal" style="display: none;">
  <div class="pin-overlay"></div>

  <div class="pin-container card-retro-neon">
    <!-- Close Button -->
    <button class="modal-close-btn" onclick="closePINSetupModal()" title="Close (progress will be saved)">
      âœ•
    </button>

    <!-- Header -->
    <div class="pin-header">
      <div class="pin-icon animated-pulse">ğŸ”</div>
      <h2 class="pin-title glitch neon-text">
        CREATE YOUR PIN
      </h2>
      <p class="pin-subtitle mono">
        This PIN will protect your wallet on this device
      </p>
    </div>

    <!-- Step Indicator -->
    <div class="step-indicator mono">
      <div class="step" id="step1Indicator">
        <span class="step-number">1</span>
        <span class="step-label">Create PIN</span>
      </div>
      <div class="step-divider">â†’</div>
      <div class="step" id="step2Indicator">
        <span class="step-number">2</span>
        <span class="step-label">Confirm PIN</span>
      </div>
      <div class="step-divider">â†’</div>
      <div class="step" id="step3Indicator">
        <span class="step-number">3</span>
        <span class="step-label">Done!</span>
      </div>
    </div>

    <!-- Create PIN Step -->
    <div class="pin-step active" id="createPINStep">
      <div class="instruction-box dialogue-box mono">
        <div class="dialogue-speaker">PIN_SETUP.EXE</div>
        <div class="dialogue-text">
          > CREATE_SECURE_PIN()<br/>
          <br/>
          Enter a 6-digit PIN to encrypt your wallet.<br/>
          <span class="text-neon">Make it memorable but not obvious!</span><br/>
          <span class="text-cyan blink">â–ˆ</span>
        </div>
      </div>

      <div class="pin-input-container">
        <div class="pin-dots" id="createPINDots">
          <input type="tel" maxlength="1" class="pin-digit" id="create1" data-index="0" inputmode="numeric" pattern="[0-9]" autocomplete="off">
          <input type="tel" maxlength="1" class="pin-digit" id="create2" data-index="1" inputmode="numeric" pattern="[0-9]" autocomplete="off">
          <input type="tel" maxlength="1" class="pin-digit" id="create3" data-index="2" inputmode="numeric" pattern="[0-9]" autocomplete="off">
          <input type="tel" maxlength="1" class="pin-digit" id="create4" data-index="3" inputmode="numeric" pattern="[0-9]" autocomplete="off">
          <input type="tel" maxlength="1" class="pin-digit" id="create5" data-index="4" inputmode="numeric" pattern="[0-9]" autocomplete="off">
          <input type="tel" maxlength="1" class="pin-digit" id="create6" data-index="5" inputmode="numeric" pattern="[0-9]" autocomplete="off">
        </div>

        <button class="btn-clear-pin mono" onclick="clearPINInput('create')">
          âœ• CLEAR
        </button>
      </div>

      <!-- PIN Strength Indicator -->
      <div class="pin-strength">
        <div class="strength-label mono">PIN Strength:</div>
        <div class="strength-bar">
          <div class="strength-fill" id="strengthFill"></div>
        </div>
        <div class="strength-text mono" id="strengthText">Enter 6 digits</div>
      </div>

      <!-- Tips -->
      <div class="pin-tips">
        <h4 class="tips-title mono text-neon">ğŸ’¡ PIN Tips:</h4>
        <ul class="tips-list mono">
          <li>âœ… Use a PIN you'll remember (but others can't guess)</li>
          <li>âŒ Avoid birthdays (123456, 111111, etc.)</li>
          <li>âœ… Mix up the digits (no patterns)</li>
          <li>ğŸ’¾ Write it down and store it safely</li>
        </ul>
      </div>
    </div>

    <!-- Confirm PIN Step -->
    <div class="pin-step" id="confirmPINStep">
      <div class="instruction-box dialogue-box mono">
        <div class="dialogue-speaker">PIN_VERIFICATION</div>
        <div class="dialogue-text">
          > VERIFY_PIN()<br/>
          <br/>
          Enter your PIN again to confirm.<br/>
          <span class="text-cyan blink">â–ˆ</span>
        </div>
      </div>

      <div class="pin-input-container">
        <div class="pin-dots" id="confirmPINDots">
          <input type="tel" maxlength="1" class="pin-digit" id="confirm1" data-index="0" inputmode="numeric" pattern="[0-9]" autocomplete="off">
          <input type="tel" maxlength="1" class="pin-digit" id="confirm2" data-index="1" inputmode="numeric" pattern="[0-9]" autocomplete="off">
          <input type="tel" maxlength="1" class="pin-digit" id="confirm3" data-index="2" inputmode="numeric" pattern="[0-9]" autocomplete="off">
          <input type="tel" maxlength="1" class="pin-digit" id="confirm4" data-index="3" inputmode="numeric" pattern="[0-9]" autocomplete="off">
          <input type="tel" maxlength="1" class="pin-digit" id="confirm5" data-index="4" inputmode="numeric" pattern="[0-9]" autocomplete="off">
          <input type="tel" maxlength="1" class="pin-digit" id="confirm6" data-index="5" inputmode="numeric" pattern="[0-9]" autocomplete="off">
        </div>

        <button class="btn-clear-pin mono" onclick="clearPINInput('confirm')">
          âœ• CLEAR
        </button>
      </div>

      <!-- Match Feedback -->
      <div class="match-feedback" id="matchFeedback"></div>
    </div>

    <!-- Success Step -->
    <div class="pin-step" id="successStep">
      <div class="success-animation">
        <div class="success-icon pulse-glow">âœ“</div>
        <h3 class="success-title mono neon-text">PIN CREATED!</h3>
        <p class="success-message mono">
          Your wallet is now protected with your PIN.
        </p>
      </div>

      <div class="security-reminder card-retro">
        <h4 class="reminder-title mono text-neon">ğŸ”’ Important Reminders:</h4>
        <ul class="reminder-list mono">
          <li>Your PIN encrypts your wallet on <strong>this device only</strong></li>
          <li>You'll need it to unlock your wallet</li>
          <li>To recover on a new device, use your <strong>recovery phrase</strong></li>
          <li>Lost PIN? Re-import wallet using recovery phrase</li>
        </ul>
      </div>
    </div>

    <!-- Actions -->
    <div class="pin-actions">
      <button class="btn-pin btn-retro" onclick="goBackFromPIN()" id="backBtn">
        <span>â† BACK</span>
      </button>
      <button
        class="btn-pin btn-retro-neon"
        id="nextBtn"
        onclick="handlePINNext()"
        disabled
      >
        <span id="nextBtnText">CONTINUE â†’</span>
      </button>
    </div>

    <!-- Progress Dots -->
    <div class="progress-dots">
      <span class="progress-dot active" id="dot1"></span>
      <span class="progress-dot" id="dot2"></span>
      <span class="progress-dot" id="dot3"></span>
    </div>
  </div>
</div>

<style>
  /* PIN Modal */
  .pin-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 10003;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    animation: fadeIn 0.5s ease-out;
  }

  .pin-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.98);
    backdrop-filter: blur(15px);
  }

  .pin-container {
    position: relative;
    width: 100%;
    max-width: 700px;
    max-height: 95vh;
    overflow-y: auto;
    padding: 3rem;
    background: var(--color-near-black);
    z-index: 1;
    animation: slideUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Close Button */
  .modal-close-btn {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 40px;
    height: 40px;
    background: transparent;
    border: 2px solid var(--color-mid-gray);
    color: var(--color-light-gray);
    font-size: 1.25rem;
    font-weight: 900;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-close-btn:hover {
    border-color: var(--color-neon-cyan);
    color: var(--color-neon-cyan);
    box-shadow: 0 0 15px var(--color-neon-cyan-glow);
    transform: scale(1.1);
  }

  /* Header */
  .pin-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .pin-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    animation: pulse 2s ease-in-out infinite;
  }

  .pin-title {
    font-size: 2.5rem;
    font-weight: 900;
    font-family: var(--font-mono);
    letter-spacing: 4px;
    margin-bottom: 0.75rem;
  }

  .pin-subtitle {
    font-size: 1rem;
    color: var(--color-light-gray);
  }

  /* Step Indicator */
  .step-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    margin-bottom: 2.5rem;
    padding: 1.5rem;
    background: var(--color-black);
    border: 2px solid var(--color-mid-gray);
  }

  .step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    opacity: 0.4;
    transition: all 0.3s ease;
  }

  .step.active {
    opacity: 1;
  }

  .step.active .step-number {
    background: var(--color-neon-green);
    color: var(--color-black);
    box-shadow: 0 0 20px var(--color-neon-green-glow);
  }

  .step.completed .step-number {
    background: var(--color-dark-gray);
    color: var(--color-neon-green);
  }

  .step.completed .step-number::after {
    content: 'âœ“';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  .step-number {
    width: 40px;
    height: 40px;
    border: 3px solid var(--color-white);
    background: var(--color-black);
    color: var(--color-white);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
    font-size: 1.125rem;
    position: relative;
    transition: all 0.3s ease;
  }

  .step-label {
    font-size: 0.875rem;
    font-weight: 700;
    white-space: nowrap;
  }

  .step-divider {
    color: var(--color-mid-gray);
    font-size: 1.5rem;
  }

  /* PIN Steps */
  .pin-step {
    display: none;
  }

  .pin-step.active {
    display: block;
    animation: fadeIn 0.5s ease-out;
  }

  .instruction-box {
    margin-bottom: 2rem;
  }

  .dialogue-box {
    background: var(--color-black);
    border: 3px solid var(--color-neon-green);
    padding: 1.75rem;
    box-shadow: 0 0 30px var(--color-neon-green-glow);
  }

  .dialogue-speaker {
    color: var(--color-neon-cyan);
    font-size: 0.875rem;
    font-weight: 900;
    letter-spacing: 2px;
    margin-bottom: 0.75rem;
  }

  .dialogue-text {
    font-size: 1rem;
    line-height: 1.8;
    color: var(--color-white);
  }

  /* PIN Input */
  .pin-input-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .pin-dots {
    display: flex;
    gap: 1rem;
    justify-content: center;
  }

  .pin-digit {
    width: 60px;
    height: 80px;
    background: var(--color-black);
    border: 4px solid var(--color-white);
    color: transparent;
    caret-color: transparent;
    font-family: var(--font-mono);
    font-size: 2rem;
    font-weight: 900;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
  }

  .pin-digit:focus {
    outline: none;
    border-color: var(--color-neon-cyan);
    box-shadow: 0 0 20px var(--color-neon-cyan-glow);
    animation: pulse 1s ease-in-out infinite;
  }

  .pin-digit.filled {
    border-color: var(--color-neon-green);
    background: var(--color-near-black);
  }

  .pin-digit.filled::after {
    content: 'â—';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: var(--color-neon-green);
    font-size: 2rem;
    animation: popIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .pin-digit.error {
    border-color: #dc2626;
    animation: shake 0.5s ease-in-out;
  }

  @keyframes popIn {
    0% {
      transform: translate(-50%, -50%) scale(0);
    }
    50% {
      transform: translate(-50%, -50%) scale(1.3);
    }
    100% {
      transform: translate(-50%, -50%) scale(1);
    }
  }

  .btn-clear-pin {
    padding: 0.75rem 1.5rem;
    background: none;
    color: var(--color-light-gray);
    border: 2px solid var(--color-mid-gray);
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn-clear-pin:hover {
    color: var(--color-white);
    border-color: var(--color-white);
    background: rgba(255, 255, 255, 0.05);
  }

  /* PIN Strength */
  .pin-strength {
    margin-bottom: 2rem;
  }

  .strength-label {
    font-size: 0.95rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
    text-align: center;
  }

  .strength-bar {
    height: 12px;
    background: var(--color-dark-gray);
    border: 3px solid var(--color-white);
    margin-bottom: 0.75rem;
    overflow: hidden;
  }

  .strength-fill {
    height: 100%;
    width: 0%;
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .strength-fill.weak {
    background: #dc2626;
    width: 33%;
  }

  .strength-fill.medium {
    background: var(--color-neon-yellow);
    width: 66%;
  }

  .strength-fill.strong {
    background: var(--color-neon-green);
    width: 100%;
    box-shadow: 0 0 20px var(--color-neon-green-glow);
  }

  .strength-text {
    text-align: center;
    font-size: 0.95rem;
    font-weight: 700;
  }

  .strength-text.weak {
    color: #dc2626;
  }

  .strength-text.medium {
    color: var(--color-neon-yellow);
  }

  .strength-text.strong {
    color: var(--color-neon-green);
  }

  /* Tips */
  .pin-tips {
    background: var(--color-black);
    border: 2px solid var(--color-mid-gray);
    padding: 1.5rem;
    margin-bottom: 2rem;
  }

  .tips-title {
    font-size: 1rem;
    font-weight: 900;
    margin-bottom: 1rem;
  }

  .tips-list {
    list-style: none;
    padding: 0;
    font-size: 0.875rem;
    line-height: 2;
  }

  /* Match Feedback */
  .match-feedback {
    text-align: center;
    font-family: var(--font-mono);
    font-size: 1.125rem;
    font-weight: 900;
    min-height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .match-feedback.success {
    color: var(--color-neon-green);
  }

  .match-feedback.success::before {
    content: 'âœ“';
    font-size: 1.5rem;
  }

  .match-feedback.error {
    color: #dc2626;
  }

  .match-feedback.error::before {
    content: 'âœ—';
    font-size: 1.5rem;
  }

  /* Success Animation */
  .success-animation {
    text-align: center;
    margin-bottom: 2rem;
  }

  .success-icon {
    width: 120px;
    height: 120px;
    background: var(--color-neon-green);
    color: var(--color-black);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 5rem;
    font-weight: 900;
    margin: 0 auto 2rem;
    animation: successPop 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes successPop {
    0% {
      transform: scale(0);
      opacity: 0;
    }
    50% {
      transform: scale(1.2);
    }
    100% {
      transform: scale(1);
      opacity: 1;
    }
  }

  .success-title {
    font-size: 2rem;
    font-weight: 900;
    letter-spacing: 3px;
    margin-bottom: 1rem;
  }

  .success-message {
    font-size: 1.125rem;
    color: var(--color-light-gray);
  }

  /* Security Reminder */
  .security-reminder {
    padding: 2rem;
    margin-bottom: 2rem;
  }

  .reminder-title {
    font-size: 1.125rem;
    font-weight: 900;
    margin-bottom: 1.25rem;
  }

  .reminder-list {
    list-style: none;
    padding: 0;
    font-size: 0.95rem;
    line-height: 2;
  }

  /* Actions */
  .pin-actions {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .btn-pin {
    flex: 1;
    padding: 1.5rem 2rem;
    font-size: 1.125rem;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 2px;
  }

  .btn-pin:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  /* Progress Dots */
  .progress-dots {
    display: flex;
    justify-content: center;
    gap: 1rem;
  }

  .progress-dot {
    width: 12px;
    height: 12px;
    background: var(--color-dark-gray);
    border-radius: 50%;
    transition: all 0.3s ease;
  }

  .progress-dot.active {
    background: var(--color-neon-green);
    box-shadow: 0 0 15px var(--color-neon-green-glow);
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .pin-container {
      padding: 2rem 1.5rem;
    }

    .pin-title {
      font-size: 2rem;
    }

    .pin-digit {
      width: 50px;
      height: 70px;
      font-size: 1.75rem;
    }

    .pin-dots {
      gap: 0.5rem;
    }

    .step-indicator {
      flex-direction: column;
      gap: 0.5rem;
    }

    .step-divider {
      transform: rotate(90deg);
    }

    .pin-actions {
      flex-direction: column;
    }
  }

  @media (max-width: 480px) {
    .pin-digit {
      width: 45px;
      height: 60px;
    }
  }
</style>

<script is:inline>
  // PIN Setup State
  let pinSetupState = {
    currentStep: 1,
    createPIN: '',
    confirmPIN: ''
  };

  window.showPINSetup = function() {
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('ğŸ” PIN SETUP STARTED');
    console.log('ğŸ“š Step 5/5: Create Your PIN');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('This PIN will encrypt your wallet locally');

    const modal = document.getElementById('pinSetupModal');

    // Reset state
    pinSetupState = {
      currentStep: 1,
      createPIN: '',
      confirmPIN: ''
    };

    // Show modal
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';

    // Show step 1
    showPINStep(1);

    // Focus first input
    setTimeout(() => document.getElementById('create1').focus(), 300);

    console.log('âœ… PIN setup modal opened');
  };

  function showPINStep(step) {
    pinSetupState.currentStep = step;

    // Hide all steps
    document.querySelectorAll('.pin-step').forEach(s => s.classList.remove('active'));

    // Show current step
    if (step === 1) {
      document.getElementById('createPINStep').classList.add('active');
      document.getElementById('backBtn').style.display = 'flex';
      document.getElementById('nextBtn').disabled = true;
    } else if (step === 2) {
      document.getElementById('confirmPINStep').classList.add('active');
      document.getElementById('backBtn').style.display = 'flex';
      document.getElementById('nextBtn').disabled = true;
      setTimeout(() => document.getElementById('confirm1').focus(), 100);
    } else if (step === 3) {
      document.getElementById('successStep').classList.add('active');
      document.getElementById('backBtn').style.display = 'none';
      document.getElementById('nextBtn').disabled = false;
      document.getElementById('nextBtnText').textContent = 'FINISH â†’';
    }

    // Update step indicators
    for (let i = 1; i <= 3; i++) {
      const indicator = document.getElementById(`step${i}Indicator`);
      const dot = document.getElementById(`dot${i}`);

      if (i < step) {
        indicator.classList.add('completed');
        indicator.classList.remove('active');
        dot.classList.add('active');
      } else if (i === step) {
        indicator.classList.add('active');
        indicator.classList.remove('completed');
        dot.classList.add('active');
      } else {
        indicator.classList.remove('active', 'completed');
        dot.classList.remove('active');
      }
    }
  }

  // Setup PIN input handlers
  document.addEventListener('DOMContentLoaded', () => {
    setupPINInputs('create');
    setupPINInputs('confirm');
  });

  function setupPINInputs(type) {
    const inputs = document.querySelectorAll(`#${type}PINDots .pin-digit`);

    inputs.forEach((input, index) => {
      // Handle input
      input.addEventListener('input', (e) => {
        const value = e.target.value;

        // Only allow digits
        if (!/^\d$/.test(value)) {
          e.target.value = '';
          return;
        }

        // Mark as filled
        e.target.classList.add('filled');
        e.target.classList.remove('error');

        // Auto-focus next input
        if (index < inputs.length - 1) {
          inputs[index + 1].focus();
        }

        // Update PIN state
        updatePINState(type);
      });

      // Handle backspace
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace') {
          if (!e.target.value && index > 0) {
            // Focus previous input if current is empty
            inputs[index - 1].focus();
            inputs[index - 1].value = '';
            inputs[index - 1].classList.remove('filled');
            updatePINState(type);
          } else if (e.target.value) {
            // Clear current input
            e.target.value = '';
            e.target.classList.remove('filled');
            updatePINState(type);
          }
        }
      });

      // Handle paste
      input.addEventListener('paste', (e) => {
        e.preventDefault();
        const paste = e.clipboardData.getData('text');
        const digits = paste.replace(/\D/g, '').slice(0, 6);

        digits.split('').forEach((digit, i) => {
          if (inputs[i]) {
            inputs[i].value = digit;
            inputs[i].classList.add('filled');
          }
        });

        updatePINState(type);

        // Focus last filled input
        const lastIndex = Math.min(digits.length - 1, inputs.length - 1);
        inputs[lastIndex].focus();
      });
    });
  }

  function updatePINState(type) {
    const inputs = document.querySelectorAll(`#${type}PINDots .pin-digit`);
    const pin = Array.from(inputs).map(input => input.value).join('');

    if (type === 'create') {
      pinSetupState.createPIN = pin;

      // Update strength indicator
      if (pin.length === 6) {
        const strength = calculatePINStrength(pin);
        updateStrengthIndicator(strength);
        document.getElementById('nextBtn').disabled = false;
      } else {
        document.getElementById('strengthFill').className = 'strength-fill';
        document.getElementById('strengthText').textContent = 'Enter 6 digits';
        document.getElementById('strengthText').className = 'strength-text mono';
        document.getElementById('nextBtn').disabled = true;
      }
    } else if (type === 'confirm') {
      pinSetupState.confirmPIN = pin;

      if (pin.length === 6) {
        checkPINMatch();
      } else {
        document.getElementById('matchFeedback').textContent = '';
        document.getElementById('matchFeedback').className = 'match-feedback';
        document.getElementById('nextBtn').disabled = true;
      }
    }
  }

  function calculatePINStrength(pin) {
    // Check for weak patterns
    const isSequential = /012345|123456|234567|345678|456789|987654|876543|765432|654321|543210/.test(pin);
    const isRepeating = /(\d)\1{5}|(\d)\2{2}(\d)\3{2}/.test(pin);
    const isBirthday = /^(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])$/.test(pin.slice(0, 4));

    if (isSequential || isRepeating || isBirthday) {
      return 'weak';
    }

    // Check for unique digits
    const uniqueDigits = new Set(pin.split('')).size;

    if (uniqueDigits >= 5) {
      return 'strong';
    } else if (uniqueDigits >= 4) {
      return 'medium';
    } else {
      return 'weak';
    }
  }

  function updateStrengthIndicator(strength) {
    const fill = document.getElementById('strengthFill');
    const text = document.getElementById('strengthText');

    fill.className = `strength-fill ${strength}`;
    text.className = `strength-text mono ${strength}`;

    if (strength === 'weak') {
      text.textContent = 'âš ï¸ Weak PIN - Avoid patterns';
    } else if (strength === 'medium') {
      text.textContent = 'ğŸ‘ Medium Strength';
    } else {
      text.textContent = 'âœ“ Strong PIN!';
    }
  }

  function checkPINMatch() {
    const feedback = document.getElementById('matchFeedback');
    const inputs = document.querySelectorAll('#confirmPINDots .pin-digit');
    const nextBtn = document.getElementById('nextBtn');

    if (pinSetupState.confirmPIN === pinSetupState.createPIN) {
      feedback.textContent = 'PINs match!';
      feedback.className = 'match-feedback success';
      nextBtn.disabled = false;
    } else {
      feedback.textContent = 'PINs do not match';
      feedback.className = 'match-feedback error';
      nextBtn.disabled = true;

      // Shake inputs
      inputs.forEach(input => input.classList.add('error'));
      setTimeout(() => {
        inputs.forEach(input => input.classList.remove('error'));
      }, 500);
    }
  }

  window.clearPINInput = function(type) {
    const inputs = document.querySelectorAll(`#${type}PINDots .pin-digit`);
    inputs.forEach(input => {
      input.value = '';
      input.classList.remove('filled', 'error');
    });

    if (type === 'create') {
      pinSetupState.createPIN = '';
      document.getElementById('strengthFill').className = 'strength-fill';
      document.getElementById('strengthText').textContent = 'Enter 6 digits';
      document.getElementById('strengthText').className = 'strength-text mono';
    } else {
      pinSetupState.confirmPIN = '';
      document.getElementById('matchFeedback').textContent = '';
      document.getElementById('matchFeedback').className = 'match-feedback';
    }

    document.getElementById('nextBtn').disabled = true;
    inputs[0].focus();
  };

  window.goBackFromPIN = function() {
    if (pinSetupState.currentStep === 1) {
      if (confirm('Go back? You will need to verify your recovery phrase again.')) {
        document.getElementById('pinSetupModal').style.display = 'none';
        document.body.style.overflow = '';

        if (window.showRecoveryPhraseVerification && window._recoveryWords) {
          window.showRecoveryPhraseVerification(window._recoveryWords);
        }
      }
    } else if (pinSetupState.currentStep === 2) {
      clearPINInput('confirm');
      showPINStep(1);
    }
  };

  window.closePINSetupModal = function() {
    // Save wallet creation progress
    if (window._recoveryWords && window._recoveryWords.length > 0) {
      localStorage.setItem('walletCreationProgress', JSON.stringify({
        step: 'pin_setup',
        words: window._recoveryWords,
        pinStep: pinSetupState.currentStep,
        timestamp: Date.now()
      }));
      console.log('ğŸ’¾ PIN setup progress saved');
    }

    document.getElementById('pinSetupModal').style.display = 'none';
    document.body.style.overflow = '';
  };

  window.handlePINNext = function() {
    if (pinSetupState.currentStep === 1) {
      showPINStep(2);
    } else if (pinSetupState.currentStep === 2) {
      // Move to success
      showPINStep(3);

      // Award XP
      if (window.progressManager) {
        window.progressManager.awardXP(25, 'pin_created', 'Created wallet PIN');
      }
    } else if (pinSetupState.currentStep === 3) {
      // Complete wallet setup
      completeWalletSetup();
    }
  };

  async function completeWalletSetup() {
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('ğŸ” FINALIZING WALLET SETUP');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('Encrypting wallet with PIN...');

    // Hide PIN modal
    document.getElementById('pinSetupModal').style.display = 'none';
    document.body.style.overflow = '';

    // Encrypt and save wallet
    if (window.encryptAndSaveWallet && window._recoveryWords && window._currentWallet) {
      const mnemonic = window._recoveryWords.join(' ');
      const publicKey = window._currentWallet.publicKey;
      console.log('ğŸ”’ Encrypting recovery phrase with PIN');
      console.log('ğŸ“ Public Key:', publicKey);
      await window.encryptAndSaveWallet(mnemonic, pinSetupState.createPIN, publicKey);
      console.log('âœ… Wallet encrypted and saved locally');
    } else {
      console.error('âŒ Encryption functions not available');
      if (!window._currentWallet) {
        console.error('âŒ Current wallet data missing');
      }
    }

    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('ğŸ‰ WALLET CREATION COMPLETE!');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('Your secure Solana wallet is ready');
    console.log('Recovery phrase: SAVED (encrypted)');
    console.log('PIN: SAVED (hashed)');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

    // Clear wallet creation progress - wallet is complete
    localStorage.removeItem('walletCreationProgress');
    localStorage.removeItem('educationProgress');

    // Show success message
    alert('ğŸ‰ Wallet Created Successfully!\n\nYour secure wallet is ready to use.\n+25 XP awarded!');

    // Reload page to initialize with new wallet
    window.location.reload();
  }
</script>
